# cat-oscilloscope

An oscilloscope-like waveform visualizer that runs in the browser.

## üåê Live Demo

**[https://cat2151.github.io/cat-oscilloscope/](https://cat2151.github.io/cat-oscilloscope/)**

You can try the application at the URL above. Microphone access permission is required.

‚ÄªThis document is temporary and largely generated by an LLM. It will be revised in the future.

## Current Status

- Major bugs have been addressed.
- Minor issues persist.
- When using audio from a microphone, phase alignment is unstable (sometimes aligned, sometimes not), resulting in low practical utility.
- When using simple monaural waveforms from chiptune WAV files, it has high practical utility.
- How easy it is to use as a library will be evaluated.

## üìö Usage as a Library

cat-oscilloscope can be used as an npm library in your own projects. See [LIBRARY_USAGE.md](./LIBRARY_USAGE.md) for detailed instructions.

```typescript
import { Oscilloscope } from 'cat-oscilloscope';

const canvas = document.getElementById('canvas') as HTMLCanvasElement;
const oscilloscope = new Oscilloscope(canvas);
await oscilloscope.start();
```

## Notes

- Frequency Estimation
  - Sometimes FFT is accurate, and other times non-FFT methods are more accurate.
  - Whether to make FFT the default is under consideration.
  - Further improvements to frequency estimation are deferred, prioritizing numerous other tasks.

## WASM Implementation

The data processing part (waveform search, frequency estimation, zero-cross detection, etc.) is also implemented in Rust/WASM.

- **TypeScript implementation**: Used by default. High compatibility and easy to debug.
- **Rust/WASM implementation**: Expected to offer faster processing. Can be toggled with the "Use WASM" checkbox.

Both implementations return the same `WaveformRenderData` structure, so the rendering logic is shared.

### Building the WASM Implementation

The WASM implementation is located in the `wasm-processor` directory.

```bash
# Build the WASM implementation (requires wasm-pack)
npm run build:wasm

# Build the entire app (including WASM)
npm run build
```

**Required tools**:
- Rust toolchain (rustc, cargo)
- wasm-pack (`cargo install wasm-pack`)

## Features

- üé§ **Microphone Input** - Captures audio from the microphone in real-time
- üéØ **Zero-Crossing Detection** - Automatically detects points where audio crosses from negative to positive
- üìä **Stable Display** - Aligns waveform display based on zero-crossing points for a stable view
- üîä **Auto-Gain** - Automatically adjusts waveform amplitude to optimally utilize canvas height
- ‚ö° **Real-time Rendering** - Continuously updates waveform visualization
- üé® **Classic Design** - Green waveform and grid overlay on a black background
- üõ°Ô∏è **Error Handling** - Gracefully handles microphone access permission issues
- üîç **Waveform Similarity Search** - Calculates similarity with previous frame for stable display
- ü¶Ä **Rust/WASM Support** - Data processing also implemented in Rust/WASM, toggleable via checkbox

## Getting Started

### Prerequisites

- Node.js (v16 or higher recommended)
- npm or yarn

### Installation

```bash
npm install
```

### Development

Start the development server:

```bash
npm run dev
```

Open `http://localhost:3000/` in your browser.

### Build

Build for production:

```bash
npm run build
```

Built files will be output to the `dist` directory.

### Preview Production Build

```bash
npm run preview
```

### Testing

Run tests:

```bash
npm test
```

Generate coverage report:

```bash
npm run test:coverage
```

Launch test UI:

```bash
npm run test:ui
```

See [TESTING.md](TESTING.md) for more details.

## How It Works

### Zero-Crossing Detection Algorithm

This oscilloscope implements the following zero-crossing detection algorithm:

1. Scans the audio buffer to detect points where the waveform crosses from negative (or zero) to positive
2. Identifies the first zero-crossing point
3. Finds the next zero-crossing point to determine one complete waveform cycle
4. Displays the waveform with slight padding before and after the zero-crossing points

This achieves a stable, non-scrolling display.

### Technical Details

- **FFT Size**: 4096 samples for high resolution
- **Smoothing**: Disabled (0) for accurate waveform representation
- **Display Padding**: 20 samples before and after zero-crossing points
- **Auto-Gain**:
  - Automatically adjusts to target 80% of canvas height
  - Smooth transitions via peak tracking (decay rate: 0.95)
  - Gain range: 0.5x to 99x
  - Interpolation factor: 0.1 (gradual adjustment)
  - Toggleable via UI checkbox (default: enabled)
- **Canvas Resolution**: 800x400 pixels
- **Refresh Rate**: Synchronized with browser's requestAnimationFrame (approx. 60 FPS)

## Technology Stack

- **TypeScript** - Type-safe JavaScript
- **Vite** - Fast build tool and development server
- **Web Audio API** - Audio capture and analysis
- **HTML Canvas** - 2D waveform rendering

## Browser Requirements

This application requires:
- A modern browser supporting Web Audio API (Chrome, Firefox, Safari, Edge)
- User permission for microphone access
- HTTPS or localhost (required for microphone access)

## License

MIT License - See the [LICENSE](LICENSE) file for more details

*Big Brother is listening to you. Now it‚Äôs the cat.* üê±