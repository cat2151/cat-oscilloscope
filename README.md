# cat-oscilloscope

An oscilloscope-style waveform visualizer that runs in your browser.

## üåê Live Demo

**[https://cat2151.github.io/cat-oscilloscope/](https://cat2151.github.io/cat-oscilloscope/)**

You can try the application at the URL above. Microphone access permission is required.

*This document is a placeholder and largely generated by an LLM. It will be revised in the future.*

## Current Status
- Most major bugs have been resolved.
- Minor issues still exist.
- When using microphone input, the phase alignment can be unstable, making practical use difficult.
- For simple monaural waveforms from WAV files, such as chiptune, the practicality is high.
- The ease of use as a library will be evaluated soon.

## üìö Usage as a Library

cat-oscilloscope can be used as an npm library in your own projects. For detailed instructions, please refer to [LIBRARY_USAGE.md](./LIBRARY_USAGE.md).

```typescript
import { Oscilloscope } from 'cat-oscilloscope';

const canvas = document.getElementById('canvas') as HTMLCanvasElement;
const oscilloscope = new Oscilloscope(canvas);
await oscilloscope.start();
```

## Features

### Frequency Estimation

cat-oscilloscope supports five frequency estimation algorithms:

1. **Zero-Crossing**: Simple and fast. Suitable for simple waveforms.
2. **Autocorrelation**: Default. Balanced accuracy for complex waveforms.
3. **FFT (Fast Fourier Transform)**: Frequency spectrum analysis. Strong for high frequencies.
4. **STFT (Short-Time Fourier Transform)**: Variable window length improves low-frequency detection accuracy.
5. **CQT (Constant-Q Transform)**: High frequency resolution in low-frequency ranges. Suitable for music analysis.

### Buffer Size Multiplier

To improve low-frequency detection accuracy, extended buffers using past frame buffers are supported:

- **1x (Standard)**: Standard buffer size (approximately 1/60 second)
- **4x (Better Low Freq)**: 4x extended buffer for improved low-frequency detection
- **16x (Best Low Freq)**: 16x extended buffer for best low-frequency detection accuracy

**Example Usage**: For detecting ultra-low frequencies below 50Hz, select STFT or CQT and set Buffer Size to 16x for optimal results.

## Notes

- Frequency Estimation
  - Sometimes FFT is accurate, and sometimes other methods are more accurate.
  - STFT and CQT are particularly excellent for detecting low frequencies (50-100Hz).
  - Increasing the buffer size multiplier improves low-frequency accuracy but may slightly slow response time.

## About WASM Implementation

The data processing parts (waveform search, frequency estimation, zero-cross detection, etc.) are also implemented in Rust/WASM.

- **TypeScript Implementation**: Used by default. High compatibility and easy debugging.
- **Rust/WASM Implementation**: Expected to provide faster processing. Can be toggled with the "Use WASM" checkbox.

Both implementations return the exact same `WaveformRenderData` structure, so the rendering logic is shared.

### Building the WASM Implementation

The WASM implementation is located in the `wasm-processor` directory.

```bash
# Build the WASM implementation (wasm-pack is required)
npm run build:wasm

# Build the entire application (including WASM)
npm run build
```

**Required Tools**:
- Rust toolchain (rustc, cargo)
- wasm-pack (`cargo install wasm-pack`)

## Features

- üé§ **Microphone Input** - Captures audio from your microphone in real-time
- üéØ **Zero-Cross Detection** - Automatically detects points where the audio crosses from negative to positive
- üìä **Stable Display** - Aligns waveform display based on zero-cross points for a stable view
- üîä **Auto Gain** - Automatically adjusts waveform amplitude to optimally utilize canvas height
- ‚ö° **Real-time Rendering** - Continuously updates waveform visualization
- üé® **Classic Design** - Black background with green waveform and grid overlay
- üõ°Ô∏è **Error Handling** - Gracefully handles microphone access permission issues
- üîç **Waveform Similarity Search** - Calculates similarity with previous frames to achieve a stable waveform display
- ü¶Ä **Rust/WASM Support** - Data processing implemented in Rust/WASM, toggleable via checkbox

## Getting Started

### Prerequisites

- Node.js (v16 or higher recommended)
- npm or yarn

### Installation

```bash
npm install
```

### Development

Start the development server:

```bash
npm run dev
```

Open `http://localhost:3000/` in your browser.

### Build

Build for production:

```bash
npm run build
```

The built files will be output to the `dist` directory.

### Preview Production Build

```bash
npm run preview
```

### Testing

Run tests:

```bash
npm test
```

Generate coverage report:

```bash
npm run test:coverage
```

Launch test UI:

```bash
npm run test:ui
```

For more details, refer to [TESTING.md](TESTING.md).

## How It Works

### Zero-Cross Detection Algorithm

This oscilloscope implements a zero-cross detection algorithm as follows:

1. Scans the audio buffer to detect points where the waveform crosses from negative (or zero) to positive.
2. Identifies the first zero-cross point.
3. Finds the next zero-cross point to determine one complete waveform cycle.
4. Displays the waveform with slight padding before and after the zero-cross points.

This achieves a stable, non-scrolling display.

### Technical Details

- **FFT Size**: 4096 samples for high resolution
- **Smoothing**: Disabled (0) for accurate waveform representation
- **Display Padding**: 20 samples before and after the zero-cross point
- **Auto Gain**:
  - Automatically adjusts to target 80% of canvas height
  - Smooth transitions via peak tracking (decay rate: 0.95)
  - Gain range: 0.5x to 99x
  - Interpolation factor: 0.1 (gradual adjustment)
  - Toggleable via UI checkbox (default: enabled)
- **Canvas Resolution**: 800x400 pixels
- **Refresh Rate**: Synchronized with browser's requestAnimationFrame (approx. 60 FPS)

## Technology Stack

- **TypeScript** - Type-safe JavaScript
- **Vite** - Fast build tool and development server
- **Web Audio API** - Audio capture and analysis
- **HTML Canvas** - 2D waveform rendering

## Browser Requirements

This application requires:
- A modern browser supporting Web Audio API (Chrome, Firefox, Safari, Edge)
- User permission for microphone access
- HTTPS or localhost (required for microphone access)

## License

MIT License - See the [LICENSE](LICENSE) file for details

*Big Brother is listening to you. Now it‚Äôs the cat.* üê±