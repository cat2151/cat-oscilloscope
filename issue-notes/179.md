# issue micで人の声を入力すると、類似度0のスパイクが1秒に10回前後発生していることが判明した。load wav fileで単純波形を入力した場合は問題ない。仮説を洗い出す #179
[issues #179](https://github.com/cat2151/cat-oscilloscope/issues/179)

## 重要な前提条件

**周波数推定グラフは安定している** ことが確認されたため、周波数推定の不安定性は原因から除外されます。

## 再分析結果（v2）

詳細な分析結果は [179-analysis-v2.md](./179-analysis-v2.md) を参照してください。

### 新しい仮説（優先度順）

1. **フレームドロップによるデータ不整合（最有力）**
   - requestAnimationFrameが60fps未満で実行される場合、データ取得のタイミングがずれる
   - AudioContextのバッファ更新と非同期になり、データの連続性が失われる
   - 修正案: タイムスタンプベースのデータ検証、類似度0の場合は前回値を維持

2. **バッファサイズ不足**
   - FFTサイズ4096が低周波人声に対して不十分な可能性
   - バッファサイズマルチプライヤーが正しく適用されていない可能性
   - 検証: バッファサイズマルチプライヤーの設定確認

3. **AnalyserNodeのデータ読み取りタイミング問題**
   - getFloatTimeDomainData()のタイミングで異なるバッファ位置を読み取る
   - データの連続性が保証されない

4. **WASM処理時間による遅延**
   - 相関係数計算が重く、16.67ms（60fps）を超える
   - 処理が遅い瞬間にデータが古くなる

5. **ノイズゲートによる信号カット**
   - 音量変動でノイズゲート閾値を下回り、信号が0で埋められる
   - 修正案: ノイズゲート適用後も前回の波形情報を保持

## 推奨アクション

### フェーズ1: 診断（最優先）
1. フレームレート測定の追加
2. 類似度が0になる条件の詳細ログ
3. AudioContextのcurrentTimeとバッファ取得タイミングの記録

### フェーズ2: 暫定修正
1. 類似度が0の場合、前回の値を維持するロジックを追加
2. フレームドロップ検出と警告

### フェーズ3: 根本的修正
1. AudioWorkletの導入検討
2. 相関係数計算の最適化
3. データ連続性の検証と補正

---

## 旧分析（v1）- 参考資料

周波数推定の不安定性を主因とした分析: [179-analysis.md](./179-analysis.md)
※この仮説は除外されました
