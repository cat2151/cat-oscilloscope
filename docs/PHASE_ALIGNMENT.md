# Phase Alignment Mode

## 概要

Phase Alignment Mode（位相同期モード）は、サブハーモニクス（1/4倍音など）を含む波形の位相ブレを解決するために追加された新しいアライメント機能です。

## 問題の背景

### Issue #139で報告された問題

1/4倍音を含む波形を表示する際、表示される波形の位相が+0周期、+1周期、+2周期、+3周期の4パターンでブレているように見える現象が発生していました。

### 既存のゼロクロス検出の限界

従来のゼロクロス検出方式では：
- 1周期に2回のゼロクロス点が存在する
- サブハーモニクス成分により、ゼロクロス点が4周期のサイクルでブレる可能性がある
- 位相情報を考慮していないため、波形の真の周期性を捉えきれない

## Phase Alignment Modeの仕組み

### 基本原理

Phase Alignment Modeは、基本周波数の位相を検出し、位相が0（または2π）となる点で波形を同期させます。

### アルゴリズム

1. **DFTベースの位相検出**
   - Hann窓を適用してスペクトル漏れを軽減
   - 基本周波数でのDFT（離散フーリエ変換）を計算
   - 複素数の位相を`atan2(imag, real)`で算出

2. **位相0の探索**
   - 探索範囲内で位相が0に最も近い点を検出
   - 粗探索後、サンプルレベルの精度で再探索

3. **時間的連続性の維持**
   - 前フレームのアライメント位置を記録
   - 探索範囲を前回位置の近傍に制限

## 使い方

### UIでの選択

「Alignment:」ドロップダウンから選択：
- **Zero-Cross**: デフォルト。ゼロクロス点でアライメント
- **Peak**: ピーク点でアライメント（高周波向け）
- **Phase**: 位相同期でアライメント（サブハーモニクス向け）

### プログラマティックな使用

```typescript
import { Oscilloscope } from 'cat-oscilloscope';

const oscilloscope = new Oscilloscope(canvas, ...);
oscilloscope.setAlignmentMode('phase');
```

## 各モードの比較

| モード | 特徴 | 適用場面 |
|--------|------|----------|
| Zero-Cross | シンプルで高速 | 単純な正弦波 |
| Peak | 高周波で安定 | ノイズの多い環境 |
| Phase | サブハーモニクスに強い | 1/4倍音を含む波形 |
