"use strict";var $=Object.defineProperty;var U=(f,t,e)=>t in f?$(f,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):f[t]=e;var n=(f,t,e)=>U(f,typeof t!="symbol"?t+"":t,e);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});function H(f){return Math.pow(10,f/20)}function k(f){return f<=0?-1/0:20*Math.log10(f)}function R(f){if(f<=0||!isFinite(f))return null;const e=440*Math.pow(2,-4.75),i=12*Math.log2(f/e),r=Math.round(i),a=Math.round((i-r)*100),o=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],s=Math.floor(r/12);return{noteName:`${o[(r%12+12)%12]}${s}`,cents:a}}const X=-48;function O(f){const t=f.numberOfChannels,e=f.sampleRate,i=f.length,r=[];let a=0;for(let c=0;c<t;c++){const d=f.getChannelData(c);r.push(d);for(let l=0;l<i;l++){const m=Math.abs(d[l]);m>a&&(a=m)}}if(a===0)return f;const o=a*Math.pow(10,X/20);let s=i;for(let c=0;c<i;c++){let d=!0;for(let l=0;l<t;l++)if(Math.abs(r[l][c])>o){d=!1;break}if(!d){s=c;break}}if(s>=i)return f;let h=i-1;for(let c=i-1;c>=s;c--){let d=!0;for(let l=0;l<t;l++)if(Math.abs(r[l][c])>o){d=!1;break}if(!d){h=c;break}}if(s===0&&h===i-1)return f;const y=h-s+1,u=new AudioBuffer({numberOfChannels:t,length:y,sampleRate:e});for(let c=0;c<t;c++){const d=r[c],l=u.getChannelData(c);for(let m=0;m<y;m++)l[m]=d[s+m]}return u}class D{constructor(){n(this,"audioContext",null);n(this,"analyser",null);n(this,"mediaStream",null);n(this,"audioBufferSource",null);n(this,"bufferSource",null);n(this,"dataArray",null);n(this,"frequencyData",null);n(this,"frameBufferHistory",[]);n(this,"MAX_FRAME_HISTORY",16)}initializeAnalyser(){if(!this.audioContext)throw new Error("AudioContext must be initialized before creating analyser");this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=4096,this.analyser.smoothingTimeConstant=0;const t=this.analyser.fftSize;this.dataArray=new Float32Array(t),this.frequencyData=new Uint8Array(this.analyser.frequencyBinCount)}async start(){try{this.mediaStream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.audioContext=new AudioContext;const t=this.audioContext.createMediaStreamSource(this.mediaStream);this.initializeAnalyser(),t.connect(this.analyser)}catch(t){throw console.error("Error accessing microphone:",t),t}}async startFromFile(t){try{const e=await t.arrayBuffer();this.audioContext&&this.audioContext.state!=="closed"&&await this.audioContext.close(),this.audioContext=new AudioContext;let i=await this.audioContext.decodeAudioData(e);i=O(i),this.initializeAnalyser(),this.audioBufferSource=this.audioContext.createBufferSource(),this.audioBufferSource.buffer=i,this.audioBufferSource.loop=!0,this.audioBufferSource.connect(this.analyser),this.analyser.connect(this.audioContext.destination),this.audioBufferSource.start(0)}catch(e){throw console.error("Error loading audio file:",e),e}}async startFromBuffer(t){try{this.audioContext&&this.audioContext.state!=="closed"&&await this.audioContext.close(),this.audioContext=null,this.bufferSource=t,this.bufferSource.setChunkSize(4096),this.dataArray=new Float32Array(4096),this.frequencyData=new Uint8Array(2048)}catch(e){throw console.error("Error starting from buffer:",e),e}}async stop(){if(this.audioBufferSource){try{this.audioBufferSource.stop()}catch{}try{this.audioBufferSource.disconnect()}catch{}this.audioBufferSource=null}if(this.mediaStream&&(this.mediaStream.getTracks().forEach(t=>t.stop()),this.mediaStream=null),this.bufferSource&&(this.bufferSource.reset(),this.bufferSource=null),this.audioContext){try{await this.audioContext.close()}catch(t){console.error("Error closing AudioContext:",t)}this.audioContext=null}this.analyser=null,this.dataArray=null,this.frequencyData=null,this.clearFrameBufferHistory()}getTimeDomainData(){if(this.bufferSource&&this.dataArray){const t=this.bufferSource.getNextChunk();return t?(this.dataArray.set(t),this.updateFrameBufferHistory(this.dataArray),this.dataArray):null}return!this.analyser||!this.dataArray?null:(this.analyser.getFloatTimeDomainData(this.dataArray),this.updateFrameBufferHistory(this.dataArray),this.dataArray)}updateFrameBufferHistory(t){let e;this.frameBufferHistory.length<this.MAX_FRAME_HISTORY?e=new Float32Array(t.length):(e=this.frameBufferHistory.shift(),e.length!==t.length&&(e=new Float32Array(t.length))),e.set(t),this.frameBufferHistory.push(e)}getExtendedTimeDomainData(t){if(t===1)return this.dataArray;if(!this.dataArray||this.frameBufferHistory.length<t)return null;const e=this.frameBufferHistory.slice(-t),i=e.reduce((o,s)=>o+s.length,0),r=new Float32Array(i);let a=0;for(const o of e)r.set(o,a),a+=o.length;return r}clearFrameBufferHistory(){this.frameBufferHistory=[]}getFrequencyData(){return this.bufferSource&&this.dataArray&&this.frequencyData||!this.analyser||!this.frequencyData?null:(this.analyser.getByteFrequencyData(this.frequencyData),this.frequencyData)}getSampleRate(){var t;return this.bufferSource?this.bufferSource.getSampleRate():((t=this.audioContext)==null?void 0:t.sampleRate)||0}getFFTSize(){var t;return this.bufferSource?4096:((t=this.analyser)==null?void 0:t.fftSize)||0}getFrequencyBinCount(){var t;return this.bufferSource?2048:((t=this.analyser)==null?void 0:t.frequencyBinCount)||0}isReady(){return this.bufferSource?this.dataArray!==null:this.audioContext!==null&&this.analyser!==null}}class G{constructor(){n(this,"autoGainEnabled",!0);n(this,"currentGain",1);n(this,"noiseGateEnabled",!0);n(this,"noiseGateThreshold",H(-60))}setAutoGain(t){this.autoGainEnabled=t}getAutoGainEnabled(){return this.autoGainEnabled}setNoiseGate(t){this.noiseGateEnabled=t}getNoiseGateEnabled(){return this.noiseGateEnabled}setNoiseGateThreshold(t){this.noiseGateThreshold=Math.min(Math.max(t,0),1)}getNoiseGateThreshold(){return this.noiseGateThreshold}getCurrentGain(){return this.currentGain}}class N{constructor(){n(this,"frequencyEstimationMethod","fft");n(this,"estimatedFrequency",0);n(this,"MIN_FREQUENCY_HZ",20);n(this,"MAX_FREQUENCY_HZ",5e3);n(this,"bufferSizeMultiplier",16);n(this,"frequencyPlotHistory",[])}clearHistory(){this.frequencyPlotHistory=[],this.estimatedFrequency=0}setFrequencyEstimationMethod(t){this.frequencyEstimationMethod!==t&&(this.frequencyEstimationMethod=t,this.frequencyPlotHistory=[])}getFrequencyEstimationMethod(){return this.frequencyEstimationMethod}setBufferSizeMultiplier(t){this.bufferSizeMultiplier=t}getBufferSizeMultiplier(){return this.bufferSizeMultiplier}getEstimatedFrequency(){return this.estimatedFrequency}getMinFrequency(){return this.MIN_FREQUENCY_HZ}getMaxFrequency(){return this.MAX_FREQUENCY_HZ}getFrequencyPlotHistory(){return this.frequencyPlotHistory}}function F(f,t){if(typeof f=="string"&&f.endsWith("%")){const e=parseFloat(f);return isNaN(e)?(console.warn(`Invalid percentage value: ${f}, using 0`),0):e<0?(console.warn(`Negative percentage value: ${f}, clamping to 0`),0):Math.floor(t*(e/100))}if(typeof f=="string"){const e=parseInt(f,10);return isNaN(e)?(console.warn(`Invalid numeric string: ${f}, using 0`),0):Math.max(0,e)}return typeof f=="number"?isNaN(f)?(console.warn(`Invalid number value: ${f}, using 0`),0):Math.max(0,Math.floor(f)):0}const z={fftOverlay:{position:{x:10,y:"65%"},size:{width:"35%",height:"35%"}},harmonicAnalysis:{position:{x:10,y:10},size:{width:500,height:"auto"}},frequencyPlot:{position:{x:"right-10",y:10},size:{width:280,height:120}}};class q{constructor(t,e){n(this,"canvas");n(this,"ctx");n(this,"fftDisplayEnabled",!0);n(this,"debugOverlaysEnabled",!0);n(this,"overlaysLayout");n(this,"FFT_OVERLAY_HEIGHT_RATIO",.9);n(this,"FFT_MIN_BAR_WIDTH",1);n(this,"FREQ_PLOT_MIN_RANGE_PADDING_HZ",50);n(this,"FREQ_PLOT_RANGE_PADDING_RATIO",.1);this.canvas=t;const i=t.getContext("2d");if(!i)throw new Error("Could not get 2D context");this.ctx=i,this.overlaysLayout=e||z}clearAndDrawGrid(t,e,i){this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.drawGrid(t,e,i)}drawGrid(t,e,i){this.ctx.strokeStyle="#222222",this.ctx.lineWidth=1,this.ctx.beginPath();const r=5;for(let o=0;o<=r;o++){const s=this.canvas.height/r*o;this.ctx.moveTo(0,s),this.ctx.lineTo(this.canvas.width,s)}const a=10;for(let o=0;o<=a;o++){const s=this.canvas.width/a*o;this.ctx.moveTo(s,0),this.ctx.lineTo(s,this.canvas.height)}this.ctx.stroke(),this.ctx.strokeStyle="#444444",this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.moveTo(0,this.canvas.height/2),this.ctx.lineTo(this.canvas.width,this.canvas.height/2),this.ctx.stroke(),t&&t>0&&e&&e>0&&i!==void 0&&i>0&&this.drawGridLabels(t,e,i)}drawGridLabels(t,e,i){this.ctx.save(),this.ctx.font="11px monospace",this.ctx.fillStyle="#666666";const r=e/t*1e3,a=10,o=r/a;for(let u=0;u<=a;u++){const c=this.canvas.width/a*u,d=o*u;let l;d>=1e3?l=`${(d/1e3).toFixed(2)}s`:d>=1?l=`${d.toFixed(1)}ms`:l=`${(d*1e3).toFixed(0)}μs`;const m=this.ctx.measureText(l).width,g=Math.max(2,Math.min(c-m/2,this.canvas.width-m-2));this.ctx.fillText(l,g,this.canvas.height-3)}const s=5,y=1/(s/2*i);for(let u=0;u<=s;u++){const c=this.canvas.height/s*u,l=(s/2-u)*y;let m;if(l===0)m="0dB*";else{const g=k(Math.abs(l)),E=l>0?"+":"-",v=Math.abs(g);v>=100?m=`${E}${v.toFixed(0)}dB`:m=`${E}${v.toFixed(1)}dB`}this.ctx.fillText(m,3,c+10)}this.ctx.restore()}drawWaveform(t,e,i,r){const a=i-e;if(a<=0)return;this.ctx.strokeStyle="#00ff00",this.ctx.lineWidth=2,this.ctx.beginPath();const o=this.canvas.width/a,s=this.canvas.height/2,y=this.canvas.height/2*r;for(let u=0;u<a;u++){const c=e+u,d=t[c],l=s-d*y,m=Math.min(this.canvas.height,Math.max(0,l)),g=u*o;u===0?this.ctx.moveTo(g,m):this.ctx.lineTo(g,m)}this.ctx.stroke()}drawFFTOverlay(t,e,i,r,a){if(!this.fftDisplayEnabled)return;const o=i/r,s=Math.floor(this.canvas.width*.35),h=Math.floor(this.canvas.height*.35),y=10,u=this.canvas.height-h-10,{x:c,y:d,width:l,height:m}=this.calculateOverlayDimensions(this.overlaysLayout.fftOverlay,y,u,s,h);this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(c,d,l,m),this.ctx.strokeStyle="#00aaff",this.ctx.lineWidth=2,this.ctx.strokeRect(c,d,l,m);const g=Math.min(t.length,Math.ceil(a/o)),E=l/g;this.ctx.fillStyle="#00aaff";for(let v=0;v<g;v++){const T=t[v]/255*m*this.FFT_OVERLAY_HEIGHT_RATIO,b=c+v*E,C=d+m-T;this.ctx.fillRect(b,C,Math.max(E-1,this.FFT_MIN_BAR_WIDTH),T)}if(e>0&&e<=a){const v=e/o,w=c+v*E;this.ctx.strokeStyle="#ff00ff",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(w,d),this.ctx.lineTo(w,d+m),this.ctx.stroke(),this.ctx.fillStyle="#ff00ff",this.ctx.font="bold 12px Arial";const T=`${e.toFixed(1)} Hz`,b=this.ctx.measureText(T).width;let C=w+3;C+b>c+l-5&&(C=w-b-3),this.ctx.fillText(T,C,d+15)}this.ctx.restore()}drawHarmonicAnalysis(t,e,i,r,a,o,s){if(!this.debugOverlaysEnabled||!this.fftDisplayEnabled||t===void 0&&!e&&!i&&!o)return;const h=16,u=(1+(t!==void 0?1:0)+(e?1:0)+(i?1:0)+(o?2:0))*h+10,{x:c,y:d,width:l,height:m}=this.calculateOverlayDimensions(this.overlaysLayout.harmonicAnalysis,10,10,500,u);let g=d;if(this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillRect(c,d,l,m),this.ctx.strokeStyle="#ffaa00",this.ctx.lineWidth=2,this.ctx.strokeRect(c,d,l,m),this.ctx.fillStyle="#ffaa00",this.ctx.font="bold 12px monospace",g+=15,this.ctx.fillText("倍音分析 (Harmonic Analysis)",c+5,g),t!==void 0&&s){g+=h,this.ctx.fillStyle="#00ff00",this.ctx.font="11px monospace";const E=s/2;this.ctx.fillText(`1/2周波数 (${E.toFixed(1)}Hz) のpeak強度: ${t.toFixed(1)}%`,c+5,g)}if(e&&s){g+=h,this.ctx.fillStyle="#ff00ff",this.ctx.font="11px monospace";const E=e.map((w,T)=>`${T+1}x:${w.toFixed(2)}`).join(" "),v=r!==void 0?` (重み付け: ${r.toFixed(1)})`:"";this.ctx.fillText(`候補1 (${s.toFixed(1)}Hz) 倍音: ${E}${v}`,c+5,g)}if(i&&s){g+=h,this.ctx.fillStyle="#00aaff",this.ctx.font="11px monospace";const E=s/2,v=i.map((T,b)=>`${b+1}x:${T.toFixed(2)}`).join(" "),w=a!==void 0?` (重み付け: ${a.toFixed(1)})`:"";this.ctx.fillText(`候補2 (${E.toFixed(1)}Hz) 倍音: ${v}${w}`,c+5,g)}if(o){g+=h,this.ctx.fillStyle="#aaaaaa",this.ctx.font="10px monospace";const E=l-10,v=o.split(" ");let w="";for(const T of v){const b=w+(w?" ":"")+T;this.ctx.measureText(b).width>E&&w?(this.ctx.fillText(w,c+5,g),g+=h,w=T):w=b}w&&this.ctx.fillText(w,c+5,g)}this.ctx.restore()}drawFrequencyPlot(t,e,i){if(!this.debugOverlaysEnabled||!t||t.length===0)return;const{x:r,y:a,width:o,height:s}=this.calculateOverlayDimensions(this.overlaysLayout.frequencyPlot,this.canvas.width-280-10,10,280,120);this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(r,a,o,s),this.ctx.strokeStyle="#ffaa00",this.ctx.lineWidth=2,this.ctx.strokeRect(r,a,o,s),this.ctx.fillStyle="#ffaa00",this.ctx.font="bold 12px Arial",this.ctx.fillText(`周波数推移 (${t.length}frame)`,r+5,a+15);const h=r+35,y=a+25,u=o-45,c=s-45,d=t.filter(x=>x>0);if(d.length===0){this.ctx.restore();return}const l=Math.min(...d),m=Math.max(...d),g=(m-l)*this.FREQ_PLOT_RANGE_PADDING_RATIO||this.FREQ_PLOT_MIN_RANGE_PADDING_HZ,E=Math.max(e,l-g),v=Math.min(i,m+g);this.ctx.strokeStyle="#333333",this.ctx.lineWidth=1,this.ctx.beginPath();for(let x=0;x<=4;x++){const p=y+c/4*x;this.ctx.moveTo(h,p),this.ctx.lineTo(h+u,p)}for(let x=0;x<=4;x++){const p=h+u/4*x;this.ctx.moveTo(p,y),this.ctx.lineTo(p,y+c)}this.ctx.stroke(),this.ctx.fillStyle="#aaaaaa",this.ctx.font="10px monospace",this.ctx.textAlign="right",this.ctx.textBaseline="middle";for(let x=0;x<=4;x++){const p=v-(v-E)*(x/4),S=y+c/4*x,A=p>=1e3?`${(p/1e3).toFixed(1)}k`:`${p.toFixed(0)}`;this.ctx.fillText(A,h-5,S)}this.ctx.fillStyle="#88ccff",this.ctx.font="9px monospace",this.ctx.textAlign="right",this.ctx.textBaseline="middle";for(let x=0;x<=4;x++){const p=v-(v-E)*(x/4),S=y+c/4*x,A=R(p);if(A){const L=A.cents>=0?"+":"";this.ctx.fillText(`${L}${A.cents}¢`,h+u-5,S)}}this.ctx.strokeStyle="#00ff00",this.ctx.lineWidth=2,this.ctx.beginPath();const w=u/Math.max(t.length-1,1),T=Math.max(1,Math.floor(t.length/4)),b=x=>{const S=(Math.max(E,Math.min(v,x))-E)/(v-E);return y+c-S*c};let C=!1;for(let x=0;x<t.length;x++){const p=t[x],S=h+x*w;if(p===0){C=!1;continue}const A=b(p);C?this.ctx.lineTo(S,A):(this.ctx.moveTo(S,A),C=!0)}this.ctx.stroke(),this.ctx.font="9px monospace",this.ctx.textAlign="center",this.ctx.textBaseline="top";for(let x=0;x<t.length;x++){const p=t[x],S=h+x*w;if(p!==0){const I=b(p);this.ctx.fillStyle="#00ff00",this.ctx.beginPath(),this.ctx.arc(S,I,2,0,Math.PI*2),this.ctx.fill()}const A=x===t.length-1;if(x%T===0||A){this.ctx.fillStyle="#aaaaaa";const I=x-t.length+1;this.ctx.fillText(`${I}`,S,y+c+2)}}const _=t[t.length-1];if(_>0){const x=R(_);this.ctx.fillStyle="#00ff00",this.ctx.font="bold 11px Arial",this.ctx.textAlign="left",this.ctx.textBaseline="bottom";let p=`${_.toFixed(1)} Hz`;if(x){const S=x.cents>=0?"+":"";p+=` (${x.noteName} ${S}${x.cents}¢)`}this.ctx.fillText(p,h+2,y+c-2)}this.ctx.restore()}drawPhaseMarkers(t,e,i,r,a,o){if(a===void 0||o===void 0)return;const s=o-a;if(s<=0)return;this.ctx.save();const h=(y,u,c)=>{const d=y-a;if(d<0||d>=s)return;const l=d/s*this.canvas.width;this.ctx.strokeStyle=u,this.ctx.lineWidth=c,this.ctx.beginPath(),this.ctx.moveTo(l,0),this.ctx.lineTo(l,this.canvas.height),this.ctx.stroke()};i!==void 0&&h(i,"#ff8800",2),r!==void 0&&h(r,"#ff8800",2),t!==void 0&&h(t,"#ff0000",2),e!==void 0&&h(e,"#ff0000",2),this.ctx.restore()}setFFTDisplay(t){this.fftDisplayEnabled=t}getFFTDisplayEnabled(){return this.fftDisplayEnabled}setDebugOverlaysEnabled(t){this.debugOverlaysEnabled=t}getDebugOverlaysEnabled(){return this.debugOverlaysEnabled}setOverlaysLayout(t){this.overlaysLayout={...this.overlaysLayout,...t}}getOverlaysLayout(){return this.overlaysLayout}calculateOverlayDimensions(t,e,i,r,a){if(!t)return{x:e,y:i,width:r,height:a};let o=e,s=i,h=r,y=a;if(t.position.x!==void 0)if(typeof t.position.x=="string"&&t.position.x.startsWith("right-")){const u=parseInt(t.position.x.substring(6),10),c=typeof t.size.width=="string"&&t.size.width.endsWith("%")?F(t.size.width,this.canvas.width):typeof t.size.width=="number"?t.size.width:r;o=this.canvas.width-c-u}else o=F(t.position.x,this.canvas.width);return t.position.y!==void 0&&(s=F(t.position.y,this.canvas.height)),t.size.width!==void 0&&t.size.width!=="auto"&&(h=F(t.size.width,this.canvas.width)),t.size.height!==void 0&&t.size.height!=="auto"&&(y=F(t.size.height,this.canvas.height)),{x:o,y:s,width:h,height:y}}}class B{constructor(){n(this,"usePeakMode",!1)}setUsePeakMode(t){this.usePeakMode=t}getUsePeakMode(){return this.usePeakMode}reset(){}}class K{constructor(){n(this,"previousWaveform",null);n(this,"lastSimilarity",0)}getLastSimilarity(){return this.lastSimilarity}reset(){this.previousWaveform=null,this.lastSimilarity=0}hasPreviousWaveform(){return this.previousWaveform!==null}getPreviousWaveform(){return this.previousWaveform}}class Y{constructor(t,e,i,r){n(this,"previousCanvas");n(this,"currentCanvas");n(this,"similarityCanvas");n(this,"bufferCanvas");n(this,"previousCtx");n(this,"currentCtx");n(this,"similarityCtx");n(this,"bufferCtx");n(this,"TARGET_FILL_RATIO",.9);n(this,"MIN_PEAK_THRESHOLD",.001);n(this,"DEFAULT_AMPLITUDE_RATIO",.4);this.previousCanvas=t,this.currentCanvas=e,this.similarityCanvas=i,this.bufferCanvas=r;const a=t.getContext("2d"),o=e.getContext("2d"),s=i.getContext("2d"),h=r.getContext("2d");if(!a||!o||!s||!h)throw new Error("Could not get 2D context for comparison canvases");this.previousCtx=a,this.currentCtx=o,this.similarityCtx=s,this.bufferCtx=h,this.clearAllCanvases()}clearAllCanvases(){this.clearCanvas(this.previousCtx,this.previousCanvas.width,this.previousCanvas.height),this.clearCanvas(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height),this.clearCanvas(this.similarityCtx,this.similarityCanvas.width,this.similarityCanvas.height),this.clearCanvas(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height)}clearCanvas(t,e,i){t.fillStyle="#000000",t.fillRect(0,0,e,i)}findPeakAmplitude(t,e,i){let r=0;const a=Math.max(0,e),o=Math.min(t.length,i);for(let s=a;s<o;s++){const h=Math.abs(t[s]);h>r&&(r=h)}return r}drawWaveform(t,e,i,r,a,o,s){const h=o-a;if(h<=0)return;const y=this.findPeakAmplitude(r,a,o);t.strokeStyle=s,t.lineWidth=1.5,t.beginPath();const u=e/h,c=i/2;let d;if(y>this.MIN_PEAK_THRESHOLD){const l=this.TARGET_FILL_RATIO/y;d=i/2*l}else d=i*this.DEFAULT_AMPLITUDE_RATIO;for(let l=0;l<h;l++){const m=a+l;if(m>=r.length)break;const g=r[m],E=c-g*d,v=Math.min(i,Math.max(0,E)),w=l*u;l===0?t.moveTo(w,v):t.lineTo(w,v)}t.stroke()}drawCenterLine(t,e,i){t.strokeStyle="#444444",t.lineWidth=1,t.beginPath(),t.moveTo(0,i/2),t.lineTo(e,i/2),t.stroke()}drawSimilarityText(t){this.currentCtx.fillStyle="#00aaff",this.currentCtx.font="bold 14px Arial";const e=`Similarity: ${t.toFixed(3)}`,i=this.currentCtx.measureText(e).width,r=(this.currentCanvas.width-i)/2;this.currentCtx.fillText(e,r,20)}drawSimilarityPlot(t){if(!t||t.length===0)return;const e=this.similarityCtx,i=this.similarityCanvas.width,r=this.similarityCanvas.height;e.save(),e.fillStyle="#000000",e.fillRect(0,0,i,r),e.strokeStyle="#00aaff",e.lineWidth=2,e.strokeRect(0,0,i,r),e.fillStyle="#00aaff",e.font="bold 12px Arial",e.fillText("類似度推移 (Similarity)",5,15);const a=40,o=25,s=i-50,h=r-35,y=-1,u=1;e.strokeStyle="#333333",e.lineWidth=1,e.beginPath();for(let l=0;l<=4;l++){const m=o+h/4*l;e.moveTo(a,m),e.lineTo(a+s,m)}for(let l=0;l<=4;l++){const m=a+s/4*l;e.moveTo(m,o),e.lineTo(m,o+h)}e.stroke(),e.fillStyle="#aaaaaa",e.font="10px monospace",e.textAlign="right",e.textBaseline="middle";for(let l=0;l<=4;l++){const m=u-(u-y)*(l/4),g=o+h/4*l,E=m.toFixed(2);e.fillText(E,a-5,g)}e.strokeStyle="#00aaff",e.lineWidth=2,e.beginPath();const c=s/Math.max(t.length-1,1);for(let l=0;l<t.length;l++){const m=t[l],g=a+l*c,v=(Math.max(y,Math.min(u,m))-y)/(u-y),w=o+h-v*h;l===0?e.moveTo(g,w):e.lineTo(g,w)}e.stroke();const d=t[t.length-1];e.fillStyle="#00aaff",e.font="bold 11px Arial",e.textAlign="left",e.textBaseline="bottom",e.fillText(`${d.toFixed(3)}`,a+2,o+h-2),e.restore()}drawPositionMarkers(t,e,i,r,a,o){if(o<=0)return;const s=r/o*e,h=a/o*e;t.strokeStyle="#ff0000",t.lineWidth=2,t.beginPath(),t.moveTo(s,0),t.lineTo(s,i),t.stroke(),t.beginPath(),t.moveTo(h,0),t.lineTo(h,i),t.stroke(),t.fillStyle="#ff0000",t.font="10px Arial",t.fillText("S",s+2,12),t.fillText("E",h+2,12)}updatePanels(t,e,i,r,a,o,s=[]){this.clearAllCanvases(),t&&(this.drawCenterLine(this.previousCtx,this.previousCanvas.width,this.previousCanvas.height),this.drawWaveform(this.previousCtx,this.previousCanvas.width,this.previousCanvas.height,t,0,t.length,"#ffaa00")),this.drawCenterLine(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height),r-i>0&&this.drawWaveform(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height,e,i,r,"#00ff00"),t&&this.drawSimilarityText(o),s.length>0&&this.drawSimilarityPlot(s),this.drawCenterLine(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height),this.drawWaveform(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height,a,0,a.length,"#888888"),this.drawPositionMarkers(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height,i,r,a.length)}clear(){this.clearAllCanvases()}}const P=class P{constructor(t,e,i,r){n(this,"audioManager");n(this,"gainController");n(this,"frequencyEstimator");n(this,"waveformSearcher");n(this,"wasmProcessor",null);n(this,"isInitialized",!1);n(this,"cachedBasePath",null);this.audioManager=t,this.gainController=e,this.frequencyEstimator=i,this.waveformSearcher=r}async initialize(){if(!this.isInitialized){if(typeof window>"u"||window.location.protocol==="file:")throw new Error("WASM module not available in test/non-browser environment");try{await this.loadWasmModule(),this.isInitialized=!0,this.syncConfigToWasm()}catch(t){throw console.error("Failed to initialize WASM module:",t),t}}}async loadWasmModule(){return new Promise((t,e)=>{if(window.wasmProcessor&&window.wasmProcessor.WasmDataProcessor){this.wasmProcessor=new window.wasmProcessor.WasmDataProcessor,t();return}const i=setTimeout(()=>{s(),e(new Error("WASM module loading timed out after 10 seconds"))},1e4),a=`${this.determineBasePath()}wasm/wasm_processor.js`,o=document.createElement("script");o.type="module",o.textContent=`
        import init, { WasmDataProcessor } from '${a}';
        await init();
        window.wasmProcessor = { WasmDataProcessor };
        window.dispatchEvent(new Event('wasmLoaded'));
      `;const s=()=>{clearTimeout(i),window.removeEventListener("wasmLoaded",h)},h=()=>{s(),window.wasmProcessor&&window.wasmProcessor.WasmDataProcessor?(this.wasmProcessor=new window.wasmProcessor.WasmDataProcessor,t()):e(new Error("WASM module loaded but WasmDataProcessor not found"))};window.addEventListener("wasmLoaded",h),o.onerror=()=>{s(),e(new Error("Failed to load WASM module script"))},document.head.appendChild(o)})}determineBasePath(){var e;if(this.cachedBasePath!==null)return this.cachedBasePath;let t=(e=document.querySelector("base"))==null?void 0:e.getAttribute("href");if(t)try{t=new URL(t,window.location.href).pathname}catch{}if(t||(t=this.getBasePathFromScripts()),!t&&window.location.pathname&&window.location.pathname!=="/"){const r=window.location.pathname.split("/").filter(a=>a.length>0);r.length>0&&(t=`/${r[0]}/`)}return t||(t="/"),t.endsWith("/")||(t+="/"),this.cachedBasePath=t,t}getBasePathFromScripts(){const t=document.querySelectorAll("script[src]");for(const e of t){const i=e.getAttribute("src");if(i)try{const a=new URL(i,window.location.href).pathname;for(const o of P.ASSET_PATTERNS){const s=a.indexOf(o);if(s>=0)return s===0?"/":a.substring(0,s)+"/"}}catch(r){(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&console.debug("Failed to parse script URL:",i,r);continue}}return""}syncConfigToWasm(){this.wasmProcessor&&(this.wasmProcessor.setAutoGain(this.gainController.getAutoGainEnabled()),this.wasmProcessor.setNoiseGate(this.gainController.getNoiseGateEnabled()),this.wasmProcessor.setNoiseGateThreshold(this.gainController.getNoiseGateThreshold()),this.wasmProcessor.setFrequencyEstimationMethod(this.frequencyEstimator.getFrequencyEstimationMethod()),this.wasmProcessor.setBufferSizeMultiplier(this.frequencyEstimator.getBufferSizeMultiplier()))}syncResultsFromWasm(t){this.frequencyEstimator.estimatedFrequency=t.estimatedFrequency,this.gainController.currentGain=t.gain,t.previousWaveform&&(this.waveformSearcher.previousWaveform=t.previousWaveform),this.waveformSearcher.lastSimilarity=t.similarity}processFrame(t){if(!this.isInitialized||!this.wasmProcessor)return console.warn("WASM processor not initialized"),null;if(!this.audioManager.isReady())return null;const e=this.audioManager.getTimeDomainData();if(!e)return null;const i=this.audioManager.getSampleRate(),r=this.audioManager.getFFTSize(),o=this.frequencyEstimator.getFrequencyEstimationMethod()==="fft"||t?this.audioManager.getFrequencyData():null;this.syncConfigToWasm();const s=this.wasmProcessor.processFrame(e,o,i,r,t);if(!s)return null;const h={waveformData:new Float32Array(s.waveform_data),displayStartIndex:s.displayStartIndex,displayEndIndex:s.displayEndIndex,gain:s.gain,estimatedFrequency:s.estimatedFrequency,frequencyPlotHistory:s.frequencyPlotHistory?Array.from(s.frequencyPlotHistory):[],sampleRate:s.sampleRate,fftSize:s.fftSize,frequencyData:s.frequencyData?new Uint8Array(s.frequencyData):void 0,isSignalAboveNoiseGate:s.isSignalAboveNoiseGate,maxFrequency:s.maxFrequency,previousWaveform:s.previousWaveform?new Float32Array(s.previousWaveform):null,similarity:s.similarity,similarityPlotHistory:s.similarityPlotHistory?Array.from(s.similarityPlotHistory):[],usedSimilaritySearch:s.usedSimilaritySearch,phaseZeroIndex:s.phaseZeroIndex,phaseTwoPiIndex:s.phaseTwoPiIndex,phaseMinusQuarterPiIndex:s.phaseMinusQuarterPiIndex,phaseTwoPiPlusQuarterPiIndex:s.phaseTwoPiPlusQuarterPiIndex,halfFreqPeakStrengthPercent:s.halfFreqPeakStrengthPercent,candidate1Harmonics:s.candidate1Harmonics?Array.from(s.candidate1Harmonics):void 0,candidate2Harmonics:s.candidate2Harmonics?Array.from(s.candidate2Harmonics):void 0,selectionReason:s.selectionReason};return this.syncResultsFromWasm(h),h}reset(){this.wasmProcessor&&this.wasmProcessor.reset()}};n(P,"ASSET_PATTERNS",["/assets/","/js/","/dist/"]);let M=P;class Q{constructor(t,e,i,r,a,o){n(this,"audioManager");n(this,"gainController");n(this,"frequencyEstimator");n(this,"renderer");n(this,"zeroCrossDetector");n(this,"waveformSearcher");n(this,"comparisonRenderer");n(this,"dataProcessor");n(this,"animationId",null);n(this,"isRunning",!1);n(this,"isPaused",!1);n(this,"lastFrameTime",0);n(this,"frameProcessingTimes",[]);n(this,"MAX_FRAME_TIMES",100);n(this,"TARGET_FRAME_TIME",16.67);n(this,"FPS_LOG_INTERVAL_FRAMES",60);this.audioManager=new D,this.gainController=new G,this.frequencyEstimator=new N,this.renderer=new q(t,o),this.zeroCrossDetector=new B,this.waveformSearcher=new K,this.comparisonRenderer=new Y(e,i,r,a),this.dataProcessor=new M(this.audioManager,this.gainController,this.frequencyEstimator,this.waveformSearcher)}async start(){try{await this.dataProcessor.initialize(),await this.audioManager.start(),this.isRunning=!0,this.render()}catch(t){throw console.error("Error starting oscilloscope:",t),t}}async startFromFile(t){try{await this.dataProcessor.initialize(),await this.audioManager.startFromFile(t),this.isRunning=!0,this.render()}catch(e){throw console.error("Error loading audio file:",e),e}}async startFromBuffer(t){try{await this.dataProcessor.initialize(),await this.audioManager.startFromBuffer(t),this.isRunning=!0,this.render()}catch(e){throw console.error("Error starting from buffer:",e),e}}async stop(){this.isRunning=!1,this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null),await this.audioManager.stop(),this.frequencyEstimator.clearHistory(),this.zeroCrossDetector.reset(),this.waveformSearcher.reset(),this.comparisonRenderer.clear(),this.dataProcessor.reset()}render(){if(!this.isRunning)return;const t=performance.now();if(!this.isPaused){const r=this.dataProcessor.processFrame(this.renderer.getFFTDisplayEnabled());r&&this.renderFrame(r)}const i=performance.now()-t;if(this.frameProcessingTimes.push(i),this.frameProcessingTimes.length>this.MAX_FRAME_TIMES&&this.frameProcessingTimes.shift(),i>this.TARGET_FRAME_TIME&&console.warn(`Frame processing time: ${i.toFixed(2)}ms (target: <${this.TARGET_FRAME_TIME}ms)`),this.lastFrameTime>0){const a=1e3/(t-this.lastFrameTime);if(this.frameProcessingTimes.length===this.FPS_LOG_INTERVAL_FRAMES){const o=this.frameProcessingTimes.reduce((s,h)=>s+h,0)/this.frameProcessingTimes.length;console.log(`FPS: ${a.toFixed(1)}, Avg frame time: ${o.toFixed(2)}ms`)}}this.lastFrameTime=t,this.animationId=requestAnimationFrame(()=>this.render())}renderFrame(t){const e=t.displayEndIndex-t.displayStartIndex;this.renderer.clearAndDrawGrid(t.sampleRate,e,t.gain),this.renderer.drawWaveform(t.waveformData,t.displayStartIndex,t.displayEndIndex,t.gain),this.renderer.drawPhaseMarkers(t.phaseZeroIndex,t.phaseTwoPiIndex,t.phaseMinusQuarterPiIndex,t.phaseTwoPiPlusQuarterPiIndex,t.displayStartIndex,t.displayEndIndex),t.frequencyData&&this.renderer.getFFTDisplayEnabled()&&t.isSignalAboveNoiseGate&&(this.renderer.drawFFTOverlay(t.frequencyData,t.estimatedFrequency,t.sampleRate,t.fftSize,t.maxFrequency),this.renderer.drawHarmonicAnalysis(t.halfFreqPeakStrengthPercent,t.candidate1Harmonics,t.candidate2Harmonics,t.candidate1WeightedScore,t.candidate2WeightedScore,t.selectionReason,t.estimatedFrequency)),this.renderer.drawFrequencyPlot(t.frequencyPlotHistory,this.frequencyEstimator.getMinFrequency(),this.frequencyEstimator.getMaxFrequency()),this.comparisonRenderer.updatePanels(t.previousWaveform,t.waveformData,t.displayStartIndex,t.displayEndIndex,t.waveformData,t.similarity,t.similarityPlotHistory)}getIsRunning(){return this.isRunning}setAutoGain(t){this.gainController.setAutoGain(t)}getAutoGainEnabled(){return this.gainController.getAutoGainEnabled()}setNoiseGate(t){this.gainController.setNoiseGate(t)}getNoiseGateEnabled(){return this.gainController.getNoiseGateEnabled()}setNoiseGateThreshold(t){this.gainController.setNoiseGateThreshold(t)}getNoiseGateThreshold(){return this.gainController.getNoiseGateThreshold()}setFrequencyEstimationMethod(t){this.frequencyEstimator.setFrequencyEstimationMethod(t)}getFrequencyEstimationMethod(){return this.frequencyEstimator.getFrequencyEstimationMethod()}setBufferSizeMultiplier(t){this.frequencyEstimator.setBufferSizeMultiplier(t)}getBufferSizeMultiplier(){return this.frequencyEstimator.getBufferSizeMultiplier()}getEstimatedFrequency(){return this.frequencyEstimator.getEstimatedFrequency()}setFFTDisplay(t){this.renderer.setFFTDisplay(t)}getFFTDisplayEnabled(){return this.renderer.getFFTDisplayEnabled()}setDebugOverlaysEnabled(t){this.renderer.setDebugOverlaysEnabled(t)}getDebugOverlaysEnabled(){return this.renderer.getDebugOverlaysEnabled()}setOverlaysLayout(t){this.renderer.setOverlaysLayout(t)}getOverlaysLayout(){return this.renderer.getOverlaysLayout()}getCurrentGain(){return this.gainController.getCurrentGain()}getSimilarityScore(){return this.waveformSearcher.getLastSimilarity()}isSimilaritySearchActive(){return this.waveformSearcher.hasPreviousWaveform()}setUsePeakMode(t){this.zeroCrossDetector.setUsePeakMode(t)}getUsePeakMode(){return this.zeroCrossDetector.getUsePeakMode()}setPauseDrawing(t){this.isPaused=t}getPauseDrawing(){return this.isPaused}}class V{constructor(t){n(this,"canvas");n(this,"ctx");n(this,"MIN_FREQ",50);n(this,"MAX_FREQ",2e3);n(this,"WHITE_KEY_WIDTH",20);n(this,"WHITE_KEY_HEIGHT",60);n(this,"BLACK_KEY_WIDTH",12);n(this,"BLACK_KEY_HEIGHT",38);n(this,"WHITE_KEY_COLOR","#ffffff");n(this,"BLACK_KEY_COLOR","#000000");n(this,"WHITE_KEY_HIGHLIGHT","#00ff00");n(this,"BLACK_KEY_HIGHLIGHT","#00cc00");n(this,"KEY_BORDER","#333333");n(this,"WHITE_KEY_NOTES",[0,2,4,5,7,9,11]);n(this,"BLACK_KEY_NOTES",[1,3,6,8,10]);n(this,"keyboardRange");n(this,"xOffset");n(this,"whiteKeyCount");this.canvas=t;const e=t.getContext("2d");if(!e)throw new Error("Could not get 2D context for piano keyboard");this.ctx=e,this.keyboardRange=this.calculateKeyboardRange(),this.whiteKeyCount=this.countWhiteKeys(),this.xOffset=this.calculateCenteringOffset()}frequencyToNoteInfo(t){const e=R(t);if(!e)return{note:-1,octave:-1,noteInOctave:-1};const i=e.noteName.match(/^([A-G]#?)(\d+)$/);if(!i)return{note:-1,octave:-1,noteInOctave:-1};const r=i[1],a=parseInt(i[2],10),s=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"].indexOf(r);return{note:a*12+s,octave:a,noteInOctave:s}}calculateKeyboardRange(){const t=this.frequencyToNoteInfo(this.MIN_FREQ),e=this.frequencyToNoteInfo(this.MAX_FREQ);return{startNote:t.note,endNote:e.note}}countWhiteKeys(){const t=this.keyboardRange;let e=0;for(let i=t.startNote;i<=t.endNote;i++){const r=(i%12+12)%12;this.WHITE_KEY_NOTES.includes(r)&&e++}return e}calculateCenteringOffset(){const t=this.whiteKeyCount*this.WHITE_KEY_WIDTH;return(this.canvas.width-t)/2}render(t){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);const e=this.keyboardRange,i=t>0?this.frequencyToNoteInfo(t):null;let r=0;for(let h=e.startNote;h<=e.endNote;h++){const y=(h%12+12)%12;if(this.WHITE_KEY_NOTES.includes(y)){const u=this.xOffset+r*this.WHITE_KEY_WIDTH,c=i&&i.note===h;this.ctx.fillStyle=c?this.WHITE_KEY_HIGHLIGHT:this.WHITE_KEY_COLOR,this.ctx.fillRect(u,0,this.WHITE_KEY_WIDTH,this.WHITE_KEY_HEIGHT),this.ctx.strokeStyle=this.KEY_BORDER,this.ctx.lineWidth=1,this.ctx.strokeRect(u,0,this.WHITE_KEY_WIDTH,this.WHITE_KEY_HEIGHT),r++}}r=0;for(let h=e.startNote;h<=e.endNote;h++){const y=(h%12+12)%12;if(this.WHITE_KEY_NOTES.includes(y)&&r++,this.BLACK_KEY_NOTES.includes(y)){const u=this.xOffset+r*this.WHITE_KEY_WIDTH-this.BLACK_KEY_WIDTH/2,c=i&&i.note===h;this.ctx.fillStyle=c?this.BLACK_KEY_HIGHLIGHT:this.BLACK_KEY_COLOR,this.ctx.fillRect(u,0,this.BLACK_KEY_WIDTH,this.BLACK_KEY_HEIGHT),this.ctx.strokeStyle=this.KEY_BORDER,this.ctx.lineWidth=1,this.ctx.strokeRect(u,0,this.BLACK_KEY_WIDTH,this.BLACK_KEY_HEIGHT)}}this.ctx.fillStyle="#888888",this.ctx.font="10px monospace",this.ctx.fillText(`${this.MIN_FREQ}Hz`,this.xOffset+5,this.WHITE_KEY_HEIGHT-5);const a=`${this.MAX_FREQ}Hz`,o=this.ctx.measureText(a).width,s=this.xOffset+this.whiteKeyCount*this.WHITE_KEY_WIDTH;this.ctx.fillText(a,s-o-5,this.WHITE_KEY_HEIGHT-5)}clear(){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}}class W{constructor(t,e,i){n(this,"buffer");n(this,"sampleRate");n(this,"position",0);n(this,"chunkSize",4096);n(this,"isLooping",!1);if(e<=0||!isFinite(e))throw new Error("Sample rate must be a positive finite number");if(this.buffer=t,this.sampleRate=e,(i==null?void 0:i.chunkSize)!==void 0){if(i.chunkSize<=0||!isFinite(i.chunkSize)||!Number.isInteger(i.chunkSize))throw new Error("Chunk size must be a positive integer");this.chunkSize=i.chunkSize}(i==null?void 0:i.loop)!==void 0&&(this.isLooping=i.loop)}static fromAudioBuffer(t,e){const i=(e==null?void 0:e.channel)??0;if(i<0||i>=t.numberOfChannels)throw new Error(`Invalid channel index ${i}. AudioBuffer has ${t.numberOfChannels} channel(s).`);const r=t.getChannelData(i);return new W(r,t.sampleRate,{chunkSize:e==null?void 0:e.chunkSize,loop:e==null?void 0:e.loop})}getNextChunk(){if(this.buffer.length===0)return null;if(this.position>=this.buffer.length)if(this.isLooping)this.position=0;else return null;const t=Math.min(this.position+this.chunkSize,this.buffer.length),e=this.buffer.slice(this.position,t);if(e.length<this.chunkSize&&this.isLooping){const i=this.chunkSize-e.length,r=Math.min(i,this.buffer.length),a=new Float32Array(this.chunkSize);return a.set(e,0),a.set(this.buffer.slice(0,r),e.length),this.position=r,a}if(this.position=t,e.length<this.chunkSize){const i=new Float32Array(this.chunkSize);return i.set(e,0),i}return e}reset(){this.position=0}seek(t){this.position=Math.max(0,Math.min(t,this.buffer.length))}getPosition(){return this.position}getLength(){return this.buffer.length}getSampleRate(){return this.sampleRate}setChunkSize(t){if(t<=0||!isFinite(t)||!Number.isInteger(t))throw new Error("Chunk size must be a positive integer");this.chunkSize=t}getChunkSize(){return this.chunkSize}setLooping(t){this.isLooping=t}isLoop(){return this.isLooping}isAtEnd(){return this.position>=this.buffer.length&&!this.isLooping}}exports.AudioManager=D;exports.BufferSource=W;exports.ComparisonPanelRenderer=Y;exports.DEFAULT_OVERLAYS_LAYOUT=z;exports.FrequencyEstimator=N;exports.GainController=G;exports.Oscilloscope=Q;exports.PianoKeyboardRenderer=V;exports.WaveformDataProcessor=M;exports.WaveformRenderer=q;exports.WaveformSearcher=K;exports.ZeroCrossDetector=B;exports.amplitudeToDb=k;exports.dbToAmplitude=H;exports.resolveValue=F;exports.trimSilence=O;
//# sourceMappingURL=cat-oscilloscope.cjs.map
