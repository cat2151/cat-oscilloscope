"use strict";var V=Object.defineProperty;var j=(u,t,e)=>t in u?V(u,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):u[t]=e;var s=(u,t,e)=>j(u,typeof t!="symbol"?t+"":t,e);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});function D(u){return Math.pow(10,u/20)}function z(u){return u<=0?-1/0:20*Math.log10(u)}function I(u){if(u<=0||!isFinite(u))return null;const e=440*Math.pow(2,-4.75),i=12*Math.log2(u/e),r=Math.round(i),o=Math.round((i-r)*100),h=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],n=Math.floor(r/12);return{noteName:`${h[(r%12+12)%12]}${n}`,cents:o}}const J=-48;function G(u){const t=u.numberOfChannels,e=u.sampleRate,i=u.length,r=[];let o=0;for(let f=0;f<t;f++){const y=u.getChannelData(f);r.push(y);for(let l=0;l<i;l++){const d=Math.abs(y[l]);d>o&&(o=d)}}if(o===0)return u;const h=o*Math.pow(10,J/20);let n=i;for(let f=0;f<i;f++){let y=!0;for(let l=0;l<t;l++)if(Math.abs(r[l][f])>h){y=!1;break}if(!y){n=f;break}}if(n>=i)return u;let a=i-1;for(let f=i-1;f>=n;f--){let y=!0;for(let l=0;l<t;l++)if(Math.abs(r[l][f])>h){y=!1;break}if(!y){a=f;break}}if(n===0&&a===i-1)return u;const g=a-n+1,c=new AudioBuffer({numberOfChannels:t,length:g,sampleRate:e});for(let f=0;f<t;f++){const y=r[f],l=c.getChannelData(f);for(let d=0;d<g;d++)l[d]=y[n+d]}return c}class N{constructor(){s(this,"audioContext",null);s(this,"analyser",null);s(this,"mediaStream",null);s(this,"audioBufferSource",null);s(this,"bufferSource",null);s(this,"dataArray",null);s(this,"frequencyData",null);s(this,"frameBufferHistory",[]);s(this,"MAX_FRAME_HISTORY",16)}initializeAnalyser(){if(!this.audioContext)throw new Error("AudioContext must be initialized before creating analyser");this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=4096,this.analyser.smoothingTimeConstant=0;const t=this.analyser.fftSize;this.dataArray=new Float32Array(t),this.frequencyData=new Uint8Array(this.analyser.frequencyBinCount)}async start(){try{this.mediaStream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.audioContext=new AudioContext;const t=this.audioContext.createMediaStreamSource(this.mediaStream);this.initializeAnalyser(),t.connect(this.analyser)}catch(t){throw console.error("Error accessing microphone:",t),t}}async startFromFile(t){try{const e=await t.arrayBuffer();this.audioContext&&this.audioContext.state!=="closed"&&await this.audioContext.close(),this.audioContext=new AudioContext;let i=await this.audioContext.decodeAudioData(e);i=G(i),this.initializeAnalyser(),this.audioBufferSource=this.audioContext.createBufferSource(),this.audioBufferSource.buffer=i,this.audioBufferSource.loop=!0,this.audioBufferSource.connect(this.analyser),this.analyser.connect(this.audioContext.destination),this.audioBufferSource.start(0)}catch(e){throw console.error("Error loading audio file:",e),e}}async startFromBuffer(t){try{this.audioContext&&this.audioContext.state!=="closed"&&await this.audioContext.close(),this.audioContext=null,this.bufferSource=t,this.bufferSource.setChunkSize(4096),this.dataArray=new Float32Array(4096),this.frequencyData=new Uint8Array(2048)}catch(e){throw console.error("Error starting from buffer:",e),e}}async stop(){if(this.audioBufferSource){try{this.audioBufferSource.stop()}catch{}try{this.audioBufferSource.disconnect()}catch{}this.audioBufferSource=null}if(this.mediaStream&&(this.mediaStream.getTracks().forEach(t=>t.stop()),this.mediaStream=null),this.bufferSource&&(this.bufferSource.reset(),this.bufferSource=null),this.audioContext){try{await this.audioContext.close()}catch(t){console.error("Error closing AudioContext:",t)}this.audioContext=null}this.analyser=null,this.dataArray=null,this.frequencyData=null,this.clearFrameBufferHistory()}getTimeDomainData(){if(this.bufferSource&&this.dataArray){const t=this.bufferSource.getNextChunk();return t?(this.dataArray.set(t),this.updateFrameBufferHistory(this.dataArray),this.dataArray):null}return!this.analyser||!this.dataArray?null:(this.analyser.getFloatTimeDomainData(this.dataArray),this.updateFrameBufferHistory(this.dataArray),this.dataArray)}updateFrameBufferHistory(t){let e;this.frameBufferHistory.length<this.MAX_FRAME_HISTORY?e=new Float32Array(t.length):(e=this.frameBufferHistory.shift(),e.length!==t.length&&(e=new Float32Array(t.length))),e.set(t),this.frameBufferHistory.push(e)}getExtendedTimeDomainData(t){if(t===1)return this.dataArray;if(!this.dataArray||this.frameBufferHistory.length<t)return null;const e=this.frameBufferHistory.slice(-t),i=e.reduce((h,n)=>h+n.length,0),r=new Float32Array(i);let o=0;for(const h of e)r.set(h,o),o+=h.length;return r}clearFrameBufferHistory(){this.frameBufferHistory=[]}getFrequencyData(){return this.bufferSource&&this.dataArray&&this.frequencyData||!this.analyser||!this.frequencyData?null:(this.analyser.getByteFrequencyData(this.frequencyData),this.frequencyData)}getSampleRate(){var t;return this.bufferSource?this.bufferSource.getSampleRate():((t=this.audioContext)==null?void 0:t.sampleRate)||0}getFFTSize(){var t;return this.bufferSource?4096:((t=this.analyser)==null?void 0:t.fftSize)||0}getFrequencyBinCount(){var t;return this.bufferSource?2048:((t=this.analyser)==null?void 0:t.frequencyBinCount)||0}isReady(){return this.bufferSource?this.dataArray!==null:this.audioContext!==null&&this.analyser!==null}}class q{constructor(){s(this,"autoGainEnabled",!0);s(this,"currentGain",1);s(this,"noiseGateEnabled",!0);s(this,"noiseGateThreshold",D(-60))}setAutoGain(t){this.autoGainEnabled=t}getAutoGainEnabled(){return this.autoGainEnabled}setNoiseGate(t){this.noiseGateEnabled=t}getNoiseGateEnabled(){return this.noiseGateEnabled}setNoiseGateThreshold(t){this.noiseGateThreshold=Math.min(Math.max(t,0),1)}getNoiseGateThreshold(){return this.noiseGateThreshold}getCurrentGain(){return this.currentGain}}class B{constructor(){s(this,"frequencyEstimationMethod","fft");s(this,"estimatedFrequency",0);s(this,"MIN_FREQUENCY_HZ",20);s(this,"MAX_FREQUENCY_HZ",5e3);s(this,"bufferSizeMultiplier",16);s(this,"frequencyPlotHistory",[])}clearHistory(){this.frequencyPlotHistory=[],this.estimatedFrequency=0}setFrequencyEstimationMethod(t){this.frequencyEstimationMethod!==t&&(this.frequencyEstimationMethod=t,this.frequencyPlotHistory=[])}getFrequencyEstimationMethod(){return this.frequencyEstimationMethod}setBufferSizeMultiplier(t){this.bufferSizeMultiplier=t}getBufferSizeMultiplier(){return this.bufferSizeMultiplier}getEstimatedFrequency(){return this.estimatedFrequency}getMinFrequency(){return this.MIN_FREQUENCY_HZ}getMaxFrequency(){return this.MAX_FREQUENCY_HZ}getFrequencyPlotHistory(){return this.frequencyPlotHistory}}function R(u,t){if(typeof u=="string"&&u.endsWith("%")){const e=parseFloat(u);return isNaN(e)?(console.warn(`Invalid percentage value: ${u}, using 0`),0):e<0?(console.warn(`Negative percentage value: ${u}, clamping to 0`),0):Math.floor(t*(e/100))}if(typeof u=="string"){const e=parseInt(u,10);return isNaN(e)?(console.warn(`Invalid numeric string: ${u}, using 0`),0):Math.max(0,e)}return typeof u=="number"?isNaN(u)?(console.warn(`Invalid number value: ${u}, using 0`),0):Math.max(0,Math.floor(u)):0}const K={fftOverlay:{position:{x:10,y:"65%"},size:{width:"35%",height:"35%"}},harmonicAnalysis:{position:{x:10,y:10},size:{width:500,height:"auto"}},frequencyPlot:{position:{x:"right-10",y:10},size:{width:280,height:120}}};class L{constructor(t,e,i){s(this,"ctx");s(this,"canvasWidth");s(this,"canvasHeight");this.ctx=t,this.canvasWidth=e,this.canvasHeight=i}updateDimensions(t,e){this.canvasWidth=t,this.canvasHeight=e}calculateOverlayDimensions(t,e,i,r,o){if(!t)return{x:e,y:i,width:r,height:o};let h=e,n=i,a=r,g=o;if(t.position.x!==void 0)if(typeof t.position.x=="string"&&t.position.x.startsWith("right-")){const c=parseInt(t.position.x.substring(6),10),f=typeof t.size.width=="string"&&t.size.width.endsWith("%")?R(t.size.width,this.canvasWidth):typeof t.size.width=="number"?t.size.width:r;h=this.canvasWidth-f-c}else h=R(t.position.x,this.canvasWidth);return t.position.y!==void 0&&(n=R(t.position.y,this.canvasHeight)),t.size.width!==void 0&&t.size.width!=="auto"&&(a=R(t.size.width,this.canvasWidth)),t.size.height!==void 0&&t.size.height!=="auto"&&(g=R(t.size.height,this.canvasHeight)),{x:h,y:n,width:a,height:g}}}class tt{constructor(t,e,i){s(this,"ctx");s(this,"canvasWidth");s(this,"canvasHeight");this.ctx=t,this.canvasWidth=e,this.canvasHeight=i}updateDimensions(t,e){this.canvasWidth=t,this.canvasHeight=e}drawGrid(t,e,i){this.ctx.strokeStyle="#222222",this.ctx.lineWidth=1,this.ctx.beginPath();const r=5;for(let h=0;h<=r;h++){const n=this.canvasHeight/r*h;this.ctx.moveTo(0,n),this.ctx.lineTo(this.canvasWidth,n)}const o=10;for(let h=0;h<=o;h++){const n=this.canvasWidth/o*h;this.ctx.moveTo(n,0),this.ctx.lineTo(n,this.canvasHeight)}this.ctx.stroke(),this.ctx.strokeStyle="#444444",this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.moveTo(0,this.canvasHeight/2),this.ctx.lineTo(this.canvasWidth,this.canvasHeight/2),this.ctx.stroke(),t&&t>0&&e&&e>0&&i!==void 0&&i>0&&this.drawGridLabels(t,e,i)}drawGridLabels(t,e,i){this.ctx.save(),this.ctx.font="11px monospace",this.ctx.fillStyle="#666666";const r=e/t*1e3,o=10,h=r/o;for(let c=0;c<=o;c++){const f=this.canvasWidth/o*c,y=h*c;let l;y>=1e3?l=`${(y/1e3).toFixed(2)}s`:y>=1?l=`${y.toFixed(1)}ms`:l=`${(y*1e3).toFixed(0)}μs`;const d=this.ctx.measureText(l).width,w=Math.max(2,Math.min(f-d/2,this.canvasWidth-d-2));this.ctx.fillText(l,w,this.canvasHeight-3)}const n=5,g=1/(n/2*i);for(let c=0;c<=n;c++){const f=this.canvasHeight/n*c,l=(n/2-c)*g;let d;if(l===0)d="0dB*";else{const w=z(Math.abs(l)),m=l>0?"+":"-",x=Math.abs(w);x>=100?d=`${m}${x.toFixed(0)}dB`:d=`${m}${x.toFixed(1)}dB`}this.ctx.fillText(d,3,f+10)}this.ctx.restore()}}class et{constructor(t,e,i){s(this,"ctx");s(this,"canvasWidth");s(this,"canvasHeight");this.ctx=t,this.canvasWidth=e,this.canvasHeight=i}updateDimensions(t,e){this.canvasWidth=t,this.canvasHeight=e}drawWaveform(t,e,i,r){const o=i-e;if(o<=0)return;this.ctx.strokeStyle="#00ff00",this.ctx.lineWidth=2,this.ctx.beginPath();const h=this.canvasWidth/o,n=this.canvasHeight/2,g=this.canvasHeight/2*r;for(let c=0;c<o;c++){const f=e+c,y=t[f],l=n-y*g,d=Math.min(this.canvasHeight,Math.max(0,l)),w=c*h;c===0?this.ctx.moveTo(w,d):this.ctx.lineTo(w,d)}this.ctx.stroke()}}class it extends L{constructor(){super(...arguments);s(this,"FFT_OVERLAY_HEIGHT_RATIO",.9);s(this,"FFT_MIN_BAR_WIDTH",1)}drawFFTOverlay(e,i,r,o,h,n){const a=r/o,g=Math.floor(this.canvasWidth*.35),c=Math.floor(this.canvasHeight*.35),f=10,y=this.canvasHeight-c-10,{x:l,y:d,width:w,height:m}=this.calculateOverlayDimensions(n,f,y,g,c);this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(l,d,w,m),this.ctx.strokeStyle="#00aaff",this.ctx.lineWidth=2,this.ctx.strokeRect(l,d,w,m);const x=Math.min(e.length,Math.ceil(h/a)),S=w/x;this.ctx.fillStyle="#00aaff";for(let p=0;p<x;p++){const C=e[p]/255*m*this.FFT_OVERLAY_HEIGHT_RATIO,A=l+p*S,b=d+m-C;this.ctx.fillRect(A,b,Math.max(S-1,this.FFT_MIN_BAR_WIDTH),C)}if(i>0&&i<=h){const p=i/a,T=l+p*S;this.ctx.strokeStyle="#ff00ff",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(T,d),this.ctx.lineTo(T,d+m),this.ctx.stroke(),this.ctx.fillStyle="#ff00ff",this.ctx.font="bold 12px Arial";const C=`${i.toFixed(1)} Hz`,A=this.ctx.measureText(C).width;let b=T+3;b+A>l+w-5&&(b=T-A-3),this.ctx.fillText(C,b,d+15)}this.ctx.restore()}}class st extends L{drawHarmonicAnalysis(t,e,i,r,o,h,n,a){if(t===void 0&&!e&&!i&&!h)return;const g=16,f=(1+(t!==void 0?1:0)+(e?1:0)+(i?1:0)+(h?2:0))*g+10,{x:y,y:l,width:d,height:w}=this.calculateOverlayDimensions(a,10,10,500,f);let m=l;if(this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillRect(y,l,d,w),this.ctx.strokeStyle="#ffaa00",this.ctx.lineWidth=2,this.ctx.strokeRect(y,l,d,w),this.ctx.fillStyle="#ffaa00",this.ctx.font="bold 12px monospace",m+=15,this.ctx.fillText("倍音分析 (Harmonic Analysis)",y+5,m),t!==void 0&&n){m+=g,this.ctx.fillStyle="#00ff00",this.ctx.font="11px monospace";const x=n/2;this.ctx.fillText(`1/2周波数 (${x.toFixed(1)}Hz) のpeak強度: ${t.toFixed(1)}%`,y+5,m)}if(e&&n){m+=g,this.ctx.fillStyle="#ff00ff",this.ctx.font="11px monospace";const x=e.map((p,T)=>`${T+1}x:${p.toFixed(2)}`).join(" "),S=r!==void 0?` (重み付け: ${r.toFixed(1)})`:"";this.ctx.fillText(`候補1 (${n.toFixed(1)}Hz) 倍音: ${x}${S}`,y+5,m)}if(i&&n){m+=g,this.ctx.fillStyle="#00aaff",this.ctx.font="11px monospace";const x=n/2,S=i.map((T,C)=>`${C+1}x:${T.toFixed(2)}`).join(" "),p=o!==void 0?` (重み付け: ${o.toFixed(1)})`:"";this.ctx.fillText(`候補2 (${x.toFixed(1)}Hz) 倍音: ${S}${p}`,y+5,m)}if(h){m+=g,this.ctx.fillStyle="#aaaaaa",this.ctx.font="10px monospace";const x=d-10,S=h.split(" ");let p="";for(const T of S){const C=p+(p?" ":"")+T;this.ctx.measureText(C).width>x&&p?(this.ctx.fillText(p,y+5,m),m+=g,p=T):p=C}p&&this.ctx.fillText(p,y+5,m)}this.ctx.restore()}}class rt extends L{constructor(){super(...arguments);s(this,"FREQ_PLOT_MIN_RANGE_PADDING_HZ",50);s(this,"FREQ_PLOT_RANGE_PADDING_RATIO",.1)}drawFrequencyPlot(e,i,r,o){if(!e||e.length===0)return;const{x:h,y:n,width:a,height:g}=this.calculateOverlayDimensions(o,this.canvasWidth-280-10,10,280,120);this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(h,n,a,g),this.ctx.strokeStyle="#ffaa00",this.ctx.lineWidth=2,this.ctx.strokeRect(h,n,a,g),this.ctx.fillStyle="#ffaa00",this.ctx.font="bold 12px Arial",this.ctx.fillText(`周波数推移 (${e.length}frame)`,h+5,n+15);const c=h+35,f=n+25,y=a-45,l=g-45,d=e.filter(v=>v>0);if(d.length===0){this.ctx.restore();return}const w=Math.min(...d),m=Math.max(...d),x=(m-w)*this.FREQ_PLOT_RANGE_PADDING_RATIO||this.FREQ_PLOT_MIN_RANGE_PADDING_HZ,S=Math.max(i,w-x),p=Math.min(r,m+x);this.ctx.strokeStyle="#333333",this.ctx.lineWidth=1,this.ctx.beginPath();for(let v=0;v<=4;v++){const E=f+l/4*v;this.ctx.moveTo(c,E),this.ctx.lineTo(c+y,E)}for(let v=0;v<=4;v++){const E=c+y/4*v;this.ctx.moveTo(E,f),this.ctx.lineTo(E,f+l)}this.ctx.stroke(),this.ctx.fillStyle="#aaaaaa",this.ctx.font="10px monospace",this.ctx.textAlign="right",this.ctx.textBaseline="middle";for(let v=0;v<=4;v++){const E=p-(p-S)*(v/4),M=f+l/4*v,F=E>=1e3?`${(E/1e3).toFixed(1)}k`:`${E.toFixed(0)}`;this.ctx.fillText(F,c-5,M)}this.ctx.fillStyle="#88ccff",this.ctx.font="9px monospace",this.ctx.textAlign="right",this.ctx.textBaseline="middle";for(let v=0;v<=4;v++){const E=p-(p-S)*(v/4),M=f+l/4*v,F=I(E);if(F){const k=F.cents>=0?"+":"";this.ctx.fillText(`${k}${F.cents}¢`,c+y-5,M)}}this.ctx.strokeStyle="#00ff00",this.ctx.lineWidth=2,this.ctx.beginPath();const T=y/Math.max(e.length-1,1),C=Math.max(1,Math.floor(e.length/4)),A=v=>{const M=(Math.max(S,Math.min(p,v))-S)/(p-S);return f+l-M*l};let b=!1;for(let v=0;v<e.length;v++){const E=e[v],M=c+v*T;if(E===0){b=!1;continue}const F=A(E);b?this.ctx.lineTo(M,F):(this.ctx.moveTo(M,F),b=!0)}this.ctx.stroke(),this.ctx.font="9px monospace",this.ctx.textAlign="center",this.ctx.textBaseline="top";for(let v=0;v<e.length;v++){const E=e[v],M=c+v*T;if(E!==0){const W=A(E);this.ctx.fillStyle="#00ff00",this.ctx.beginPath(),this.ctx.arc(M,W,2,0,Math.PI*2),this.ctx.fill()}const F=v===e.length-1;if(v%C===0||F){this.ctx.fillStyle="#aaaaaa";const W=v-e.length+1;this.ctx.fillText(`${W}`,M,f+l+2)}}const _=e[e.length-1];if(_>0){const v=I(_);this.ctx.fillStyle="#00ff00",this.ctx.font="bold 11px Arial",this.ctx.textAlign="left",this.ctx.textBaseline="bottom";let E=`${_.toFixed(1)} Hz`;if(v){const M=v.cents>=0?"+":"";E+=` (${v.noteName} ${M}${v.cents}¢)`}this.ctx.fillText(E,c+2,f+l-2)}this.ctx.restore()}}class at{constructor(t,e,i,r=!0){s(this,"ctx");s(this,"canvasWidth");s(this,"canvasHeight");s(this,"debugOverlaysEnabled");this.ctx=t,this.canvasWidth=e,this.canvasHeight=i,this.debugOverlaysEnabled=r}updateDimensions(t,e){this.canvasWidth=t,this.canvasHeight=e}setDebugOverlaysEnabled(t){this.debugOverlaysEnabled=t}drawPhaseMarkers(t,e,i,r,o,h,n){if(o===void 0||h===void 0)return;const a=h-o;if(a<=0)return;this.ctx.save();const g=(c,f,y)=>{const l=c-o;if(l<0||l>=a)return;const d=l/a*this.canvasWidth;this.ctx.strokeStyle=f,this.ctx.lineWidth=y,this.ctx.beginPath(),this.ctx.moveTo(d,0),this.ctx.lineTo(d,this.canvasHeight),this.ctx.stroke()};if(i!==void 0&&g(i,"#ff8800",2),r!==void 0&&g(r,"#ff8800",2),t!==void 0&&(g(t,"#ff0000",2),this.debugOverlaysEnabled&&(n==null?void 0:n.phaseZeroSegmentRelative)!==void 0)){const f=(t-o)/a*this.canvasWidth,y=20;this.ctx.save(),this.ctx.fillStyle="#ff0000",this.ctx.font="12px monospace",this.ctx.textAlign="left";const l=n.phaseZeroSegmentRelative,d=n.phaseZeroHistory??"?",w=n.phaseZeroTolerance??"?";[`Mode: ${n.zeroCrossModeName??"Unknown"}`,`Seg Rel: ${l}`,`History: ${d}`,`Tolerance: ±${w}`,`Range: ${typeof d=="number"&&typeof w=="number"?`${d-w}~${d+w}`:"?"}`].forEach((S,p)=>{this.ctx.fillText(S,f+5,y+p*14)}),this.ctx.restore()}e!==void 0&&g(e,"#ff0000",2),this.ctx.restore()}}class Y{constructor(t,e){s(this,"canvas");s(this,"ctx");s(this,"fftDisplayEnabled",!0);s(this,"debugOverlaysEnabled",!0);s(this,"overlaysLayout");s(this,"gridRenderer");s(this,"waveformLineRenderer");s(this,"fftOverlayRenderer");s(this,"harmonicAnalysisRenderer");s(this,"frequencyPlotRenderer");s(this,"phaseMarkerRenderer");this.canvas=t;const i=t.getContext("2d");if(!i)throw new Error("Could not get 2D context");this.ctx=i,this.overlaysLayout=e||K,this.gridRenderer=new tt(this.ctx,t.width,t.height),this.waveformLineRenderer=new et(this.ctx,t.width,t.height),this.fftOverlayRenderer=new it(this.ctx,t.width,t.height),this.harmonicAnalysisRenderer=new st(this.ctx,t.width,t.height),this.frequencyPlotRenderer=new rt(this.ctx,t.width,t.height),this.phaseMarkerRenderer=new at(this.ctx,t.width,t.height,this.debugOverlaysEnabled),t.width===300&&t.height===150&&console.warn('Canvas element is using default dimensions (300x150). Set explicit width and height attributes on the canvas element to match desired resolution. Example: <canvas id="oscilloscope" width="1800" height="1000"></canvas>')}clearAndDrawGrid(t,e,i){this.updateRendererDimensions(),this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.gridRenderer.drawGrid(t,e,i)}updateRendererDimensions(){const t=this.canvas.width,e=this.canvas.height;this.gridRenderer.updateDimensions(t,e),this.waveformLineRenderer.updateDimensions(t,e),this.fftOverlayRenderer.updateDimensions(t,e),this.harmonicAnalysisRenderer.updateDimensions(t,e),this.frequencyPlotRenderer.updateDimensions(t,e),this.phaseMarkerRenderer.updateDimensions(t,e)}drawWaveform(t,e,i,r){this.waveformLineRenderer.drawWaveform(t,e,i,r)}drawFFTOverlay(t,e,i,r,o){this.fftDisplayEnabled&&this.fftOverlayRenderer.drawFFTOverlay(t,e,i,r,o,this.overlaysLayout.fftOverlay)}drawHarmonicAnalysis(t,e,i,r,o,h,n){this.debugOverlaysEnabled&&this.fftDisplayEnabled&&this.harmonicAnalysisRenderer.drawHarmonicAnalysis(t,e,i,r,o,h,n,this.overlaysLayout.harmonicAnalysis)}drawFrequencyPlot(t,e,i){this.debugOverlaysEnabled&&this.frequencyPlotRenderer.drawFrequencyPlot(t,e,i,this.overlaysLayout.frequencyPlot)}drawPhaseMarkers(t,e,i,r,o,h,n){this.phaseMarkerRenderer.drawPhaseMarkers(t,e,i,r,o,h,n)}setFFTDisplay(t){this.fftDisplayEnabled=t}getFFTDisplayEnabled(){return this.fftDisplayEnabled}setDebugOverlaysEnabled(t){this.debugOverlaysEnabled=t,this.phaseMarkerRenderer.setDebugOverlaysEnabled(t)}getDebugOverlaysEnabled(){return this.debugOverlaysEnabled}setOverlaysLayout(t){this.overlaysLayout={...this.overlaysLayout,...t}}getOverlaysLayout(){return this.overlaysLayout}}class ${constructor(){s(this,"usePeakMode",!1);s(this,"zeroCrossMode","hysteresis")}setUsePeakMode(t){this.usePeakMode=t}getUsePeakMode(){return this.usePeakMode}setZeroCrossMode(t){this.zeroCrossMode=t}getZeroCrossMode(){return this.zeroCrossMode}reset(){}}class U{constructor(){s(this,"previousWaveform",null);s(this,"lastSimilarity",0)}getLastSimilarity(){return this.lastSimilarity}reset(){this.previousWaveform=null,this.lastSimilarity=0}hasPreviousWaveform(){return this.previousWaveform!==null}getPreviousWaveform(){return this.previousWaveform}}class Z{constructor(t,e,i,r){s(this,"previousCanvas");s(this,"currentCanvas");s(this,"similarityCanvas");s(this,"bufferCanvas");s(this,"previousCtx");s(this,"currentCtx");s(this,"similarityCtx");s(this,"bufferCtx");s(this,"TARGET_FILL_RATIO",.9);s(this,"MIN_PEAK_THRESHOLD",.001);s(this,"DEFAULT_AMPLITUDE_RATIO",.4);this.previousCanvas=t,this.currentCanvas=e,this.similarityCanvas=i,this.bufferCanvas=r;const o=t.getContext("2d"),h=e.getContext("2d"),n=i.getContext("2d"),a=r.getContext("2d");if(!o||!h||!n||!a)throw new Error("Could not get 2D context for comparison canvases");this.previousCtx=o,this.currentCtx=h,this.similarityCtx=n,this.bufferCtx=a,this.clearAllCanvases()}clearAllCanvases(){this.clearCanvas(this.previousCtx,this.previousCanvas.width,this.previousCanvas.height),this.clearCanvas(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height),this.clearCanvas(this.similarityCtx,this.similarityCanvas.width,this.similarityCanvas.height),this.clearCanvas(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height)}clearCanvas(t,e,i){t.fillStyle="#000000",t.fillRect(0,0,e,i)}findPeakAmplitude(t,e,i){let r=0;const o=Math.max(0,e),h=Math.min(t.length,i);for(let n=o;n<h;n++){const a=Math.abs(t[n]);a>r&&(r=a)}return r}drawWaveform(t,e,i,r,o,h,n){const a=h-o;if(a<=0)return;const g=this.findPeakAmplitude(r,o,h);t.strokeStyle=n,t.lineWidth=1.5,t.beginPath();const c=e/a,f=i/2;let y;if(g>this.MIN_PEAK_THRESHOLD){const l=this.TARGET_FILL_RATIO/g;y=i/2*l}else y=i*this.DEFAULT_AMPLITUDE_RATIO;for(let l=0;l<a;l++){const d=o+l;if(d>=r.length)break;const w=r[d],m=f-w*y,x=Math.min(i,Math.max(0,m)),S=l*c;l===0?t.moveTo(S,x):t.lineTo(S,x)}t.stroke()}drawCenterLine(t,e,i){t.strokeStyle="#444444",t.lineWidth=1,t.beginPath(),t.moveTo(0,i/2),t.lineTo(e,i/2),t.stroke()}drawSimilarityText(t){this.currentCtx.fillStyle="#00aaff",this.currentCtx.font="bold 14px Arial";const e=`Similarity: ${t.toFixed(3)}`,i=this.currentCtx.measureText(e).width,r=(this.currentCanvas.width-i)/2;this.currentCtx.fillText(e,r,20)}drawSimilarityPlot(t){if(!t||t.length===0)return;const e=this.similarityCtx,i=this.similarityCanvas.width,r=this.similarityCanvas.height;e.save(),e.fillStyle="#000000",e.fillRect(0,0,i,r),e.strokeStyle="#00aaff",e.lineWidth=2,e.strokeRect(0,0,i,r),e.fillStyle="#00aaff",e.font="bold 12px Arial",e.fillText("類似度推移 (Similarity)",5,15);const o=40,h=25,n=i-50,a=r-35,g=-1,c=1;e.strokeStyle="#333333",e.lineWidth=1,e.beginPath();for(let l=0;l<=4;l++){const d=h+a/4*l;e.moveTo(o,d),e.lineTo(o+n,d)}for(let l=0;l<=4;l++){const d=o+n/4*l;e.moveTo(d,h),e.lineTo(d,h+a)}e.stroke(),e.fillStyle="#aaaaaa",e.font="10px monospace",e.textAlign="right",e.textBaseline="middle";for(let l=0;l<=4;l++){const d=c-(c-g)*(l/4),w=h+a/4*l,m=d.toFixed(2);e.fillText(m,o-5,w)}e.strokeStyle="#00aaff",e.lineWidth=2,e.beginPath();const f=n/Math.max(t.length-1,1);for(let l=0;l<t.length;l++){const d=t[l],w=o+l*f,x=(Math.max(g,Math.min(c,d))-g)/(c-g),S=h+a-x*a;l===0?e.moveTo(w,S):e.lineTo(w,S)}e.stroke();const y=t[t.length-1];e.fillStyle="#00aaff",e.font="bold 11px Arial",e.textAlign="left",e.textBaseline="bottom",e.fillText(`${y.toFixed(3)}`,o+2,h+a-2),e.restore()}drawPositionMarkers(t,e,i,r,o,h){if(h<=0)return;const n=r/h*e,a=o/h*e;t.strokeStyle="#ff0000",t.lineWidth=2,t.beginPath(),t.moveTo(n,0),t.lineTo(n,i),t.stroke(),t.beginPath(),t.moveTo(a,0),t.lineTo(a,i),t.stroke(),t.fillStyle="#ff0000",t.font="10px Arial",t.fillText("S",n+2,12),t.fillText("E",a+2,12)}updatePanels(t,e,i,r,o,h,n=[]){this.clearAllCanvases(),t&&(this.drawCenterLine(this.previousCtx,this.previousCanvas.width,this.previousCanvas.height),this.drawWaveform(this.previousCtx,this.previousCanvas.width,this.previousCanvas.height,t,0,t.length,"#ffaa00")),this.drawCenterLine(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height),r-i>0&&this.drawWaveform(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height,e,i,r,"#00ff00"),t&&this.drawSimilarityText(h),n.length>0&&this.drawSimilarityPlot(n),this.drawCenterLine(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height),this.drawWaveform(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height,o,0,o.length,"#888888"),this.drawPositionMarkers(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height,i,r,o.length)}clear(){this.clearAllCanvases()}}class X{constructor(t,e,i){s(this,"canvas8div");s(this,"canvas4div");s(this,"canvas2div");s(this,"ctx8div");s(this,"ctx4div");s(this,"ctx2div");this.canvas8div=t,this.canvas4div=e,this.canvas2div=i;const r=t.getContext("2d"),o=e.getContext("2d"),h=i.getContext("2d");if(!r||!o||!h)throw new Error("Could not get 2D context for cycle similarity canvases");this.ctx8div=r,this.ctx4div=o,this.ctx2div=h,this.clearAllCanvases()}clearAllCanvases(){this.clearCanvas(this.ctx8div,this.canvas8div.width,this.canvas8div.height),this.clearCanvas(this.ctx4div,this.canvas4div.width,this.canvas4div.height),this.clearCanvas(this.ctx2div,this.canvas2div.width,this.canvas2div.height)}clearCanvas(t,e,i){t.fillStyle="#000000",t.fillRect(0,0,e,i)}drawSimilarityGraph(t,e,i,r,o,h){if(t.save(),t.fillStyle="#000000",t.fillRect(0,0,e,i),t.strokeStyle="#ff8800",t.lineWidth=2,t.strokeRect(0,0,e,i),t.fillStyle="#ff8800",t.font="bold 12px Arial",t.fillText(o,5,15),!r||r.length===0){t.fillStyle="#666666",t.font="11px Arial",t.fillText("データなし (No data)",e/2-50,i/2),t.restore();return}const n=35,a=25,g=e-45,c=i-35,f=-1,y=1;t.strokeStyle="#333333",t.lineWidth=1,t.beginPath();for(let m=0;m<=4;m++){const x=a+c/4*m;t.moveTo(n,x),t.lineTo(n+g,x)}for(let m=0;m<=r.length;m++){const x=n+g/r.length*m;t.moveTo(x,a),t.lineTo(x,a+c)}t.stroke(),t.fillStyle="#aaaaaa",t.font="10px monospace",t.textAlign="right",t.textBaseline="middle";for(let m=0;m<=4;m++){const x=y-(y-f)*(m/4),S=a+c/4*m,p=x.toFixed(1);t.fillText(p,n-5,S)}const l=g/r.length,d=l*.15;for(let m=0;m<r.length;m++){const x=r[m],S=Math.max(f,Math.min(y,x)),p=(S-f)/(y-f),T=a+c-p*c,C=a+c-(0-f)/(y-f)*c,A=n+m*l+d,b=l-d*2;x>=.9?t.fillStyle="#00ff00":x>=.7?t.fillStyle="#88ff00":x>=.5?t.fillStyle="#ffaa00":x>=0?t.fillStyle="#ff6600":t.fillStyle="#ff0000",T<C?t.fillRect(A,T,b,C-T):t.fillRect(A,C,b,T-C),t.fillStyle="#ffffff",t.font="9px monospace",t.textAlign="center",S>=0?(t.textBaseline="bottom",t.fillText(x.toFixed(2),A+b/2,T-2)):(t.textBaseline="top",t.fillText(x.toFixed(2),A+b/2,T+2))}const w=a+c-(0-f)/(y-f)*c;t.strokeStyle="#666666",t.lineWidth=1,t.beginPath(),t.moveTo(n,w),t.lineTo(n+g,w),t.stroke(),t.fillStyle="#aaaaaa",t.font="9px Arial",t.textAlign="center",t.textBaseline="top";for(let m=0;m<r.length;m++){const x=n+(m+.5)*l;t.fillText(`${m+1}-${m+2}`,x,a+c+2)}t.fillStyle="#aaaaaa",t.font="10px Arial",t.textAlign="center",t.fillText(h,n+g/2,i-3),t.restore()}updateGraphs(t,e,i){this.drawSimilarityGraph(this.ctx8div,this.canvas8div.width,this.canvas8div.height,t||[],"8分割 (1/2周期)","連続する1/2周期間の類似度"),this.drawSimilarityGraph(this.ctx4div,this.canvas4div.width,this.canvas4div.height,e||[],"4分割 (1周期)","連続する1周期間の類似度"),this.drawSimilarityGraph(this.ctx2div,this.canvas2div.width,this.canvas2div.height,i||[],"2分割 (2周期)","連続する2周期間の類似度")}clear(){this.clearAllCanvases()}}const P=class P{constructor(){s(this,"cachedBasePath",null)}getBasePath(){var e;if(this.cachedBasePath!==null)return this.cachedBasePath;let t=(e=document.querySelector("base"))==null?void 0:e.getAttribute("href");if(t)try{t=new URL(t,window.location.href).pathname}catch{}if(t||(t=this.getBasePathFromScripts()),!t&&window.location.pathname&&window.location.pathname!=="/"){const r=window.location.pathname.split("/").filter(o=>o.length>0);r.length>0&&(t=`/${r[0]}/`)}return t||(t="/"),t.endsWith("/")||(t+="/"),this.cachedBasePath=t,t}getBasePathFromScripts(){const t=document.querySelectorAll("script[src]");for(const e of t){const i=e.getAttribute("src");if(i)try{const o=new URL(i,window.location.href).pathname;for(const h of P.ASSET_PATTERNS){const n=o.indexOf(h);if(n>=0)return n===0?"/":o.substring(0,n)+"/"}}catch(r){(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&console.debug("Failed to parse script URL:",i,r);continue}}return""}};s(P,"ASSET_PATTERNS",["/assets/","/js/","/dist/"]);let H=P;class nt{constructor(){s(this,"wasmProcessor",null);s(this,"isInitialized",!1);s(this,"LOAD_TIMEOUT_MS",1e4)}async loadWasmModule(t){if(!(this.isInitialized&&this.wasmProcessor)){if(typeof window>"u"||window.location.protocol==="file:")throw new Error("WASM module not available in test/non-browser environment");return new Promise((e,i)=>{if(window.wasmProcessor&&window.wasmProcessor.WasmDataProcessor){this.wasmProcessor=new window.wasmProcessor.WasmDataProcessor,this.isInitialized=!0,e();return}const r=setTimeout(()=>{n(),i(new Error(`WASM module loading timed out after ${this.LOAD_TIMEOUT_MS/1e3} seconds`))},this.LOAD_TIMEOUT_MS),o=`${t}wasm/wasm_processor.js`,h=document.createElement("script");h.type="module",h.textContent=`
        import init, { WasmDataProcessor } from '${o}';
        await init();
        window.wasmProcessor = { WasmDataProcessor };
        window.dispatchEvent(new Event('wasmLoaded'));
      `;const n=()=>{clearTimeout(r),window.removeEventListener("wasmLoaded",a)},a=()=>{n(),window.wasmProcessor&&window.wasmProcessor.WasmDataProcessor?(this.wasmProcessor=new window.wasmProcessor.WasmDataProcessor,this.isInitialized=!0,e()):i(new Error("WASM module loaded but WasmDataProcessor not found"))};window.addEventListener("wasmLoaded",a),h.onerror=()=>{n(),i(new Error("Failed to load WASM module script"))},document.head.appendChild(h)})}}getProcessor(){return this.wasmProcessor}isReady(){return this.isInitialized&&this.wasmProcessor!==null}}class Q{constructor(t,e,i,r,o){s(this,"audioManager");s(this,"gainController");s(this,"frequencyEstimator");s(this,"waveformSearcher");s(this,"zeroCrossDetector");s(this,"basePathResolver");s(this,"wasmLoader");this.audioManager=t,this.gainController=e,this.frequencyEstimator=i,this.waveformSearcher=r,this.zeroCrossDetector=o,this.basePathResolver=new H,this.wasmLoader=new nt}async initialize(){if(!this.wasmLoader.isReady())try{const t=this.basePathResolver.getBasePath();await this.wasmLoader.loadWasmModule(t),this.syncConfigToWasm()}catch(t){throw console.error("Failed to initialize WASM module:",t),t}}syncConfigToWasm(){const t=this.wasmLoader.getProcessor();t&&(t.setAutoGain(this.gainController.getAutoGainEnabled()),t.setNoiseGate(this.gainController.getNoiseGateEnabled()),t.setNoiseGateThreshold(this.gainController.getNoiseGateThreshold()),t.setFrequencyEstimationMethod(this.frequencyEstimator.getFrequencyEstimationMethod()),t.setBufferSizeMultiplier(this.frequencyEstimator.getBufferSizeMultiplier()),t.setZeroCrossMode(this.zeroCrossDetector.getZeroCrossMode()))}syncResultsFromWasm(t){this.frequencyEstimator.estimatedFrequency=t.estimatedFrequency,this.gainController.currentGain=t.gain,t.previousWaveform&&(this.waveformSearcher.previousWaveform=t.previousWaveform),this.waveformSearcher.lastSimilarity=t.similarity}processFrame(t){const e=this.wasmLoader.getProcessor();if(!this.wasmLoader.isReady()||!e)return console.warn("WASM processor not initialized"),null;if(!this.audioManager.isReady())return null;const i=this.audioManager.getTimeDomainData();if(!i)return null;const r=this.audioManager.getSampleRate(),o=this.audioManager.getFFTSize(),n=this.frequencyEstimator.getFrequencyEstimationMethod()==="fft"||t?this.audioManager.getFrequencyData():null;this.syncConfigToWasm();const a=e.processFrame(i,n,r,o,t);if(!a)return null;const g={waveformData:new Float32Array(a.waveform_data),displayStartIndex:a.displayStartIndex,displayEndIndex:a.displayEndIndex,gain:a.gain,estimatedFrequency:a.estimatedFrequency,frequencyPlotHistory:a.frequencyPlotHistory?Array.from(a.frequencyPlotHistory):[],sampleRate:a.sampleRate,fftSize:a.fftSize,frequencyData:a.frequencyData?new Uint8Array(a.frequencyData):void 0,isSignalAboveNoiseGate:a.isSignalAboveNoiseGate,maxFrequency:a.maxFrequency,previousWaveform:a.previousWaveform?new Float32Array(a.previousWaveform):null,similarity:a.similarity,similarityPlotHistory:a.similarityPlotHistory?Array.from(a.similarityPlotHistory):[],usedSimilaritySearch:a.usedSimilaritySearch,phaseZeroIndex:a.phaseZeroIndex,phaseTwoPiIndex:a.phaseTwoPiIndex,phaseMinusQuarterPiIndex:a.phaseMinusQuarterPiIndex,phaseTwoPiPlusQuarterPiIndex:a.phaseTwoPiPlusQuarterPiIndex,halfFreqPeakStrengthPercent:a.halfFreqPeakStrengthPercent,candidate1Harmonics:a.candidate1Harmonics?Array.from(a.candidate1Harmonics):void 0,candidate2Harmonics:a.candidate2Harmonics?Array.from(a.candidate2Harmonics):void 0,selectionReason:a.selectionReason,cycleSimilarities8div:a.cycleSimilarities8div?Array.from(a.cycleSimilarities8div):void 0,cycleSimilarities4div:a.cycleSimilarities4div?Array.from(a.cycleSimilarities4div):void 0,cycleSimilarities2div:a.cycleSimilarities2div?Array.from(a.cycleSimilarities2div):void 0};return this.syncResultsFromWasm(g),g}reset(){const t=this.wasmLoader.getProcessor();t&&t.reset()}}class ot{constructor(t,e,i,r,o,h,n,a,g){s(this,"audioManager");s(this,"gainController");s(this,"frequencyEstimator");s(this,"renderer");s(this,"zeroCrossDetector");s(this,"waveformSearcher");s(this,"comparisonRenderer");s(this,"cycleSimilarityRenderer",null);s(this,"dataProcessor");s(this,"animationId",null);s(this,"isRunning",!1);s(this,"isPaused",!1);s(this,"lastFrameTime",0);s(this,"frameProcessingTimes",[]);s(this,"MAX_FRAME_TIMES",100);s(this,"TARGET_FRAME_TIME",16.67);s(this,"FPS_LOG_INTERVAL_FRAMES",60);this.audioManager=new N,this.gainController=new q,this.frequencyEstimator=new B,this.renderer=new Y(t,g),this.zeroCrossDetector=new $,this.waveformSearcher=new U,this.comparisonRenderer=new Z(e,i,r,o),h&&n&&a&&(this.cycleSimilarityRenderer=new X(h,n,a)),this.dataProcessor=new Q(this.audioManager,this.gainController,this.frequencyEstimator,this.waveformSearcher,this.zeroCrossDetector)}async start(){try{await this.dataProcessor.initialize(),await this.audioManager.start(),this.isRunning=!0,this.render()}catch(t){throw console.error("Error starting oscilloscope:",t),t}}async startFromFile(t){try{await this.dataProcessor.initialize(),await this.audioManager.startFromFile(t),this.isRunning=!0,this.render()}catch(e){throw console.error("Error loading audio file:",e),e}}async startFromBuffer(t){try{await this.dataProcessor.initialize(),await this.audioManager.startFromBuffer(t),this.isRunning=!0,this.render()}catch(e){throw console.error("Error starting from buffer:",e),e}}async stop(){this.isRunning=!1,this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null),await this.audioManager.stop(),this.frequencyEstimator.clearHistory(),this.zeroCrossDetector.reset(),this.waveformSearcher.reset(),this.comparisonRenderer.clear(),this.cycleSimilarityRenderer&&this.cycleSimilarityRenderer.clear(),this.dataProcessor.reset()}render(){if(!this.isRunning)return;const t=performance.now();if(!this.isPaused){const r=this.dataProcessor.processFrame(this.renderer.getFFTDisplayEnabled());r&&this.renderFrame(r)}const i=performance.now()-t;if(this.frameProcessingTimes.push(i),this.frameProcessingTimes.length>this.MAX_FRAME_TIMES&&this.frameProcessingTimes.shift(),i>this.TARGET_FRAME_TIME&&console.warn(`Frame processing time: ${i.toFixed(2)}ms (target: <${this.TARGET_FRAME_TIME}ms)`),this.lastFrameTime>0){const o=1e3/(t-this.lastFrameTime);if(this.frameProcessingTimes.length===this.FPS_LOG_INTERVAL_FRAMES){const h=this.frameProcessingTimes.reduce((n,a)=>n+a,0)/this.frameProcessingTimes.length;console.log(`FPS: ${o.toFixed(1)}, Avg frame time: ${h.toFixed(2)}ms`)}}this.lastFrameTime=t,this.animationId=requestAnimationFrame(()=>this.render())}renderFrame(t){const e=t.displayEndIndex-t.displayStartIndex;this.renderer.clearAndDrawGrid(t.sampleRate,e,t.gain),this.renderer.drawWaveform(t.waveformData,t.displayStartIndex,t.displayEndIndex,t.gain),this.renderer.drawPhaseMarkers(t.phaseZeroIndex,t.phaseTwoPiIndex,t.phaseMinusQuarterPiIndex,t.phaseTwoPiPlusQuarterPiIndex,t.displayStartIndex,t.displayEndIndex,{phaseZeroSegmentRelative:t.phaseZeroSegmentRelative,phaseZeroHistory:t.phaseZeroHistory,phaseZeroTolerance:t.phaseZeroTolerance,zeroCrossModeName:t.zeroCrossModeName}),t.frequencyData&&this.renderer.getFFTDisplayEnabled()&&t.isSignalAboveNoiseGate&&(this.renderer.drawFFTOverlay(t.frequencyData,t.estimatedFrequency,t.sampleRate,t.fftSize,t.maxFrequency),this.renderer.drawHarmonicAnalysis(t.halfFreqPeakStrengthPercent,t.candidate1Harmonics,t.candidate2Harmonics,t.candidate1WeightedScore,t.candidate2WeightedScore,t.selectionReason,t.estimatedFrequency)),this.renderer.drawFrequencyPlot(t.frequencyPlotHistory,this.frequencyEstimator.getMinFrequency(),this.frequencyEstimator.getMaxFrequency()),this.comparisonRenderer.updatePanels(t.previousWaveform,t.waveformData,t.displayStartIndex,t.displayEndIndex,t.waveformData,t.similarity,t.similarityPlotHistory),this.cycleSimilarityRenderer&&this.cycleSimilarityRenderer.updateGraphs(t.cycleSimilarities8div,t.cycleSimilarities4div,t.cycleSimilarities2div)}getIsRunning(){return this.isRunning}setAutoGain(t){this.gainController.setAutoGain(t)}getAutoGainEnabled(){return this.gainController.getAutoGainEnabled()}setNoiseGate(t){this.gainController.setNoiseGate(t)}getNoiseGateEnabled(){return this.gainController.getNoiseGateEnabled()}setNoiseGateThreshold(t){this.gainController.setNoiseGateThreshold(t)}getNoiseGateThreshold(){return this.gainController.getNoiseGateThreshold()}setFrequencyEstimationMethod(t){this.frequencyEstimator.setFrequencyEstimationMethod(t)}getFrequencyEstimationMethod(){return this.frequencyEstimator.getFrequencyEstimationMethod()}setBufferSizeMultiplier(t){this.frequencyEstimator.setBufferSizeMultiplier(t)}getBufferSizeMultiplier(){return this.frequencyEstimator.getBufferSizeMultiplier()}getEstimatedFrequency(){return this.frequencyEstimator.getEstimatedFrequency()}setFFTDisplay(t){this.renderer.setFFTDisplay(t)}getFFTDisplayEnabled(){return this.renderer.getFFTDisplayEnabled()}setDebugOverlaysEnabled(t){this.renderer.setDebugOverlaysEnabled(t)}getDebugOverlaysEnabled(){return this.renderer.getDebugOverlaysEnabled()}setOverlaysLayout(t){this.renderer.setOverlaysLayout(t)}getOverlaysLayout(){return this.renderer.getOverlaysLayout()}getCurrentGain(){return this.gainController.getCurrentGain()}getSimilarityScore(){return this.waveformSearcher.getLastSimilarity()}isSimilaritySearchActive(){return this.waveformSearcher.hasPreviousWaveform()}setUsePeakMode(t){this.zeroCrossDetector.setUsePeakMode(t)}getUsePeakMode(){return this.zeroCrossDetector.getUsePeakMode()}setZeroCrossMode(t){this.zeroCrossDetector.setZeroCrossMode(t)}getZeroCrossMode(){return this.zeroCrossDetector.getZeroCrossMode()}setPauseDrawing(t){this.isPaused=t}getPauseDrawing(){return this.isPaused}}class ht{constructor(t){s(this,"canvas");s(this,"ctx");s(this,"MIN_FREQ",50);s(this,"MAX_FREQ",2e3);s(this,"WHITE_KEY_WIDTH",20);s(this,"WHITE_KEY_HEIGHT",60);s(this,"BLACK_KEY_WIDTH",12);s(this,"BLACK_KEY_HEIGHT",38);s(this,"WHITE_KEY_COLOR","#ffffff");s(this,"BLACK_KEY_COLOR","#000000");s(this,"WHITE_KEY_HIGHLIGHT","#00ff00");s(this,"BLACK_KEY_HIGHLIGHT","#00cc00");s(this,"KEY_BORDER","#333333");s(this,"WHITE_KEY_NOTES",[0,2,4,5,7,9,11]);s(this,"BLACK_KEY_NOTES",[1,3,6,8,10]);s(this,"keyboardRange");s(this,"xOffset");s(this,"whiteKeyCount");this.canvas=t;const e=t.getContext("2d");if(!e)throw new Error("Could not get 2D context for piano keyboard");this.ctx=e,this.keyboardRange=this.calculateKeyboardRange(),this.whiteKeyCount=this.countWhiteKeys(),this.xOffset=this.calculateCenteringOffset()}frequencyToNoteInfo(t){const e=I(t);if(!e)return{note:-1,octave:-1,noteInOctave:-1};const i=e.noteName.match(/^([A-G]#?)(\d+)$/);if(!i)return{note:-1,octave:-1,noteInOctave:-1};const r=i[1],o=parseInt(i[2],10),n=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"].indexOf(r);return{note:o*12+n,octave:o,noteInOctave:n}}calculateKeyboardRange(){const t=this.frequencyToNoteInfo(this.MIN_FREQ),e=this.frequencyToNoteInfo(this.MAX_FREQ);return{startNote:t.note,endNote:e.note}}countWhiteKeys(){const t=this.keyboardRange;let e=0;for(let i=t.startNote;i<=t.endNote;i++){const r=(i%12+12)%12;this.WHITE_KEY_NOTES.includes(r)&&e++}return e}calculateCenteringOffset(){const t=this.whiteKeyCount*this.WHITE_KEY_WIDTH;return(this.canvas.width-t)/2}render(t){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);const e=this.keyboardRange,i=t>0?this.frequencyToNoteInfo(t):null;let r=0;for(let a=e.startNote;a<=e.endNote;a++){const g=(a%12+12)%12;if(this.WHITE_KEY_NOTES.includes(g)){const c=this.xOffset+r*this.WHITE_KEY_WIDTH,f=i&&i.note===a;this.ctx.fillStyle=f?this.WHITE_KEY_HIGHLIGHT:this.WHITE_KEY_COLOR,this.ctx.fillRect(c,0,this.WHITE_KEY_WIDTH,this.WHITE_KEY_HEIGHT),this.ctx.strokeStyle=this.KEY_BORDER,this.ctx.lineWidth=1,this.ctx.strokeRect(c,0,this.WHITE_KEY_WIDTH,this.WHITE_KEY_HEIGHT),r++}}r=0;for(let a=e.startNote;a<=e.endNote;a++){const g=(a%12+12)%12;if(this.WHITE_KEY_NOTES.includes(g)&&r++,this.BLACK_KEY_NOTES.includes(g)){const c=this.xOffset+r*this.WHITE_KEY_WIDTH-this.BLACK_KEY_WIDTH/2,f=i&&i.note===a;this.ctx.fillStyle=f?this.BLACK_KEY_HIGHLIGHT:this.BLACK_KEY_COLOR,this.ctx.fillRect(c,0,this.BLACK_KEY_WIDTH,this.BLACK_KEY_HEIGHT),this.ctx.strokeStyle=this.KEY_BORDER,this.ctx.lineWidth=1,this.ctx.strokeRect(c,0,this.BLACK_KEY_WIDTH,this.BLACK_KEY_HEIGHT)}}this.ctx.fillStyle="#888888",this.ctx.font="10px monospace",this.ctx.fillText(`${this.MIN_FREQ}Hz`,this.xOffset+5,this.WHITE_KEY_HEIGHT-5);const o=`${this.MAX_FREQ}Hz`,h=this.ctx.measureText(o).width,n=this.xOffset+this.whiteKeyCount*this.WHITE_KEY_WIDTH;this.ctx.fillText(o,n-h-5,this.WHITE_KEY_HEIGHT-5)}clear(){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}}class O{constructor(t,e,i){s(this,"buffer");s(this,"sampleRate");s(this,"position",0);s(this,"chunkSize",4096);s(this,"isLooping",!1);if(e<=0||!isFinite(e))throw new Error("Sample rate must be a positive finite number");if(this.buffer=t,this.sampleRate=e,(i==null?void 0:i.chunkSize)!==void 0){if(i.chunkSize<=0||!isFinite(i.chunkSize)||!Number.isInteger(i.chunkSize))throw new Error("Chunk size must be a positive integer");this.chunkSize=i.chunkSize}(i==null?void 0:i.loop)!==void 0&&(this.isLooping=i.loop)}static fromAudioBuffer(t,e){const i=(e==null?void 0:e.channel)??0;if(i<0||i>=t.numberOfChannels)throw new Error(`Invalid channel index ${i}. AudioBuffer has ${t.numberOfChannels} channel(s).`);const r=t.getChannelData(i);return new O(r,t.sampleRate,{chunkSize:e==null?void 0:e.chunkSize,loop:e==null?void 0:e.loop})}getNextChunk(){if(this.buffer.length===0)return null;if(this.position>=this.buffer.length)if(this.isLooping)this.position=0;else return null;const t=Math.min(this.position+this.chunkSize,this.buffer.length),e=this.buffer.slice(this.position,t);if(e.length<this.chunkSize&&this.isLooping){const i=this.chunkSize-e.length,r=Math.min(i,this.buffer.length),o=new Float32Array(this.chunkSize);return o.set(e,0),o.set(this.buffer.slice(0,r),e.length),this.position=r,o}if(this.position=t,e.length<this.chunkSize){const i=new Float32Array(this.chunkSize);return i.set(e,0),i}return e}reset(){this.position=0}seek(t){this.position=Math.max(0,Math.min(t,this.buffer.length))}getPosition(){return this.position}getLength(){return this.buffer.length}getSampleRate(){return this.sampleRate}setChunkSize(t){if(t<=0||!isFinite(t)||!Number.isInteger(t))throw new Error("Chunk size must be a positive integer");this.chunkSize=t}getChunkSize(){return this.chunkSize}setLooping(t){this.isLooping=t}isLoop(){return this.isLooping}isAtEnd(){return this.position>=this.buffer.length&&!this.isLooping}}exports.AudioManager=N;exports.BufferSource=O;exports.ComparisonPanelRenderer=Z;exports.CycleSimilarityRenderer=X;exports.DEFAULT_OVERLAYS_LAYOUT=K;exports.FrequencyEstimator=B;exports.GainController=q;exports.Oscilloscope=ot;exports.PianoKeyboardRenderer=ht;exports.WaveformDataProcessor=Q;exports.WaveformRenderer=Y;exports.WaveformSearcher=U;exports.ZeroCrossDetector=$;exports.amplitudeToDb=z;exports.dbToAmplitude=D;exports.resolveValue=R;exports.trimSilence=G;
//# sourceMappingURL=cat-oscilloscope.cjs.map
