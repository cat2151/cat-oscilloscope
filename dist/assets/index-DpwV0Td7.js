var ut=Object.defineProperty;var mt=(a,t,e)=>t in a?ut(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var o=(a,t,e)=>mt(a,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();function it(a){return Math.pow(10,a/20)}function yt(a){return a<=0?-1/0:20*Math.log10(a)}function D(a){if(a<=0||!isFinite(a))return null;const e=440*Math.pow(2,-4.75),s=12*Math.log2(a/e),n=Math.round(s),r=Math.round((s-n)*100),l=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],i=Math.floor(n/12);return{noteName:`${l[(n%12+12)%12]}${i}`,cents:r}}const xt=-48;function gt(a){const t=a.numberOfChannels,e=a.sampleRate,s=a.length,n=[];let r=0;for(let d=0;d<t;d++){const u=a.getChannelData(d);n.push(u);for(let c=0;c<s;c++){const m=Math.abs(u[c]);m>r&&(r=m)}}if(r===0)return a;const l=r*Math.pow(10,xt/20);let i=s;for(let d=0;d<s;d++){let u=!0;for(let c=0;c<t;c++)if(Math.abs(n[c][d])>l){u=!1;break}if(!u){i=d;break}}if(i>=s)return a;let h=s-1;for(let d=s-1;d>=i;d--){let u=!0;for(let c=0;c<t;c++)if(Math.abs(n[c][d])>l){u=!1;break}if(!u){h=d;break}}if(i===0&&h===s-1)return a;const x=h-i+1,f=new AudioBuffer({numberOfChannels:t,length:x,sampleRate:e});for(let d=0;d<t;d++){const u=n[d],c=f.getChannelData(d);for(let m=0;m<x;m++)c[m]=u[i+m]}return f}class vt{constructor(){o(this,"audioContext",null);o(this,"analyser",null);o(this,"mediaStream",null);o(this,"audioBufferSource",null);o(this,"bufferSource",null);o(this,"dataArray",null);o(this,"frequencyData",null);o(this,"frameBufferHistory",[]);o(this,"MAX_FRAME_HISTORY",16)}initializeAnalyser(){if(!this.audioContext)throw new Error("AudioContext must be initialized before creating analyser");this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=4096,this.analyser.smoothingTimeConstant=0;const t=this.analyser.fftSize;this.dataArray=new Float32Array(t),this.frequencyData=new Uint8Array(this.analyser.frequencyBinCount)}async start(){try{this.mediaStream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.audioContext=new AudioContext;const t=this.audioContext.createMediaStreamSource(this.mediaStream);this.initializeAnalyser(),t.connect(this.analyser)}catch(t){throw console.error("Error accessing microphone:",t),t}}async startFromFile(t){try{const e=await t.arrayBuffer();this.audioContext&&this.audioContext.state!=="closed"&&await this.audioContext.close(),this.audioContext=new AudioContext;let s=await this.audioContext.decodeAudioData(e);s=gt(s),this.initializeAnalyser(),this.audioBufferSource=this.audioContext.createBufferSource(),this.audioBufferSource.buffer=s,this.audioBufferSource.loop=!0,this.audioBufferSource.connect(this.analyser),this.analyser.connect(this.audioContext.destination),this.audioBufferSource.start(0)}catch(e){throw console.error("Error loading audio file:",e),e}}async startFromBuffer(t){try{this.audioContext&&this.audioContext.state!=="closed"&&await this.audioContext.close(),this.audioContext=null,this.bufferSource=t,this.bufferSource.setChunkSize(4096),this.dataArray=new Float32Array(4096),this.frequencyData=new Uint8Array(2048)}catch(e){throw console.error("Error starting from buffer:",e),e}}async stop(){if(this.audioBufferSource){try{this.audioBufferSource.stop()}catch{}try{this.audioBufferSource.disconnect()}catch{}this.audioBufferSource=null}if(this.mediaStream&&(this.mediaStream.getTracks().forEach(t=>t.stop()),this.mediaStream=null),this.bufferSource&&(this.bufferSource.reset(),this.bufferSource=null),this.audioContext){try{await this.audioContext.close()}catch(t){console.error("Error closing AudioContext:",t)}this.audioContext=null}this.analyser=null,this.dataArray=null,this.frequencyData=null,this.clearFrameBufferHistory()}getTimeDomainData(){if(this.bufferSource&&this.dataArray){const t=this.bufferSource.getNextChunk();return t?(this.dataArray.set(t),this.updateFrameBufferHistory(this.dataArray),this.dataArray):null}return!this.analyser||!this.dataArray?null:(this.analyser.getFloatTimeDomainData(this.dataArray),this.updateFrameBufferHistory(this.dataArray),this.dataArray)}updateFrameBufferHistory(t){let e;this.frameBufferHistory.length<this.MAX_FRAME_HISTORY?e=new Float32Array(t.length):(e=this.frameBufferHistory.shift(),e.length!==t.length&&(e=new Float32Array(t.length))),e.set(t),this.frameBufferHistory.push(e)}getExtendedTimeDomainData(t){if(t===1)return this.dataArray;if(!this.dataArray||this.frameBufferHistory.length<t)return null;const e=this.frameBufferHistory.slice(-t),s=e.reduce((l,i)=>l+i.length,0),n=new Float32Array(s);let r=0;for(const l of e)n.set(l,r),r+=l.length;return n}clearFrameBufferHistory(){this.frameBufferHistory=[]}getFrequencyData(){return this.bufferSource&&this.dataArray&&this.frequencyData||!this.analyser||!this.frequencyData?null:(this.analyser.getByteFrequencyData(this.frequencyData),this.frequencyData)}getSampleRate(){var t;return this.bufferSource?this.bufferSource.getSampleRate():((t=this.audioContext)==null?void 0:t.sampleRate)||0}getFFTSize(){var t;return this.bufferSource?4096:((t=this.analyser)==null?void 0:t.fftSize)||0}getFrequencyBinCount(){var t;return this.bufferSource?2048:((t=this.analyser)==null?void 0:t.frequencyBinCount)||0}isReady(){return this.bufferSource?this.dataArray!==null:this.audioContext!==null&&this.analyser!==null}}class pt{constructor(){o(this,"autoGainEnabled",!0);o(this,"currentGain",1);o(this,"noiseGateEnabled",!0);o(this,"noiseGateThreshold",it(-60))}setAutoGain(t){this.autoGainEnabled=t}getAutoGainEnabled(){return this.autoGainEnabled}setNoiseGate(t){this.noiseGateEnabled=t}getNoiseGateEnabled(){return this.noiseGateEnabled}setNoiseGateThreshold(t){this.noiseGateThreshold=Math.min(Math.max(t,0),1)}getNoiseGateThreshold(){return this.noiseGateThreshold}getCurrentGain(){return this.currentGain}}class wt{constructor(){o(this,"frequencyEstimationMethod","fft");o(this,"estimatedFrequency",0);o(this,"MIN_FREQUENCY_HZ",20);o(this,"MAX_FREQUENCY_HZ",5e3);o(this,"bufferSizeMultiplier",16);o(this,"frequencyPlotHistory",[])}clearHistory(){this.frequencyPlotHistory=[],this.estimatedFrequency=0}setFrequencyEstimationMethod(t){this.frequencyEstimationMethod!==t&&(this.frequencyEstimationMethod=t,this.frequencyPlotHistory=[])}getFrequencyEstimationMethod(){return this.frequencyEstimationMethod}setBufferSizeMultiplier(t){this.bufferSizeMultiplier=t}getBufferSizeMultiplier(){return this.bufferSizeMultiplier}getEstimatedFrequency(){return this.estimatedFrequency}getMinFrequency(){return this.MIN_FREQUENCY_HZ}getMaxFrequency(){return this.MAX_FREQUENCY_HZ}getFrequencyPlotHistory(){return this.frequencyPlotHistory}}function _(a,t){if(typeof a=="string"&&a.endsWith("%")){const e=parseFloat(a);return isNaN(e)?(console.warn(`Invalid percentage value: ${a}, using 0`),0):e<0?(console.warn(`Negative percentage value: ${a}, clamping to 0`),0):Math.floor(t*(e/100))}if(typeof a=="string"){const e=parseInt(a,10);return isNaN(e)?(console.warn(`Invalid numeric string: ${a}, using 0`),0):Math.max(0,e)}return typeof a=="number"?isNaN(a)?(console.warn(`Invalid number value: ${a}, using 0`),0):Math.max(0,Math.floor(a)):0}const Et={fftOverlay:{position:{x:10,y:"65%"},size:{width:"35%",height:"35%"}},harmonicAnalysis:{position:{x:10,y:10},size:{width:500,height:"auto"}},frequencyPlot:{position:{x:"right-10",y:10},size:{width:280,height:120}}};class Ct{constructor(t,e){o(this,"canvas");o(this,"ctx");o(this,"fftDisplayEnabled",!0);o(this,"debugOverlaysEnabled",!0);o(this,"overlaysLayout");o(this,"FFT_OVERLAY_HEIGHT_RATIO",.9);o(this,"FFT_MIN_BAR_WIDTH",1);o(this,"FREQ_PLOT_MIN_RANGE_PADDING_HZ",50);o(this,"FREQ_PLOT_RANGE_PADDING_RATIO",.1);this.canvas=t;const s=t.getContext("2d");if(!s)throw new Error("Could not get 2D context");this.ctx=s,this.overlaysLayout=e||Et,t.width===300&&t.height===150&&console.warn('Canvas element is using default dimensions (300x150). Set explicit width and height attributes on the canvas element to match desired resolution. Example: <canvas id="oscilloscope" width="1800" height="1000"></canvas>')}clearAndDrawGrid(t,e,s){this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.drawGrid(t,e,s)}drawGrid(t,e,s){this.ctx.strokeStyle="#222222",this.ctx.lineWidth=1,this.ctx.beginPath();const n=5;for(let l=0;l<=n;l++){const i=this.canvas.height/n*l;this.ctx.moveTo(0,i),this.ctx.lineTo(this.canvas.width,i)}const r=10;for(let l=0;l<=r;l++){const i=this.canvas.width/r*l;this.ctx.moveTo(i,0),this.ctx.lineTo(i,this.canvas.height)}this.ctx.stroke(),this.ctx.strokeStyle="#444444",this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.moveTo(0,this.canvas.height/2),this.ctx.lineTo(this.canvas.width,this.canvas.height/2),this.ctx.stroke(),t&&t>0&&e&&e>0&&s!==void 0&&s>0&&this.drawGridLabels(t,e,s)}drawGridLabels(t,e,s){this.ctx.save(),this.ctx.font="11px monospace",this.ctx.fillStyle="#666666";const n=e/t*1e3,r=10,l=n/r;for(let f=0;f<=r;f++){const d=this.canvas.width/r*f,u=l*f;let c;u>=1e3?c=`${(u/1e3).toFixed(2)}s`:u>=1?c=`${u.toFixed(1)}ms`:c=`${(u*1e3).toFixed(0)}μs`;const m=this.ctx.measureText(c).width,g=Math.max(2,Math.min(d-m/2,this.canvas.width-m-2));this.ctx.fillText(c,g,this.canvas.height-3)}const i=5,x=1/(i/2*s);for(let f=0;f<=i;f++){const d=this.canvas.height/i*f,c=(i/2-f)*x;let m;if(c===0)m="0dB*";else{const g=yt(Math.abs(c)),E=c>0?"+":"-",v=Math.abs(g);v>=100?m=`${E}${v.toFixed(0)}dB`:m=`${E}${v.toFixed(1)}dB`}this.ctx.fillText(m,3,d+10)}this.ctx.restore()}drawWaveform(t,e,s,n){const r=s-e;if(r<=0)return;this.ctx.strokeStyle="#00ff00",this.ctx.lineWidth=2,this.ctx.beginPath();const l=this.canvas.width/r,i=this.canvas.height/2,x=this.canvas.height/2*n;for(let f=0;f<r;f++){const d=e+f,u=t[d],c=i-u*x,m=Math.min(this.canvas.height,Math.max(0,c)),g=f*l;f===0?this.ctx.moveTo(g,m):this.ctx.lineTo(g,m)}this.ctx.stroke()}drawFFTOverlay(t,e,s,n,r){if(!this.fftDisplayEnabled)return;const l=s/n,i=Math.floor(this.canvas.width*.35),h=Math.floor(this.canvas.height*.35),x=10,f=this.canvas.height-h-10,{x:d,y:u,width:c,height:m}=this.calculateOverlayDimensions(this.overlaysLayout.fftOverlay,x,f,i,h);this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(d,u,c,m),this.ctx.strokeStyle="#00aaff",this.ctx.lineWidth=2,this.ctx.strokeRect(d,u,c,m);const g=Math.min(t.length,Math.ceil(r/l)),E=c/g;this.ctx.fillStyle="#00aaff";for(let v=0;v<g;v++){const T=t[v]/255*m*this.FFT_OVERLAY_HEIGHT_RATIO,F=d+v*E,M=u+m-T;this.ctx.fillRect(F,M,Math.max(E-1,this.FFT_MIN_BAR_WIDTH),T)}if(e>0&&e<=r){const v=e/l,p=d+v*E;this.ctx.strokeStyle="#ff00ff",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(p,u),this.ctx.lineTo(p,u+m),this.ctx.stroke(),this.ctx.fillStyle="#ff00ff",this.ctx.font="bold 12px Arial";const T=`${e.toFixed(1)} Hz`,F=this.ctx.measureText(T).width;let M=p+3;M+F>d+c-5&&(M=p-F-3),this.ctx.fillText(T,M,u+15)}this.ctx.restore()}drawHarmonicAnalysis(t,e,s,n,r,l,i){if(!this.debugOverlaysEnabled||!this.fftDisplayEnabled||t===void 0&&!e&&!s&&!l)return;const h=16,f=(1+(t!==void 0?1:0)+(e?1:0)+(s?1:0)+(l?2:0))*h+10,{x:d,y:u,width:c,height:m}=this.calculateOverlayDimensions(this.overlaysLayout.harmonicAnalysis,10,10,500,f);let g=u;if(this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillRect(d,u,c,m),this.ctx.strokeStyle="#ffaa00",this.ctx.lineWidth=2,this.ctx.strokeRect(d,u,c,m),this.ctx.fillStyle="#ffaa00",this.ctx.font="bold 12px monospace",g+=15,this.ctx.fillText("倍音分析 (Harmonic Analysis)",d+5,g),t!==void 0&&i){g+=h,this.ctx.fillStyle="#00ff00",this.ctx.font="11px monospace";const E=i/2;this.ctx.fillText(`1/2周波数 (${E.toFixed(1)}Hz) のpeak強度: ${t.toFixed(1)}%`,d+5,g)}if(e&&i){g+=h,this.ctx.fillStyle="#ff00ff",this.ctx.font="11px monospace";const E=e.map((p,T)=>`${T+1}x:${p.toFixed(2)}`).join(" "),v=n!==void 0?` (重み付け: ${n.toFixed(1)})`:"";this.ctx.fillText(`候補1 (${i.toFixed(1)}Hz) 倍音: ${E}${v}`,d+5,g)}if(s&&i){g+=h,this.ctx.fillStyle="#00aaff",this.ctx.font="11px monospace";const E=i/2,v=s.map((T,F)=>`${F+1}x:${T.toFixed(2)}`).join(" "),p=r!==void 0?` (重み付け: ${r.toFixed(1)})`:"";this.ctx.fillText(`候補2 (${E.toFixed(1)}Hz) 倍音: ${v}${p}`,d+5,g)}if(l){g+=h,this.ctx.fillStyle="#aaaaaa",this.ctx.font="10px monospace";const E=c-10,v=l.split(" ");let p="";for(const T of v){const F=p+(p?" ":"")+T;this.ctx.measureText(F).width>E&&p?(this.ctx.fillText(p,d+5,g),g+=h,p=T):p=F}p&&this.ctx.fillText(p,d+5,g)}this.ctx.restore()}drawFrequencyPlot(t,e,s){if(!this.debugOverlaysEnabled||!t||t.length===0)return;const{x:n,y:r,width:l,height:i}=this.calculateOverlayDimensions(this.overlaysLayout.frequencyPlot,this.canvas.width-280-10,10,280,120);this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(n,r,l,i),this.ctx.strokeStyle="#ffaa00",this.ctx.lineWidth=2,this.ctx.strokeRect(n,r,l,i),this.ctx.fillStyle="#ffaa00",this.ctx.font="bold 12px Arial",this.ctx.fillText(`周波数推移 (${t.length}frame)`,n+5,r+15);const h=n+35,x=r+25,f=l-45,d=i-45,u=t.filter(y=>y>0);if(u.length===0){this.ctx.restore();return}const c=Math.min(...u),m=Math.max(...u),g=(m-c)*this.FREQ_PLOT_RANGE_PADDING_RATIO||this.FREQ_PLOT_MIN_RANGE_PADDING_HZ,E=Math.max(e,c-g),v=Math.min(s,m+g);this.ctx.strokeStyle="#333333",this.ctx.lineWidth=1,this.ctx.beginPath();for(let y=0;y<=4;y++){const C=x+d/4*y;this.ctx.moveTo(h,C),this.ctx.lineTo(h+f,C)}for(let y=0;y<=4;y++){const C=h+f/4*y;this.ctx.moveTo(C,x),this.ctx.lineTo(C,x+d)}this.ctx.stroke(),this.ctx.fillStyle="#aaaaaa",this.ctx.font="10px monospace",this.ctx.textAlign="right",this.ctx.textBaseline="middle";for(let y=0;y<=4;y++){const C=v-(v-E)*(y/4),S=x+d/4*y,I=C>=1e3?`${(C/1e3).toFixed(1)}k`:`${C.toFixed(0)}`;this.ctx.fillText(I,h-5,S)}this.ctx.fillStyle="#88ccff",this.ctx.font="9px monospace",this.ctx.textAlign="right",this.ctx.textBaseline="middle";for(let y=0;y<=4;y++){const C=v-(v-E)*(y/4),S=x+d/4*y,I=D(C);if(I){const tt=I.cents>=0?"+":"";this.ctx.fillText(`${tt}${I.cents}¢`,h+f-5,S)}}this.ctx.strokeStyle="#00ff00",this.ctx.lineWidth=2,this.ctx.beginPath();const p=f/Math.max(t.length-1,1),T=Math.max(1,Math.floor(t.length/4)),F=y=>{const S=(Math.max(E,Math.min(v,y))-E)/(v-E);return x+d-S*d};let M=!1;for(let y=0;y<t.length;y++){const C=t[y],S=h+y*p;if(C===0){M=!1;continue}const I=F(C);M?this.ctx.lineTo(S,I):(this.ctx.moveTo(S,I),M=!0)}this.ctx.stroke(),this.ctx.font="9px monospace",this.ctx.textAlign="center",this.ctx.textBaseline="top";for(let y=0;y<t.length;y++){const C=t[y],S=h+y*p;if(C!==0){const V=F(C);this.ctx.fillStyle="#00ff00",this.ctx.beginPath(),this.ctx.arc(S,V,2,0,Math.PI*2),this.ctx.fill()}const I=y===t.length-1;if(y%T===0||I){this.ctx.fillStyle="#aaaaaa";const V=y-t.length+1;this.ctx.fillText(`${V}`,S,x+d+2)}}const U=t[t.length-1];if(U>0){const y=D(U);this.ctx.fillStyle="#00ff00",this.ctx.font="bold 11px Arial",this.ctx.textAlign="left",this.ctx.textBaseline="bottom";let C=`${U.toFixed(1)} Hz`;if(y){const S=y.cents>=0?"+":"";C+=` (${y.noteName} ${S}${y.cents}¢)`}this.ctx.fillText(C,h+2,x+d-2)}this.ctx.restore()}drawPhaseMarkers(t,e,s,n,r,l){if(r===void 0||l===void 0)return;const i=l-r;if(i<=0)return;this.ctx.save();const h=(x,f,d)=>{const u=x-r;if(u<0||u>=i)return;const c=u/i*this.canvas.width;this.ctx.strokeStyle=f,this.ctx.lineWidth=d,this.ctx.beginPath(),this.ctx.moveTo(c,0),this.ctx.lineTo(c,this.canvas.height),this.ctx.stroke()};s!==void 0&&h(s,"#ff8800",2),n!==void 0&&h(n,"#ff8800",2),t!==void 0&&h(t,"#ff0000",2),e!==void 0&&h(e,"#ff0000",2),this.ctx.restore()}setFFTDisplay(t){this.fftDisplayEnabled=t}getFFTDisplayEnabled(){return this.fftDisplayEnabled}setDebugOverlaysEnabled(t){this.debugOverlaysEnabled=t}getDebugOverlaysEnabled(){return this.debugOverlaysEnabled}setOverlaysLayout(t){this.overlaysLayout={...this.overlaysLayout,...t}}getOverlaysLayout(){return this.overlaysLayout}calculateOverlayDimensions(t,e,s,n,r){if(!t)return{x:e,y:s,width:n,height:r};let l=e,i=s,h=n,x=r;if(t.position.x!==void 0)if(typeof t.position.x=="string"&&t.position.x.startsWith("right-")){const f=parseInt(t.position.x.substring(6),10),d=typeof t.size.width=="string"&&t.size.width.endsWith("%")?_(t.size.width,this.canvas.width):typeof t.size.width=="number"?t.size.width:n;l=this.canvas.width-d-f}else l=_(t.position.x,this.canvas.width);return t.position.y!==void 0&&(i=_(t.position.y,this.canvas.height)),t.size.width!==void 0&&t.size.width!=="auto"&&(h=_(t.size.width,this.canvas.width)),t.size.height!==void 0&&t.size.height!=="auto"&&(x=_(t.size.height,this.canvas.height)),{x:l,y:i,width:h,height:x}}}class Tt{constructor(){o(this,"usePeakMode",!1);o(this,"zeroCrossMode","hysteresis")}setUsePeakMode(t){this.usePeakMode=t}getUsePeakMode(){return this.usePeakMode}setZeroCrossMode(t){this.zeroCrossMode=t}getZeroCrossMode(){return this.zeroCrossMode}reset(){}}class bt{constructor(){o(this,"previousWaveform",null);o(this,"lastSimilarity",0)}getLastSimilarity(){return this.lastSimilarity}reset(){this.previousWaveform=null,this.lastSimilarity=0}hasPreviousWaveform(){return this.previousWaveform!==null}getPreviousWaveform(){return this.previousWaveform}}class St{constructor(t,e,s,n){o(this,"previousCanvas");o(this,"currentCanvas");o(this,"similarityCanvas");o(this,"bufferCanvas");o(this,"previousCtx");o(this,"currentCtx");o(this,"similarityCtx");o(this,"bufferCtx");o(this,"TARGET_FILL_RATIO",.9);o(this,"MIN_PEAK_THRESHOLD",.001);o(this,"DEFAULT_AMPLITUDE_RATIO",.4);this.previousCanvas=t,this.currentCanvas=e,this.similarityCanvas=s,this.bufferCanvas=n;const r=t.getContext("2d"),l=e.getContext("2d"),i=s.getContext("2d"),h=n.getContext("2d");if(!r||!l||!i||!h)throw new Error("Could not get 2D context for comparison canvases");this.previousCtx=r,this.currentCtx=l,this.similarityCtx=i,this.bufferCtx=h,this.clearAllCanvases()}clearAllCanvases(){this.clearCanvas(this.previousCtx,this.previousCanvas.width,this.previousCanvas.height),this.clearCanvas(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height),this.clearCanvas(this.similarityCtx,this.similarityCanvas.width,this.similarityCanvas.height),this.clearCanvas(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height)}clearCanvas(t,e,s){t.fillStyle="#000000",t.fillRect(0,0,e,s)}findPeakAmplitude(t,e,s){let n=0;const r=Math.max(0,e),l=Math.min(t.length,s);for(let i=r;i<l;i++){const h=Math.abs(t[i]);h>n&&(n=h)}return n}drawWaveform(t,e,s,n,r,l,i){const h=l-r;if(h<=0)return;const x=this.findPeakAmplitude(n,r,l);t.strokeStyle=i,t.lineWidth=1.5,t.beginPath();const f=e/h,d=s/2;let u;if(x>this.MIN_PEAK_THRESHOLD){const c=this.TARGET_FILL_RATIO/x;u=s/2*c}else u=s*this.DEFAULT_AMPLITUDE_RATIO;for(let c=0;c<h;c++){const m=r+c;if(m>=n.length)break;const g=n[m],E=d-g*u,v=Math.min(s,Math.max(0,E)),p=c*f;c===0?t.moveTo(p,v):t.lineTo(p,v)}t.stroke()}drawCenterLine(t,e,s){t.strokeStyle="#444444",t.lineWidth=1,t.beginPath(),t.moveTo(0,s/2),t.lineTo(e,s/2),t.stroke()}drawSimilarityText(t){this.currentCtx.fillStyle="#00aaff",this.currentCtx.font="bold 14px Arial";const e=`Similarity: ${t.toFixed(3)}`,s=this.currentCtx.measureText(e).width,n=(this.currentCanvas.width-s)/2;this.currentCtx.fillText(e,n,20)}drawSimilarityPlot(t){if(!t||t.length===0)return;const e=this.similarityCtx,s=this.similarityCanvas.width,n=this.similarityCanvas.height;e.save(),e.fillStyle="#000000",e.fillRect(0,0,s,n),e.strokeStyle="#00aaff",e.lineWidth=2,e.strokeRect(0,0,s,n),e.fillStyle="#00aaff",e.font="bold 12px Arial",e.fillText("類似度推移 (Similarity)",5,15);const r=40,l=25,i=s-50,h=n-35,x=-1,f=1;e.strokeStyle="#333333",e.lineWidth=1,e.beginPath();for(let c=0;c<=4;c++){const m=l+h/4*c;e.moveTo(r,m),e.lineTo(r+i,m)}for(let c=0;c<=4;c++){const m=r+i/4*c;e.moveTo(m,l),e.lineTo(m,l+h)}e.stroke(),e.fillStyle="#aaaaaa",e.font="10px monospace",e.textAlign="right",e.textBaseline="middle";for(let c=0;c<=4;c++){const m=f-(f-x)*(c/4),g=l+h/4*c,E=m.toFixed(2);e.fillText(E,r-5,g)}e.strokeStyle="#00aaff",e.lineWidth=2,e.beginPath();const d=i/Math.max(t.length-1,1);for(let c=0;c<t.length;c++){const m=t[c],g=r+c*d,v=(Math.max(x,Math.min(f,m))-x)/(f-x),p=l+h-v*h;c===0?e.moveTo(g,p):e.lineTo(g,p)}e.stroke();const u=t[t.length-1];e.fillStyle="#00aaff",e.font="bold 11px Arial",e.textAlign="left",e.textBaseline="bottom",e.fillText(`${u.toFixed(3)}`,r+2,l+h-2),e.restore()}drawPositionMarkers(t,e,s,n,r,l){if(l<=0)return;const i=n/l*e,h=r/l*e;t.strokeStyle="#ff0000",t.lineWidth=2,t.beginPath(),t.moveTo(i,0),t.lineTo(i,s),t.stroke(),t.beginPath(),t.moveTo(h,0),t.lineTo(h,s),t.stroke(),t.fillStyle="#ff0000",t.font="10px Arial",t.fillText("S",i+2,12),t.fillText("E",h+2,12)}updatePanels(t,e,s,n,r,l,i=[]){this.clearAllCanvases(),t&&(this.drawCenterLine(this.previousCtx,this.previousCanvas.width,this.previousCanvas.height),this.drawWaveform(this.previousCtx,this.previousCanvas.width,this.previousCanvas.height,t,0,t.length,"#ffaa00")),this.drawCenterLine(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height),n-s>0&&this.drawWaveform(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height,e,s,n,"#00ff00"),t&&this.drawSimilarityText(l),i.length>0&&this.drawSimilarityPlot(i),this.drawCenterLine(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height),this.drawWaveform(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height,r,0,r.length,"#888888"),this.drawPositionMarkers(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height,s,n,r.length)}clear(){this.clearAllCanvases()}}const Y=class Y{constructor(t,e,s,n,r){o(this,"audioManager");o(this,"gainController");o(this,"frequencyEstimator");o(this,"waveformSearcher");o(this,"zeroCrossDetector");o(this,"wasmProcessor",null);o(this,"isInitialized",!1);o(this,"cachedBasePath",null);this.audioManager=t,this.gainController=e,this.frequencyEstimator=s,this.waveformSearcher=n,this.zeroCrossDetector=r}async initialize(){if(!this.isInitialized){if(typeof window>"u"||window.location.protocol==="file:")throw new Error("WASM module not available in test/non-browser environment");try{await this.loadWasmModule(),this.isInitialized=!0,this.syncConfigToWasm()}catch(t){throw console.error("Failed to initialize WASM module:",t),t}}}async loadWasmModule(){return new Promise((t,e)=>{if(window.wasmProcessor&&window.wasmProcessor.WasmDataProcessor){this.wasmProcessor=new window.wasmProcessor.WasmDataProcessor,t();return}const s=setTimeout(()=>{i(),e(new Error("WASM module loading timed out after 10 seconds"))},1e4),r=`${this.determineBasePath()}wasm/wasm_processor.js`,l=document.createElement("script");l.type="module",l.textContent=`
        import init, { WasmDataProcessor } from '${r}';
        await init();
        window.wasmProcessor = { WasmDataProcessor };
        window.dispatchEvent(new Event('wasmLoaded'));
      `;const i=()=>{clearTimeout(s),window.removeEventListener("wasmLoaded",h)},h=()=>{i(),window.wasmProcessor&&window.wasmProcessor.WasmDataProcessor?(this.wasmProcessor=new window.wasmProcessor.WasmDataProcessor,t()):e(new Error("WASM module loaded but WasmDataProcessor not found"))};window.addEventListener("wasmLoaded",h),l.onerror=()=>{i(),e(new Error("Failed to load WASM module script"))},document.head.appendChild(l)})}determineBasePath(){var e;if(this.cachedBasePath!==null)return this.cachedBasePath;let t=(e=document.querySelector("base"))==null?void 0:e.getAttribute("href");if(t)try{t=new URL(t,window.location.href).pathname}catch{}if(t||(t=this.getBasePathFromScripts()),!t&&window.location.pathname&&window.location.pathname!=="/"){const n=window.location.pathname.split("/").filter(r=>r.length>0);n.length>0&&(t=`/${n[0]}/`)}return t||(t="/"),t.endsWith("/")||(t+="/"),this.cachedBasePath=t,t}getBasePathFromScripts(){const t=document.querySelectorAll("script[src]");for(const e of t){const s=e.getAttribute("src");if(s)try{const r=new URL(s,window.location.href).pathname;for(const l of Y.ASSET_PATTERNS){const i=r.indexOf(l);if(i>=0)return i===0?"/":r.substring(0,i)+"/"}}catch(n){(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&console.debug("Failed to parse script URL:",s,n);continue}}return""}syncConfigToWasm(){this.wasmProcessor&&(this.wasmProcessor.setAutoGain(this.gainController.getAutoGainEnabled()),this.wasmProcessor.setNoiseGate(this.gainController.getNoiseGateEnabled()),this.wasmProcessor.setNoiseGateThreshold(this.gainController.getNoiseGateThreshold()),this.wasmProcessor.setFrequencyEstimationMethod(this.frequencyEstimator.getFrequencyEstimationMethod()),this.wasmProcessor.setBufferSizeMultiplier(this.frequencyEstimator.getBufferSizeMultiplier()),this.wasmProcessor.setZeroCrossMode(this.zeroCrossDetector.getZeroCrossMode()))}syncResultsFromWasm(t){this.frequencyEstimator.estimatedFrequency=t.estimatedFrequency,this.gainController.currentGain=t.gain,t.previousWaveform&&(this.waveformSearcher.previousWaveform=t.previousWaveform),this.waveformSearcher.lastSimilarity=t.similarity}processFrame(t){if(!this.isInitialized||!this.wasmProcessor)return console.warn("WASM processor not initialized"),null;if(!this.audioManager.isReady())return null;const e=this.audioManager.getTimeDomainData();if(!e)return null;const s=this.audioManager.getSampleRate(),n=this.audioManager.getFFTSize(),l=this.frequencyEstimator.getFrequencyEstimationMethod()==="fft"||t?this.audioManager.getFrequencyData():null;this.syncConfigToWasm();const i=this.wasmProcessor.processFrame(e,l,s,n,t);if(!i)return null;const h={waveformData:new Float32Array(i.waveform_data),displayStartIndex:i.displayStartIndex,displayEndIndex:i.displayEndIndex,gain:i.gain,estimatedFrequency:i.estimatedFrequency,frequencyPlotHistory:i.frequencyPlotHistory?Array.from(i.frequencyPlotHistory):[],sampleRate:i.sampleRate,fftSize:i.fftSize,frequencyData:i.frequencyData?new Uint8Array(i.frequencyData):void 0,isSignalAboveNoiseGate:i.isSignalAboveNoiseGate,maxFrequency:i.maxFrequency,previousWaveform:i.previousWaveform?new Float32Array(i.previousWaveform):null,similarity:i.similarity,similarityPlotHistory:i.similarityPlotHistory?Array.from(i.similarityPlotHistory):[],usedSimilaritySearch:i.usedSimilaritySearch,phaseZeroIndex:i.phaseZeroIndex,phaseTwoPiIndex:i.phaseTwoPiIndex,phaseMinusQuarterPiIndex:i.phaseMinusQuarterPiIndex,phaseTwoPiPlusQuarterPiIndex:i.phaseTwoPiPlusQuarterPiIndex,halfFreqPeakStrengthPercent:i.halfFreqPeakStrengthPercent,candidate1Harmonics:i.candidate1Harmonics?Array.from(i.candidate1Harmonics):void 0,candidate2Harmonics:i.candidate2Harmonics?Array.from(i.candidate2Harmonics):void 0,selectionReason:i.selectionReason};return this.syncResultsFromWasm(h),h}reset(){this.wasmProcessor&&this.wasmProcessor.reset()}};o(Y,"ASSET_PATTERNS",["/assets/","/js/","/dist/"]);let Z=Y;class Ft{constructor(t,e,s,n,r,l){o(this,"audioManager");o(this,"gainController");o(this,"frequencyEstimator");o(this,"renderer");o(this,"zeroCrossDetector");o(this,"waveformSearcher");o(this,"comparisonRenderer");o(this,"dataProcessor");o(this,"animationId",null);o(this,"isRunning",!1);o(this,"isPaused",!1);o(this,"lastFrameTime",0);o(this,"frameProcessingTimes",[]);o(this,"MAX_FRAME_TIMES",100);o(this,"TARGET_FRAME_TIME",16.67);o(this,"FPS_LOG_INTERVAL_FRAMES",60);this.audioManager=new vt,this.gainController=new pt,this.frequencyEstimator=new wt,this.renderer=new Ct(t,l),this.zeroCrossDetector=new Tt,this.waveformSearcher=new bt,this.comparisonRenderer=new St(e,s,n,r),this.dataProcessor=new Z(this.audioManager,this.gainController,this.frequencyEstimator,this.waveformSearcher,this.zeroCrossDetector)}async start(){try{await this.dataProcessor.initialize(),await this.audioManager.start(),this.isRunning=!0,this.render()}catch(t){throw console.error("Error starting oscilloscope:",t),t}}async startFromFile(t){try{await this.dataProcessor.initialize(),await this.audioManager.startFromFile(t),this.isRunning=!0,this.render()}catch(e){throw console.error("Error loading audio file:",e),e}}async startFromBuffer(t){try{await this.dataProcessor.initialize(),await this.audioManager.startFromBuffer(t),this.isRunning=!0,this.render()}catch(e){throw console.error("Error starting from buffer:",e),e}}async stop(){this.isRunning=!1,this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null),await this.audioManager.stop(),this.frequencyEstimator.clearHistory(),this.zeroCrossDetector.reset(),this.waveformSearcher.reset(),this.comparisonRenderer.clear(),this.dataProcessor.reset()}render(){if(!this.isRunning)return;const t=performance.now();if(!this.isPaused){const n=this.dataProcessor.processFrame(this.renderer.getFFTDisplayEnabled());n&&this.renderFrame(n)}const s=performance.now()-t;if(this.frameProcessingTimes.push(s),this.frameProcessingTimes.length>this.MAX_FRAME_TIMES&&this.frameProcessingTimes.shift(),s>this.TARGET_FRAME_TIME&&console.warn(`Frame processing time: ${s.toFixed(2)}ms (target: <${this.TARGET_FRAME_TIME}ms)`),this.lastFrameTime>0){const r=1e3/(t-this.lastFrameTime);if(this.frameProcessingTimes.length===this.FPS_LOG_INTERVAL_FRAMES){const l=this.frameProcessingTimes.reduce((i,h)=>i+h,0)/this.frameProcessingTimes.length;console.log(`FPS: ${r.toFixed(1)}, Avg frame time: ${l.toFixed(2)}ms`)}}this.lastFrameTime=t,this.animationId=requestAnimationFrame(()=>this.render())}renderFrame(t){const e=t.displayEndIndex-t.displayStartIndex;this.renderer.clearAndDrawGrid(t.sampleRate,e,t.gain),this.renderer.drawWaveform(t.waveformData,t.displayStartIndex,t.displayEndIndex,t.gain),this.renderer.drawPhaseMarkers(t.phaseZeroIndex,t.phaseTwoPiIndex,t.phaseMinusQuarterPiIndex,t.phaseTwoPiPlusQuarterPiIndex,t.displayStartIndex,t.displayEndIndex),t.frequencyData&&this.renderer.getFFTDisplayEnabled()&&t.isSignalAboveNoiseGate&&(this.renderer.drawFFTOverlay(t.frequencyData,t.estimatedFrequency,t.sampleRate,t.fftSize,t.maxFrequency),this.renderer.drawHarmonicAnalysis(t.halfFreqPeakStrengthPercent,t.candidate1Harmonics,t.candidate2Harmonics,t.candidate1WeightedScore,t.candidate2WeightedScore,t.selectionReason,t.estimatedFrequency)),this.renderer.drawFrequencyPlot(t.frequencyPlotHistory,this.frequencyEstimator.getMinFrequency(),this.frequencyEstimator.getMaxFrequency()),this.comparisonRenderer.updatePanels(t.previousWaveform,t.waveformData,t.displayStartIndex,t.displayEndIndex,t.waveformData,t.similarity,t.similarityPlotHistory)}getIsRunning(){return this.isRunning}setAutoGain(t){this.gainController.setAutoGain(t)}getAutoGainEnabled(){return this.gainController.getAutoGainEnabled()}setNoiseGate(t){this.gainController.setNoiseGate(t)}getNoiseGateEnabled(){return this.gainController.getNoiseGateEnabled()}setNoiseGateThreshold(t){this.gainController.setNoiseGateThreshold(t)}getNoiseGateThreshold(){return this.gainController.getNoiseGateThreshold()}setFrequencyEstimationMethod(t){this.frequencyEstimator.setFrequencyEstimationMethod(t)}getFrequencyEstimationMethod(){return this.frequencyEstimator.getFrequencyEstimationMethod()}setBufferSizeMultiplier(t){this.frequencyEstimator.setBufferSizeMultiplier(t)}getBufferSizeMultiplier(){return this.frequencyEstimator.getBufferSizeMultiplier()}getEstimatedFrequency(){return this.frequencyEstimator.getEstimatedFrequency()}setFFTDisplay(t){this.renderer.setFFTDisplay(t)}getFFTDisplayEnabled(){return this.renderer.getFFTDisplayEnabled()}setDebugOverlaysEnabled(t){this.renderer.setDebugOverlaysEnabled(t)}getDebugOverlaysEnabled(){return this.renderer.getDebugOverlaysEnabled()}setOverlaysLayout(t){this.renderer.setOverlaysLayout(t)}getOverlaysLayout(){return this.renderer.getOverlaysLayout()}getCurrentGain(){return this.gainController.getCurrentGain()}getSimilarityScore(){return this.waveformSearcher.getLastSimilarity()}isSimilaritySearchActive(){return this.waveformSearcher.hasPreviousWaveform()}setUsePeakMode(t){this.zeroCrossDetector.setUsePeakMode(t)}getUsePeakMode(){return this.zeroCrossDetector.getUsePeakMode()}setZeroCrossMode(t){this.zeroCrossDetector.setZeroCrossMode(t)}getZeroCrossMode(){return this.zeroCrossDetector.getZeroCrossMode()}setPauseDrawing(t){this.isPaused=t}getPauseDrawing(){return this.isPaused}}class Mt{constructor(t){o(this,"canvas");o(this,"ctx");o(this,"MIN_FREQ",50);o(this,"MAX_FREQ",2e3);o(this,"WHITE_KEY_WIDTH",20);o(this,"WHITE_KEY_HEIGHT",60);o(this,"BLACK_KEY_WIDTH",12);o(this,"BLACK_KEY_HEIGHT",38);o(this,"WHITE_KEY_COLOR","#ffffff");o(this,"BLACK_KEY_COLOR","#000000");o(this,"WHITE_KEY_HIGHLIGHT","#00ff00");o(this,"BLACK_KEY_HIGHLIGHT","#00cc00");o(this,"KEY_BORDER","#333333");o(this,"WHITE_KEY_NOTES",[0,2,4,5,7,9,11]);o(this,"BLACK_KEY_NOTES",[1,3,6,8,10]);o(this,"keyboardRange");o(this,"xOffset");o(this,"whiteKeyCount");this.canvas=t;const e=t.getContext("2d");if(!e)throw new Error("Could not get 2D context for piano keyboard");this.ctx=e,this.keyboardRange=this.calculateKeyboardRange(),this.whiteKeyCount=this.countWhiteKeys(),this.xOffset=this.calculateCenteringOffset()}frequencyToNoteInfo(t){const e=D(t);if(!e)return{note:-1,octave:-1,noteInOctave:-1};const s=e.noteName.match(/^([A-G]#?)(\d+)$/);if(!s)return{note:-1,octave:-1,noteInOctave:-1};const n=s[1],r=parseInt(s[2],10),i=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"].indexOf(n);return{note:r*12+i,octave:r,noteInOctave:i}}calculateKeyboardRange(){const t=this.frequencyToNoteInfo(this.MIN_FREQ),e=this.frequencyToNoteInfo(this.MAX_FREQ);return{startNote:t.note,endNote:e.note}}countWhiteKeys(){const t=this.keyboardRange;let e=0;for(let s=t.startNote;s<=t.endNote;s++){const n=(s%12+12)%12;this.WHITE_KEY_NOTES.includes(n)&&e++}return e}calculateCenteringOffset(){const t=this.whiteKeyCount*this.WHITE_KEY_WIDTH;return(this.canvas.width-t)/2}render(t){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);const e=this.keyboardRange,s=t>0?this.frequencyToNoteInfo(t):null;let n=0;for(let h=e.startNote;h<=e.endNote;h++){const x=(h%12+12)%12;if(this.WHITE_KEY_NOTES.includes(x)){const f=this.xOffset+n*this.WHITE_KEY_WIDTH,d=s&&s.note===h;this.ctx.fillStyle=d?this.WHITE_KEY_HIGHLIGHT:this.WHITE_KEY_COLOR,this.ctx.fillRect(f,0,this.WHITE_KEY_WIDTH,this.WHITE_KEY_HEIGHT),this.ctx.strokeStyle=this.KEY_BORDER,this.ctx.lineWidth=1,this.ctx.strokeRect(f,0,this.WHITE_KEY_WIDTH,this.WHITE_KEY_HEIGHT),n++}}n=0;for(let h=e.startNote;h<=e.endNote;h++){const x=(h%12+12)%12;if(this.WHITE_KEY_NOTES.includes(x)&&n++,this.BLACK_KEY_NOTES.includes(x)){const f=this.xOffset+n*this.WHITE_KEY_WIDTH-this.BLACK_KEY_WIDTH/2,d=s&&s.note===h;this.ctx.fillStyle=d?this.BLACK_KEY_HIGHLIGHT:this.BLACK_KEY_COLOR,this.ctx.fillRect(f,0,this.BLACK_KEY_WIDTH,this.BLACK_KEY_HEIGHT),this.ctx.strokeStyle=this.KEY_BORDER,this.ctx.lineWidth=1,this.ctx.strokeRect(f,0,this.BLACK_KEY_WIDTH,this.BLACK_KEY_HEIGHT)}}this.ctx.fillStyle="#888888",this.ctx.font="10px monospace",this.ctx.fillText(`${this.MIN_FREQ}Hz`,this.xOffset+5,this.WHITE_KEY_HEIGHT-5);const r=`${this.MAX_FREQ}Hz`,l=this.ctx.measureText(r).width,i=this.xOffset+this.whiteKeyCount*this.WHITE_KEY_WIDTH;this.ctx.fillText(r,i-l-5,this.WHITE_KEY_HEIGHT-5)}clear(){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}}const st=document.getElementById("canvas"),nt=document.getElementById("previousWaveformCanvas"),rt=document.getElementById("currentWaveformCanvas"),ot=document.getElementById("similarityPlotCanvas"),at=document.getElementById("frameBufferCanvas"),lt=document.getElementById("pianoKeyboardCanvas"),b=document.getElementById("startButton"),P=document.getElementById("loadFileButton"),R=document.getElementById("fileInput"),G=document.getElementById("autoGainCheckbox"),q=document.getElementById("noiseGateCheckbox"),O=document.getElementById("fftDisplayCheckbox"),k=document.getElementById("pauseDrawingCheckbox"),N=document.getElementById("noiseGateThreshold"),j=document.getElementById("thresholdValue"),A=document.getElementById("status"),X=document.getElementById("frequencyMethod"),B=document.getElementById("bufferSizeMultiplier"),W=document.getElementById("zeroCrossMode"),z=document.getElementById("frequencyValue"),L=document.getElementById("noteValue"),J=document.getElementById("gainValue"),K=document.getElementById("similarityValue"),It=[{element:st,name:"canvas"},{element:nt,name:"previousWaveformCanvas"},{element:rt,name:"currentWaveformCanvas"},{element:ot,name:"similarityPlotCanvas"},{element:at,name:"frameBufferCanvas"},{element:lt,name:"pianoKeyboardCanvas"},{element:b,name:"startButton"},{element:P,name:"loadFileButton"},{element:R,name:"fileInput"},{element:G,name:"autoGainCheckbox"},{element:q,name:"noiseGateCheckbox"},{element:O,name:"fftDisplayCheckbox"},{element:k,name:"pauseDrawingCheckbox"},{element:N,name:"noiseGateThreshold"},{element:j,name:"thresholdValue"},{element:A,name:"status"},{element:X,name:"frequencyMethod"},{element:B,name:"bufferSizeMultiplier"},{element:W,name:"zeroCrossMode"},{element:z,name:"frequencyValue"},{element:L,name:"noteValue"},{element:J,name:"gainValue"},{element:K,name:"similarityValue"}];for(const{element:a,name:t}of It)if(!a)throw new Error(`Required DOM element not found: ${t}`);function ht(a){const t=parseFloat(a);if(Number.isNaN(t))throw new Error(`Invalid slider value for noise gate threshold: "${a}"`);return{db:t,amplitude:it(t)}}function ct(a,t){return`${a.toFixed(0)} dB (${t.toFixed(3)})`}const w=new Ft(st,nt,rt,ot,at),$=new Mt(lt);$.render(0);b.focus();w.setAutoGain(G.checked);w.setNoiseGate(q.checked);const Q=ht(N.value);w.setNoiseGateThreshold(Q.amplitude);j.textContent=ct(Q.db,Q.amplitude);w.setFFTDisplay(O.checked);w.setPauseDrawing(k.checked);const et=W.value,At=["standard","peak-backtrack-history","bidirectional-nearest","gradient-based","adaptive-step","hysteresis","closest-to-zero"];At.includes(et)&&w.setZeroCrossMode(et);G.addEventListener("change",()=>{w.setAutoGain(G.checked)});q.addEventListener("change",()=>{w.setNoiseGate(q.checked)});O.addEventListener("change",()=>{w.setFFTDisplay(O.checked)});k.addEventListener("change",()=>{w.setPauseDrawing(k.checked)});N.addEventListener("input",()=>{const a=ht(N.value);w.setNoiseGateThreshold(a.amplitude),j.textContent=ct(a.db,a.amplitude)});X.addEventListener("change",()=>{const a=X.value;w.setFrequencyEstimationMethod(a)});B.addEventListener("change",()=>{const a=parseInt(B.value,10);a===1||a===4||a===16?w.setBufferSizeMultiplier(a):(console.error("Invalid buffer size multiplier:",a),B.value="1",w.setBufferSizeMultiplier(1))});W.addEventListener("change",()=>{const a=W.value;["standard","peak-backtrack-history","bidirectional-nearest","gradient-based","adaptive-step","hysteresis","closest-to-zero"].includes(a)?w.setZeroCrossMode(a):(console.error("Invalid zero-cross mode:",a),W.value="hysteresis",w.setZeroCrossMode("hysteresis"))});let H=null;function dt(){H===null&&(H=window.setInterval(()=>{const a=w.getEstimatedFrequency();if(a>0){z.textContent=`${a.toFixed(1)} Hz`;const e=D(a);if(e){const s=e.cents>=0?"+":"";L.textContent=`${e.noteName}${s}${e.cents}cent`}else L.textContent="---";$.render(a)}else z.textContent="--- Hz",L.textContent="---",$.render(0);const t=w.getCurrentGain();if(J.textContent=`${t.toFixed(2)}x`,w.isSimilaritySearchActive()){const e=w.getSimilarityScore();K.textContent=e.toFixed(3)}else K.textContent="---"},100))}function ft(){H!==null&&(clearInterval(H),H=null,z.textContent="--- Hz",L.textContent="---",J.textContent="---x",K.textContent="---",$.clear())}b.addEventListener("click",async()=>{if(w.getIsRunning())try{ft(),await w.stop(),b.textContent="Start",P.disabled=!1,A.textContent="Stopped"}catch(a){console.error("Failed to stop oscilloscope:",a),A.textContent="Stopped (with errors)",b.textContent="Start",P.disabled=!1}else try{b.disabled=!0,P.disabled=!0,A.textContent="Requesting microphone access...",await w.start(),b.textContent="Stop",b.disabled=!1,A.textContent="Running - Microphone active",dt()}catch(a){console.error("Failed to start oscilloscope:",a),A.textContent="Error: Could not access microphone",b.disabled=!1,P.disabled=!1}});P.addEventListener("click",()=>{R.click()});R.addEventListener("change",async()=>{var t;const a=(t=R.files)==null?void 0:t[0];if(a){w.getIsRunning()&&(ft(),await w.stop());try{b.disabled=!0,P.disabled=!0,A.textContent=`Loading file: ${a.name}...`,await w.startFromFile(a),b.textContent="Stop",b.disabled=!1,A.textContent=`Playing: ${a.name} (loop)`,dt()}catch(e){console.error("Failed to load audio file:",e),A.textContent="Error: Could not load audio file",b.textContent="Start",b.disabled=!1,P.disabled=!1}R.value=""}});
//# sourceMappingURL=index-DpwV0Td7.js.map
