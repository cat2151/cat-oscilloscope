{"version":3,"file":"demo-nVUfoJ2K.js","sources":["../../src/BufferSource.ts","../../demo-simple.js"],"sourcesContent":["/**\n * BufferSource provides audio data from a static buffer (Float32Array or AudioBuffer)\n * without requiring audio playback through the Web Audio API.\n * This is useful for visualizing pre-recorded audio data or processing results.\n */\nexport class BufferSource {\n  private buffer: Float32Array;\n  private sampleRate: number;\n  private position: number = 0;\n  private chunkSize: number = 4096; // Default FFT size\n  private isLooping: boolean = false;\n\n  /**\n   * Create a BufferSource from Float32Array\n   * @param buffer - Audio data as Float32Array (values typically in range -1.0 to 1.0)\n   * @param sampleRate - Sample rate in Hz (e.g., 44100, 48000)\n   * @param options - Optional configuration\n   */\n  constructor(\n    buffer: Float32Array,\n    sampleRate: number,\n    options?: {\n      chunkSize?: number;\n      loop?: boolean;\n    }\n  ) {\n    // Validate sample rate\n    if (sampleRate <= 0 || !isFinite(sampleRate)) {\n      throw new Error('Sample rate must be a positive finite number');\n    }\n    \n    this.buffer = buffer;\n    this.sampleRate = sampleRate;\n    \n    if (options?.chunkSize !== undefined) {\n      // Validate chunk size\n      if (options.chunkSize <= 0 || !isFinite(options.chunkSize) || !Number.isInteger(options.chunkSize)) {\n        throw new Error('Chunk size must be a positive integer');\n      }\n      this.chunkSize = options.chunkSize;\n    }\n    \n    if (options?.loop !== undefined) {\n      this.isLooping = options.loop;\n    }\n  }\n\n  /**\n   * Create a BufferSource from AudioBuffer\n   * @param audioBuffer - Web Audio API AudioBuffer\n   * @param options - Optional configuration\n   */\n  static fromAudioBuffer(\n    audioBuffer: AudioBuffer,\n    options?: {\n      chunkSize?: number;\n      loop?: boolean;\n      channel?: number;\n    }\n  ): BufferSource {\n    const channelIndex = options?.channel ?? 0;\n    \n    // Validate channel index\n    if (channelIndex < 0 || channelIndex >= audioBuffer.numberOfChannels) {\n      throw new Error(\n        `Invalid channel index ${channelIndex}. AudioBuffer has ${audioBuffer.numberOfChannels} channel(s).`\n      );\n    }\n    \n    const channelData = audioBuffer.getChannelData(channelIndex);\n    \n    return new BufferSource(channelData, audioBuffer.sampleRate, {\n      chunkSize: options?.chunkSize,\n      loop: options?.loop\n    });\n  }\n\n  /**\n   * Get the next chunk of audio data\n   * @returns Float32Array chunk or null if end is reached and not looping\n   */\n  getNextChunk(): Float32Array | null {\n    // Handle empty buffer case - return null even in loop mode to prevent infinite loop\n    if (this.buffer.length === 0) {\n      return null;\n    }\n    \n    if (this.position >= this.buffer.length) {\n      if (this.isLooping) {\n        this.position = 0;\n      } else {\n        return null;\n      }\n    }\n\n    const endPosition = Math.min(this.position + this.chunkSize, this.buffer.length);\n    const chunk = this.buffer.slice(this.position, endPosition);\n    \n    // If chunk is smaller than chunkSize and we're looping, wrap around\n    if (chunk.length < this.chunkSize && this.isLooping) {\n      const remaining = this.chunkSize - chunk.length;\n      // Ensure we don't try to read more than buffer length when wrapping\n      const wrapAmount = Math.min(remaining, this.buffer.length);\n      const wrappedChunk = new Float32Array(this.chunkSize);\n      wrappedChunk.set(chunk, 0);\n      wrappedChunk.set(this.buffer.slice(0, wrapAmount), chunk.length);\n      this.position = wrapAmount;\n      return wrappedChunk;\n    }\n    \n    this.position = endPosition;\n    \n    // If chunk is smaller than expected and we're not looping, pad with zeros\n    if (chunk.length < this.chunkSize) {\n      const paddedChunk = new Float32Array(this.chunkSize);\n      paddedChunk.set(chunk, 0);\n      return paddedChunk;\n    }\n    \n    return chunk;\n  }\n\n  /**\n   * Reset playback position to the beginning\n   */\n  reset(): void {\n    this.position = 0;\n  }\n\n  /**\n   * Seek to a specific position in the buffer\n   * @param positionInSamples - Position in samples\n   */\n  seek(positionInSamples: number): void {\n    this.position = Math.max(0, Math.min(positionInSamples, this.buffer.length));\n  }\n\n  /**\n   * Get current position in samples\n   */\n  getPosition(): number {\n    return this.position;\n  }\n\n  /**\n   * Get total buffer length in samples\n   */\n  getLength(): number {\n    return this.buffer.length;\n  }\n\n  /**\n   * Get sample rate\n   */\n  getSampleRate(): number {\n    return this.sampleRate;\n  }\n\n  /**\n   * Set chunk size\n   */\n  setChunkSize(size: number): void {\n    // Validate chunk size\n    if (size <= 0 || !isFinite(size) || !Number.isInteger(size)) {\n      throw new Error('Chunk size must be a positive integer');\n    }\n    this.chunkSize = size;\n  }\n\n  /**\n   * Get chunk size\n   */\n  getChunkSize(): number {\n    return this.chunkSize;\n  }\n\n  /**\n   * Set looping mode\n   */\n  setLooping(loop: boolean): void {\n    this.isLooping = loop;\n  }\n\n  /**\n   * Get looping mode\n   */\n  isLoop(): boolean {\n    return this.isLooping;\n  }\n\n  /**\n   * Check if end of buffer is reached\n   */\n  isAtEnd(): boolean {\n    return this.position >= this.buffer.length && !this.isLooping;\n  }\n}\n","// ライブラリとしてインポート（install from github と同じパターン）\n// 外部プロジェクトでの利用方法:\n//   npm install git+https://github.com/cat2151/cat-oscilloscope.git\n//   import { Oscilloscope, BufferSource } from 'cat-oscilloscope';\nimport { Oscilloscope, BufferSource } from 'cat-oscilloscope';\n\n// Canvas要素とUI要素を取得\nconst canvas = document.getElementById('oscilloscope');\nconst startBtn = document.getElementById('startBtn');\nconst stopBtn = document.getElementById('stopBtn');\nconst statusElement = document.getElementById('status');\nconst frequencyElement = document.getElementById('frequency');\nconst gainElement = document.getElementById('gain');\nconst waveformRadios = document.querySelectorAll('input[name=\"waveform\"]');\n\n// Oscilloscopeインスタンスを作成（簡易版なので比較パネル用のcanvasは隠しcanvasを使用）\nconst hiddenCanvas = document.createElement('canvas');\nhiddenCanvas.width = 250;\nhiddenCanvas.height = 120;\n\nconst oscilloscope = new Oscilloscope(\n  canvas,\n  hiddenCanvas,  // previousWaveformCanvas\n  hiddenCanvas,  // currentWaveformCanvas\n  hiddenCanvas,  // similarityPlotCanvas\n  hiddenCanvas   // frameBufferCanvas\n);\n\n// デバッグオーバーレイを無効化（シンプルな表示にするため）\noscilloscope.setDebugOverlaysEnabled(false);\n\n// 周波数とゲイン表示の更新\nlet updateInterval = null;\n\nfunction startUpdates() {\n  updateInterval = setInterval(() => {\n    const freq = oscilloscope.getEstimatedFrequency();\n    frequencyElement.textContent = freq > 0 ? `${freq.toFixed(1)} Hz` : '--- Hz';\n    \n    const gain = oscilloscope.getCurrentGain();\n    gainElement.textContent = `${gain.toFixed(2)}x`;\n  }, 100);\n}\n\nfunction stopUpdates() {\n  if (updateInterval) {\n    clearInterval(updateInterval);\n    updateInterval = null;\n  }\n  frequencyElement.textContent = '--- Hz';\n  gainElement.textContent = '---x';\n}\n\n// 波形データを生成する関数\nfunction generateWaveform(type, sampleRate = 44100, duration = 1) {\n  const audioData = new Float32Array(sampleRate * duration);\n  const len = audioData.length;\n  \n  switch(type) {\n    case '440':\n      // 440Hz サイン波\n      for (let i = 0; i < len; i++) {\n        audioData[i] = Math.sin(2 * Math.PI * 440 * i / sampleRate);\n      }\n      break;\n    case '880':\n      // 880Hz サイン波\n      for (let i = 0; i < len; i++) {\n        audioData[i] = Math.sin(2 * Math.PI * 880 * i / sampleRate);\n      }\n      break;\n    case '220':\n      // 220Hz サイン波\n      for (let i = 0; i < len; i++) {\n        audioData[i] = Math.sin(2 * Math.PI * 220 * i / sampleRate);\n      }\n      break;\n    case 'complex':\n      // 複合波形（440Hz + 880Hz）\n      for (let i = 0; i < len; i++) {\n        audioData[i] = 0.5 * Math.sin(2 * Math.PI * 440 * i / sampleRate) +\n                      0.3 * Math.sin(2 * Math.PI * 880 * i / sampleRate);\n      }\n      break;\n  }\n  \n  return audioData;\n}\n\n// 開始処理を実行する関数\nasync function startOscilloscope() {\n  try {\n    startBtn.disabled = true;\n    statusElement.textContent = '初期化中...';\n    \n    // 選択された波形タイプを取得\n    const selectedElement = document.querySelector('input[name=\"waveform\"]:checked');\n    if (!selectedElement) {\n      throw new Error('波形が選択されていません');\n    }\n    const selectedWaveform = selectedElement.value;\n    \n    // 波形データを生成\n    const sampleRate = 44100;\n    const audioData = generateWaveform(selectedWaveform, sampleRate, 1);\n    \n    // BufferSourceを作成してループ再生\n    const bufferSource = new BufferSource(audioData, sampleRate, { loop: true });\n    \n    // 可視化を開始\n    await oscilloscope.startFromBuffer(bufferSource);\n    \n    statusElement.textContent = '実行中';\n    stopBtn.disabled = false;\n    startUpdates();\n    \n    // ラジオボタンを無効化（実行中は変更不可）\n    waveformRadios.forEach(radio => radio.disabled = true);\n  } catch (error) {\n    console.error('Failed to start oscilloscope:', error);\n    statusElement.textContent = 'エラー';\n    startBtn.disabled = false;\n  }\n}\n\n// 開始ボタン\nstartBtn.addEventListener('click', startOscilloscope);\n\n// 停止ボタン\nstopBtn.addEventListener('click', async () => {\n  try {\n    await oscilloscope.stop();\n    \n    statusElement.textContent = '停止';\n    startBtn.disabled = false;\n    stopBtn.disabled = true;\n    stopUpdates();\n    \n    // ラジオボタンを有効化\n    waveformRadios.forEach(radio => radio.disabled = false);\n  } catch (error) {\n    console.error('Failed to stop oscilloscope:', error);\n  }\n});\n\n// ページロード時に自動的に440Hzで開始（デバッグ用）\n// DOMContentLoadedイベントが既に発火している可能性を考慮\nif (document.readyState === 'loading') {\n  // まだDOMがロード中の場合はイベントリスナーを設定\n  document.addEventListener('DOMContentLoaded', () => {\n    console.log('Auto-starting oscilloscope with 440Hz...');\n    startOscilloscope();\n  });\n} else {\n  // DOMが既にロード済みの場合は即座に実行\n  console.log('Auto-starting oscilloscope with 440Hz...');\n  startOscilloscope();\n}\n"],"names":["BufferSource","buffer","sampleRate","options","__publicField","audioBuffer","channelIndex","channelData","endPosition","chunk","remaining","wrapAmount","wrappedChunk","paddedChunk","positionInSamples","size","loop","canvas","startBtn","stopBtn","statusElement","frequencyElement","gainElement","waveformRadios","hiddenCanvas","oscilloscope","Oscilloscope","updateInterval","startUpdates","freq","gain","stopUpdates","generateWaveform","type","duration","audioData","len","startOscilloscope","selectedElement","selectedWaveform","bufferSource","radio","error"],"mappings":"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"}