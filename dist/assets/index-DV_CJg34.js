var lt=Object.defineProperty;var ct=(l,t,e)=>t in l?lt(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var a=(l,t,e)=>ct(l,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();function Z(l){return Math.pow(10,l/20)}function ht(l){return l<=0?-1/0:20*Math.log10(l)}function R(l){if(l<=0||!isFinite(l))return null;const e=440*Math.pow(2,-4.75),i=12*Math.log2(l/e),n=Math.round(i),r=Math.round((i-n)*100),o=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],s=Math.floor(n/12);return{noteName:`${o[(n%12+12)%12]}${s}`,cents:r}}const ut=-48;function ft(l){const t=l.numberOfChannels,e=l.sampleRate,i=l.length,n=[];let r=0;for(let m=0;m<t;m++){const x=l.getChannelData(m);n.push(x);for(let c=0;c<i;c++){const u=Math.abs(x[c]);u>r&&(r=u)}}if(r===0)return l;const o=r*Math.pow(10,ut/20);let s=i;for(let m=0;m<i;m++){let x=!0;for(let c=0;c<t;c++)if(Math.abs(n[c][m])>o){x=!1;break}if(!x){s=m;break}}if(s>=i)return l;let h=i-1;for(let m=i-1;m>=s;m--){let x=!0;for(let c=0;c<t;c++)if(Math.abs(n[c][m])>o){x=!1;break}if(!x){h=m;break}}if(s===0&&h===i-1)return l;const y=h-s+1,f=new AudioBuffer({numberOfChannels:t,length:y,sampleRate:e});for(let m=0;m<t;m++){const x=n[m],c=f.getChannelData(m);for(let u=0;u<y;u++)c[u]=x[s+u]}return f}class dt{constructor(){a(this,"audioContext",null);a(this,"analyser",null);a(this,"mediaStream",null);a(this,"audioBufferSource",null);a(this,"bufferSource",null);a(this,"dataArray",null);a(this,"frequencyData",null);a(this,"frameBufferHistory",[]);a(this,"MAX_FRAME_HISTORY",16)}initializeAnalyser(){if(!this.audioContext)throw new Error("AudioContext must be initialized before creating analyser");this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=4096,this.analyser.smoothingTimeConstant=0;const t=this.analyser.fftSize;this.dataArray=new Float32Array(t),this.frequencyData=new Uint8Array(this.analyser.frequencyBinCount)}async start(){try{this.mediaStream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.audioContext=new AudioContext;const t=this.audioContext.createMediaStreamSource(this.mediaStream);this.initializeAnalyser(),t.connect(this.analyser)}catch(t){throw console.error("Error accessing microphone:",t),t}}async startFromFile(t){try{const e=await t.arrayBuffer();this.audioContext&&this.audioContext.state!=="closed"&&await this.audioContext.close(),this.audioContext=new AudioContext;let i=await this.audioContext.decodeAudioData(e);i=ft(i),this.initializeAnalyser(),this.audioBufferSource=this.audioContext.createBufferSource(),this.audioBufferSource.buffer=i,this.audioBufferSource.loop=!0,this.audioBufferSource.connect(this.analyser),this.analyser.connect(this.audioContext.destination),this.audioBufferSource.start(0)}catch(e){throw console.error("Error loading audio file:",e),e}}async startFromBuffer(t){try{this.audioContext&&this.audioContext.state!=="closed"&&await this.audioContext.close(),this.audioContext=null,this.bufferSource=t,this.bufferSource.setChunkSize(4096),this.dataArray=new Float32Array(4096),this.frequencyData=new Uint8Array(2048)}catch(e){throw console.error("Error starting from buffer:",e),e}}async stop(){if(this.audioBufferSource){try{this.audioBufferSource.stop()}catch{}try{this.audioBufferSource.disconnect()}catch{}this.audioBufferSource=null}if(this.mediaStream&&(this.mediaStream.getTracks().forEach(t=>t.stop()),this.mediaStream=null),this.bufferSource&&(this.bufferSource.reset(),this.bufferSource=null),this.audioContext){try{await this.audioContext.close()}catch(t){console.error("Error closing AudioContext:",t)}this.audioContext=null}this.analyser=null,this.dataArray=null,this.frequencyData=null,this.clearFrameBufferHistory()}getTimeDomainData(){if(this.bufferSource&&this.dataArray){const t=this.bufferSource.getNextChunk();return t?(this.dataArray.set(t),this.updateFrameBufferHistory(this.dataArray),this.dataArray):null}return!this.analyser||!this.dataArray?null:(this.analyser.getFloatTimeDomainData(this.dataArray),this.updateFrameBufferHistory(this.dataArray),this.dataArray)}updateFrameBufferHistory(t){let e;this.frameBufferHistory.length<this.MAX_FRAME_HISTORY?e=new Float32Array(t.length):(e=this.frameBufferHistory.shift(),e.length!==t.length&&(e=new Float32Array(t.length))),e.set(t),this.frameBufferHistory.push(e)}getExtendedTimeDomainData(t){if(t===1)return this.dataArray;if(!this.dataArray||this.frameBufferHistory.length<t)return null;const e=this.frameBufferHistory.slice(-t),i=e.reduce((o,s)=>o+s.length,0),n=new Float32Array(i);let r=0;for(const o of e)n.set(o,r),r+=o.length;return n}clearFrameBufferHistory(){this.frameBufferHistory=[]}getFrequencyData(){return this.bufferSource&&this.dataArray&&this.frequencyData||!this.analyser||!this.frequencyData?null:(this.analyser.getByteFrequencyData(this.frequencyData),this.frequencyData)}getSampleRate(){var t;return this.bufferSource?this.bufferSource.getSampleRate():((t=this.audioContext)==null?void 0:t.sampleRate)||0}getFFTSize(){var t;return this.bufferSource?4096:((t=this.analyser)==null?void 0:t.fftSize)||0}getFrequencyBinCount(){var t;return this.bufferSource?2048:((t=this.analyser)==null?void 0:t.frequencyBinCount)||0}isReady(){return this.bufferSource?this.dataArray!==null:this.audioContext!==null&&this.analyser!==null}}class mt{constructor(){a(this,"autoGainEnabled",!0);a(this,"currentGain",1);a(this,"noiseGateEnabled",!0);a(this,"noiseGateThreshold",Z(-60))}setAutoGain(t){this.autoGainEnabled=t}getAutoGainEnabled(){return this.autoGainEnabled}setNoiseGate(t){this.noiseGateEnabled=t}getNoiseGateEnabled(){return this.noiseGateEnabled}setNoiseGateThreshold(t){this.noiseGateThreshold=Math.min(Math.max(t,0),1)}getNoiseGateThreshold(){return this.noiseGateThreshold}getCurrentGain(){return this.currentGain}}class yt{constructor(){a(this,"frequencyEstimationMethod","fft");a(this,"estimatedFrequency",0);a(this,"MIN_FREQUENCY_HZ",20);a(this,"MAX_FREQUENCY_HZ",5e3);a(this,"bufferSizeMultiplier",16);a(this,"frequencyPlotHistory",[])}clearHistory(){this.frequencyPlotHistory=[],this.estimatedFrequency=0}setFrequencyEstimationMethod(t){this.frequencyEstimationMethod!==t&&(this.frequencyEstimationMethod=t,this.frequencyPlotHistory=[])}getFrequencyEstimationMethod(){return this.frequencyEstimationMethod}setBufferSizeMultiplier(t){this.bufferSizeMultiplier=t}getBufferSizeMultiplier(){return this.bufferSizeMultiplier}getEstimatedFrequency(){return this.estimatedFrequency}getMinFrequency(){return this.MIN_FREQUENCY_HZ}getMaxFrequency(){return this.MAX_FREQUENCY_HZ}getFrequencyPlotHistory(){return this.frequencyPlotHistory}}class xt{constructor(t){a(this,"canvas");a(this,"ctx");a(this,"fftDisplayEnabled",!0);a(this,"FFT_OVERLAY_HEIGHT_RATIO",.9);a(this,"FFT_MIN_BAR_WIDTH",1);a(this,"FREQ_PLOT_WIDTH",280);a(this,"FREQ_PLOT_HEIGHT",120);a(this,"FREQ_PLOT_PADDING",10);a(this,"FREQ_PLOT_MIN_RANGE_PADDING_HZ",50);a(this,"FREQ_PLOT_RANGE_PADDING_RATIO",.1);this.canvas=t;const e=t.getContext("2d");if(!e)throw new Error("Could not get 2D context");this.ctx=e}clearAndDrawGrid(t,e,i){this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.drawGrid(t,e,i)}drawGrid(t,e,i){this.ctx.strokeStyle="#222222",this.ctx.lineWidth=1,this.ctx.beginPath();const n=5;for(let o=0;o<=n;o++){const s=this.canvas.height/n*o;this.ctx.moveTo(0,s),this.ctx.lineTo(this.canvas.width,s)}const r=10;for(let o=0;o<=r;o++){const s=this.canvas.width/r*o;this.ctx.moveTo(s,0),this.ctx.lineTo(s,this.canvas.height)}this.ctx.stroke(),this.ctx.strokeStyle="#444444",this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.moveTo(0,this.canvas.height/2),this.ctx.lineTo(this.canvas.width,this.canvas.height/2),this.ctx.stroke(),t&&t>0&&e&&e>0&&i!==void 0&&i>0&&this.drawGridLabels(t,e,i)}drawGridLabels(t,e,i){this.ctx.save(),this.ctx.font="11px monospace",this.ctx.fillStyle="#666666";const n=e/t*1e3,r=10,o=n/r;for(let f=0;f<=r;f++){const m=this.canvas.width/r*f,x=o*f;let c;x>=1e3?c=`${(x/1e3).toFixed(2)}s`:x>=1?c=`${x.toFixed(1)}ms`:c=`${(x*1e3).toFixed(0)}μs`;const u=this.ctx.measureText(c).width,g=Math.max(2,Math.min(m-u/2,this.canvas.width-u-2));this.ctx.fillText(c,g,this.canvas.height-3)}const s=5,y=1/(s/2*i);for(let f=0;f<=s;f++){const m=this.canvas.height/s*f,c=(s/2-f)*y;let u;if(c===0)u="0dB*";else{const g=ht(Math.abs(c)),T=c>0?"+":"-",v=Math.abs(g);v>=100?u=`${T}${v.toFixed(0)}dB`:u=`${T}${v.toFixed(1)}dB`}this.ctx.fillText(u,3,m+10)}this.ctx.restore()}drawWaveform(t,e,i,n){const r=i-e;if(r<=0)return;this.ctx.strokeStyle="#00ff00",this.ctx.lineWidth=2,this.ctx.beginPath();const o=this.canvas.width/r,s=this.canvas.height/2,y=this.canvas.height/2*n;for(let f=0;f<r;f++){const m=e+f,x=t[m],c=s-x*y,u=Math.min(this.canvas.height,Math.max(0,c)),g=f*o;f===0?this.ctx.moveTo(g,u):this.ctx.lineTo(g,u)}this.ctx.stroke()}drawFFTOverlay(t,e,i,n,r){if(!this.fftDisplayEnabled)return;const o=i/n,s=Math.floor(this.canvas.width*.35),h=Math.floor(this.canvas.height*.35),y=10,f=this.canvas.height-h-10;this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(y,f,s,h),this.ctx.strokeStyle="#00aaff",this.ctx.lineWidth=2,this.ctx.strokeRect(y,f,s,h);const m=Math.min(t.length,Math.ceil(r/o)),x=s/m;this.ctx.fillStyle="#00aaff";for(let c=0;c<m;c++){const g=t[c]/255*h*this.FFT_OVERLAY_HEIGHT_RATIO,T=y+c*x,v=f+h-g;this.ctx.fillRect(T,v,Math.max(x-1,this.FFT_MIN_BAR_WIDTH),g)}if(e>0&&e<=r){const c=e/o,u=y+c*x;this.ctx.strokeStyle="#ff00ff",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(u,f),this.ctx.lineTo(u,f+h),this.ctx.stroke(),this.ctx.fillStyle="#ff00ff",this.ctx.font="bold 12px Arial";const g=`${e.toFixed(1)} Hz`,T=this.ctx.measureText(g).width;let v=u+3;v+T>y+s-5&&(v=u-T-3),this.ctx.fillText(g,v,f+15)}this.ctx.restore()}drawFrequencyPlot(t,e,i){if(!t||t.length===0)return;const n=this.canvas.width-this.FREQ_PLOT_WIDTH-this.FREQ_PLOT_PADDING,r=this.FREQ_PLOT_PADDING;this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(n,r,this.FREQ_PLOT_WIDTH,this.FREQ_PLOT_HEIGHT),this.ctx.strokeStyle="#ffaa00",this.ctx.lineWidth=2,this.ctx.strokeRect(n,r,this.FREQ_PLOT_WIDTH,this.FREQ_PLOT_HEIGHT),this.ctx.fillStyle="#ffaa00",this.ctx.font="bold 12px Arial",this.ctx.fillText(`周波数推移 (${t.length}frame)`,n+5,r+15);const o=n+35,s=r+25,h=this.FREQ_PLOT_WIDTH-45,y=this.FREQ_PLOT_HEIGHT-45,f=t.filter(d=>d>0);if(f.length===0){this.ctx.restore();return}const m=Math.min(...f),x=Math.max(...f),c=(x-m)*this.FREQ_PLOT_RANGE_PADDING_RATIO||this.FREQ_PLOT_MIN_RANGE_PADDING_HZ,u=Math.max(e,m-c),g=Math.min(i,x+c);this.ctx.strokeStyle="#333333",this.ctx.lineWidth=1,this.ctx.beginPath();for(let d=0;d<=4;d++){const p=s+y/4*d;this.ctx.moveTo(o,p),this.ctx.lineTo(o+h,p)}for(let d=0;d<=4;d++){const p=o+h/4*d;this.ctx.moveTo(p,s),this.ctx.lineTo(p,s+y)}this.ctx.stroke(),this.ctx.fillStyle="#aaaaaa",this.ctx.font="10px monospace",this.ctx.textAlign="right",this.ctx.textBaseline="middle";for(let d=0;d<=4;d++){const p=g-(g-u)*(d/4),C=s+y/4*d,F=p>=1e3?`${(p/1e3).toFixed(1)}k`:`${p.toFixed(0)}`;this.ctx.fillText(F,o-5,C)}this.ctx.fillStyle="#88ccff",this.ctx.font="9px monospace",this.ctx.textAlign="right",this.ctx.textBaseline="middle";for(let d=0;d<=4;d++){const p=g-(g-u)*(d/4),C=s+y/4*d,F=R(p);if(F){const V=F.cents>=0?"+":"";this.ctx.fillText(`${V}${F.cents}¢`,o+h-5,C)}}this.ctx.strokeStyle="#00ff00",this.ctx.lineWidth=2,this.ctx.beginPath();const T=h/Math.max(t.length-1,1),v=Math.max(1,Math.floor(t.length/4)),b=d=>{const C=(Math.max(u,Math.min(g,d))-u)/(g-u);return s+y-C*y};let O=!1;for(let d=0;d<t.length;d++){const p=t[d],C=o+d*T;if(p===0){O=!1;continue}const F=b(p);O?this.ctx.lineTo(C,F):(this.ctx.moveTo(C,F),O=!0)}this.ctx.stroke(),this.ctx.font="9px monospace",this.ctx.textAlign="center",this.ctx.textBaseline="top";for(let d=0;d<t.length;d++){const p=t[d],C=o+d*T;if(p!==0){const z=b(p);this.ctx.fillStyle="#00ff00",this.ctx.beginPath(),this.ctx.arc(C,z,2,0,Math.PI*2),this.ctx.fill()}const F=d===t.length-1;if(d%v===0||F){this.ctx.fillStyle="#aaaaaa";const z=d-t.length+1;this.ctx.fillText(`${z}`,C,s+y+2)}}const K=t[t.length-1];if(K>0){const d=R(K);this.ctx.fillStyle="#00ff00",this.ctx.font="bold 11px Arial",this.ctx.textAlign="left",this.ctx.textBaseline="bottom";let p=`${K.toFixed(1)} Hz`;if(d){const C=d.cents>=0?"+":"";p+=` (${d.noteName} ${C}${d.cents}¢)`}this.ctx.fillText(p,o+2,s+y-2)}this.ctx.restore()}setFFTDisplay(t){this.fftDisplayEnabled=t}getFFTDisplayEnabled(){return this.fftDisplayEnabled}}class gt{constructor(){a(this,"usePeakMode",!1)}setUsePeakMode(t){this.usePeakMode=t}getUsePeakMode(){return this.usePeakMode}reset(){}}class Et{constructor(){a(this,"previousWaveform",null);a(this,"lastSimilarity",0)}getLastSimilarity(){return this.lastSimilarity}reset(){this.previousWaveform=null,this.lastSimilarity=0}hasPreviousWaveform(){return this.previousWaveform!==null}getPreviousWaveform(){return this.previousWaveform}}class pt{constructor(t,e,i,n){a(this,"previousCanvas");a(this,"currentCanvas");a(this,"similarityCanvas");a(this,"bufferCanvas");a(this,"previousCtx");a(this,"currentCtx");a(this,"similarityCtx");a(this,"bufferCtx");a(this,"TARGET_FILL_RATIO",.9);a(this,"MIN_PEAK_THRESHOLD",.001);a(this,"DEFAULT_AMPLITUDE_RATIO",.4);this.previousCanvas=t,this.currentCanvas=e,this.similarityCanvas=i,this.bufferCanvas=n;const r=t.getContext("2d"),o=e.getContext("2d"),s=i.getContext("2d"),h=n.getContext("2d");if(!r||!o||!s||!h)throw new Error("Could not get 2D context for comparison canvases");this.previousCtx=r,this.currentCtx=o,this.similarityCtx=s,this.bufferCtx=h,this.clearAllCanvases()}clearAllCanvases(){this.clearCanvas(this.previousCtx,this.previousCanvas.width,this.previousCanvas.height),this.clearCanvas(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height),this.clearCanvas(this.similarityCtx,this.similarityCanvas.width,this.similarityCanvas.height),this.clearCanvas(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height)}clearCanvas(t,e,i){t.fillStyle="#000000",t.fillRect(0,0,e,i)}findPeakAmplitude(t,e,i){let n=0;const r=Math.max(0,e),o=Math.min(t.length,i);for(let s=r;s<o;s++){const h=Math.abs(t[s]);h>n&&(n=h)}return n}drawWaveform(t,e,i,n,r,o,s){const h=o-r;if(h<=0)return;const y=this.findPeakAmplitude(n,r,o);t.strokeStyle=s,t.lineWidth=1.5,t.beginPath();const f=e/h,m=i/2;let x;if(y>this.MIN_PEAK_THRESHOLD){const c=this.TARGET_FILL_RATIO/y;x=i/2*c}else x=i*this.DEFAULT_AMPLITUDE_RATIO;for(let c=0;c<h;c++){const u=r+c;if(u>=n.length)break;const g=n[u],T=m-g*x,v=Math.min(i,Math.max(0,T)),b=c*f;c===0?t.moveTo(b,v):t.lineTo(b,v)}t.stroke()}drawCenterLine(t,e,i){t.strokeStyle="#444444",t.lineWidth=1,t.beginPath(),t.moveTo(0,i/2),t.lineTo(e,i/2),t.stroke()}drawSimilarityText(t){this.currentCtx.fillStyle="#00aaff",this.currentCtx.font="bold 14px Arial";const e=`Similarity: ${t.toFixed(3)}`,i=this.currentCtx.measureText(e).width,n=(this.currentCanvas.width-i)/2;this.currentCtx.fillText(e,n,20)}drawSimilarityPlot(t){if(!t||t.length===0)return;const e=this.similarityCtx,i=this.similarityCanvas.width,n=this.similarityCanvas.height;e.save(),e.fillStyle="#000000",e.fillRect(0,0,i,n),e.strokeStyle="#00aaff",e.lineWidth=2,e.strokeRect(0,0,i,n),e.fillStyle="#00aaff",e.font="bold 12px Arial",e.fillText("類似度推移 (Similarity)",5,15);const r=40,o=25,s=i-50,h=n-35,y=-1,f=1;e.strokeStyle="#333333",e.lineWidth=1,e.beginPath();for(let c=0;c<=4;c++){const u=o+h/4*c;e.moveTo(r,u),e.lineTo(r+s,u)}for(let c=0;c<=4;c++){const u=r+s/4*c;e.moveTo(u,o),e.lineTo(u,o+h)}e.stroke(),e.fillStyle="#aaaaaa",e.font="10px monospace",e.textAlign="right",e.textBaseline="middle";for(let c=0;c<=4;c++){const u=f-(f-y)*(c/4),g=o+h/4*c,T=u.toFixed(2);e.fillText(T,r-5,g)}e.strokeStyle="#00aaff",e.lineWidth=2,e.beginPath();const m=s/Math.max(t.length-1,1);for(let c=0;c<t.length;c++){const u=t[c],g=r+c*m,v=(Math.max(y,Math.min(f,u))-y)/(f-y),b=o+h-v*h;c===0?e.moveTo(g,b):e.lineTo(g,b)}e.stroke();const x=t[t.length-1];e.fillStyle="#00aaff",e.font="bold 11px Arial",e.textAlign="left",e.textBaseline="bottom",e.fillText(`${x.toFixed(3)}`,r+2,o+h-2),e.restore()}drawPositionMarkers(t,e,i,n,r,o){if(o<=0)return;const s=n/o*e,h=r/o*e;t.strokeStyle="#ff0000",t.lineWidth=2,t.beginPath(),t.moveTo(s,0),t.lineTo(s,i),t.stroke(),t.beginPath(),t.moveTo(h,0),t.lineTo(h,i),t.stroke(),t.fillStyle="#ff0000",t.font="10px Arial",t.fillText("S",s+2,12),t.fillText("E",h+2,12)}updatePanels(t,e,i,n,r,o,s=[]){this.clearAllCanvases(),t&&(this.drawCenterLine(this.previousCtx,this.previousCanvas.width,this.previousCanvas.height),this.drawWaveform(this.previousCtx,this.previousCanvas.width,this.previousCanvas.height,t,0,t.length,"#ffaa00")),this.drawCenterLine(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height),n-i>0&&this.drawWaveform(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height,e,i,n,"#00ff00"),t&&this.drawSimilarityText(o),s.length>0&&this.drawSimilarityPlot(s),this.drawCenterLine(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height),this.drawWaveform(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height,r,0,r.length,"#888888"),this.drawPositionMarkers(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height,i,n,r.length)}clear(){this.clearAllCanvases()}}const k=class k{constructor(t,e,i,n){a(this,"audioManager");a(this,"gainController");a(this,"frequencyEstimator");a(this,"waveformSearcher");a(this,"wasmProcessor",null);a(this,"isInitialized",!1);a(this,"cachedBasePath",null);this.audioManager=t,this.gainController=e,this.frequencyEstimator=i,this.waveformSearcher=n}async initialize(){if(!this.isInitialized){if(typeof window>"u"||window.location.protocol==="file:")throw new Error("WASM module not available in test/non-browser environment");try{await this.loadWasmModule(),this.isInitialized=!0,this.syncConfigToWasm()}catch(t){throw console.error("Failed to initialize WASM module:",t),t}}}async loadWasmModule(){return new Promise((t,e)=>{if(window.wasmProcessor&&window.wasmProcessor.WasmDataProcessor){this.wasmProcessor=new window.wasmProcessor.WasmDataProcessor,t();return}const i=setTimeout(()=>{s(),e(new Error("WASM module loading timed out after 10 seconds"))},1e4),r=`${this.determineBasePath()}wasm/wasm_processor.js`,o=document.createElement("script");o.type="module",o.textContent=`
        import init, { WasmDataProcessor } from '${r}';
        await init();
        window.wasmProcessor = { WasmDataProcessor };
        window.dispatchEvent(new Event('wasmLoaded'));
      `;const s=()=>{clearTimeout(i),window.removeEventListener("wasmLoaded",h)},h=()=>{s(),window.wasmProcessor&&window.wasmProcessor.WasmDataProcessor?(this.wasmProcessor=new window.wasmProcessor.WasmDataProcessor,t()):e(new Error("WASM module loaded but WasmDataProcessor not found"))};window.addEventListener("wasmLoaded",h),o.onerror=()=>{s(),e(new Error("Failed to load WASM module script"))},document.head.appendChild(o)})}determineBasePath(){var e;if(this.cachedBasePath!==null)return this.cachedBasePath;let t=(e=document.querySelector("base"))==null?void 0:e.getAttribute("href");if(t)try{t=new URL(t,window.location.href).pathname}catch{}if(t||(t=this.getBasePathFromScripts()),!t&&window.location.pathname&&window.location.pathname!=="/"){const n=window.location.pathname.split("/").filter(r=>r.length>0);n.length>0&&(t=`/${n[0]}/`)}return t||(t="/"),t.endsWith("/")||(t+="/"),this.cachedBasePath=t,t}getBasePathFromScripts(){const t=document.querySelectorAll("script[src]");for(const e of t){const i=e.getAttribute("src");if(i)try{const r=new URL(i,window.location.href).pathname;for(const o of k.ASSET_PATTERNS){const s=r.indexOf(o);if(s>=0)return s===0?"/":r.substring(0,s)+"/"}}catch(n){(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&console.debug("Failed to parse script URL:",i,n);continue}}return""}syncConfigToWasm(){this.wasmProcessor&&(this.wasmProcessor.setAutoGain(this.gainController.getAutoGainEnabled()),this.wasmProcessor.setNoiseGate(this.gainController.getNoiseGateEnabled()),this.wasmProcessor.setNoiseGateThreshold(this.gainController.getNoiseGateThreshold()),this.wasmProcessor.setFrequencyEstimationMethod(this.frequencyEstimator.getFrequencyEstimationMethod()),this.wasmProcessor.setBufferSizeMultiplier(this.frequencyEstimator.getBufferSizeMultiplier()))}syncResultsFromWasm(t){this.frequencyEstimator.estimatedFrequency=t.estimatedFrequency,this.gainController.currentGain=t.gain,t.previousWaveform&&(this.waveformSearcher.previousWaveform=t.previousWaveform),this.waveformSearcher.lastSimilarity=t.similarity}processFrame(t){if(!this.isInitialized||!this.wasmProcessor)return console.warn("WASM processor not initialized"),null;if(!this.audioManager.isReady())return null;const e=this.audioManager.getTimeDomainData();if(!e)return null;const i=this.audioManager.getSampleRate(),n=this.audioManager.getFFTSize(),o=this.frequencyEstimator.getFrequencyEstimationMethod()==="fft"||t?this.audioManager.getFrequencyData():null;this.syncConfigToWasm();const s=this.wasmProcessor.processFrame(e,o,i,n,t);if(!s)return null;const h={waveformData:new Float32Array(s.waveform_data),displayStartIndex:s.displayStartIndex,displayEndIndex:s.displayEndIndex,gain:s.gain,estimatedFrequency:s.estimatedFrequency,frequencyPlotHistory:s.frequencyPlotHistory?Array.from(s.frequencyPlotHistory):[],sampleRate:s.sampleRate,fftSize:s.fftSize,frequencyData:s.frequencyData?new Uint8Array(s.frequencyData):void 0,isSignalAboveNoiseGate:s.isSignalAboveNoiseGate,maxFrequency:s.maxFrequency,previousWaveform:s.previousWaveform?new Float32Array(s.previousWaveform):null,similarity:s.similarity,similarityPlotHistory:s.similarityPlotHistory?Array.from(s.similarityPlotHistory):[],usedSimilaritySearch:s.usedSimilaritySearch};return this.syncResultsFromWasm(h),h}reset(){this.wasmProcessor&&this.wasmProcessor.reset()}};a(k,"ASSET_PATTERNS",["/assets/","/js/","/dist/"]);let Y=k;class vt{constructor(t,e,i,n,r){a(this,"audioManager");a(this,"gainController");a(this,"frequencyEstimator");a(this,"renderer");a(this,"zeroCrossDetector");a(this,"waveformSearcher");a(this,"comparisonRenderer");a(this,"dataProcessor");a(this,"animationId",null);a(this,"isRunning",!1);a(this,"isPaused",!1);a(this,"lastFrameTime",0);a(this,"frameProcessingTimes",[]);a(this,"MAX_FRAME_TIMES",100);a(this,"TARGET_FRAME_TIME",16.67);this.audioManager=new dt,this.gainController=new mt,this.frequencyEstimator=new yt,this.renderer=new xt(t),this.zeroCrossDetector=new gt,this.waveformSearcher=new Et,this.comparisonRenderer=new pt(e,i,n,r),this.dataProcessor=new Y(this.audioManager,this.gainController,this.frequencyEstimator,this.waveformSearcher)}async start(){try{await this.dataProcessor.initialize(),await this.audioManager.start(),this.isRunning=!0,this.render()}catch(t){throw console.error("Error starting oscilloscope:",t),t}}async startFromFile(t){try{await this.dataProcessor.initialize(),await this.audioManager.startFromFile(t),this.isRunning=!0,this.render()}catch(e){throw console.error("Error loading audio file:",e),e}}async startFromBuffer(t){try{await this.dataProcessor.initialize(),await this.audioManager.startFromBuffer(t),this.isRunning=!0,this.render()}catch(e){throw console.error("Error starting from buffer:",e),e}}async stop(){this.isRunning=!1,this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null),await this.audioManager.stop(),this.frequencyEstimator.clearHistory(),this.zeroCrossDetector.reset(),this.waveformSearcher.reset(),this.comparisonRenderer.clear(),this.dataProcessor.reset()}render(){if(!this.isRunning)return;const t=performance.now();if(!this.isPaused){const n=this.dataProcessor.processFrame(this.renderer.getFFTDisplayEnabled());n&&this.renderFrame(n)}const i=performance.now()-t;if(this.frameProcessingTimes.push(i),this.frameProcessingTimes.length>this.MAX_FRAME_TIMES&&this.frameProcessingTimes.shift(),i>this.TARGET_FRAME_TIME&&console.warn(`フレーム処理時間: ${i.toFixed(2)}ms (目標: ${this.TARGET_FRAME_TIME}ms以下)`),this.lastFrameTime>0){const r=1e3/(t-this.lastFrameTime);if(this.frameProcessingTimes.length===this.MAX_FRAME_TIMES){const o=this.frameProcessingTimes.reduce((s,h)=>s+h,0)/this.frameProcessingTimes.length;console.log(`FPS: ${r.toFixed(1)}, 平均処理時間: ${o.toFixed(2)}ms`)}}this.lastFrameTime=t,this.animationId=requestAnimationFrame(()=>this.render())}renderFrame(t){const e=t.displayEndIndex-t.displayStartIndex;this.renderer.clearAndDrawGrid(t.sampleRate,e,t.gain),this.renderer.drawWaveform(t.waveformData,t.displayStartIndex,t.displayEndIndex,t.gain),t.frequencyData&&this.renderer.getFFTDisplayEnabled()&&t.isSignalAboveNoiseGate&&this.renderer.drawFFTOverlay(t.frequencyData,t.estimatedFrequency,t.sampleRate,t.fftSize,t.maxFrequency),this.renderer.drawFrequencyPlot(t.frequencyPlotHistory,this.frequencyEstimator.getMinFrequency(),this.frequencyEstimator.getMaxFrequency()),this.comparisonRenderer.updatePanels(t.previousWaveform,t.waveformData,t.displayStartIndex,t.displayEndIndex,t.waveformData,t.similarity,t.similarityPlotHistory)}getIsRunning(){return this.isRunning}setAutoGain(t){this.gainController.setAutoGain(t)}getAutoGainEnabled(){return this.gainController.getAutoGainEnabled()}setNoiseGate(t){this.gainController.setNoiseGate(t)}getNoiseGateEnabled(){return this.gainController.getNoiseGateEnabled()}setNoiseGateThreshold(t){this.gainController.setNoiseGateThreshold(t)}getNoiseGateThreshold(){return this.gainController.getNoiseGateThreshold()}setFrequencyEstimationMethod(t){this.frequencyEstimator.setFrequencyEstimationMethod(t)}getFrequencyEstimationMethod(){return this.frequencyEstimator.getFrequencyEstimationMethod()}setBufferSizeMultiplier(t){this.frequencyEstimator.setBufferSizeMultiplier(t)}getBufferSizeMultiplier(){return this.frequencyEstimator.getBufferSizeMultiplier()}getEstimatedFrequency(){return this.frequencyEstimator.getEstimatedFrequency()}setFFTDisplay(t){this.renderer.setFFTDisplay(t)}getFFTDisplayEnabled(){return this.renderer.getFFTDisplayEnabled()}getCurrentGain(){return this.gainController.getCurrentGain()}getSimilarityScore(){return this.waveformSearcher.getLastSimilarity()}isSimilaritySearchActive(){return this.waveformSearcher.hasPreviousWaveform()}setUsePeakMode(t){this.zeroCrossDetector.setUsePeakMode(t)}getUsePeakMode(){return this.zeroCrossDetector.getUsePeakMode()}setPauseDrawing(t){this.isPaused=t}getPauseDrawing(){return this.isPaused}}class Tt{constructor(t){a(this,"canvas");a(this,"ctx");a(this,"MIN_FREQ",50);a(this,"MAX_FREQ",2e3);a(this,"WHITE_KEY_WIDTH",20);a(this,"WHITE_KEY_HEIGHT",60);a(this,"BLACK_KEY_WIDTH",12);a(this,"BLACK_KEY_HEIGHT",38);a(this,"WHITE_KEY_COLOR","#ffffff");a(this,"BLACK_KEY_COLOR","#000000");a(this,"WHITE_KEY_HIGHLIGHT","#00ff00");a(this,"BLACK_KEY_HIGHLIGHT","#00cc00");a(this,"KEY_BORDER","#333333");a(this,"WHITE_KEY_NOTES",[0,2,4,5,7,9,11]);a(this,"BLACK_KEY_NOTES",[1,3,6,8,10]);a(this,"keyboardRange");a(this,"xOffset");a(this,"whiteKeyCount");this.canvas=t;const e=t.getContext("2d");if(!e)throw new Error("Could not get 2D context for piano keyboard");this.ctx=e,this.keyboardRange=this.calculateKeyboardRange(),this.whiteKeyCount=this.countWhiteKeys(),this.xOffset=this.calculateCenteringOffset()}frequencyToNoteInfo(t){const e=R(t);if(!e)return{note:-1,octave:-1,noteInOctave:-1};const i=e.noteName.match(/^([A-G]#?)(\d+)$/);if(!i)return{note:-1,octave:-1,noteInOctave:-1};const n=i[1],r=parseInt(i[2],10),s=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"].indexOf(n);return{note:r*12+s,octave:r,noteInOctave:s}}calculateKeyboardRange(){const t=this.frequencyToNoteInfo(this.MIN_FREQ),e=this.frequencyToNoteInfo(this.MAX_FREQ);return{startNote:t.note,endNote:e.note}}countWhiteKeys(){const t=this.keyboardRange;let e=0;for(let i=t.startNote;i<=t.endNote;i++){const n=(i%12+12)%12;this.WHITE_KEY_NOTES.includes(n)&&e++}return e}calculateCenteringOffset(){const t=this.whiteKeyCount*this.WHITE_KEY_WIDTH;return(this.canvas.width-t)/2}render(t){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);const e=this.keyboardRange,i=t>0?this.frequencyToNoteInfo(t):null;let n=0;for(let h=e.startNote;h<=e.endNote;h++){const y=(h%12+12)%12;if(this.WHITE_KEY_NOTES.includes(y)){const f=this.xOffset+n*this.WHITE_KEY_WIDTH,m=i&&i.note===h;this.ctx.fillStyle=m?this.WHITE_KEY_HIGHLIGHT:this.WHITE_KEY_COLOR,this.ctx.fillRect(f,0,this.WHITE_KEY_WIDTH,this.WHITE_KEY_HEIGHT),this.ctx.strokeStyle=this.KEY_BORDER,this.ctx.lineWidth=1,this.ctx.strokeRect(f,0,this.WHITE_KEY_WIDTH,this.WHITE_KEY_HEIGHT),n++}}n=0;for(let h=e.startNote;h<=e.endNote;h++){const y=(h%12+12)%12;if(this.WHITE_KEY_NOTES.includes(y)&&n++,this.BLACK_KEY_NOTES.includes(y)){const f=this.xOffset+n*this.WHITE_KEY_WIDTH-this.BLACK_KEY_WIDTH/2,m=i&&i.note===h;this.ctx.fillStyle=m?this.BLACK_KEY_HIGHLIGHT:this.BLACK_KEY_COLOR,this.ctx.fillRect(f,0,this.BLACK_KEY_WIDTH,this.BLACK_KEY_HEIGHT),this.ctx.strokeStyle=this.KEY_BORDER,this.ctx.lineWidth=1,this.ctx.strokeRect(f,0,this.BLACK_KEY_WIDTH,this.BLACK_KEY_HEIGHT)}}this.ctx.fillStyle="#888888",this.ctx.font="10px monospace",this.ctx.fillText(`${this.MIN_FREQ}Hz`,this.xOffset+5,this.WHITE_KEY_HEIGHT-5);const r=`${this.MAX_FREQ}Hz`,o=this.ctx.measureText(r).width,s=this.xOffset+this.whiteKeyCount*this.WHITE_KEY_WIDTH;this.ctx.fillText(r,s-o-5,this.WHITE_KEY_HEIGHT-5)}clear(){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}}const j=document.getElementById("canvas"),J=document.getElementById("previousWaveformCanvas"),tt=document.getElementById("currentWaveformCanvas"),et=document.getElementById("similarityPlotCanvas"),it=document.getElementById("frameBufferCanvas"),st=document.getElementById("pianoKeyboardCanvas"),w=document.getElementById("startButton"),I=document.getElementById("loadFileButton"),_=document.getElementById("fileInput"),H=document.getElementById("autoGainCheckbox"),W=document.getElementById("noiseGateCheckbox"),D=document.getElementById("fftDisplayCheckbox"),B=document.getElementById("pauseDrawingCheckbox"),G=document.getElementById("noiseGateThreshold"),U=document.getElementById("thresholdValue"),S=document.getElementById("status"),$=document.getElementById("frequencyMethod"),P=document.getElementById("bufferSizeMultiplier"),L=document.getElementById("frequencyValue"),A=document.getElementById("noteValue"),X=document.getElementById("gainValue"),q=document.getElementById("similarityValue"),Ct=[{element:j,name:"canvas"},{element:J,name:"previousWaveformCanvas"},{element:tt,name:"currentWaveformCanvas"},{element:et,name:"similarityPlotCanvas"},{element:it,name:"frameBufferCanvas"},{element:st,name:"pianoKeyboardCanvas"},{element:w,name:"startButton"},{element:I,name:"loadFileButton"},{element:_,name:"fileInput"},{element:H,name:"autoGainCheckbox"},{element:W,name:"noiseGateCheckbox"},{element:D,name:"fftDisplayCheckbox"},{element:B,name:"pauseDrawingCheckbox"},{element:G,name:"noiseGateThreshold"},{element:U,name:"thresholdValue"},{element:S,name:"status"},{element:$,name:"frequencyMethod"},{element:P,name:"bufferSizeMultiplier"},{element:L,name:"frequencyValue"},{element:A,name:"noteValue"},{element:X,name:"gainValue"},{element:q,name:"similarityValue"}];for(const{element:l,name:t}of Ct)if(!l)throw new Error(`Required DOM element not found: ${t}`);function nt(l){const t=parseFloat(l);if(Number.isNaN(t))throw new Error(`Invalid slider value for noise gate threshold: "${l}"`);return{db:t,amplitude:Z(t)}}function at(l,t){return`${l.toFixed(0)} dB (${t.toFixed(3)})`}const E=new vt(j,J,tt,et,it),N=new Tt(st);N.render(0);E.setAutoGain(H.checked);E.setNoiseGate(W.checked);const Q=nt(G.value);E.setNoiseGateThreshold(Q.amplitude);U.textContent=at(Q.db,Q.amplitude);E.setFFTDisplay(D.checked);E.setPauseDrawing(B.checked);H.addEventListener("change",()=>{E.setAutoGain(H.checked)});W.addEventListener("change",()=>{E.setNoiseGate(W.checked)});D.addEventListener("change",()=>{E.setFFTDisplay(D.checked)});B.addEventListener("change",()=>{E.setPauseDrawing(B.checked)});G.addEventListener("input",()=>{const l=nt(G.value);E.setNoiseGateThreshold(l.amplitude),U.textContent=at(l.db,l.amplitude)});$.addEventListener("change",()=>{const l=$.value;E.setFrequencyEstimationMethod(l)});P.addEventListener("change",()=>{const l=parseInt(P.value,10);l===1||l===4||l===16?E.setBufferSizeMultiplier(l):(console.error("Invalid buffer size multiplier:",l),P.value="1",E.setBufferSizeMultiplier(1))});let M=null;function rt(){M===null&&(M=window.setInterval(()=>{const l=E.getEstimatedFrequency();if(l>0){L.textContent=`${l.toFixed(1)} Hz`;const e=R(l);if(e){const i=e.cents>=0?"+":"";A.textContent=`${e.noteName}${i}${e.cents}cent`}else A.textContent="---";N.render(l)}else L.textContent="--- Hz",A.textContent="---",N.render(0);const t=E.getCurrentGain();if(X.textContent=`${t.toFixed(2)}x`,E.isSimilaritySearchActive()){const e=E.getSimilarityScore();q.textContent=e.toFixed(3)}else q.textContent="---"},100))}function ot(){M!==null&&(clearInterval(M),M=null,L.textContent="--- Hz",A.textContent="---",X.textContent="---x",q.textContent="---",N.clear())}w.addEventListener("click",async()=>{if(E.getIsRunning())try{ot(),await E.stop(),w.textContent="Start",I.disabled=!1,S.textContent="Stopped"}catch(l){console.error("Failed to stop oscilloscope:",l),S.textContent="Stopped (with errors)",w.textContent="Start",I.disabled=!1}else try{w.disabled=!0,I.disabled=!0,S.textContent="Requesting microphone access...",await E.start(),w.textContent="Stop",w.disabled=!1,S.textContent="Running - Microphone active",rt()}catch(l){console.error("Failed to start oscilloscope:",l),S.textContent="Error: Could not access microphone",w.disabled=!1,I.disabled=!1}});I.addEventListener("click",()=>{_.click()});_.addEventListener("change",async()=>{var t;const l=(t=_.files)==null?void 0:t[0];if(l){E.getIsRunning()&&(ot(),await E.stop());try{w.disabled=!0,I.disabled=!0,S.textContent=`Loading file: ${l.name}...`,await E.startFromFile(l),w.textContent="Stop",w.disabled=!1,S.textContent=`Playing: ${l.name} (loop)`,rt()}catch(e){console.error("Failed to load audio file:",e),S.textContent="Error: Could not load audio file",w.textContent="Start",w.disabled=!1,I.disabled=!1}_.value=""}});
//# sourceMappingURL=index-DV_CJg34.js.map
