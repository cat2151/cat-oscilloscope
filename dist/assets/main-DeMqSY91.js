var E=Object.defineProperty;var v=(l,e,s)=>e in l?E(l,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):l[e]=s;var t=(l,e,s)=>v(l,typeof e!="symbol"?e+"":e,s);import{f as y,d as x,O as b}from"./Oscilloscope-DgVQ170m.js";class g{constructor(e){t(this,"canvas");t(this,"ctx");t(this,"MIN_FREQ",50);t(this,"MAX_FREQ",2e3);t(this,"WHITE_KEY_WIDTH",20);t(this,"WHITE_KEY_HEIGHT",60);t(this,"BLACK_KEY_WIDTH",12);t(this,"BLACK_KEY_HEIGHT",38);t(this,"WHITE_KEY_COLOR","#ffffff");t(this,"BLACK_KEY_COLOR","#000000");t(this,"WHITE_KEY_HIGHLIGHT","#00ff00");t(this,"BLACK_KEY_HIGHLIGHT","#00cc00");t(this,"KEY_BORDER","#333333");t(this,"WHITE_KEY_NOTES",[0,2,4,5,7,9,11]);t(this,"BLACK_KEY_NOTES",[1,3,6,8,10]);t(this,"keyboardRange");t(this,"xOffset");t(this,"whiteKeyCount");this.canvas=e;const s=e.getContext("2d");if(!s)throw new Error("Could not get 2D context for piano keyboard");this.ctx=s,this.keyboardRange=this.calculateKeyboardRange(),this.whiteKeyCount=this.countWhiteKeys(),this.xOffset=this.calculateCenteringOffset()}frequencyToNoteInfo(e){const s=y(e);if(!s)return{note:-1,octave:-1,noteInOctave:-1};const i=s.noteName.match(/^([A-G]#?)(\d+)$/);if(!i)return{note:-1,octave:-1,noteInOctave:-1};const o=i[1],h=parseInt(i[2],10),d=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"].indexOf(o);return{note:h*12+d,octave:h,noteInOctave:d}}calculateKeyboardRange(){const e=this.frequencyToNoteInfo(this.MIN_FREQ),s=this.frequencyToNoteInfo(this.MAX_FREQ);return{startNote:e.note,endNote:s.note}}countWhiteKeys(){const e=this.keyboardRange;let s=0;for(let i=e.startNote;i<=e.endNote;i++){const o=(i%12+12)%12;this.WHITE_KEY_NOTES.includes(o)&&s++}return s}calculateCenteringOffset(){const e=this.whiteKeyCount*this.WHITE_KEY_WIDTH;return(this.canvas.width-e)/2}render(e){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);const s=this.keyboardRange,i=e>0?this.frequencyToNoteInfo(e):null;let o=0;for(let n=s.startNote;n<=s.endNote;n++){const u=(n%12+12)%12;if(this.WHITE_KEY_NOTES.includes(u)){const r=this.xOffset+o*this.WHITE_KEY_WIDTH,m=i&&i.note===n;this.ctx.fillStyle=m?this.WHITE_KEY_HIGHLIGHT:this.WHITE_KEY_COLOR,this.ctx.fillRect(r,0,this.WHITE_KEY_WIDTH,this.WHITE_KEY_HEIGHT),this.ctx.strokeStyle=this.KEY_BORDER,this.ctx.lineWidth=1,this.ctx.strokeRect(r,0,this.WHITE_KEY_WIDTH,this.WHITE_KEY_HEIGHT),o++}}o=0;for(let n=s.startNote;n<=s.endNote;n++){const u=(n%12+12)%12;if(this.WHITE_KEY_NOTES.includes(u)&&o++,this.BLACK_KEY_NOTES.includes(u)){const r=this.xOffset+o*this.WHITE_KEY_WIDTH-this.BLACK_KEY_WIDTH/2,m=i&&i.note===n;this.ctx.fillStyle=m?this.BLACK_KEY_HIGHLIGHT:this.BLACK_KEY_COLOR,this.ctx.fillRect(r,0,this.BLACK_KEY_WIDTH,this.BLACK_KEY_HEIGHT),this.ctx.strokeStyle=this.KEY_BORDER,this.ctx.lineWidth=1,this.ctx.strokeRect(r,0,this.BLACK_KEY_WIDTH,this.BLACK_KEY_HEIGHT)}}this.ctx.fillStyle="#888888",this.ctx.font="10px monospace",this.ctx.fillText(`${this.MIN_FREQ}Hz`,this.xOffset+5,this.WHITE_KEY_HEIGHT-5);const h=`${this.MAX_FREQ}Hz`,c=this.ctx.measureText(h).width,d=this.xOffset+this.whiteKeyCount*this.WHITE_KEY_WIDTH;this.ctx.fillText(h,d-c-5,this.WHITE_KEY_HEIGHT-5)}clear(){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}}class k{constructor(){t(this,"canvas");t(this,"previousWaveformCanvas");t(this,"currentWaveformCanvas");t(this,"similarityPlotCanvas");t(this,"frameBufferCanvas");t(this,"cycleSimilarity8divCanvas");t(this,"cycleSimilarity4divCanvas");t(this,"cycleSimilarity2divCanvas");t(this,"pianoKeyboardCanvas");t(this,"startButton");t(this,"loadFileButton");t(this,"fileInput");t(this,"autoGainCheckbox");t(this,"noiseGateCheckbox");t(this,"fftDisplayCheckbox");t(this,"harmonicAnalysisCheckbox");t(this,"pauseDrawingCheckbox");t(this,"phaseMarkerRangeCheckbox");t(this,"cycleSimilarityDisplayCheckbox");t(this,"noiseGateThreshold");t(this,"frequencyMethod");t(this,"bufferSizeMultiplier");t(this,"zeroCrossMode");t(this,"cycleSimilarityPanel");t(this,"thresholdValue");t(this,"statusElement");t(this,"frequencyValue");t(this,"noteValue");t(this,"gainValue");t(this,"similarityValue");this.canvas=this.getElement("canvas"),this.previousWaveformCanvas=this.getElement("previousWaveformCanvas"),this.currentWaveformCanvas=this.getElement("currentWaveformCanvas"),this.similarityPlotCanvas=this.getElement("similarityPlotCanvas"),this.frameBufferCanvas=this.getElement("frameBufferCanvas"),this.cycleSimilarity8divCanvas=this.getElement("cycleSimilarity8divCanvas"),this.cycleSimilarity4divCanvas=this.getElement("cycleSimilarity4divCanvas"),this.cycleSimilarity2divCanvas=this.getElement("cycleSimilarity2divCanvas"),this.pianoKeyboardCanvas=this.getElement("pianoKeyboardCanvas"),this.startButton=this.getElement("startButton"),this.loadFileButton=this.getElement("loadFileButton"),this.fileInput=this.getElement("fileInput"),this.autoGainCheckbox=this.getElement("autoGainCheckbox"),this.noiseGateCheckbox=this.getElement("noiseGateCheckbox"),this.fftDisplayCheckbox=this.getElement("fftDisplayCheckbox"),this.harmonicAnalysisCheckbox=this.getElement("harmonicAnalysisCheckbox"),this.pauseDrawingCheckbox=this.getElement("pauseDrawingCheckbox"),this.phaseMarkerRangeCheckbox=this.getElement("phaseMarkerRangeCheckbox"),this.cycleSimilarityDisplayCheckbox=this.getElement("cycleSimilarityDisplayCheckbox"),this.noiseGateThreshold=this.getElement("noiseGateThreshold"),this.frequencyMethod=this.getElement("frequencyMethod"),this.bufferSizeMultiplier=this.getElement("bufferSizeMultiplier"),this.zeroCrossMode=this.getElement("zeroCrossMode"),this.cycleSimilarityPanel=this.getElement("cycleSimilarityPanel"),this.thresholdValue=this.getElement("thresholdValue"),this.statusElement=this.getElement("status"),this.frequencyValue=this.getElement("frequencyValue"),this.noteValue=this.getElement("noteValue"),this.gainValue=this.getElement("gainValue"),this.similarityValue=this.getElement("similarityValue"),this.validateElements()}getElement(e){const s=document.getElementById(e);if(!s)throw new Error(`Required DOM element not found: ${e}`);return s}validateElements(){const e=[{element:this.canvas,name:"canvas"},{element:this.previousWaveformCanvas,name:"previousWaveformCanvas"},{element:this.currentWaveformCanvas,name:"currentWaveformCanvas"},{element:this.similarityPlotCanvas,name:"similarityPlotCanvas"},{element:this.frameBufferCanvas,name:"frameBufferCanvas"},{element:this.cycleSimilarity8divCanvas,name:"cycleSimilarity8divCanvas"},{element:this.cycleSimilarity4divCanvas,name:"cycleSimilarity4divCanvas"},{element:this.cycleSimilarity2divCanvas,name:"cycleSimilarity2divCanvas"},{element:this.pianoKeyboardCanvas,name:"pianoKeyboardCanvas"},{element:this.startButton,name:"startButton"},{element:this.loadFileButton,name:"loadFileButton"},{element:this.fileInput,name:"fileInput"},{element:this.autoGainCheckbox,name:"autoGainCheckbox"},{element:this.noiseGateCheckbox,name:"noiseGateCheckbox"},{element:this.fftDisplayCheckbox,name:"fftDisplayCheckbox"},{element:this.harmonicAnalysisCheckbox,name:"harmonicAnalysisCheckbox"},{element:this.pauseDrawingCheckbox,name:"pauseDrawingCheckbox"},{element:this.phaseMarkerRangeCheckbox,name:"phaseMarkerRangeCheckbox"},{element:this.cycleSimilarityDisplayCheckbox,name:"cycleSimilarityDisplayCheckbox"},{element:this.noiseGateThreshold,name:"noiseGateThreshold"},{element:this.thresholdValue,name:"thresholdValue"},{element:this.cycleSimilarityPanel,name:"cycleSimilarityPanel"},{element:this.statusElement,name:"status"},{element:this.frequencyMethod,name:"frequencyMethod"},{element:this.bufferSizeMultiplier,name:"bufferSizeMultiplier"},{element:this.zeroCrossMode,name:"zeroCrossMode"},{element:this.frequencyValue,name:"frequencyValue"},{element:this.noteValue,name:"noteValue"},{element:this.gainValue,name:"gainValue"},{element:this.similarityValue,name:"similarityValue"}];for(const{element:s,name:i}of e)if(!s)throw new Error(`Required DOM element not found: ${i}`)}}class I{constructor(e,s,i,o,h,c){t(this,"oscilloscope");t(this,"pianoKeyboardRenderer");t(this,"frequencyValue");t(this,"noteValue");t(this,"gainValue");t(this,"similarityValue");t(this,"updateInterval",null);t(this,"UPDATE_INTERVAL_MS",100);this.oscilloscope=e,this.pianoKeyboardRenderer=s,this.frequencyValue=i,this.noteValue=o,this.gainValue=h,this.similarityValue=c}start(){this.updateInterval===null&&(this.updateInterval=window.setInterval(()=>{this.update()},this.UPDATE_INTERVAL_MS))}stop(){this.updateInterval!==null&&(clearInterval(this.updateInterval),this.updateInterval=null,this.clearDisplays())}update(){this.updateFrequencyDisplay(),this.updateGainDisplay(),this.updateSimilarityDisplay()}updateFrequencyDisplay(){const e=this.oscilloscope.getEstimatedFrequency();if(e>0){this.frequencyValue.textContent=`${e.toFixed(1)} Hz`;const s=y(e);if(s){const i=s.cents>=0?"+":"";this.noteValue.textContent=`${s.noteName}${i}${s.cents}cent`}else this.noteValue.textContent="---";this.pianoKeyboardRenderer.render(e)}else this.frequencyValue.textContent="--- Hz",this.noteValue.textContent="---",this.pianoKeyboardRenderer.render(0)}updateGainDisplay(){const e=this.oscilloscope.getCurrentGain();this.gainValue.textContent=`${e.toFixed(2)}x`}updateSimilarityDisplay(){if(this.oscilloscope.isSimilaritySearchActive()){const e=this.oscilloscope.getSimilarityScore();this.similarityValue.textContent=e.toFixed(3)}else this.similarityValue.textContent="---"}clearDisplays(){this.frequencyValue.textContent="--- Hz",this.noteValue.textContent="---",this.gainValue.textContent="---x",this.similarityValue.textContent="---",this.pianoKeyboardRenderer.clear()}}class S{constructor(e,s,i){t(this,"oscilloscope");t(this,"dom");t(this,"displayUpdater");this.oscilloscope=e,this.dom=s,this.displayUpdater=i}setupEventHandlers(){this.setupCheckboxHandlers(),this.setupSliderHandlers(),this.setupSelectHandlers(),this.setupButtonHandlers(),this.setupFileInputHandler()}initializeUIState(){this.oscilloscope.setAutoGain(this.dom.autoGainCheckbox.checked),this.oscilloscope.setNoiseGate(this.dom.noiseGateCheckbox.checked),this.oscilloscope.setFFTDisplay(this.dom.fftDisplayCheckbox.checked),this.oscilloscope.setHarmonicAnalysisEnabled(this.dom.harmonicAnalysisCheckbox.checked),this.oscilloscope.setPauseDrawing(this.dom.pauseDrawingCheckbox.checked),this.oscilloscope.setPhaseMarkerRangeEnabled(this.dom.phaseMarkerRangeCheckbox.checked),this.updateCycleSimilarityPanelDisplay(this.dom.cycleSimilarityDisplayCheckbox.checked);const e=this.sliderValueToThreshold(this.dom.noiseGateThreshold.value);this.oscilloscope.setNoiseGateThreshold(e.amplitude),this.dom.thresholdValue.textContent=this.formatThresholdDisplay(e.db,e.amplitude);const s=this.dom.zeroCrossMode.value;["standard","peak-backtrack-history","bidirectional-nearest","gradient-based","adaptive-step","hysteresis","closest-to-zero"].includes(s)&&this.oscilloscope.setZeroCrossMode(s),this.dom.startButton.focus()}setupCheckboxHandlers(){this.dom.autoGainCheckbox.addEventListener("change",()=>{this.oscilloscope.setAutoGain(this.dom.autoGainCheckbox.checked)}),this.dom.noiseGateCheckbox.addEventListener("change",()=>{this.oscilloscope.setNoiseGate(this.dom.noiseGateCheckbox.checked)}),this.dom.fftDisplayCheckbox.addEventListener("change",()=>{this.oscilloscope.setFFTDisplay(this.dom.fftDisplayCheckbox.checked)}),this.dom.harmonicAnalysisCheckbox.addEventListener("change",()=>{this.oscilloscope.setHarmonicAnalysisEnabled(this.dom.harmonicAnalysisCheckbox.checked)}),this.dom.pauseDrawingCheckbox.addEventListener("change",()=>{this.oscilloscope.setPauseDrawing(this.dom.pauseDrawingCheckbox.checked)}),this.dom.phaseMarkerRangeCheckbox.addEventListener("change",()=>{this.oscilloscope.setPhaseMarkerRangeEnabled(this.dom.phaseMarkerRangeCheckbox.checked)}),this.dom.cycleSimilarityDisplayCheckbox.addEventListener("change",()=>{this.updateCycleSimilarityPanelDisplay(this.dom.cycleSimilarityDisplayCheckbox.checked)})}setupSliderHandlers(){this.dom.noiseGateThreshold.addEventListener("input",()=>{const e=this.sliderValueToThreshold(this.dom.noiseGateThreshold.value);this.oscilloscope.setNoiseGateThreshold(e.amplitude),this.dom.thresholdValue.textContent=this.formatThresholdDisplay(e.db,e.amplitude)})}setupSelectHandlers(){this.dom.frequencyMethod.addEventListener("change",()=>{const e=this.dom.frequencyMethod.value;this.oscilloscope.setFrequencyEstimationMethod(e)}),this.dom.bufferSizeMultiplier.addEventListener("change",()=>{const e=parseInt(this.dom.bufferSizeMultiplier.value,10);e===1||e===4||e===16?this.oscilloscope.setBufferSizeMultiplier(e):(console.error("Invalid buffer size multiplier:",e),this.dom.bufferSizeMultiplier.value="1",this.oscilloscope.setBufferSizeMultiplier(1))}),this.dom.zeroCrossMode.addEventListener("change",()=>{const e=this.dom.zeroCrossMode.value;["standard","peak-backtrack-history","bidirectional-nearest","gradient-based","adaptive-step","hysteresis","closest-to-zero"].includes(e)?this.oscilloscope.setZeroCrossMode(e):(console.error("Invalid zero-cross mode:",e),this.dom.zeroCrossMode.value="hysteresis",this.oscilloscope.setZeroCrossMode("hysteresis"))})}setupButtonHandlers(){this.dom.startButton.addEventListener("click",async()=>{await this.handleStartStopButton()}),this.dom.loadFileButton.addEventListener("click",()=>{this.dom.fileInput.click()})}setupFileInputHandler(){this.dom.fileInput.addEventListener("change",async()=>{await this.handleFileInput()})}async handleStartStopButton(){if(this.oscilloscope.getIsRunning())try{this.displayUpdater.stop(),await this.oscilloscope.stop(),this.dom.startButton.textContent="Start",this.dom.loadFileButton.disabled=!1,this.dom.statusElement.textContent="Stopped"}catch(e){console.error("Failed to stop oscilloscope:",e),this.dom.statusElement.textContent="Stopped (with errors)",this.dom.startButton.textContent="Start",this.dom.loadFileButton.disabled=!1}else try{this.dom.startButton.disabled=!0,this.dom.loadFileButton.disabled=!0,this.dom.statusElement.textContent="Requesting microphone access...",await this.oscilloscope.start(),this.dom.startButton.textContent="Stop",this.dom.startButton.disabled=!1,this.dom.statusElement.textContent="Running - Microphone active",this.displayUpdater.start()}catch(e){console.error("Failed to start oscilloscope:",e),this.dom.statusElement.textContent="Error: Could not access microphone",this.dom.startButton.disabled=!1,this.dom.loadFileButton.disabled=!1}}async handleFileInput(){var s;const e=(s=this.dom.fileInput.files)==null?void 0:s[0];if(e){this.oscilloscope.getIsRunning()&&(this.displayUpdater.stop(),await this.oscilloscope.stop());try{this.dom.startButton.disabled=!0,this.dom.loadFileButton.disabled=!0,this.dom.statusElement.textContent=`Loading file: ${e.name}...`,await this.oscilloscope.startFromFile(e),this.dom.startButton.textContent="Stop",this.dom.startButton.disabled=!1,this.dom.statusElement.textContent=`Playing: ${e.name} (loop)`,this.displayUpdater.start()}catch(i){console.error("Failed to load audio file:",i),this.dom.statusElement.textContent="Error: Could not load audio file",this.dom.startButton.textContent="Start",this.dom.startButton.disabled=!1,this.dom.loadFileButton.disabled=!1}this.dom.fileInput.value=""}}sliderValueToThreshold(e){const s=parseFloat(e);if(Number.isNaN(s))throw new Error(`Invalid slider value for noise gate threshold: "${e}"`);return{db:s,amplitude:x(s)}}formatThresholdDisplay(e,s){return`${e.toFixed(0)} dB (${s.toFixed(3)})`}updateCycleSimilarityPanelDisplay(e){this.dom.cycleSimilarityPanel.style.display=e?"flex":"none"}}const a=new k,p=new b(a.canvas,a.previousWaveformCanvas,a.currentWaveformCanvas,a.similarityPlotCanvas,a.frameBufferCanvas,a.cycleSimilarity8divCanvas,a.cycleSimilarity4divCanvas,a.cycleSimilarity2divCanvas),f=new g(a.pianoKeyboardCanvas);f.render(0);const T=new I(p,f,a.frequencyValue,a.noteValue,a.gainValue,a.similarityValue),C=new S(p,a,T);C.initializeUIState();C.setupEventHandlers();
//# sourceMappingURL=main-DeMqSY91.js.map
