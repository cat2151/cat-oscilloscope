var B=Object.defineProperty;var q=(f,t,e)=>t in f?B(f,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):f[t]=e;var i=(f,t,e)=>q(f,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const l of n.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function e(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(o){if(o.ep)return;o.ep=!0;const n=e(o);fetch(o.href,n)}})();function L(f){return Math.pow(10,f/20)}function z(f){return f<=0?-1/0:20*Math.log10(f)}function P(f){if(f<=0||!isFinite(f))return null;const e=440*Math.pow(2,-4.75),s=12*Math.log2(f/e),o=Math.round(s),n=Math.round((s-o)*100),l=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],r=Math.floor(o/12);return{noteName:`${l[(o%12+12)%12]}${r}`,cents:n}}const O=-48;function N(f){const t=f.numberOfChannels,e=f.sampleRate,s=f.length,o=[];let n=0;for(let c=0;c<t;c++){const u=f.getChannelData(c);o.push(u);for(let h=0;h<s;h++){const v=Math.abs(u[h]);v>n&&(n=v)}}if(n===0)return f;const l=n*Math.pow(10,O/20);let r=s;for(let c=0;c<s;c++){let u=!0;for(let h=0;h<t;h++)if(Math.abs(o[h][c])>l){u=!1;break}if(!u){r=c;break}}if(r>=s)return f;let a=s-1;for(let c=s-1;c>=r;c--){let u=!0;for(let h=0;h<t;h++)if(Math.abs(o[h][c])>l){u=!1;break}if(!u){a=c;break}}if(r===0&&a===s-1)return f;const y=a-r+1,d=new AudioBuffer({numberOfChannels:t,length:y,sampleRate:e});for(let c=0;c<t;c++){const u=o[c],h=d.getChannelData(c);for(let v=0;v<y;v++)h[v]=u[r+v]}return d}class K{constructor(){i(this,"audioContext",null);i(this,"analyser",null);i(this,"mediaStream",null);i(this,"audioBufferSource",null);i(this,"bufferSource",null);i(this,"dataArray",null);i(this,"frequencyData",null);i(this,"frameBufferHistory",[]);i(this,"MAX_FRAME_HISTORY",16)}initializeAnalyser(){if(!this.audioContext)throw new Error("AudioContext must be initialized before creating analyser");this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=4096,this.analyser.smoothingTimeConstant=0;const t=this.analyser.fftSize;this.dataArray=new Float32Array(t),this.frequencyData=new Uint8Array(this.analyser.frequencyBinCount)}async start(){try{this.mediaStream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.audioContext=new AudioContext;const t=this.audioContext.createMediaStreamSource(this.mediaStream);this.initializeAnalyser(),t.connect(this.analyser)}catch(t){throw console.error("Error accessing microphone:",t),t}}async startFromFile(t){try{const e=await t.arrayBuffer();this.audioContext&&this.audioContext.state!=="closed"&&await this.audioContext.close(),this.audioContext=new AudioContext;let s=await this.audioContext.decodeAudioData(e);s=N(s),this.initializeAnalyser(),this.audioBufferSource=this.audioContext.createBufferSource(),this.audioBufferSource.buffer=s,this.audioBufferSource.loop=!0,this.audioBufferSource.connect(this.analyser),this.analyser.connect(this.audioContext.destination),this.audioBufferSource.start(0)}catch(e){throw console.error("Error loading audio file:",e),e}}async startFromBuffer(t){try{this.audioContext&&this.audioContext.state!=="closed"&&await this.audioContext.close(),this.audioContext=null,this.bufferSource=t,this.bufferSource.setChunkSize(4096),this.dataArray=new Float32Array(4096),this.frequencyData=new Uint8Array(2048)}catch(e){throw console.error("Error starting from buffer:",e),e}}async stop(){if(this.audioBufferSource){try{this.audioBufferSource.stop()}catch{}try{this.audioBufferSource.disconnect()}catch{}this.audioBufferSource=null}if(this.mediaStream&&(this.mediaStream.getTracks().forEach(t=>t.stop()),this.mediaStream=null),this.bufferSource&&(this.bufferSource.reset(),this.bufferSource=null),this.audioContext){try{await this.audioContext.close()}catch(t){console.error("Error closing AudioContext:",t)}this.audioContext=null}this.analyser=null,this.dataArray=null,this.frequencyData=null,this.clearFrameBufferHistory()}getTimeDomainData(){if(this.bufferSource&&this.dataArray){const t=this.bufferSource.getNextChunk();return t?(this.dataArray.set(t),this.updateFrameBufferHistory(this.dataArray),this.dataArray):null}return!this.analyser||!this.dataArray?null:(this.analyser.getFloatTimeDomainData(this.dataArray),this.updateFrameBufferHistory(this.dataArray),this.dataArray)}updateFrameBufferHistory(t){let e;this.frameBufferHistory.length<this.MAX_FRAME_HISTORY?e=new Float32Array(t.length):(e=this.frameBufferHistory.shift(),e.length!==t.length&&(e=new Float32Array(t.length))),e.set(t),this.frameBufferHistory.push(e)}getExtendedTimeDomainData(t){if(t===1)return this.dataArray;if(!this.dataArray||this.frameBufferHistory.length<t)return null;const e=this.frameBufferHistory.slice(-t),s=e.reduce((l,r)=>l+r.length,0),o=new Float32Array(s);let n=0;for(const l of e)o.set(l,n),n+=l.length;return o}clearFrameBufferHistory(){this.frameBufferHistory=[]}getFrequencyData(){return this.bufferSource&&this.dataArray&&this.frequencyData||!this.analyser||!this.frequencyData?null:(this.analyser.getByteFrequencyData(this.frequencyData),this.frequencyData)}getSampleRate(){var t;return this.bufferSource?this.bufferSource.getSampleRate():((t=this.audioContext)==null?void 0:t.sampleRate)||0}getFFTSize(){var t;return this.bufferSource?4096:((t=this.analyser)==null?void 0:t.fftSize)||0}getFrequencyBinCount(){var t;return this.bufferSource?2048:((t=this.analyser)==null?void 0:t.frequencyBinCount)||0}isReady(){return this.bufferSource?this.dataArray!==null:this.audioContext!==null&&this.analyser!==null}}class ${constructor(){i(this,"autoGainEnabled",!0);i(this,"currentGain",1);i(this,"noiseGateEnabled",!0);i(this,"noiseGateThreshold",L(-60))}setAutoGain(t){this.autoGainEnabled=t}getAutoGainEnabled(){return this.autoGainEnabled}setNoiseGate(t){this.noiseGateEnabled=t}getNoiseGateEnabled(){return this.noiseGateEnabled}setNoiseGateThreshold(t){this.noiseGateThreshold=Math.min(Math.max(t,0),1)}getNoiseGateThreshold(){return this.noiseGateThreshold}getCurrentGain(){return this.currentGain}}class V{constructor(){i(this,"frequencyEstimationMethod","fft");i(this,"estimatedFrequency",0);i(this,"MIN_FREQUENCY_HZ",20);i(this,"MAX_FREQUENCY_HZ",5e3);i(this,"bufferSizeMultiplier",16);i(this,"frequencyPlotHistory",[])}clearHistory(){this.frequencyPlotHistory=[],this.estimatedFrequency=0}setFrequencyEstimationMethod(t){this.frequencyEstimationMethod!==t&&(this.frequencyEstimationMethod=t,this.frequencyPlotHistory=[])}getFrequencyEstimationMethod(){return this.frequencyEstimationMethod}setBufferSizeMultiplier(t){this.bufferSizeMultiplier=t}getBufferSizeMultiplier(){return this.bufferSizeMultiplier}getEstimatedFrequency(){return this.estimatedFrequency}getMinFrequency(){return this.MIN_FREQUENCY_HZ}getMaxFrequency(){return this.MAX_FREQUENCY_HZ}getFrequencyPlotHistory(){return this.frequencyPlotHistory}}function I(f,t){if(typeof f=="string"&&f.endsWith("%")){const e=parseFloat(f);return isNaN(e)?(console.warn(`Invalid percentage value: ${f}, using 0`),0):e<0?(console.warn(`Negative percentage value: ${f}, clamping to 0`),0):Math.floor(t*(e/100))}if(typeof f=="string"){const e=parseInt(f,10);return isNaN(e)?(console.warn(`Invalid numeric string: ${f}, using 0`),0):Math.max(0,e)}return typeof f=="number"?isNaN(f)?(console.warn(`Invalid number value: ${f}, using 0`),0):Math.max(0,Math.floor(f)):0}const Y={fftOverlay:{position:{x:10,y:"65%"},size:{width:"35%",height:"35%"}},harmonicAnalysis:{position:{x:10,y:10},size:{width:500,height:"auto"}},frequencyPlot:{position:{x:"right-10",y:10},size:{width:280,height:120}}};class U{constructor(t,e){i(this,"canvas");i(this,"ctx");i(this,"fftDisplayEnabled",!0);i(this,"debugOverlaysEnabled",!0);i(this,"overlaysLayout");i(this,"FFT_OVERLAY_HEIGHT_RATIO",.9);i(this,"FFT_MIN_BAR_WIDTH",1);i(this,"FREQ_PLOT_MIN_RANGE_PADDING_HZ",50);i(this,"FREQ_PLOT_RANGE_PADDING_RATIO",.1);this.canvas=t;const s=t.getContext("2d");if(!s)throw new Error("Could not get 2D context");this.ctx=s,this.overlaysLayout=e||Y,t.width===300&&t.height===150&&console.warn('Canvas element is using default dimensions (300x150). Set explicit width and height attributes on the canvas element to match desired resolution. Example: <canvas id="oscilloscope" width="1800" height="1000"></canvas>')}clearAndDrawGrid(t,e,s){this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.drawGrid(t,e,s)}drawGrid(t,e,s){this.ctx.strokeStyle="#222222",this.ctx.lineWidth=1,this.ctx.beginPath();const o=5;for(let l=0;l<=o;l++){const r=this.canvas.height/o*l;this.ctx.moveTo(0,r),this.ctx.lineTo(this.canvas.width,r)}const n=10;for(let l=0;l<=n;l++){const r=this.canvas.width/n*l;this.ctx.moveTo(r,0),this.ctx.lineTo(r,this.canvas.height)}this.ctx.stroke(),this.ctx.strokeStyle="#444444",this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.moveTo(0,this.canvas.height/2),this.ctx.lineTo(this.canvas.width,this.canvas.height/2),this.ctx.stroke(),t&&t>0&&e&&e>0&&s!==void 0&&s>0&&this.drawGridLabels(t,e,s)}drawGridLabels(t,e,s){this.ctx.save(),this.ctx.font="11px monospace",this.ctx.fillStyle="#666666";const o=e/t*1e3,n=10,l=o/n;for(let d=0;d<=n;d++){const c=this.canvas.width/n*d,u=l*d;let h;u>=1e3?h=`${(u/1e3).toFixed(2)}s`:u>=1?h=`${u.toFixed(1)}ms`:h=`${(u*1e3).toFixed(0)}μs`;const v=this.ctx.measureText(h).width,x=Math.max(2,Math.min(c-v/2,this.canvas.width-v-2));this.ctx.fillText(h,x,this.canvas.height-3)}const r=5,y=1/(r/2*s);for(let d=0;d<=r;d++){const c=this.canvas.height/r*d,h=(r/2-d)*y;let v;if(h===0)v="0dB*";else{const x=z(Math.abs(h)),m=h>0?"+":"-",p=Math.abs(x);p>=100?v=`${m}${p.toFixed(0)}dB`:v=`${m}${p.toFixed(1)}dB`}this.ctx.fillText(v,3,c+10)}this.ctx.restore()}drawWaveform(t,e,s,o){const n=s-e;if(n<=0)return;this.ctx.strokeStyle="#00ff00",this.ctx.lineWidth=2,this.ctx.beginPath();const l=this.canvas.width/n,r=this.canvas.height/2,y=this.canvas.height/2*o;for(let d=0;d<n;d++){const c=e+d,u=t[c],h=r-u*y,v=Math.min(this.canvas.height,Math.max(0,h)),x=d*l;d===0?this.ctx.moveTo(x,v):this.ctx.lineTo(x,v)}this.ctx.stroke()}drawFFTOverlay(t,e,s,o,n){if(!this.fftDisplayEnabled)return;const l=s/o,r=Math.floor(this.canvas.width*.35),a=Math.floor(this.canvas.height*.35),y=10,d=this.canvas.height-a-10,{x:c,y:u,width:h,height:v}=this.calculateOverlayDimensions(this.overlaysLayout.fftOverlay,y,d,r,a);this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(c,u,h,v),this.ctx.strokeStyle="#00aaff",this.ctx.lineWidth=2,this.ctx.strokeRect(c,u,h,v);const x=Math.min(t.length,Math.ceil(n/l)),m=h/x;this.ctx.fillStyle="#00aaff";for(let p=0;p<x;p++){const S=t[p]/255*v*this.FFT_OVERLAY_HEIGHT_RATIO,w=c+p*m,T=u+v-S;this.ctx.fillRect(w,T,Math.max(m-1,this.FFT_MIN_BAR_WIDTH),S)}if(e>0&&e<=n){const p=e/l,C=c+p*m;this.ctx.strokeStyle="#ff00ff",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(C,u),this.ctx.lineTo(C,u+v),this.ctx.stroke(),this.ctx.fillStyle="#ff00ff",this.ctx.font="bold 12px Arial";const S=`${e.toFixed(1)} Hz`,w=this.ctx.measureText(S).width;let T=C+3;T+w>c+h-5&&(T=C-w-3),this.ctx.fillText(S,T,u+15)}this.ctx.restore()}drawHarmonicAnalysis(t,e,s,o,n,l,r){if(!this.debugOverlaysEnabled||!this.fftDisplayEnabled||t===void 0&&!e&&!s&&!l)return;const a=16,d=(1+(t!==void 0?1:0)+(e?1:0)+(s?1:0)+(l?2:0))*a+10,{x:c,y:u,width:h,height:v}=this.calculateOverlayDimensions(this.overlaysLayout.harmonicAnalysis,10,10,500,d);let x=u;if(this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillRect(c,u,h,v),this.ctx.strokeStyle="#ffaa00",this.ctx.lineWidth=2,this.ctx.strokeRect(c,u,h,v),this.ctx.fillStyle="#ffaa00",this.ctx.font="bold 12px monospace",x+=15,this.ctx.fillText("倍音分析 (Harmonic Analysis)",c+5,x),t!==void 0&&r){x+=a,this.ctx.fillStyle="#00ff00",this.ctx.font="11px monospace";const m=r/2;this.ctx.fillText(`1/2周波数 (${m.toFixed(1)}Hz) のpeak強度: ${t.toFixed(1)}%`,c+5,x)}if(e&&r){x+=a,this.ctx.fillStyle="#ff00ff",this.ctx.font="11px monospace";const m=e.map((C,S)=>`${S+1}x:${C.toFixed(2)}`).join(" "),p=o!==void 0?` (重み付け: ${o.toFixed(1)})`:"";this.ctx.fillText(`候補1 (${r.toFixed(1)}Hz) 倍音: ${m}${p}`,c+5,x)}if(s&&r){x+=a,this.ctx.fillStyle="#00aaff",this.ctx.font="11px monospace";const m=r/2,p=s.map((S,w)=>`${w+1}x:${S.toFixed(2)}`).join(" "),C=n!==void 0?` (重み付け: ${n.toFixed(1)})`:"";this.ctx.fillText(`候補2 (${m.toFixed(1)}Hz) 倍音: ${p}${C}`,c+5,x)}if(l){x+=a,this.ctx.fillStyle="#aaaaaa",this.ctx.font="10px monospace";const m=h-10,p=l.split(" ");let C="";for(const S of p){const w=C+(C?" ":"")+S;this.ctx.measureText(w).width>m&&C?(this.ctx.fillText(C,c+5,x),x+=a,C=S):C=w}C&&this.ctx.fillText(C,c+5,x)}this.ctx.restore()}drawFrequencyPlot(t,e,s){if(!this.debugOverlaysEnabled||!t||t.length===0)return;const{x:o,y:n,width:l,height:r}=this.calculateOverlayDimensions(this.overlaysLayout.frequencyPlot,this.canvas.width-280-10,10,280,120);this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(o,n,l,r),this.ctx.strokeStyle="#ffaa00",this.ctx.lineWidth=2,this.ctx.strokeRect(o,n,l,r),this.ctx.fillStyle="#ffaa00",this.ctx.font="bold 12px Arial",this.ctx.fillText(`周波数推移 (${t.length}frame)`,o+5,n+15);const a=o+35,y=n+25,d=l-45,c=r-45,u=t.filter(g=>g>0);if(u.length===0){this.ctx.restore();return}const h=Math.min(...u),v=Math.max(...u),x=(v-h)*this.FREQ_PLOT_RANGE_PADDING_RATIO||this.FREQ_PLOT_MIN_RANGE_PADDING_HZ,m=Math.max(e,h-x),p=Math.min(s,v+x);this.ctx.strokeStyle="#333333",this.ctx.lineWidth=1,this.ctx.beginPath();for(let g=0;g<=4;g++){const E=y+c/4*g;this.ctx.moveTo(a,E),this.ctx.lineTo(a+d,E)}for(let g=0;g<=4;g++){const E=a+d/4*g;this.ctx.moveTo(E,y),this.ctx.lineTo(E,y+c)}this.ctx.stroke(),this.ctx.fillStyle="#aaaaaa",this.ctx.font="10px monospace",this.ctx.textAlign="right",this.ctx.textBaseline="middle";for(let g=0;g<=4;g++){const E=p-(p-m)*(g/4),M=y+c/4*g,F=E>=1e3?`${(E/1e3).toFixed(1)}k`:`${E.toFixed(0)}`;this.ctx.fillText(F,a-5,M)}this.ctx.fillStyle="#88ccff",this.ctx.font="9px monospace",this.ctx.textAlign="right",this.ctx.textBaseline="middle";for(let g=0;g<=4;g++){const E=p-(p-m)*(g/4),M=y+c/4*g,F=P(E);if(F){const W=F.cents>=0?"+":"";this.ctx.fillText(`${W}${F.cents}¢`,a+d-5,M)}}this.ctx.strokeStyle="#00ff00",this.ctx.lineWidth=2,this.ctx.beginPath();const C=d/Math.max(t.length-1,1),S=Math.max(1,Math.floor(t.length/4)),w=g=>{const M=(Math.max(m,Math.min(p,g))-m)/(p-m);return y+c-M*c};let T=!1;for(let g=0;g<t.length;g++){const E=t[g],M=a+g*C;if(E===0){T=!1;continue}const F=w(E);T?this.ctx.lineTo(M,F):(this.ctx.moveTo(M,F),T=!0)}this.ctx.stroke(),this.ctx.font="9px monospace",this.ctx.textAlign="center",this.ctx.textBaseline="top";for(let g=0;g<t.length;g++){const E=t[g],M=a+g*C;if(E!==0){const R=w(E);this.ctx.fillStyle="#00ff00",this.ctx.beginPath(),this.ctx.arc(M,R,2,0,Math.PI*2),this.ctx.fill()}const F=g===t.length-1;if(g%S===0||F){this.ctx.fillStyle="#aaaaaa";const R=g-t.length+1;this.ctx.fillText(`${R}`,M,y+c+2)}}const A=t[t.length-1];if(A>0){const g=P(A);this.ctx.fillStyle="#00ff00",this.ctx.font="bold 11px Arial",this.ctx.textAlign="left",this.ctx.textBaseline="bottom";let E=`${A.toFixed(1)} Hz`;if(g){const M=g.cents>=0?"+":"";E+=` (${g.noteName} ${M}${g.cents}¢)`}this.ctx.fillText(E,a+2,y+c-2)}this.ctx.restore()}drawPhaseMarkers(t,e,s,o,n,l){if(n===void 0||l===void 0)return;const r=l-n;if(r<=0)return;this.ctx.save();const a=(y,d,c)=>{const u=y-n;if(u<0||u>=r)return;const h=u/r*this.canvas.width;this.ctx.strokeStyle=d,this.ctx.lineWidth=c,this.ctx.beginPath(),this.ctx.moveTo(h,0),this.ctx.lineTo(h,this.canvas.height),this.ctx.stroke()};s!==void 0&&a(s,"#ff8800",2),o!==void 0&&a(o,"#ff8800",2),t!==void 0&&a(t,"#ff0000",2),e!==void 0&&a(e,"#ff0000",2),this.ctx.restore()}setFFTDisplay(t){this.fftDisplayEnabled=t}getFFTDisplayEnabled(){return this.fftDisplayEnabled}setDebugOverlaysEnabled(t){this.debugOverlaysEnabled=t}getDebugOverlaysEnabled(){return this.debugOverlaysEnabled}setOverlaysLayout(t){this.overlaysLayout={...this.overlaysLayout,...t}}getOverlaysLayout(){return this.overlaysLayout}calculateOverlayDimensions(t,e,s,o,n){if(!t)return{x:e,y:s,width:o,height:n};let l=e,r=s,a=o,y=n;if(t.position.x!==void 0)if(typeof t.position.x=="string"&&t.position.x.startsWith("right-")){const d=parseInt(t.position.x.substring(6),10),c=typeof t.size.width=="string"&&t.size.width.endsWith("%")?I(t.size.width,this.canvas.width):typeof t.size.width=="number"?t.size.width:o;l=this.canvas.width-c-d}else l=I(t.position.x,this.canvas.width);return t.position.y!==void 0&&(r=I(t.position.y,this.canvas.height)),t.size.width!==void 0&&t.size.width!=="auto"&&(a=I(t.size.width,this.canvas.width)),t.size.height!==void 0&&t.size.height!=="auto"&&(y=I(t.size.height,this.canvas.height)),{x:l,y:r,width:a,height:y}}}class Z{constructor(){i(this,"usePeakMode",!1);i(this,"zeroCrossMode","hysteresis")}setUsePeakMode(t){this.usePeakMode=t}getUsePeakMode(){return this.usePeakMode}setZeroCrossMode(t){this.zeroCrossMode=t}getZeroCrossMode(){return this.zeroCrossMode}reset(){}}class X{constructor(){i(this,"previousWaveform",null);i(this,"lastSimilarity",0)}getLastSimilarity(){return this.lastSimilarity}reset(){this.previousWaveform=null,this.lastSimilarity=0}hasPreviousWaveform(){return this.previousWaveform!==null}getPreviousWaveform(){return this.previousWaveform}}class Q{constructor(t,e,s,o){i(this,"previousCanvas");i(this,"currentCanvas");i(this,"similarityCanvas");i(this,"bufferCanvas");i(this,"previousCtx");i(this,"currentCtx");i(this,"similarityCtx");i(this,"bufferCtx");i(this,"TARGET_FILL_RATIO",.9);i(this,"MIN_PEAK_THRESHOLD",.001);i(this,"DEFAULT_AMPLITUDE_RATIO",.4);this.previousCanvas=t,this.currentCanvas=e,this.similarityCanvas=s,this.bufferCanvas=o;const n=t.getContext("2d"),l=e.getContext("2d"),r=s.getContext("2d"),a=o.getContext("2d");if(!n||!l||!r||!a)throw new Error("Could not get 2D context for comparison canvases");this.previousCtx=n,this.currentCtx=l,this.similarityCtx=r,this.bufferCtx=a,this.clearAllCanvases()}clearAllCanvases(){this.clearCanvas(this.previousCtx,this.previousCanvas.width,this.previousCanvas.height),this.clearCanvas(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height),this.clearCanvas(this.similarityCtx,this.similarityCanvas.width,this.similarityCanvas.height),this.clearCanvas(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height)}clearCanvas(t,e,s){t.fillStyle="#000000",t.fillRect(0,0,e,s)}findPeakAmplitude(t,e,s){let o=0;const n=Math.max(0,e),l=Math.min(t.length,s);for(let r=n;r<l;r++){const a=Math.abs(t[r]);a>o&&(o=a)}return o}drawWaveform(t,e,s,o,n,l,r){const a=l-n;if(a<=0)return;const y=this.findPeakAmplitude(o,n,l);t.strokeStyle=r,t.lineWidth=1.5,t.beginPath();const d=e/a,c=s/2;let u;if(y>this.MIN_PEAK_THRESHOLD){const h=this.TARGET_FILL_RATIO/y;u=s/2*h}else u=s*this.DEFAULT_AMPLITUDE_RATIO;for(let h=0;h<a;h++){const v=n+h;if(v>=o.length)break;const x=o[v],m=c-x*u,p=Math.min(s,Math.max(0,m)),C=h*d;h===0?t.moveTo(C,p):t.lineTo(C,p)}t.stroke()}drawCenterLine(t,e,s){t.strokeStyle="#444444",t.lineWidth=1,t.beginPath(),t.moveTo(0,s/2),t.lineTo(e,s/2),t.stroke()}drawSimilarityText(t){this.currentCtx.fillStyle="#00aaff",this.currentCtx.font="bold 14px Arial";const e=`Similarity: ${t.toFixed(3)}`,s=this.currentCtx.measureText(e).width,o=(this.currentCanvas.width-s)/2;this.currentCtx.fillText(e,o,20)}drawSimilarityPlot(t){if(!t||t.length===0)return;const e=this.similarityCtx,s=this.similarityCanvas.width,o=this.similarityCanvas.height;e.save(),e.fillStyle="#000000",e.fillRect(0,0,s,o),e.strokeStyle="#00aaff",e.lineWidth=2,e.strokeRect(0,0,s,o),e.fillStyle="#00aaff",e.font="bold 12px Arial",e.fillText("類似度推移 (Similarity)",5,15);const n=40,l=25,r=s-50,a=o-35,y=-1,d=1;e.strokeStyle="#333333",e.lineWidth=1,e.beginPath();for(let h=0;h<=4;h++){const v=l+a/4*h;e.moveTo(n,v),e.lineTo(n+r,v)}for(let h=0;h<=4;h++){const v=n+r/4*h;e.moveTo(v,l),e.lineTo(v,l+a)}e.stroke(),e.fillStyle="#aaaaaa",e.font="10px monospace",e.textAlign="right",e.textBaseline="middle";for(let h=0;h<=4;h++){const v=d-(d-y)*(h/4),x=l+a/4*h,m=v.toFixed(2);e.fillText(m,n-5,x)}e.strokeStyle="#00aaff",e.lineWidth=2,e.beginPath();const c=r/Math.max(t.length-1,1);for(let h=0;h<t.length;h++){const v=t[h],x=n+h*c,p=(Math.max(y,Math.min(d,v))-y)/(d-y),C=l+a-p*a;h===0?e.moveTo(x,C):e.lineTo(x,C)}e.stroke();const u=t[t.length-1];e.fillStyle="#00aaff",e.font="bold 11px Arial",e.textAlign="left",e.textBaseline="bottom",e.fillText(`${u.toFixed(3)}`,n+2,l+a-2),e.restore()}drawPositionMarkers(t,e,s,o,n,l){if(l<=0)return;const r=o/l*e,a=n/l*e;t.strokeStyle="#ff0000",t.lineWidth=2,t.beginPath(),t.moveTo(r,0),t.lineTo(r,s),t.stroke(),t.beginPath(),t.moveTo(a,0),t.lineTo(a,s),t.stroke(),t.fillStyle="#ff0000",t.font="10px Arial",t.fillText("S",r+2,12),t.fillText("E",a+2,12)}updatePanels(t,e,s,o,n,l,r=[]){this.clearAllCanvases(),t&&(this.drawCenterLine(this.previousCtx,this.previousCanvas.width,this.previousCanvas.height),this.drawWaveform(this.previousCtx,this.previousCanvas.width,this.previousCanvas.height,t,0,t.length,"#ffaa00")),this.drawCenterLine(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height),o-s>0&&this.drawWaveform(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height,e,s,o,"#00ff00"),t&&this.drawSimilarityText(l),r.length>0&&this.drawSimilarityPlot(r),this.drawCenterLine(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height),this.drawWaveform(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height,n,0,n.length,"#888888"),this.drawPositionMarkers(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height,s,o,n.length)}clear(){this.clearAllCanvases()}}class j{constructor(t,e,s){i(this,"canvas8div");i(this,"canvas4div");i(this,"canvas2div");i(this,"ctx8div");i(this,"ctx4div");i(this,"ctx2div");this.canvas8div=t,this.canvas4div=e,this.canvas2div=s;const o=t.getContext("2d"),n=e.getContext("2d"),l=s.getContext("2d");if(!o||!n||!l)throw new Error("Could not get 2D context for cycle similarity canvases");this.ctx8div=o,this.ctx4div=n,this.ctx2div=l,this.clearAllCanvases()}clearAllCanvases(){this.clearCanvas(this.ctx8div,this.canvas8div.width,this.canvas8div.height),this.clearCanvas(this.ctx4div,this.canvas4div.width,this.canvas4div.height),this.clearCanvas(this.ctx2div,this.canvas2div.width,this.canvas2div.height)}clearCanvas(t,e,s){t.fillStyle="#000000",t.fillRect(0,0,e,s)}drawSimilarityGraph(t,e,s,o,n,l){if(t.save(),t.fillStyle="#000000",t.fillRect(0,0,e,s),t.strokeStyle="#ff8800",t.lineWidth=2,t.strokeRect(0,0,e,s),t.fillStyle="#ff8800",t.font="bold 12px Arial",t.fillText(n,5,15),!o||o.length===0){t.fillStyle="#666666",t.font="11px Arial",t.fillText("データなし (No data)",e/2-50,s/2),t.restore();return}const r=35,a=25,y=e-45,d=s-35,c=-1,u=1;t.strokeStyle="#333333",t.lineWidth=1,t.beginPath();for(let m=0;m<=4;m++){const p=a+d/4*m;t.moveTo(r,p),t.lineTo(r+y,p)}for(let m=0;m<=o.length;m++){const p=r+y/o.length*m;t.moveTo(p,a),t.lineTo(p,a+d)}t.stroke(),t.fillStyle="#aaaaaa",t.font="10px monospace",t.textAlign="right",t.textBaseline="middle";for(let m=0;m<=4;m++){const p=u-(u-c)*(m/4),C=a+d/4*m,S=p.toFixed(1);t.fillText(S,r-5,C)}const h=y/o.length,v=h*.15;for(let m=0;m<o.length;m++){const p=o[m],C=Math.max(c,Math.min(u,p)),S=(C-c)/(u-c),w=a+d-S*d,T=a+d-(0-c)/(u-c)*d,A=r+m*h+v,g=h-v*2;p>=.9?t.fillStyle="#00ff00":p>=.7?t.fillStyle="#88ff00":p>=.5?t.fillStyle="#ffaa00":p>=0?t.fillStyle="#ff6600":t.fillStyle="#ff0000",w<T?t.fillRect(A,w,g,T-w):t.fillRect(A,T,g,w-T),t.fillStyle="#ffffff",t.font="9px monospace",t.textAlign="center",C>=0?(t.textBaseline="bottom",t.fillText(p.toFixed(2),A+g/2,w-2)):(t.textBaseline="top",t.fillText(p.toFixed(2),A+g/2,w+2))}const x=a+d-(0-c)/(u-c)*d;t.strokeStyle="#666666",t.lineWidth=1,t.beginPath(),t.moveTo(r,x),t.lineTo(r+y,x),t.stroke(),t.fillStyle="#aaaaaa",t.font="9px Arial",t.textAlign="center",t.textBaseline="top";for(let m=0;m<o.length;m++){const p=r+(m+.5)*h;t.fillText(`${m+1}-${m+2}`,p,a+d+2)}t.fillStyle="#aaaaaa",t.font="10px Arial",t.textAlign="center",t.fillText(l,r+y/2,s-3),t.restore()}updateGraphs(t,e,s){this.drawSimilarityGraph(this.ctx8div,this.canvas8div.width,this.canvas8div.height,t||[],"8分割 (1/2周期)","連続する1/2周期間の類似度"),this.drawSimilarityGraph(this.ctx4div,this.canvas4div.width,this.canvas4div.height,e||[],"4分割 (1周期)","連続する1周期間の類似度"),this.drawSimilarityGraph(this.ctx2div,this.canvas2div.width,this.canvas2div.height,s||[],"2分割 (2周期)","連続する2周期間の類似度")}clear(){this.clearAllCanvases()}}const _=class _{constructor(){i(this,"cachedBasePath",null)}getBasePath(){var e;if(this.cachedBasePath!==null)return this.cachedBasePath;let t=(e=document.querySelector("base"))==null?void 0:e.getAttribute("href");if(t)try{t=new URL(t,window.location.href).pathname}catch{}if(t||(t=this.getBasePathFromScripts()),!t&&window.location.pathname&&window.location.pathname!=="/"){const o=window.location.pathname.split("/").filter(n=>n.length>0);o.length>0&&(t=`/${o[0]}/`)}return t||(t="/"),t.endsWith("/")||(t+="/"),this.cachedBasePath=t,t}getBasePathFromScripts(){const t=document.querySelectorAll("script[src]");for(const e of t){const s=e.getAttribute("src");if(s)try{const n=new URL(s,window.location.href).pathname;for(const l of _.ASSET_PATTERNS){const r=n.indexOf(l);if(r>=0)return r===0?"/":n.substring(0,r)+"/"}}catch(o){(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&console.debug("Failed to parse script URL:",s,o);continue}}return""}};i(_,"ASSET_PATTERNS",["/assets/","/js/","/dist/"]);let D=_;class J{constructor(){i(this,"wasmProcessor",null);i(this,"isInitialized",!1);i(this,"LOAD_TIMEOUT_MS",1e4)}async loadWasmModule(t){if(!(this.isInitialized&&this.wasmProcessor)){if(typeof window>"u"||window.location.protocol==="file:")throw new Error("WASM module not available in test/non-browser environment");return new Promise((e,s)=>{if(window.wasmProcessor&&window.wasmProcessor.WasmDataProcessor){this.wasmProcessor=new window.wasmProcessor.WasmDataProcessor,this.isInitialized=!0,e();return}const o=setTimeout(()=>{r(),s(new Error(`WASM module loading timed out after ${this.LOAD_TIMEOUT_MS/1e3} seconds`))},this.LOAD_TIMEOUT_MS),n=`${t}wasm/wasm_processor.js`,l=document.createElement("script");l.type="module",l.textContent=`
        import init, { WasmDataProcessor } from '${n}';
        await init();
        window.wasmProcessor = { WasmDataProcessor };
        window.dispatchEvent(new Event('wasmLoaded'));
      `;const r=()=>{clearTimeout(o),window.removeEventListener("wasmLoaded",a)},a=()=>{r(),window.wasmProcessor&&window.wasmProcessor.WasmDataProcessor?(this.wasmProcessor=new window.wasmProcessor.WasmDataProcessor,this.isInitialized=!0,e()):s(new Error("WASM module loaded but WasmDataProcessor not found"))};window.addEventListener("wasmLoaded",a),l.onerror=()=>{r(),s(new Error("Failed to load WASM module script"))},document.head.appendChild(l)})}}getProcessor(){return this.wasmProcessor}isReady(){return this.isInitialized&&this.wasmProcessor!==null}}class tt{constructor(t,e,s,o,n){i(this,"audioManager");i(this,"gainController");i(this,"frequencyEstimator");i(this,"waveformSearcher");i(this,"zeroCrossDetector");i(this,"basePathResolver");i(this,"wasmLoader");this.audioManager=t,this.gainController=e,this.frequencyEstimator=s,this.waveformSearcher=o,this.zeroCrossDetector=n,this.basePathResolver=new D,this.wasmLoader=new J}async initialize(){if(!this.wasmLoader.isReady())try{const t=this.basePathResolver.getBasePath();await this.wasmLoader.loadWasmModule(t),this.syncConfigToWasm()}catch(t){throw console.error("Failed to initialize WASM module:",t),t}}syncConfigToWasm(){const t=this.wasmLoader.getProcessor();t&&(t.setAutoGain(this.gainController.getAutoGainEnabled()),t.setNoiseGate(this.gainController.getNoiseGateEnabled()),t.setNoiseGateThreshold(this.gainController.getNoiseGateThreshold()),t.setFrequencyEstimationMethod(this.frequencyEstimator.getFrequencyEstimationMethod()),t.setBufferSizeMultiplier(this.frequencyEstimator.getBufferSizeMultiplier()),t.setZeroCrossMode(this.zeroCrossDetector.getZeroCrossMode()))}syncResultsFromWasm(t){this.frequencyEstimator.estimatedFrequency=t.estimatedFrequency,this.gainController.currentGain=t.gain,t.previousWaveform&&(this.waveformSearcher.previousWaveform=t.previousWaveform),this.waveformSearcher.lastSimilarity=t.similarity}processFrame(t){const e=this.wasmLoader.getProcessor();if(!this.wasmLoader.isReady()||!e)return console.warn("WASM processor not initialized"),null;if(!this.audioManager.isReady())return null;const s=this.audioManager.getTimeDomainData();if(!s)return null;const o=this.audioManager.getSampleRate(),n=this.audioManager.getFFTSize(),r=this.frequencyEstimator.getFrequencyEstimationMethod()==="fft"||t?this.audioManager.getFrequencyData():null;this.syncConfigToWasm();const a=e.processFrame(s,r,o,n,t);if(!a)return null;const y={waveformData:new Float32Array(a.waveform_data),displayStartIndex:a.displayStartIndex,displayEndIndex:a.displayEndIndex,gain:a.gain,estimatedFrequency:a.estimatedFrequency,frequencyPlotHistory:a.frequencyPlotHistory?Array.from(a.frequencyPlotHistory):[],sampleRate:a.sampleRate,fftSize:a.fftSize,frequencyData:a.frequencyData?new Uint8Array(a.frequencyData):void 0,isSignalAboveNoiseGate:a.isSignalAboveNoiseGate,maxFrequency:a.maxFrequency,previousWaveform:a.previousWaveform?new Float32Array(a.previousWaveform):null,similarity:a.similarity,similarityPlotHistory:a.similarityPlotHistory?Array.from(a.similarityPlotHistory):[],usedSimilaritySearch:a.usedSimilaritySearch,phaseZeroIndex:a.phaseZeroIndex,phaseTwoPiIndex:a.phaseTwoPiIndex,phaseMinusQuarterPiIndex:a.phaseMinusQuarterPiIndex,phaseTwoPiPlusQuarterPiIndex:a.phaseTwoPiPlusQuarterPiIndex,halfFreqPeakStrengthPercent:a.halfFreqPeakStrengthPercent,candidate1Harmonics:a.candidate1Harmonics?Array.from(a.candidate1Harmonics):void 0,candidate2Harmonics:a.candidate2Harmonics?Array.from(a.candidate2Harmonics):void 0,selectionReason:a.selectionReason,cycleSimilarities8div:a.cycleSimilarities8div?Array.from(a.cycleSimilarities8div):void 0,cycleSimilarities4div:a.cycleSimilarities4div?Array.from(a.cycleSimilarities4div):void 0,cycleSimilarities2div:a.cycleSimilarities2div?Array.from(a.cycleSimilarities2div):void 0};return this.syncResultsFromWasm(y),y}reset(){const t=this.wasmLoader.getProcessor();t&&t.reset()}}class et{constructor(t,e,s,o,n,l,r,a,y){i(this,"audioManager");i(this,"gainController");i(this,"frequencyEstimator");i(this,"renderer");i(this,"zeroCrossDetector");i(this,"waveformSearcher");i(this,"comparisonRenderer");i(this,"cycleSimilarityRenderer",null);i(this,"dataProcessor");i(this,"animationId",null);i(this,"isRunning",!1);i(this,"isPaused",!1);i(this,"lastFrameTime",0);i(this,"frameProcessingTimes",[]);i(this,"MAX_FRAME_TIMES",100);i(this,"TARGET_FRAME_TIME",16.67);i(this,"FPS_LOG_INTERVAL_FRAMES",60);this.audioManager=new K,this.gainController=new $,this.frequencyEstimator=new V,this.renderer=new U(t,y),this.zeroCrossDetector=new Z,this.waveformSearcher=new X,this.comparisonRenderer=new Q(e,s,o,n),l&&r&&a&&(this.cycleSimilarityRenderer=new j(l,r,a)),this.dataProcessor=new tt(this.audioManager,this.gainController,this.frequencyEstimator,this.waveformSearcher,this.zeroCrossDetector)}async start(){try{await this.dataProcessor.initialize(),await this.audioManager.start(),this.isRunning=!0,this.render()}catch(t){throw console.error("Error starting oscilloscope:",t),t}}async startFromFile(t){try{await this.dataProcessor.initialize(),await this.audioManager.startFromFile(t),this.isRunning=!0,this.render()}catch(e){throw console.error("Error loading audio file:",e),e}}async startFromBuffer(t){try{await this.dataProcessor.initialize(),await this.audioManager.startFromBuffer(t),this.isRunning=!0,this.render()}catch(e){throw console.error("Error starting from buffer:",e),e}}async stop(){this.isRunning=!1,this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null),await this.audioManager.stop(),this.frequencyEstimator.clearHistory(),this.zeroCrossDetector.reset(),this.waveformSearcher.reset(),this.comparisonRenderer.clear(),this.cycleSimilarityRenderer&&this.cycleSimilarityRenderer.clear(),this.dataProcessor.reset()}render(){if(!this.isRunning)return;const t=performance.now();if(!this.isPaused){const o=this.dataProcessor.processFrame(this.renderer.getFFTDisplayEnabled());o&&this.renderFrame(o)}const s=performance.now()-t;if(this.frameProcessingTimes.push(s),this.frameProcessingTimes.length>this.MAX_FRAME_TIMES&&this.frameProcessingTimes.shift(),s>this.TARGET_FRAME_TIME&&console.warn(`Frame processing time: ${s.toFixed(2)}ms (target: <${this.TARGET_FRAME_TIME}ms)`),this.lastFrameTime>0){const n=1e3/(t-this.lastFrameTime);if(this.frameProcessingTimes.length===this.FPS_LOG_INTERVAL_FRAMES){const l=this.frameProcessingTimes.reduce((r,a)=>r+a,0)/this.frameProcessingTimes.length;console.log(`FPS: ${n.toFixed(1)}, Avg frame time: ${l.toFixed(2)}ms`)}}this.lastFrameTime=t,this.animationId=requestAnimationFrame(()=>this.render())}renderFrame(t){const e=t.displayEndIndex-t.displayStartIndex;this.renderer.clearAndDrawGrid(t.sampleRate,e,t.gain),this.renderer.drawWaveform(t.waveformData,t.displayStartIndex,t.displayEndIndex,t.gain),this.renderer.drawPhaseMarkers(t.phaseZeroIndex,t.phaseTwoPiIndex,t.phaseMinusQuarterPiIndex,t.phaseTwoPiPlusQuarterPiIndex,t.displayStartIndex,t.displayEndIndex),t.frequencyData&&this.renderer.getFFTDisplayEnabled()&&t.isSignalAboveNoiseGate&&(this.renderer.drawFFTOverlay(t.frequencyData,t.estimatedFrequency,t.sampleRate,t.fftSize,t.maxFrequency),this.renderer.drawHarmonicAnalysis(t.halfFreqPeakStrengthPercent,t.candidate1Harmonics,t.candidate2Harmonics,t.candidate1WeightedScore,t.candidate2WeightedScore,t.selectionReason,t.estimatedFrequency)),this.renderer.drawFrequencyPlot(t.frequencyPlotHistory,this.frequencyEstimator.getMinFrequency(),this.frequencyEstimator.getMaxFrequency()),this.comparisonRenderer.updatePanels(t.previousWaveform,t.waveformData,t.displayStartIndex,t.displayEndIndex,t.waveformData,t.similarity,t.similarityPlotHistory),this.cycleSimilarityRenderer&&this.cycleSimilarityRenderer.updateGraphs(t.cycleSimilarities8div,t.cycleSimilarities4div,t.cycleSimilarities2div)}getIsRunning(){return this.isRunning}setAutoGain(t){this.gainController.setAutoGain(t)}getAutoGainEnabled(){return this.gainController.getAutoGainEnabled()}setNoiseGate(t){this.gainController.setNoiseGate(t)}getNoiseGateEnabled(){return this.gainController.getNoiseGateEnabled()}setNoiseGateThreshold(t){this.gainController.setNoiseGateThreshold(t)}getNoiseGateThreshold(){return this.gainController.getNoiseGateThreshold()}setFrequencyEstimationMethod(t){this.frequencyEstimator.setFrequencyEstimationMethod(t)}getFrequencyEstimationMethod(){return this.frequencyEstimator.getFrequencyEstimationMethod()}setBufferSizeMultiplier(t){this.frequencyEstimator.setBufferSizeMultiplier(t)}getBufferSizeMultiplier(){return this.frequencyEstimator.getBufferSizeMultiplier()}getEstimatedFrequency(){return this.frequencyEstimator.getEstimatedFrequency()}setFFTDisplay(t){this.renderer.setFFTDisplay(t)}getFFTDisplayEnabled(){return this.renderer.getFFTDisplayEnabled()}setDebugOverlaysEnabled(t){this.renderer.setDebugOverlaysEnabled(t)}getDebugOverlaysEnabled(){return this.renderer.getDebugOverlaysEnabled()}setOverlaysLayout(t){this.renderer.setOverlaysLayout(t)}getOverlaysLayout(){return this.renderer.getOverlaysLayout()}getCurrentGain(){return this.gainController.getCurrentGain()}getSimilarityScore(){return this.waveformSearcher.getLastSimilarity()}isSimilaritySearchActive(){return this.waveformSearcher.hasPreviousWaveform()}setUsePeakMode(t){this.zeroCrossDetector.setUsePeakMode(t)}getUsePeakMode(){return this.zeroCrossDetector.getUsePeakMode()}setZeroCrossMode(t){this.zeroCrossDetector.setZeroCrossMode(t)}getZeroCrossMode(){return this.zeroCrossDetector.getZeroCrossMode()}setPauseDrawing(t){this.isPaused=t}getPauseDrawing(){return this.isPaused}}class it{constructor(t){i(this,"canvas");i(this,"ctx");i(this,"MIN_FREQ",50);i(this,"MAX_FREQ",2e3);i(this,"WHITE_KEY_WIDTH",20);i(this,"WHITE_KEY_HEIGHT",60);i(this,"BLACK_KEY_WIDTH",12);i(this,"BLACK_KEY_HEIGHT",38);i(this,"WHITE_KEY_COLOR","#ffffff");i(this,"BLACK_KEY_COLOR","#000000");i(this,"WHITE_KEY_HIGHLIGHT","#00ff00");i(this,"BLACK_KEY_HIGHLIGHT","#00cc00");i(this,"KEY_BORDER","#333333");i(this,"WHITE_KEY_NOTES",[0,2,4,5,7,9,11]);i(this,"BLACK_KEY_NOTES",[1,3,6,8,10]);i(this,"keyboardRange");i(this,"xOffset");i(this,"whiteKeyCount");this.canvas=t;const e=t.getContext("2d");if(!e)throw new Error("Could not get 2D context for piano keyboard");this.ctx=e,this.keyboardRange=this.calculateKeyboardRange(),this.whiteKeyCount=this.countWhiteKeys(),this.xOffset=this.calculateCenteringOffset()}frequencyToNoteInfo(t){const e=P(t);if(!e)return{note:-1,octave:-1,noteInOctave:-1};const s=e.noteName.match(/^([A-G]#?)(\d+)$/);if(!s)return{note:-1,octave:-1,noteInOctave:-1};const o=s[1],n=parseInt(s[2],10),r=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"].indexOf(o);return{note:n*12+r,octave:n,noteInOctave:r}}calculateKeyboardRange(){const t=this.frequencyToNoteInfo(this.MIN_FREQ),e=this.frequencyToNoteInfo(this.MAX_FREQ);return{startNote:t.note,endNote:e.note}}countWhiteKeys(){const t=this.keyboardRange;let e=0;for(let s=t.startNote;s<=t.endNote;s++){const o=(s%12+12)%12;this.WHITE_KEY_NOTES.includes(o)&&e++}return e}calculateCenteringOffset(){const t=this.whiteKeyCount*this.WHITE_KEY_WIDTH;return(this.canvas.width-t)/2}render(t){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);const e=this.keyboardRange,s=t>0?this.frequencyToNoteInfo(t):null;let o=0;for(let a=e.startNote;a<=e.endNote;a++){const y=(a%12+12)%12;if(this.WHITE_KEY_NOTES.includes(y)){const d=this.xOffset+o*this.WHITE_KEY_WIDTH,c=s&&s.note===a;this.ctx.fillStyle=c?this.WHITE_KEY_HIGHLIGHT:this.WHITE_KEY_COLOR,this.ctx.fillRect(d,0,this.WHITE_KEY_WIDTH,this.WHITE_KEY_HEIGHT),this.ctx.strokeStyle=this.KEY_BORDER,this.ctx.lineWidth=1,this.ctx.strokeRect(d,0,this.WHITE_KEY_WIDTH,this.WHITE_KEY_HEIGHT),o++}}o=0;for(let a=e.startNote;a<=e.endNote;a++){const y=(a%12+12)%12;if(this.WHITE_KEY_NOTES.includes(y)&&o++,this.BLACK_KEY_NOTES.includes(y)){const d=this.xOffset+o*this.WHITE_KEY_WIDTH-this.BLACK_KEY_WIDTH/2,c=s&&s.note===a;this.ctx.fillStyle=c?this.BLACK_KEY_HIGHLIGHT:this.BLACK_KEY_COLOR,this.ctx.fillRect(d,0,this.BLACK_KEY_WIDTH,this.BLACK_KEY_HEIGHT),this.ctx.strokeStyle=this.KEY_BORDER,this.ctx.lineWidth=1,this.ctx.strokeRect(d,0,this.BLACK_KEY_WIDTH,this.BLACK_KEY_HEIGHT)}}this.ctx.fillStyle="#888888",this.ctx.font="10px monospace",this.ctx.fillText(`${this.MIN_FREQ}Hz`,this.xOffset+5,this.WHITE_KEY_HEIGHT-5);const n=`${this.MAX_FREQ}Hz`,l=this.ctx.measureText(n).width,r=this.xOffset+this.whiteKeyCount*this.WHITE_KEY_WIDTH;this.ctx.fillText(n,r-l-5,this.WHITE_KEY_HEIGHT-5)}clear(){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}}class st{constructor(){i(this,"canvas");i(this,"previousWaveformCanvas");i(this,"currentWaveformCanvas");i(this,"similarityPlotCanvas");i(this,"frameBufferCanvas");i(this,"cycleSimilarity8divCanvas");i(this,"cycleSimilarity4divCanvas");i(this,"cycleSimilarity2divCanvas");i(this,"pianoKeyboardCanvas");i(this,"startButton");i(this,"loadFileButton");i(this,"fileInput");i(this,"autoGainCheckbox");i(this,"noiseGateCheckbox");i(this,"fftDisplayCheckbox");i(this,"pauseDrawingCheckbox");i(this,"noiseGateThreshold");i(this,"frequencyMethod");i(this,"bufferSizeMultiplier");i(this,"zeroCrossMode");i(this,"thresholdValue");i(this,"statusElement");i(this,"frequencyValue");i(this,"noteValue");i(this,"gainValue");i(this,"similarityValue");this.canvas=this.getElement("canvas"),this.previousWaveformCanvas=this.getElement("previousWaveformCanvas"),this.currentWaveformCanvas=this.getElement("currentWaveformCanvas"),this.similarityPlotCanvas=this.getElement("similarityPlotCanvas"),this.frameBufferCanvas=this.getElement("frameBufferCanvas"),this.cycleSimilarity8divCanvas=this.getElement("cycleSimilarity8divCanvas"),this.cycleSimilarity4divCanvas=this.getElement("cycleSimilarity4divCanvas"),this.cycleSimilarity2divCanvas=this.getElement("cycleSimilarity2divCanvas"),this.pianoKeyboardCanvas=this.getElement("pianoKeyboardCanvas"),this.startButton=this.getElement("startButton"),this.loadFileButton=this.getElement("loadFileButton"),this.fileInput=this.getElement("fileInput"),this.autoGainCheckbox=this.getElement("autoGainCheckbox"),this.noiseGateCheckbox=this.getElement("noiseGateCheckbox"),this.fftDisplayCheckbox=this.getElement("fftDisplayCheckbox"),this.pauseDrawingCheckbox=this.getElement("pauseDrawingCheckbox"),this.noiseGateThreshold=this.getElement("noiseGateThreshold"),this.frequencyMethod=this.getElement("frequencyMethod"),this.bufferSizeMultiplier=this.getElement("bufferSizeMultiplier"),this.zeroCrossMode=this.getElement("zeroCrossMode"),this.thresholdValue=this.getElement("thresholdValue"),this.statusElement=this.getElement("status"),this.frequencyValue=this.getElement("frequencyValue"),this.noteValue=this.getElement("noteValue"),this.gainValue=this.getElement("gainValue"),this.similarityValue=this.getElement("similarityValue"),this.validateElements()}getElement(t){const e=document.getElementById(t);if(!e)throw new Error(`Required DOM element not found: ${t}`);return e}validateElements(){const t=[{element:this.canvas,name:"canvas"},{element:this.previousWaveformCanvas,name:"previousWaveformCanvas"},{element:this.currentWaveformCanvas,name:"currentWaveformCanvas"},{element:this.similarityPlotCanvas,name:"similarityPlotCanvas"},{element:this.frameBufferCanvas,name:"frameBufferCanvas"},{element:this.cycleSimilarity8divCanvas,name:"cycleSimilarity8divCanvas"},{element:this.cycleSimilarity4divCanvas,name:"cycleSimilarity4divCanvas"},{element:this.cycleSimilarity2divCanvas,name:"cycleSimilarity2divCanvas"},{element:this.pianoKeyboardCanvas,name:"pianoKeyboardCanvas"},{element:this.startButton,name:"startButton"},{element:this.loadFileButton,name:"loadFileButton"},{element:this.fileInput,name:"fileInput"},{element:this.autoGainCheckbox,name:"autoGainCheckbox"},{element:this.noiseGateCheckbox,name:"noiseGateCheckbox"},{element:this.fftDisplayCheckbox,name:"fftDisplayCheckbox"},{element:this.pauseDrawingCheckbox,name:"pauseDrawingCheckbox"},{element:this.noiseGateThreshold,name:"noiseGateThreshold"},{element:this.thresholdValue,name:"thresholdValue"},{element:this.statusElement,name:"status"},{element:this.frequencyMethod,name:"frequencyMethod"},{element:this.bufferSizeMultiplier,name:"bufferSizeMultiplier"},{element:this.zeroCrossMode,name:"zeroCrossMode"},{element:this.frequencyValue,name:"frequencyValue"},{element:this.noteValue,name:"noteValue"},{element:this.gainValue,name:"gainValue"},{element:this.similarityValue,name:"similarityValue"}];for(const{element:e,name:s}of t)if(!e)throw new Error(`Required DOM element not found: ${s}`)}}class at{constructor(t,e,s,o,n,l){i(this,"oscilloscope");i(this,"pianoKeyboardRenderer");i(this,"frequencyValue");i(this,"noteValue");i(this,"gainValue");i(this,"similarityValue");i(this,"updateInterval",null);i(this,"UPDATE_INTERVAL_MS",100);this.oscilloscope=t,this.pianoKeyboardRenderer=e,this.frequencyValue=s,this.noteValue=o,this.gainValue=n,this.similarityValue=l}start(){this.updateInterval===null&&(this.updateInterval=window.setInterval(()=>{this.update()},this.UPDATE_INTERVAL_MS))}stop(){this.updateInterval!==null&&(clearInterval(this.updateInterval),this.updateInterval=null,this.clearDisplays())}update(){this.updateFrequencyDisplay(),this.updateGainDisplay(),this.updateSimilarityDisplay()}updateFrequencyDisplay(){const t=this.oscilloscope.getEstimatedFrequency();if(t>0){this.frequencyValue.textContent=`${t.toFixed(1)} Hz`;const e=P(t);if(e){const s=e.cents>=0?"+":"";this.noteValue.textContent=`${e.noteName}${s}${e.cents}cent`}else this.noteValue.textContent="---";this.pianoKeyboardRenderer.render(t)}else this.frequencyValue.textContent="--- Hz",this.noteValue.textContent="---",this.pianoKeyboardRenderer.render(0)}updateGainDisplay(){const t=this.oscilloscope.getCurrentGain();this.gainValue.textContent=`${t.toFixed(2)}x`}updateSimilarityDisplay(){if(this.oscilloscope.isSimilaritySearchActive()){const t=this.oscilloscope.getSimilarityScore();this.similarityValue.textContent=t.toFixed(3)}else this.similarityValue.textContent="---"}clearDisplays(){this.frequencyValue.textContent="--- Hz",this.noteValue.textContent="---",this.gainValue.textContent="---x",this.similarityValue.textContent="---",this.pianoKeyboardRenderer.clear()}}class ot{constructor(t,e,s){i(this,"oscilloscope");i(this,"dom");i(this,"displayUpdater");this.oscilloscope=t,this.dom=e,this.displayUpdater=s}setupEventHandlers(){this.setupCheckboxHandlers(),this.setupSliderHandlers(),this.setupSelectHandlers(),this.setupButtonHandlers(),this.setupFileInputHandler()}initializeUIState(){this.oscilloscope.setAutoGain(this.dom.autoGainCheckbox.checked),this.oscilloscope.setNoiseGate(this.dom.noiseGateCheckbox.checked),this.oscilloscope.setFFTDisplay(this.dom.fftDisplayCheckbox.checked),this.oscilloscope.setPauseDrawing(this.dom.pauseDrawingCheckbox.checked);const t=this.sliderValueToThreshold(this.dom.noiseGateThreshold.value);this.oscilloscope.setNoiseGateThreshold(t.amplitude),this.dom.thresholdValue.textContent=this.formatThresholdDisplay(t.db,t.amplitude);const e=this.dom.zeroCrossMode.value;["standard","peak-backtrack-history","bidirectional-nearest","gradient-based","adaptive-step","hysteresis","closest-to-zero"].includes(e)&&this.oscilloscope.setZeroCrossMode(e),this.dom.startButton.focus()}setupCheckboxHandlers(){this.dom.autoGainCheckbox.addEventListener("change",()=>{this.oscilloscope.setAutoGain(this.dom.autoGainCheckbox.checked)}),this.dom.noiseGateCheckbox.addEventListener("change",()=>{this.oscilloscope.setNoiseGate(this.dom.noiseGateCheckbox.checked)}),this.dom.fftDisplayCheckbox.addEventListener("change",()=>{this.oscilloscope.setFFTDisplay(this.dom.fftDisplayCheckbox.checked)}),this.dom.pauseDrawingCheckbox.addEventListener("change",()=>{this.oscilloscope.setPauseDrawing(this.dom.pauseDrawingCheckbox.checked)})}setupSliderHandlers(){this.dom.noiseGateThreshold.addEventListener("input",()=>{const t=this.sliderValueToThreshold(this.dom.noiseGateThreshold.value);this.oscilloscope.setNoiseGateThreshold(t.amplitude),this.dom.thresholdValue.textContent=this.formatThresholdDisplay(t.db,t.amplitude)})}setupSelectHandlers(){this.dom.frequencyMethod.addEventListener("change",()=>{const t=this.dom.frequencyMethod.value;this.oscilloscope.setFrequencyEstimationMethod(t)}),this.dom.bufferSizeMultiplier.addEventListener("change",()=>{const t=parseInt(this.dom.bufferSizeMultiplier.value,10);t===1||t===4||t===16?this.oscilloscope.setBufferSizeMultiplier(t):(console.error("Invalid buffer size multiplier:",t),this.dom.bufferSizeMultiplier.value="1",this.oscilloscope.setBufferSizeMultiplier(1))}),this.dom.zeroCrossMode.addEventListener("change",()=>{const t=this.dom.zeroCrossMode.value;["standard","peak-backtrack-history","bidirectional-nearest","gradient-based","adaptive-step","hysteresis","closest-to-zero"].includes(t)?this.oscilloscope.setZeroCrossMode(t):(console.error("Invalid zero-cross mode:",t),this.dom.zeroCrossMode.value="hysteresis",this.oscilloscope.setZeroCrossMode("hysteresis"))})}setupButtonHandlers(){this.dom.startButton.addEventListener("click",async()=>{await this.handleStartStopButton()}),this.dom.loadFileButton.addEventListener("click",()=>{this.dom.fileInput.click()})}setupFileInputHandler(){this.dom.fileInput.addEventListener("change",async()=>{await this.handleFileInput()})}async handleStartStopButton(){if(this.oscilloscope.getIsRunning())try{this.displayUpdater.stop(),await this.oscilloscope.stop(),this.dom.startButton.textContent="Start",this.dom.loadFileButton.disabled=!1,this.dom.statusElement.textContent="Stopped"}catch(t){console.error("Failed to stop oscilloscope:",t),this.dom.statusElement.textContent="Stopped (with errors)",this.dom.startButton.textContent="Start",this.dom.loadFileButton.disabled=!1}else try{this.dom.startButton.disabled=!0,this.dom.loadFileButton.disabled=!0,this.dom.statusElement.textContent="Requesting microphone access...",await this.oscilloscope.start(),this.dom.startButton.textContent="Stop",this.dom.startButton.disabled=!1,this.dom.statusElement.textContent="Running - Microphone active",this.displayUpdater.start()}catch(t){console.error("Failed to start oscilloscope:",t),this.dom.statusElement.textContent="Error: Could not access microphone",this.dom.startButton.disabled=!1,this.dom.loadFileButton.disabled=!1}}async handleFileInput(){var e;const t=(e=this.dom.fileInput.files)==null?void 0:e[0];if(t){this.oscilloscope.getIsRunning()&&(this.displayUpdater.stop(),await this.oscilloscope.stop());try{this.dom.startButton.disabled=!0,this.dom.loadFileButton.disabled=!0,this.dom.statusElement.textContent=`Loading file: ${t.name}...`,await this.oscilloscope.startFromFile(t),this.dom.startButton.textContent="Stop",this.dom.startButton.disabled=!1,this.dom.statusElement.textContent=`Playing: ${t.name} (loop)`,this.displayUpdater.start()}catch(s){console.error("Failed to load audio file:",s),this.dom.statusElement.textContent="Error: Could not load audio file",this.dom.startButton.textContent="Start",this.dom.startButton.disabled=!1,this.dom.loadFileButton.disabled=!1}this.dom.fileInput.value=""}}sliderValueToThreshold(t){const e=parseFloat(t);if(Number.isNaN(e))throw new Error(`Invalid slider value for noise gate threshold: "${t}"`);return{db:e,amplitude:L(e)}}formatThresholdDisplay(t,e){return`${t.toFixed(0)} dB (${e.toFixed(3)})`}}const b=new st,G=new et(b.canvas,b.previousWaveformCanvas,b.currentWaveformCanvas,b.similarityPlotCanvas,b.frameBufferCanvas,b.cycleSimilarity8divCanvas,b.cycleSimilarity4divCanvas,b.cycleSimilarity2divCanvas),H=new it(b.pianoKeyboardCanvas);H.render(0);const nt=new at(G,H,b.frequencyValue,b.noteValue,b.gainValue,b.similarityValue),k=new ot(G,b,nt);k.initializeUIState();k.setupEventHandlers();
//# sourceMappingURL=index-BSIPHox7.js.map
