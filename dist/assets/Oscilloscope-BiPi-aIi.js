var q=Object.defineProperty;var G=(y,e,t)=>e in y?q(y,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):y[e]=t;var o=(y,e,t)=>G(y,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();function z(y){return Math.pow(10,y/20)}function N(y){return y<=0?-1/0:20*Math.log10(y)}function D(y){if(y<=0||!isFinite(y))return null;const t=440*Math.pow(2,-4.75),i=12*Math.log2(y/t),s=Math.round(i),r=Math.round((i-s)*100),a=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],n=Math.floor(s/12);return{noteName:`${a[(s%12+12)%12]}${n}`,cents:r}}const $=-48;function B(y){const e=y.numberOfChannels,t=y.sampleRate,i=y.length,s=[];let r=0;for(let u=0;u<e;u++){const g=y.getChannelData(u);s.push(g);for(let l=0;l<i;l++){const m=Math.abs(g[l]);m>r&&(r=m)}}if(r===0)return y;const a=r*Math.pow(10,$/20);let n=i;for(let u=0;u<i;u++){let g=!0;for(let l=0;l<e;l++)if(Math.abs(s[l][u])>a){g=!1;break}if(!g){n=u;break}}if(n>=i)return y;let c=i-1;for(let u=i-1;u>=n;u--){let g=!0;for(let l=0;l<e;l++)if(Math.abs(s[l][u])>a){g=!1;break}if(!g){c=u;break}}if(n===0&&c===i-1)return y;const f=c-n+1,d=new AudioBuffer({numberOfChannels:e,length:f,sampleRate:t});for(let u=0;u<e;u++){const g=s[u],l=d.getChannelData(u);for(let m=0;m<f;m++)l[m]=g[n+m]}return d}class Z{constructor(){o(this,"frameBufferHistory",[]);o(this,"MAX_FRAME_HISTORY",16);o(this,"extendedBufferCache",new Map)}updateHistory(e){let t;this.frameBufferHistory.length<this.MAX_FRAME_HISTORY?t=new Float32Array(e.length):(t=this.frameBufferHistory.shift(),t.length!==e.length&&(t=new Float32Array(e.length))),t.set(e),this.frameBufferHistory.push(t)}getExtendedBuffer(e,t){if(e===1)return t;if(!t||this.frameBufferHistory.length<e)return null;const i=this.frameBufferHistory.slice(-e),s=i.reduce((n,c)=>n+c.length,0);let r=this.extendedBufferCache.get(e);(!r||r.length!==s)&&(r=new Float32Array(s),this.extendedBufferCache.set(e,r));let a=0;for(const n of i)r.set(n,a),a+=n.length;return r}clear(){this.frameBufferHistory=[],this.extendedBufferCache.clear()}}class Y{constructor(){o(this,"audioContext",null);o(this,"analyser",null);o(this,"mediaStream",null);o(this,"audioBufferSource",null);o(this,"bufferSource",null);o(this,"dataArray",null);o(this,"frequencyData",null);o(this,"frameBufferHistory",new Z)}initializeAnalyser(){if(!this.audioContext)throw new Error("AudioContext must be initialized before creating analyser");this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=4096,this.analyser.smoothingTimeConstant=0;const e=this.analyser.fftSize;this.dataArray=new Float32Array(e),this.frequencyData=new Uint8Array(this.analyser.frequencyBinCount)}async start(){try{this.mediaStream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.audioContext=new AudioContext;const e=this.audioContext.createMediaStreamSource(this.mediaStream);this.initializeAnalyser(),e.connect(this.analyser)}catch(e){throw console.error("Error accessing microphone:",e),e}}async startFromFile(e){try{const t=await e.arrayBuffer();this.audioContext&&this.audioContext.state!=="closed"&&await this.audioContext.close(),this.audioContext=new AudioContext;let i=await this.audioContext.decodeAudioData(t);i=B(i),this.initializeAnalyser(),this.audioBufferSource=this.audioContext.createBufferSource(),this.audioBufferSource.buffer=i,this.audioBufferSource.loop=!0,this.audioBufferSource.connect(this.analyser),this.analyser.connect(this.audioContext.destination),this.audioBufferSource.start(0)}catch(t){throw console.error("Error loading audio file:",t),t}}async startFromBuffer(e){try{this.audioContext&&this.audioContext.state!=="closed"&&await this.audioContext.close(),this.audioContext=new AudioContext,e.reset(),e.setChunkSize(4096);const i=e.getSampleRate(),s=e.getLength(),r=this.audioContext.createBuffer(1,s,i),a=r.getChannelData(0);let n=0;for(;n<s;){const c=e.getNextChunk();if(!c)break;const f=s-n;c.length<=f?(a.set(c,n),n+=c.length):(a.set(c.subarray(0,f),n),n+=f)}this.initializeAnalyser(),this.audioBufferSource=this.audioContext.createBufferSource(),this.audioBufferSource.buffer=r,this.audioBufferSource.loop=!0,this.audioBufferSource.connect(this.analyser),this.audioBufferSource.start(0)}catch(t){throw console.error("Error starting from buffer:",t),t}}async stop(){if(this.audioBufferSource){try{this.audioBufferSource.stop()}catch{}try{this.audioBufferSource.disconnect()}catch{}this.audioBufferSource=null}if(this.mediaStream&&(this.mediaStream.getTracks().forEach(e=>e.stop()),this.mediaStream=null),this.audioContext){try{await this.audioContext.close()}catch(e){console.error("Error closing AudioContext:",e)}this.audioContext=null}this.analyser=null,this.dataArray=null,this.frequencyData=null,this.frameBufferHistory.clear()}getTimeDomainData(){return!this.analyser||!this.dataArray?null:(this.analyser.getFloatTimeDomainData(this.dataArray),this.frameBufferHistory.updateHistory(this.dataArray),this.dataArray)}getExtendedTimeDomainData(e){return this.frameBufferHistory.getExtendedBuffer(e,this.dataArray)}getFrequencyData(){return!this.analyser||!this.frequencyData?null:(this.analyser.getByteFrequencyData(this.frequencyData),this.frequencyData)}getSampleRate(){var e;return((e=this.audioContext)==null?void 0:e.sampleRate)||0}getFFTSize(){var e;return this.bufferSource?4096:((e=this.analyser)==null?void 0:e.fftSize)||0}getFrequencyBinCount(){var e;return this.bufferSource?2048:((e=this.analyser)==null?void 0:e.frequencyBinCount)||0}isReady(){return this.bufferSource?this.dataArray!==null:this.audioContext!==null&&this.analyser!==null}}class U{constructor(){o(this,"autoGainEnabled",!0);o(this,"currentGain",1);o(this,"noiseGateEnabled",!0);o(this,"noiseGateThreshold",z(-60))}setAutoGain(e){this.autoGainEnabled=e}getAutoGainEnabled(){return this.autoGainEnabled}setNoiseGate(e){this.noiseGateEnabled=e}getNoiseGateEnabled(){return this.noiseGateEnabled}setNoiseGateThreshold(e){this.noiseGateThreshold=Math.min(Math.max(e,0),1)}getNoiseGateThreshold(){return this.noiseGateThreshold}getCurrentGain(){return this.currentGain}}class Q{constructor(){o(this,"frequencyEstimationMethod","fft");o(this,"estimatedFrequency",0);o(this,"MIN_FREQUENCY_HZ",20);o(this,"MAX_FREQUENCY_HZ",5e3);o(this,"bufferSizeMultiplier",16);o(this,"frequencyPlotHistory",[])}clearHistory(){this.frequencyPlotHistory=[],this.estimatedFrequency=0}setFrequencyEstimationMethod(e){this.frequencyEstimationMethod!==e&&(this.frequencyEstimationMethod=e,this.frequencyPlotHistory=[])}getFrequencyEstimationMethod(){return this.frequencyEstimationMethod}setBufferSizeMultiplier(e){this.bufferSizeMultiplier=e}getBufferSizeMultiplier(){return this.bufferSizeMultiplier}getEstimatedFrequency(){return this.estimatedFrequency}getMinFrequency(){return this.MIN_FREQUENCY_HZ}getMaxFrequency(){return this.MAX_FREQUENCY_HZ}getFrequencyPlotHistory(){return this.frequencyPlotHistory}}function O(y,e){if(typeof y=="string"&&y.endsWith("%")){const t=parseFloat(y);return isNaN(t)?(console.warn(`Invalid percentage value: ${y}, using 0`),0):t<0?(console.warn(`Negative percentage value: ${y}, clamping to 0`),0):Math.floor(e*(t/100))}if(typeof y=="string"){const t=parseInt(y,10);return isNaN(t)?(console.warn(`Invalid numeric string: ${y}, using 0`),0):Math.max(0,t)}return typeof y=="number"?isNaN(y)?(console.warn(`Invalid number value: ${y}, using 0`),0):Math.max(0,Math.floor(y)):0}const X={fftOverlay:{position:{x:10,y:"65%"},size:{width:"35%",height:"35%"}},harmonicAnalysis:{position:{x:10,y:10},size:{width:500,height:"auto"}},frequencyPlot:{position:{x:"right-10",y:10},size:{width:280,height:120}}};class k{constructor(e,t,i){o(this,"ctx");o(this,"canvasWidth");o(this,"canvasHeight");this.ctx=e,this.canvasWidth=t,this.canvasHeight=i}updateDimensions(e,t){this.canvasWidth=e,this.canvasHeight=t}calculateOverlayDimensions(e,t,i,s,r){if(!e)return{x:t,y:i,width:s,height:r};let a=t,n=i,c=s,f=r;if(e.position.x!==void 0)if(typeof e.position.x=="string"&&e.position.x.startsWith("right-")){const d=parseInt(e.position.x.substring(6),10),u=e.size.width!==void 0&&e.size.width!=="auto"?O(e.size.width,this.canvasWidth):s;a=this.canvasWidth-u-d}else a=O(e.position.x,this.canvasWidth);return e.position.y!==void 0&&(n=O(e.position.y,this.canvasHeight)),e.size.width!==void 0&&e.size.width!=="auto"&&(c=O(e.size.width,this.canvasWidth)),e.size.height!==void 0&&e.size.height!=="auto"&&(f=O(e.size.height,this.canvasHeight)),{x:a,y:n,width:c,height:f}}}class V{constructor(e,t,i){o(this,"ctx");o(this,"canvasWidth");o(this,"canvasHeight");this.ctx=e,this.canvasWidth=t,this.canvasHeight=i}updateDimensions(e,t){this.canvasWidth=e,this.canvasHeight=t}drawGrid(e,t,i){this.ctx.strokeStyle="#222222",this.ctx.lineWidth=1,this.ctx.beginPath();const s=5;for(let a=0;a<=s;a++){const n=this.canvasHeight/s*a;this.ctx.moveTo(0,n),this.ctx.lineTo(this.canvasWidth,n)}const r=10;for(let a=0;a<=r;a++){const n=this.canvasWidth/r*a;this.ctx.moveTo(n,0),this.ctx.lineTo(n,this.canvasHeight)}this.ctx.stroke(),this.ctx.strokeStyle="#444444",this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.moveTo(0,this.canvasHeight/2),this.ctx.lineTo(this.canvasWidth,this.canvasHeight/2),this.ctx.stroke(),e&&e>0&&t&&t>0&&i!==void 0&&i>0&&this.drawGridLabels(e,t,i)}drawGridLabels(e,t,i){this.ctx.save(),this.ctx.font="11px monospace",this.ctx.fillStyle="#666666";const s=t/e*1e3,r=10,a=s/r;for(let d=0;d<=r;d++){const u=this.canvasWidth/r*d,g=a*d;let l;g>=1e3?l=`${(g/1e3).toFixed(2)}s`:g>=1?l=`${g.toFixed(1)}ms`:l=`${(g*1e3).toFixed(0)}μs`;const m=this.ctx.measureText(l).width,v=Math.max(2,Math.min(u-m/2,this.canvasWidth-m-2));this.ctx.fillText(l,v,this.canvasHeight-3)}const n=5,f=1/(n/2*i);for(let d=0;d<=n;d++){const u=this.canvasHeight/n*d,l=(n/2-d)*f;let m;if(l===0)m="0dB*";else{const v=N(Math.abs(l)),h=l>0?"+":"-",x=Math.abs(v);x>=100?m=`${h}${x.toFixed(0)}dB`:m=`${h}${x.toFixed(1)}dB`}this.ctx.fillText(m,3,u+10)}this.ctx.restore()}}class K{constructor(e,t,i){o(this,"ctx");o(this,"canvasWidth");o(this,"canvasHeight");this.ctx=e,this.canvasWidth=t,this.canvasHeight=i}updateDimensions(e,t){this.canvasWidth=e,this.canvasHeight=t}drawWaveform(e,t,i,s){const r=i-t;if(r<=0)return;this.ctx.strokeStyle="#00ff00",this.ctx.lineWidth=2,this.ctx.beginPath();const a=this.canvasWidth/r,n=this.canvasHeight/2,f=this.canvasHeight/2*s;for(let d=0;d<r;d++){const u=t+d,g=e[u],l=n-g*f,m=Math.min(this.canvasHeight,Math.max(0,l)),v=d*a;d===0?this.ctx.moveTo(v,m):this.ctx.lineTo(v,m)}this.ctx.stroke()}}class j extends k{constructor(){super(...arguments);o(this,"FFT_OVERLAY_HEIGHT_RATIO",.9);o(this,"FFT_MIN_BAR_WIDTH",1)}drawFFTOverlay(t,i,s,r,a,n){const c=s/r,f=Math.floor(this.canvasWidth*.35),d=Math.floor(this.canvasHeight*.35),u=10,g=this.canvasHeight-d-10,{x:l,y:m,width:v,height:h}=this.calculateOverlayDimensions(n,u,g,f,d);this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(l,m,v,h),this.ctx.strokeStyle="#00aaff",this.ctx.lineWidth=2,this.ctx.strokeRect(l,m,v,h);const x=Math.min(t.length,Math.ceil(a/c)),w=v/x;this.ctx.fillStyle="#00aaff";for(let p=0;p<x;p++){const T=t[p]/255*h*this.FFT_OVERLAY_HEIGHT_RATIO,R=l+p*w,E=m+h-T;this.ctx.fillRect(R,E,Math.max(w-1,this.FFT_MIN_BAR_WIDTH),T)}if(i>0&&i<=a){const p=i/c,S=l+p*w;this.ctx.strokeStyle="#ff00ff",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(S,m),this.ctx.lineTo(S,m+h),this.ctx.stroke(),this.ctx.fillStyle="#ff00ff",this.ctx.font="bold 12px Arial";const T=`${i.toFixed(1)} Hz`,R=this.ctx.measureText(T).width;let E=S+3;E+R>l+v-5&&(E=S-R-3),this.ctx.fillText(T,E,m+15)}this.ctx.restore()}}class J extends k{drawHarmonicAnalysis(e,t,i,s,r,a,n,c){if(e===void 0&&!t&&!i&&!a)return;const f=16,u=(1+(e!==void 0?1:0)+(t?1:0)+(i?1:0)+(a?2:0))*f+10,{x:g,y:l,width:m,height:v}=this.calculateOverlayDimensions(c,10,10,500,u);let h=l;if(this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillRect(g,l,m,v),this.ctx.strokeStyle="#ffaa00",this.ctx.lineWidth=2,this.ctx.strokeRect(g,l,m,v),this.ctx.fillStyle="#ffaa00",this.ctx.font="bold 12px monospace",h+=15,this.ctx.fillText("倍音分析 (Harmonic Analysis)",g+5,h),e!==void 0&&n){h+=f,this.ctx.fillStyle="#00ff00",this.ctx.font="11px monospace";const x=n/2;this.ctx.fillText(`1/2周波数 (${x.toFixed(1)}Hz) のpeak強度: ${e.toFixed(1)}%`,g+5,h)}if(t&&n){h+=f,this.ctx.fillStyle="#ff00ff",this.ctx.font="11px monospace";const x=t.map((p,S)=>`${S+1}x:${p.toFixed(2)}`).join(" "),w=s!==void 0?` (重み付け: ${s.toFixed(1)})`:"";this.ctx.fillText(`候補1 (${n.toFixed(1)}Hz) 倍音: ${x}${w}`,g+5,h)}if(i&&n){h+=f,this.ctx.fillStyle="#00aaff",this.ctx.font="11px monospace";const x=n/2,w=i.map((S,T)=>`${T+1}x:${S.toFixed(2)}`).join(" "),p=r!==void 0?` (重み付け: ${r.toFixed(1)})`:"";this.ctx.fillText(`候補2 (${x.toFixed(1)}Hz) 倍音: ${w}${p}`,g+5,h)}if(a){h+=f,this.ctx.fillStyle="#aaaaaa",this.ctx.font="10px monospace";const x=m-10,w=a.split(" ");let p="";for(const S of w){const T=p+(p?" ":"")+S;this.ctx.measureText(T).width>x&&p?(this.ctx.fillText(p,g+5,h),h+=f,p=S):p=T}p&&this.ctx.fillText(p,g+5,h)}this.ctx.restore()}}class ee extends k{constructor(){super(...arguments);o(this,"FREQ_PLOT_MIN_RANGE_PADDING_HZ",50);o(this,"FREQ_PLOT_RANGE_PADDING_RATIO",.1)}drawFrequencyPlot(t,i,s,r){if(!t||t.length===0)return;const{x:a,y:n,width:c,height:f}=this.calculateOverlayDimensions(r,this.canvasWidth-280-10,10,280,120);this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(a,n,c,f),this.ctx.strokeStyle="#ffaa00",this.ctx.lineWidth=2,this.ctx.strokeRect(a,n,c,f),this.ctx.fillStyle="#ffaa00",this.ctx.font="bold 12px Arial",this.ctx.fillText(`周波数推移 (${t.length}frame)`,a+5,n+15);const d=a+35,u=n+25,g=c-45,l=f-45,m=t.filter(P=>P>0);if(m.length===0){this.ctx.restore();return}const v=Math.min(...m),h=Math.max(...m),x=(h-v)*this.FREQ_PLOT_RANGE_PADDING_RATIO||this.FREQ_PLOT_MIN_RANGE_PADDING_HZ,w=Math.max(i,v-x),p=Math.min(s,h+x);this.ctx.strokeStyle="#333333",this.ctx.lineWidth=1,this.ctx.beginPath();for(let P=0;P<=4;P++){const C=u+l/4*P;this.ctx.moveTo(d,C),this.ctx.lineTo(d+g,C)}for(let P=0;P<=4;P++){const C=d+g/4*P;this.ctx.moveTo(C,u),this.ctx.lineTo(C,u+l)}this.ctx.stroke(),this.ctx.fillStyle="#aaaaaa",this.ctx.font="10px monospace",this.ctx.textAlign="right",this.ctx.textBaseline="middle";for(let P=0;P<=4;P++){const C=p-(p-w)*(P/4),b=u+l/4*P,A=C>=1e3?`${(C/1e3).toFixed(1)}k`:`${C.toFixed(0)}`;this.ctx.fillText(A,d-5,b)}this.ctx.fillStyle="#88ccff",this.ctx.font="9px monospace",this.ctx.textAlign="right",this.ctx.textBaseline="middle";for(let P=0;P<=4;P++){const C=p-(p-w)*(P/4),b=u+l/4*P,A=D(C);if(A){const _=A.cents>=0?"+":"";this.ctx.fillText(`${_}${A.cents}¢`,d+g-5,b)}}this.ctx.strokeStyle="#00ff00",this.ctx.lineWidth=2,this.ctx.beginPath();const S=g/Math.max(t.length-1,1),T=Math.max(1,Math.floor(t.length/4)),R=P=>{const b=(Math.max(w,Math.min(p,P))-w)/(p-w);return u+l-b*l};let E=!1;for(let P=0;P<t.length;P++){const C=t[P],b=d+P*S;if(C===0){E=!1;continue}const A=R(C);E?this.ctx.lineTo(b,A):(this.ctx.moveTo(b,A),E=!0)}this.ctx.stroke(),this.ctx.font="9px monospace",this.ctx.textAlign="center",this.ctx.textBaseline="top";for(let P=0;P<t.length;P++){const C=t[P],b=d+P*S;if(C!==0){const L=R(C);this.ctx.fillStyle="#00ff00",this.ctx.beginPath(),this.ctx.arc(b,L,2,0,Math.PI*2),this.ctx.fill()}const A=P===t.length-1;if(P%T===0||A){this.ctx.fillStyle="#aaaaaa";const L=P-t.length+1;this.ctx.fillText(`${L}`,b,u+l+2)}}const M=t[t.length-1];if(M>0){const P=D(M);this.ctx.fillStyle="#00ff00",this.ctx.font="bold 11px Arial",this.ctx.textAlign="left",this.ctx.textBaseline="bottom";let C=`${M.toFixed(1)} Hz`;if(P){const b=P.cents>=0?"+":"";C+=` (${P.noteName} ${b}${P.cents}¢)`}this.ctx.fillText(C,d+2,u+l-2)}this.ctx.restore()}}class te{constructor(e,t,i,s=!0){o(this,"ctx");o(this,"canvasWidth");o(this,"canvasHeight");o(this,"debugOverlaysEnabled");this.ctx=e,this.canvasWidth=t,this.canvasHeight=i,this.debugOverlaysEnabled=s}updateDimensions(e,t){this.canvasWidth=e,this.canvasHeight=t}setDebugOverlaysEnabled(e){this.debugOverlaysEnabled=e}drawPhaseMarkers(e,t,i,s,r,a,n){if(r===void 0||a===void 0)return;const c=a-r;if(c<=0)return;this.ctx.save();const f=(d,u,g)=>{const l=d-r;if(l<0||l>=c)return;const m=l/c*this.canvasWidth;this.ctx.strokeStyle=u,this.ctx.lineWidth=g,this.ctx.beginPath(),this.ctx.moveTo(m,0),this.ctx.lineTo(m,this.canvasHeight),this.ctx.stroke()};if(i!==void 0&&f(i,"#ff8800",2),s!==void 0&&f(s,"#ff8800",2),e!==void 0&&(f(e,"#ff0000",2),this.debugOverlaysEnabled&&(n==null?void 0:n.phaseZeroSegmentRelative)!==void 0)){const u=(e-r)/c*this.canvasWidth,g=20;this.ctx.save(),this.ctx.fillStyle="#ff0000",this.ctx.font="12px monospace",this.ctx.textAlign="left";const l=n.phaseZeroSegmentRelative,m=n.phaseZeroHistory??"?",v=n.phaseZeroTolerance??"?";[`Mode: ${n.zeroCrossModeName??"Unknown"}`,`Seg Rel: ${l}`,`History: ${m}`,`Tolerance: ±${v}`,`Range: ${typeof m=="number"&&typeof v=="number"?`${m-v}~${m+v}`:"?"}`].forEach((w,p)=>{this.ctx.fillText(w,u+5,g+p*14)}),this.ctx.restore()}t!==void 0&&f(t,"#ff0000",2),this.ctx.restore()}}class ie{constructor(e,t){o(this,"canvas");o(this,"ctx");o(this,"fftDisplayEnabled",!0);o(this,"harmonicAnalysisEnabled",!1);o(this,"debugOverlaysEnabled",!0);o(this,"overlaysLayout");o(this,"gridRenderer");o(this,"waveformLineRenderer");o(this,"fftOverlayRenderer");o(this,"harmonicAnalysisRenderer");o(this,"frequencyPlotRenderer");o(this,"phaseMarkerRenderer");this.canvas=e;const i=e.getContext("2d");if(!i)throw new Error("Could not get 2D context");this.ctx=i,this.overlaysLayout=t||X,this.gridRenderer=new V(this.ctx,e.width,e.height),this.waveformLineRenderer=new K(this.ctx,e.width,e.height),this.fftOverlayRenderer=new j(this.ctx,e.width,e.height),this.harmonicAnalysisRenderer=new J(this.ctx,e.width,e.height),this.frequencyPlotRenderer=new ee(this.ctx,e.width,e.height),this.phaseMarkerRenderer=new te(this.ctx,e.width,e.height,this.debugOverlaysEnabled),e.width===300&&e.height===150&&console.warn('Canvas element is using default dimensions (300x150). Set explicit width and height attributes on the canvas element to match desired resolution. Example: <canvas id="oscilloscope" width="1800" height="1000"></canvas>')}clearAndDrawGrid(e,t,i){this.updateRendererDimensions(),this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.gridRenderer.drawGrid(e,t,i)}updateRendererDimensions(){const e=this.canvas.width,t=this.canvas.height;this.gridRenderer.updateDimensions(e,t),this.waveformLineRenderer.updateDimensions(e,t),this.fftOverlayRenderer.updateDimensions(e,t),this.harmonicAnalysisRenderer.updateDimensions(e,t),this.frequencyPlotRenderer.updateDimensions(e,t),this.phaseMarkerRenderer.updateDimensions(e,t)}drawWaveform(e,t,i,s){this.updateRendererDimensions(),this.waveformLineRenderer.drawWaveform(e,t,i,s)}drawFFTOverlay(e,t,i,s,r){this.fftDisplayEnabled&&(this.updateRendererDimensions(),this.fftOverlayRenderer.drawFFTOverlay(e,t,i,s,r,this.overlaysLayout.fftOverlay))}drawHarmonicAnalysis(e,t,i,s,r,a,n){this.harmonicAnalysisEnabled&&this.debugOverlaysEnabled&&this.fftDisplayEnabled&&(this.updateRendererDimensions(),this.harmonicAnalysisRenderer.drawHarmonicAnalysis(e,t,i,s,r,a,n,this.overlaysLayout.harmonicAnalysis))}drawFrequencyPlot(e,t,i){this.debugOverlaysEnabled&&(this.updateRendererDimensions(),this.frequencyPlotRenderer.drawFrequencyPlot(e,t,i,this.overlaysLayout.frequencyPlot))}drawPhaseMarkers(e,t,i,s,r,a,n){this.updateRendererDimensions(),this.phaseMarkerRenderer.drawPhaseMarkers(e,t,i,s,r,a,n)}setFFTDisplay(e){this.fftDisplayEnabled=e}getFFTDisplayEnabled(){return this.fftDisplayEnabled}setHarmonicAnalysisEnabled(e){this.harmonicAnalysisEnabled=e}getHarmonicAnalysisEnabled(){return this.harmonicAnalysisEnabled}setDebugOverlaysEnabled(e){this.debugOverlaysEnabled=e,this.phaseMarkerRenderer.setDebugOverlaysEnabled(e)}getDebugOverlaysEnabled(){return this.debugOverlaysEnabled}setOverlaysLayout(e){this.overlaysLayout={...this.overlaysLayout,...e}}getOverlaysLayout(){return this.overlaysLayout}}class se{constructor(){o(this,"usePeakMode",!1);o(this,"zeroCrossMode","hysteresis")}setUsePeakMode(e){this.usePeakMode=e}getUsePeakMode(){return this.usePeakMode}setZeroCrossMode(e){this.zeroCrossMode=e}getZeroCrossMode(){return this.zeroCrossMode}reset(){}}class re{constructor(){o(this,"previousWaveform",null);o(this,"lastSimilarity",0)}getLastSimilarity(){return this.lastSimilarity}reset(){this.previousWaveform=null,this.lastSimilarity=0}hasPreviousWaveform(){return this.previousWaveform!==null}getPreviousWaveform(){return this.previousWaveform}}class ne{constructor(){o(this,"TARGET_FILL_RATIO",.9);o(this,"MIN_PEAK_THRESHOLD",.001);o(this,"DEFAULT_AMPLITUDE_RATIO",.4)}findPeakAmplitude(e,t,i){let s=0;const r=Math.max(0,t),a=Math.min(e.length,i);for(let n=r;n<a;n++){const c=Math.abs(e[n]);c>s&&(s=c)}return s}drawWaveform(e,t,i,s,r,a,n){const c=a-r;if(c<=0)return;const f=this.findPeakAmplitude(s,r,a);e.strokeStyle=n,e.lineWidth=1.5,e.beginPath();const d=t/c,u=i/2;let g;if(f>this.MIN_PEAK_THRESHOLD){const l=this.TARGET_FILL_RATIO/f;g=i/2*l}else g=i*this.DEFAULT_AMPLITUDE_RATIO;for(let l=0;l<c;l++){const m=r+l;if(m>=s.length)break;const v=s[m],h=u-v*g,x=Math.min(i,Math.max(0,h)),w=l*d;l===0?e.moveTo(w,x):e.lineTo(w,x)}e.stroke()}drawCenterLine(e,t,i){e.strokeStyle="#444444",e.lineWidth=1,e.beginPath(),e.moveTo(0,i/2),e.lineTo(t,i/2),e.stroke()}drawZeroCrossCandidates(e,t,i,s,r,a,n,c){const f=a-r;if(s.length===0||f<=0)return;const d=i/2,u=4,g=performance.now();e.save();for(const l of s){const m=l-r;if(m<0||m>=f)continue;const v=m/f*t,h=n!==void 0&&l===n,x=h&&Math.floor(g/400)%2===0,w=h?x?"#ffff00":"#0066ff":"#ffff00";e.beginPath(),e.fillStyle=w,e.strokeStyle=w,e.lineWidth=2,e.arc(v,d,u,0,Math.PI*2),e.fill(),e.stroke()}if(c!==void 0){const l=c-r;if(l>=0&&l<f){const m=l/f*t;e.beginPath(),e.fillStyle="#ff0000",e.strokeStyle="#ff0000",e.lineWidth=2,e.arc(m,d,u,0,Math.PI*2),e.fill(),e.stroke()}}e.restore()}clearCanvas(e,t,i){e.fillStyle="#000000",e.fillRect(0,0,t,i)}drawPhaseMarkers(e,t,i,s,r,a,n,c,f){const d=r-s;if(d<=0)return;const u=(g,l,m)=>{const v=g-s;if(v<0||v>=d)return;const h=v/d*t;e.strokeStyle=l,e.lineWidth=m,e.beginPath(),e.moveTo(h,0),e.lineTo(h,i),e.stroke()};c!==void 0&&u(c,"#ff8800",2),f!==void 0&&u(f,"#ff8800",2),a!==void 0&&u(a,"#ff0000",2),n!==void 0&&u(n,"#ff0000",2)}}class oe{drawSimilarityPlot(e,t,i,s){if(!s||s.length===0)return;e.save(),e.fillStyle="#000000",e.fillRect(0,0,t,i),e.strokeStyle="#00aaff",e.lineWidth=2,e.strokeRect(0,0,t,i),e.fillStyle="#00aaff",e.font="bold 12px Arial",e.fillText("類似度推移 (Similarity)",5,15);const r=40,a=25,n=t-50,c=i-35,f=-1,d=1;e.strokeStyle="#333333",e.lineWidth=1,e.beginPath();for(let l=0;l<=4;l++){const m=a+c/4*l;e.moveTo(r,m),e.lineTo(r+n,m)}for(let l=0;l<=4;l++){const m=r+n/4*l;e.moveTo(m,a),e.lineTo(m,a+c)}e.stroke(),e.fillStyle="#aaaaaa",e.font="10px monospace",e.textAlign="right",e.textBaseline="middle";for(let l=0;l<=4;l++){const m=d-(d-f)*(l/4),v=a+c/4*l,h=m.toFixed(2);e.fillText(h,r-5,v)}e.strokeStyle="#00aaff",e.lineWidth=2,e.beginPath();const u=n/Math.max(s.length-1,1);for(let l=0;l<s.length;l++){const m=s[l],v=r+l*u,x=(Math.max(f,Math.min(d,m))-f)/(d-f),w=a+c-x*c;l===0?e.moveTo(v,w):e.lineTo(v,w)}e.stroke();const g=s[s.length-1];e.fillStyle="#00aaff",e.font="bold 11px Arial",e.textAlign="left",e.textBaseline="bottom",e.fillText(`${g.toFixed(3)}`,r+2,a+c-2),e.restore()}drawSimilarityText(e,t,i){e.fillStyle="#00aaff",e.font="bold 14px Arial";const s=`Similarity: ${i.toFixed(3)}`,r=e.measureText(s).width,a=(t-r)/2;e.fillText(s,a,20)}}class ae{drawPositionMarkers(e,t,i,s,r,a){if(a<=0)return;const n=s/a*t,c=r/a*t;e.strokeStyle="#ff0000",e.lineWidth=2,e.beginPath(),e.moveTo(n,0),e.lineTo(n,i),e.stroke(),e.beginPath(),e.moveTo(c,0),e.lineTo(c,i),e.stroke(),e.fillStyle="#ff0000",e.font="10px Arial",e.fillText("S",n+2,12),e.fillText("E",c+2,12)}drawPhaseMarkers(e,t,i,s,r,a,n,c){if(s<=0)return;const f=(d,u)=>{const g=d/s*t;e.strokeStyle=u,e.lineWidth=1,e.beginPath(),e.moveTo(g,0),e.lineTo(g,i),e.stroke()};n!==void 0&&f(n,"#ff8800"),c!==void 0&&f(c,"#ff8800"),r!==void 0&&f(r,"#ff0000"),a!==void 0&&f(a,"#ff0000")}}class he{drawOffsetOverlayGraphs(e,t,i,s=[],r=[]){if(s.length===0&&r.length===0)return;e.save();const a=Math.min(120,t*.4),n=Math.min(60,i*.4),c=t-a-5,f=5;e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(c,f,a,n),e.strokeStyle="#00aaff",e.lineWidth=1,e.strokeRect(c,f,a,n),e.fillStyle="#00aaff",e.font="9px Arial",e.fillText("Offset %",c+2,f+9);const d=2,u=c+d,g=f+12,l=a-d*2,m=n-12-d,v=0,h=100,x=(w,p)=>{if(w.length<2)return;e.strokeStyle=p,e.lineWidth=1.5,e.beginPath();const S=l/Math.max(w.length-1,1);for(let T=0;T<w.length;T++){const R=w[T],E=u+T*S,P=(Math.max(v,Math.min(h,R))-v)/(h-v),C=g+m-P*m;T===0?e.moveTo(E,C):e.lineTo(E,C)}e.stroke()};if(x(s,"#ff0000"),x(r,"#ff8800"),e.font="8px monospace",e.textAlign="left",s.length>0){const w=s[s.length-1];e.fillStyle="#ff0000",e.fillText(`S:${w.toFixed(1)}%`,c+2,f+n-11)}if(r.length>0){const w=r[r.length-1];e.fillStyle="#ff8800",e.fillText(`E:${w.toFixed(1)}%`,c+2,f+n-2)}e.restore()}}class le{constructor(e,t,i,s){o(this,"previousCanvas");o(this,"currentCanvas");o(this,"similarityCanvas");o(this,"bufferCanvas");o(this,"previousCtx");o(this,"currentCtx");o(this,"similarityCtx");o(this,"bufferCtx");o(this,"waveformRenderer");o(this,"similarityPlotRenderer");o(this,"positionMarkerRenderer");o(this,"offsetOverlayRenderer");this.previousCanvas=e,this.currentCanvas=t,this.similarityCanvas=i,this.bufferCanvas=s;const r=e.getContext("2d"),a=t.getContext("2d"),n=i.getContext("2d"),c=s.getContext("2d");if(!r||!a||!n||!c)throw new Error("Could not get 2D context for comparison canvases");this.previousCtx=r,this.currentCtx=a,this.similarityCtx=n,this.bufferCtx=c,this.waveformRenderer=new ne,this.similarityPlotRenderer=new oe,this.positionMarkerRenderer=new ae,this.offsetOverlayRenderer=new he,this.clearAllCanvases()}clearAllCanvases(){this.waveformRenderer.clearCanvas(this.previousCtx,this.previousCanvas.width,this.previousCanvas.height),this.waveformRenderer.clearCanvas(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height),this.waveformRenderer.clearCanvas(this.similarityCtx,this.similarityCanvas.width,this.similarityCanvas.height),this.waveformRenderer.clearCanvas(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height)}updatePanels(e,t,i,s,r,a,n=[],c=[],f=[],d,u,g,l,m=[],v){this.clearAllCanvases(),e&&(this.waveformRenderer.drawCenterLine(this.previousCtx,this.previousCanvas.width,this.previousCanvas.height),this.waveformRenderer.drawWaveform(this.previousCtx,this.previousCanvas.width,this.previousCanvas.height,e,0,e.length,"#ffaa00")),this.waveformRenderer.drawCenterLine(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height),e&&this.waveformRenderer.drawWaveform(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height,e,0,e.length,"#666600"),s-i>0&&this.waveformRenderer.drawWaveform(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height,t,i,s,"#00ff00"),e&&this.similarityPlotRenderer.drawSimilarityText(this.currentCtx,this.currentCanvas.width,a),this.offsetOverlayRenderer.drawOffsetOverlayGraphs(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height,c,f);const x=(()=>{if(d===void 0||d<i||d>=s||m.length===0)return;let w,p=Number.POSITIVE_INFINITY;for(const S of m){if(S<i||S>=s)continue;const T=Math.abs(S-d);T<p&&(p=T,w=S)}return w})();this.waveformRenderer.drawZeroCrossCandidates(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height,m,i,s,v,x),this.waveformRenderer.drawPhaseMarkers(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height,i,s,d,u,g,l),n.length>0&&this.similarityPlotRenderer.drawSimilarityPlot(this.similarityCtx,this.similarityCanvas.width,this.similarityCanvas.height,n),this.waveformRenderer.drawCenterLine(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height),this.waveformRenderer.drawWaveform(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height,r,0,r.length,"#888888"),this.positionMarkerRenderer.drawPositionMarkers(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height,i,s,r.length),this.positionMarkerRenderer.drawPhaseMarkers(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height,r.length,d,u,g,l)}clear(){this.clearAllCanvases()}}const F=class F{constructor(e,t,i){o(this,"canvas8div");o(this,"canvas4div");o(this,"canvas2div");o(this,"ctx8div");o(this,"ctx4div");o(this,"ctx2div");o(this,"history8div",[]);o(this,"history4div",[]);o(this,"history2div",[]);this.canvas8div=e,this.canvas4div=t,this.canvas2div=i;const s=e.getContext("2d"),r=t.getContext("2d"),a=i.getContext("2d");if(!s||!r||!a)throw new Error("Could not get 2D context for cycle similarity canvases");this.ctx8div=s,this.ctx4div=r,this.ctx2div=a,this.clearAllCanvases()}clearAllCanvases(){this.clearCanvas(this.ctx8div,this.canvas8div.width,this.canvas8div.height),this.clearCanvas(this.ctx4div,this.canvas4div.width,this.canvas4div.height),this.clearCanvas(this.ctx2div,this.canvas2div.width,this.canvas2div.height)}clearCanvas(e,t,i){e.fillStyle="#000000",e.fillRect(0,0,t,i)}drawSimilarityGraph(e,t,i,s,r,a){if(e.save(),e.fillStyle="#000000",e.fillRect(0,0,t,i),e.strokeStyle="#ff8800",e.lineWidth=2,e.strokeRect(0,0,t,i),e.fillStyle="#ff8800",e.font="bold 12px Arial",e.fillText(r,5,15),!s||s.length===0||!s[0]||s[0].length===0){e.fillStyle="#666666",e.font="11px Arial",e.fillText("データなし (No data)",t/2-50,i/2),e.restore();return}const n=35,c=25,f=t-45,d=i-35,u=-1,g=1;e.strokeStyle="#333333",e.lineWidth=1,e.beginPath();for(let h=0;h<=4;h++){const x=c+d/4*h;e.moveTo(n,x),e.lineTo(n+f,x)}for(let h=0;h<=4;h++){const x=n+f/4*h;e.moveTo(x,c),e.lineTo(x,c+d)}e.stroke(),e.fillStyle="#aaaaaa",e.font="10px monospace",e.textAlign="right",e.textBaseline="middle";for(let h=0;h<=4;h++){const x=g-(g-u)*(h/4),w=c+d/4*h,p=x.toFixed(1);e.fillText(p,n-5,w)}const l=c+d-(0-u)/(g-u)*d;e.strokeStyle="#666666",e.lineWidth=1,e.beginPath(),e.moveTo(n,l),e.lineTo(n+f,l),e.stroke();const m=s[0].length;for(let h=0;h<m;h++){const x=F.SEGMENT_COLORS[h%F.SEGMENT_COLORS.length];e.strokeStyle=x,e.lineWidth=2,e.beginPath();const w=s.length>1?f/(s.length-1):0;let p=!1;for(let S=0;S<s.length;S++){const T=s[S];if(T&&T.length>h){const R=T[h],E=n+S*w,P=(Math.max(u,Math.min(g,R))-u)/(g-u),C=c+d-P*d;p?e.lineTo(E,C):(e.moveTo(E,C),p=!0)}}e.stroke()}const v=s[s.length-1];if(v&&v.length>0){const x=v.length*11+4,w=65,p=n+f-w-2,S=c+2;e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(p,S,w,x),e.strokeStyle="#555555",e.lineWidth=1,e.strokeRect(p,S,w,x),e.font="9px Arial",e.textAlign="left",e.textBaseline="top";for(let T=0;T<v.length;T++){const R=F.SEGMENT_COLORS[T%F.SEGMENT_COLORS.length],E=v[T],M=S+2+T*11;e.fillStyle=R,e.fillRect(p+2,M,8,8),e.fillStyle="#ffffff",e.fillText(`${T+1}-${T+2}: ${E.toFixed(2)}`,p+12,M)}}e.fillStyle="#aaaaaa",e.font="10px Arial",e.textAlign="center",e.fillText(a,n+f/2,i-3),e.restore()}updateGraphs(e,t,i){e&&e.length>0&&(this.history8div.push(e),this.history8div.length>F.HISTORY_SIZE&&this.history8div.shift()),t&&t.length>0&&(this.history4div.push(t),this.history4div.length>F.HISTORY_SIZE&&this.history4div.shift()),i&&i.length>0&&(this.history2div.push(i),this.history2div.length>F.HISTORY_SIZE&&this.history2div.shift()),this.drawSimilarityGraph(this.ctx8div,this.canvas8div.width,this.canvas8div.height,this.history8div,"8分割 (1/2周期)","連続する1/2周期間の類似度"),this.drawSimilarityGraph(this.ctx4div,this.canvas4div.width,this.canvas4div.height,this.history4div,"4分割 (1周期)","連続する1周期間の類似度"),this.drawSimilarityGraph(this.ctx2div,this.canvas2div.width,this.canvas2div.height,this.history2div,"2分割 (2周期)","連続する2周期間の類似度")}clear(){this.history8div=[],this.history4div=[],this.history2div=[],this.clearAllCanvases()}};o(F,"HISTORY_SIZE",100),o(F,"SEGMENT_COLORS",["#00ff00","#88ff00","#ffaa00","#ff6600","#ff0000","#ff00ff","#00ffff"]);let W=F;const I=class I{constructor(){o(this,"cachedBasePath",null)}getBasePath(){var t;if(this.cachedBasePath!==null)return this.cachedBasePath;let e=(t=document.querySelector("base"))==null?void 0:t.getAttribute("href");if(e)try{e=new URL(e,window.location.href).pathname}catch{}if(e||(e=this.getBasePathFromScripts()),!e&&window.location.pathname&&window.location.pathname!=="/"){const s=window.location.pathname.split("/").filter(r=>r.length>0);s.length>0&&(e=`/${s[0]}/`)}return e||(e="/"),e.endsWith("/")||(e+="/"),this.cachedBasePath=e,e}getBasePathFromScripts(){const e=document.querySelectorAll("script[src]");for(const t of e){const i=t.getAttribute("src");if(i)try{const r=new URL(i,window.location.href).pathname;for(const a of I.ASSET_PATTERNS){const n=r.indexOf(a);if(n>=0)return n===0?"/":r.substring(0,n)+"/"}}catch(s){(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&console.debug("Failed to parse script URL:",i,s);continue}}return""}};o(I,"ASSET_PATTERNS",["/assets/","/js/","/dist/"]);let H=I;class ce{constructor(){o(this,"wasmProcessor",null);o(this,"isInitialized",!1);o(this,"LOAD_TIMEOUT_MS",1e4)}async loadWasmModule(e){if(!(this.isInitialized&&this.wasmProcessor)){if(typeof window>"u"||window.location.protocol==="file:")throw new Error("WASM module not available in test/non-browser environment");return new Promise((t,i)=>{if(window.wasmProcessor&&window.wasmProcessor.WasmDataProcessor){this.wasmProcessor=new window.wasmProcessor.WasmDataProcessor,this.isInitialized=!0,t();return}const s=setTimeout(()=>{n(),i(new Error(`WASM module loading timed out after ${this.LOAD_TIMEOUT_MS/1e3} seconds`))},this.LOAD_TIMEOUT_MS),r=`${e}wasm/signal_processor_wasm.js`,a=document.createElement("script");a.type="module",a.textContent=`
        import init, { WasmDataProcessor } from '${r}';
        await init();
        window.wasmProcessor = { WasmDataProcessor };
        window.dispatchEvent(new Event('wasmLoaded'));
      `;const n=()=>{clearTimeout(s),window.removeEventListener("wasmLoaded",c)},c=()=>{n(),window.wasmProcessor&&window.wasmProcessor.WasmDataProcessor?(this.wasmProcessor=new window.wasmProcessor.WasmDataProcessor,this.isInitialized=!0,t()):i(new Error("WASM module loaded but WasmDataProcessor not found"))};window.addEventListener("wasmLoaded",c),a.onerror=()=>{n(),i(new Error("Failed to load WASM module script"))},document.head.appendChild(a)})}}getProcessor(){return this.wasmProcessor}isReady(){return this.isInitialized&&this.wasmProcessor!==null}}class de{constructor(e,t,i,s,r){o(this,"audioManager");o(this,"gainController");o(this,"frequencyEstimator");o(this,"waveformSearcher");o(this,"zeroCrossDetector");o(this,"basePathResolver");o(this,"wasmLoader");o(this,"phaseZeroOffsetHistory",[]);o(this,"phaseTwoPiOffsetHistory",[]);o(this,"MAX_OFFSET_HISTORY",100);o(this,"previousPhaseZeroIndex");o(this,"previousPhaseTwoPiIndex");o(this,"prevPhaseZeroPercent");o(this,"prevPhaseMinusQuarterPiPercent");o(this,"prevPhaseTwoPiPlusQuarterPiPercent");o(this,"enableDetailedTimingLogs",!1);o(this,"TIMING_LOG_THRESHOLD_MS",16.67);this.audioManager=e,this.gainController=t,this.frequencyEstimator=i,this.waveformSearcher=s,this.zeroCrossDetector=r,this.basePathResolver=new H,this.wasmLoader=new ce}async initialize(){if(!this.wasmLoader.isReady())try{const e=this.basePathResolver.getBasePath();await this.wasmLoader.loadWasmModule(e),this.syncConfigToWasm()}catch(e){throw console.error("Failed to initialize WASM module:",e),e}}syncConfigToWasm(){const e=this.wasmLoader.getProcessor();e&&(e.setAutoGain(this.gainController.getAutoGainEnabled()),e.setNoiseGate(this.gainController.getNoiseGateEnabled()),e.setNoiseGateThreshold(this.gainController.getNoiseGateThreshold()),e.setFrequencyEstimationMethod(this.frequencyEstimator.getFrequencyEstimationMethod()),e.setBufferSizeMultiplier(this.frequencyEstimator.getBufferSizeMultiplier()),e.setZeroCrossMode(this.zeroCrossDetector.getZeroCrossMode()))}syncResultsFromWasm(e){this.frequencyEstimator.estimatedFrequency=e.estimatedFrequency,this.gainController.currentGain=e.gain,e.previousWaveform&&(this.waveformSearcher.previousWaveform=e.previousWaveform),this.waveformSearcher.lastSimilarity=e.similarity}processFrame(e,t){const i=performance.now(),s=this.wasmLoader.getProcessor();if(!this.wasmLoader.isReady()||!s)return console.warn("WASM processor not initialized"),null;if(!this.audioManager.isReady())return null;const r=performance.now(),a=this.audioManager.getTimeDomainData();if(!a)return null;const n=performance.now(),c=this.audioManager.getSampleRate(),f=this.audioManager.getFFTSize(),d=performance.now(),u=this.frequencyEstimator.getFrequencyEstimationMethod()==="fft"||e;let g=u?this.audioManager.getFrequencyData():null;const l=performance.now();if(u&&!g&&a){const M=s.computeFrequencyData(a,f);M&&(g=new Uint8Array(M))}const m=performance.now();this.syncConfigToWasm();const v=performance.now(),h=s.processFrame(a,g,c,f,e),x=performance.now();if(!h)return null;const w=performance.now(),p={waveformData:new Float32Array(h.waveform_data),displayStartIndex:h.displayStartIndex,displayEndIndex:h.displayEndIndex,gain:h.gain,estimatedFrequency:h.estimatedFrequency,frequencyPlotHistory:h.frequencyPlotHistory?Array.from(h.frequencyPlotHistory):[],sampleRate:h.sampleRate,fftSize:h.fftSize,frequencyData:h.frequencyData?new Uint8Array(h.frequencyData):void 0,isSignalAboveNoiseGate:h.isSignalAboveNoiseGate,maxFrequency:h.maxFrequency,previousWaveform:h.previousWaveform?new Float32Array(h.previousWaveform):null,similarity:h.similarity,similarityPlotHistory:h.similarityPlotHistory?Array.from(h.similarityPlotHistory):[],usedSimilaritySearch:h.usedSimilaritySearch,phaseZeroIndex:h.phaseZeroIndex,phaseTwoPiIndex:h.phaseTwoPiIndex,phaseMinusQuarterPiIndex:h.phaseMinusQuarterPiIndex,phaseTwoPiPlusQuarterPiIndex:h.phaseTwoPiPlusQuarterPiIndex,zeroCrossCandidates:h.zeroCrossCandidates?Array.from(h.zeroCrossCandidates):[],highlightedZeroCrossCandidate:h.highlightedZeroCrossCandidate,halfFreqPeakStrengthPercent:h.halfFreqPeakStrengthPercent,candidate1Harmonics:h.candidate1Harmonics?Array.from(h.candidate1Harmonics):void 0,candidate2Harmonics:h.candidate2Harmonics?Array.from(h.candidate2Harmonics):void 0,selectionReason:h.selectionReason,cycleSimilarities8div:h.cycleSimilarities8div?Array.from(h.cycleSimilarities8div):void 0,cycleSimilarities4div:h.cycleSimilarities4div?Array.from(h.cycleSimilarities4div):void 0,cycleSimilarities2div:h.cycleSimilarities2div?Array.from(h.cycleSimilarities2div):void 0},S=performance.now();this.clampPhaseMarkers(p),this.updatePhaseOffsetHistory(p),p.phaseZeroOffsetHistory=[...this.phaseZeroOffsetHistory],p.phaseTwoPiOffsetHistory=[...this.phaseTwoPiOffsetHistory],this.syncResultsFromWasm(p);const T=performance.now(),R=t!==void 0?t:this.enableDetailedTimingLogs,E=T-i;if(R||E>this.TIMING_LOG_THRESHOLD_MS){const M={init:(r-i).toFixed(2),getTimeDomain:(n-r).toFixed(2),getMetadata:(d-n).toFixed(2),getFreqData:(l-d).toFixed(2),computeFFT:(m-l).toFixed(2),syncConfig:(v-m).toFixed(2),wasmProcess:(x-v).toFixed(2),convertResult:(S-w).toFixed(2),postProcess:(T-S).toFixed(2),total:E.toFixed(2)};console.log(`[WaveformDataProcessor] init:${M.init}ms | getTimeDomain:${M.getTimeDomain}ms | getMeta:${M.getMetadata}ms | getFreq:${M.getFreqData}ms | computeFFT:${M.computeFFT}ms | syncCfg:${M.syncConfig}ms | WASM:${M.wasmProcess}ms | convert:${M.convertResult}ms | post:${M.postProcess}ms | total:${M.total}ms`)}return p}setDetailedTimingLogs(e){this.enableDetailedTimingLogs=e}clampPhaseMarkers(e){if(e.displayStartIndex===void 0||e.displayEndIndex===void 0)return;const t=e.displayEndIndex-e.displayStartIndex;if(t<=0)return;const i=4,s=100/i*.01,r=Math.floor(t/i),a=(d,u)=>{if(d===void 0)return{index:void 0,percent:void 0};const g=(d-e.displayStartIndex)/t*100;if(u===void 0)return{index:d,percent:g};const l=g-u;if(Math.abs(l)<=s)return{index:d,percent:g};const m=u+Math.sign(l)*s,v=e.displayStartIndex+m/100*t;let h;l>0?h=Math.floor(v):l<0?h=Math.ceil(v):h=Math.round(v);const x=(h-e.displayStartIndex)/t*100;return{index:h,percent:x}},n=a(e.phaseZeroIndex,this.prevPhaseZeroPercent);if(e.phaseZeroIndex=n.index,this.prevPhaseZeroPercent=n.percent,n.index!==void 0&&r>0){const d=n.index+r;e.phaseTwoPiIndex=d}else e.phaseTwoPiIndex=void 0;const c=a(e.phaseMinusQuarterPiIndex,this.prevPhaseMinusQuarterPiPercent);e.phaseMinusQuarterPiIndex=c.index,this.prevPhaseMinusQuarterPiPercent=c.percent;const f=a(e.phaseTwoPiPlusQuarterPiIndex,this.prevPhaseTwoPiPlusQuarterPiPercent);e.phaseTwoPiPlusQuarterPiIndex=f.index,this.prevPhaseTwoPiPlusQuarterPiPercent=f.percent}updatePhaseOffsetHistory(e){if(e.displayStartIndex===void 0||e.displayEndIndex===void 0)return;const t=e.displayEndIndex-e.displayStartIndex;if(t<=0)return;const s=100/4*.01;let r=!1;const a={frame:Date.now(),fourCycleWindow:{lengthSamples:t}};if(e.phaseZeroIndex!==void 0){const c=(e.phaseZeroIndex-e.displayStartIndex)/t*100;if(a.phaseZero={startOffsetPercent:c},this.previousPhaseZeroIndex!==void 0){const f=this.phaseZeroOffsetHistory[this.phaseZeroOffsetHistory.length-1];if(f!==void 0){const d=Math.abs(c-f);a.phaseZero.offsetChange=d,a.phaseZero.previousOffsetPercent=f,d>s&&(r=!0,a.phaseZero.SPEC_VIOLATION=!0)}}this.phaseZeroOffsetHistory.push(c),this.phaseZeroOffsetHistory.length>this.MAX_OFFSET_HISTORY&&this.phaseZeroOffsetHistory.shift(),this.previousPhaseZeroIndex=e.phaseZeroIndex}if(e.phaseTwoPiIndex!==void 0){const c=(e.phaseTwoPiIndex-e.displayStartIndex)/t*100;if(a.phaseTwoPi={endOffsetPercent:c},this.previousPhaseTwoPiIndex!==void 0){const f=this.phaseTwoPiOffsetHistory[this.phaseTwoPiOffsetHistory.length-1];if(f!==void 0){const d=Math.abs(c-f);a.phaseTwoPi.offsetChange=d,a.phaseTwoPi.previousOffsetPercent=f,d>s&&(r=!0,a.phaseTwoPi.SPEC_VIOLATION=!0)}}this.phaseTwoPiOffsetHistory.push(c),this.phaseTwoPiOffsetHistory.length>this.MAX_OFFSET_HISTORY&&this.phaseTwoPiOffsetHistory.shift(),this.previousPhaseTwoPiIndex=e.phaseTwoPiIndex}r&&(console.warn("[1% Spec Violation Detected - Issue #254]",a),console.warn("→ Phase marker moved by more than 1% of one cycle in one frame"))}reset(){const e=this.wasmLoader.getProcessor();e&&e.reset(),this.phaseZeroOffsetHistory=[],this.phaseTwoPiOffsetHistory=[],this.previousPhaseZeroIndex=void 0,this.previousPhaseTwoPiIndex=void 0,this.prevPhaseZeroPercent=void 0,this.prevPhaseMinusQuarterPiPercent=void 0,this.prevPhaseTwoPiPlusQuarterPiPercent=void 0}}class fe{constructor(){o(this,"lastFrameTime",0);o(this,"frameProcessingTimes",[]);o(this,"frameCount",0);o(this,"MAX_FRAME_TIMES",100);o(this,"TARGET_FRAME_TIME",16.67);o(this,"FPS_LOG_INTERVAL_FRAMES",60);o(this,"enableDetailedTimingLogs",!1)}setDetailedTimingLogs(e){this.enableDetailedTimingLogs=e}getDetailedTimingLogsEnabled(){return this.enableDetailedTimingLogs}recordFrameTime(e,t){const i=t-e;if(this.frameProcessingTimes.push(i),this.frameProcessingTimes.length>this.MAX_FRAME_TIMES&&this.frameProcessingTimes.shift(),i>this.TARGET_FRAME_TIME&&console.warn(`Frame processing time: ${i.toFixed(2)}ms (target: <${this.TARGET_FRAME_TIME}ms)`),this.lastFrameTime>0){const r=1e3/(e-this.lastFrameTime);if(this.frameCount++,this.frameCount>=this.FPS_LOG_INTERVAL_FRAMES){const a=this.frameProcessingTimes.reduce((n,c)=>n+c,0)/this.frameProcessingTimes.length;console.log(`FPS: ${r.toFixed(1)}, Avg frame time: ${a.toFixed(2)}ms`),this.frameCount=0}}this.lastFrameTime=e}logDetailedTiming(e,t){const i=e+t;(this.enableDetailedTimingLogs||i>this.TARGET_FRAME_TIME)&&console.log(`[Frame Timing] Total: ${i.toFixed(2)}ms | Data Processing: ${e.toFixed(2)}ms | Rendering: ${t.toFixed(2)}ms`)}reset(){this.lastFrameTime=0,this.frameProcessingTimes=[],this.frameCount=0}}class ue{constructor(e,t,i,s){this.renderer=e,this.comparisonRenderer=t,this.cycleSimilarityRenderer=i,this.frequencyEstimator=s}renderFrame(e,t){let i=e.displayStartIndex,s=e.displayEndIndex;t&&e.phaseMinusQuarterPiIndex!==void 0&&e.phaseTwoPiPlusQuarterPiIndex!==void 0&&e.phaseMinusQuarterPiIndex<=e.phaseTwoPiPlusQuarterPiIndex&&(i=e.phaseMinusQuarterPiIndex,s=e.phaseTwoPiPlusQuarterPiIndex);const r=s-i;this.renderer.clearAndDrawGrid(e.sampleRate,r,e.gain),this.renderer.drawWaveform(e.waveformData,i,s,e.gain),this.renderer.drawPhaseMarkers(e.phaseZeroIndex,e.phaseTwoPiIndex,e.phaseMinusQuarterPiIndex,e.phaseTwoPiPlusQuarterPiIndex,i,s,{phaseZeroSegmentRelative:e.phaseZeroSegmentRelative,phaseZeroHistory:e.phaseZeroHistory,phaseZeroTolerance:e.phaseZeroTolerance,zeroCrossModeName:e.zeroCrossModeName}),e.frequencyData&&this.renderer.getFFTDisplayEnabled()&&e.isSignalAboveNoiseGate&&(this.renderer.drawFFTOverlay(e.frequencyData,e.estimatedFrequency,e.sampleRate,e.fftSize,e.maxFrequency),this.renderer.drawHarmonicAnalysis(e.halfFreqPeakStrengthPercent,e.candidate1Harmonics,e.candidate2Harmonics,e.candidate1WeightedScore,e.candidate2WeightedScore,e.selectionReason,e.estimatedFrequency)),this.renderer.drawFrequencyPlot(e.frequencyPlotHistory,this.frequencyEstimator.getMinFrequency(),this.frequencyEstimator.getMaxFrequency()),this.comparisonRenderer.updatePanels(e.previousWaveform,e.waveformData,e.displayStartIndex,e.displayEndIndex,e.waveformData,e.similarity,e.similarityPlotHistory,e.phaseZeroOffsetHistory,e.phaseTwoPiOffsetHistory,e.phaseZeroIndex,e.phaseTwoPiIndex,e.phaseMinusQuarterPiIndex,e.phaseTwoPiPlusQuarterPiIndex,e.zeroCrossCandidates??[],e.highlightedZeroCrossCandidate),this.cycleSimilarityRenderer&&this.cycleSimilarityRenderer.updateGraphs(e.cycleSimilarities8div,e.cycleSimilarities4div,e.cycleSimilarities2div)}}class ge{constructor(e,t,i,s,r,a,n,c,f){o(this,"audioManager");o(this,"gainController");o(this,"frequencyEstimator");o(this,"renderer");o(this,"zeroCrossDetector");o(this,"waveformSearcher");o(this,"comparisonRenderer");o(this,"cycleSimilarityRenderer",null);o(this,"dataProcessor");o(this,"timingDiagnostics");o(this,"renderCoordinator");o(this,"animationId",null);o(this,"isRunning",!1);o(this,"isPaused",!1);o(this,"phaseMarkerRangeEnabled",!0);this.audioManager=new Y,this.gainController=new U,this.frequencyEstimator=new Q,this.renderer=new ie(e,f),this.zeroCrossDetector=new se,this.waveformSearcher=new re,this.comparisonRenderer=new le(t,i,s,r),a&&n&&c&&(this.cycleSimilarityRenderer=new W(a,n,c)),this.dataProcessor=new de(this.audioManager,this.gainController,this.frequencyEstimator,this.waveformSearcher,this.zeroCrossDetector),this.timingDiagnostics=new fe,this.renderCoordinator=new ue(this.renderer,this.comparisonRenderer,this.cycleSimilarityRenderer,this.frequencyEstimator)}async start(){try{await this.dataProcessor.initialize(),await this.audioManager.start(),this.isRunning=!0,this.render()}catch(e){throw console.error("Error starting oscilloscope:",e),e}}async startFromFile(e){try{await this.dataProcessor.initialize(),await this.audioManager.startFromFile(e),this.isRunning=!0,this.render()}catch(t){throw console.error("Error loading audio file:",t),t}}async startFromBuffer(e){try{await this.dataProcessor.initialize(),await this.audioManager.startFromBuffer(e),this.isRunning=!0,this.render()}catch(t){throw console.error("Error starting from buffer:",t),t}}async stop(){this.isRunning=!1,this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null),await this.audioManager.stop(),this.frequencyEstimator.clearHistory(),this.zeroCrossDetector.reset(),this.waveformSearcher.reset(),this.comparisonRenderer.clear(),this.cycleSimilarityRenderer&&this.cycleSimilarityRenderer.clear(),this.dataProcessor.reset(),this.timingDiagnostics.reset()}render(){if(!this.isRunning)return;const e=performance.now();if(!this.isPaused){const i=performance.now(),s=this.dataProcessor.processFrame(this.renderer.getFFTDisplayEnabled(),this.timingDiagnostics.getDetailedTimingLogsEnabled()),r=performance.now();if(s){this.renderCoordinator.renderFrame(s,this.phaseMarkerRangeEnabled);const a=performance.now(),n=r-i,c=a-r;this.timingDiagnostics.logDetailedTiming(n,c)}}const t=performance.now();this.timingDiagnostics.recordFrameTime(e,t),this.animationId=requestAnimationFrame(()=>this.render())}getIsRunning(){return this.isRunning}setAutoGain(e){this.gainController.setAutoGain(e)}getAutoGainEnabled(){return this.gainController.getAutoGainEnabled()}setNoiseGate(e){this.gainController.setNoiseGate(e)}getNoiseGateEnabled(){return this.gainController.getNoiseGateEnabled()}setNoiseGateThreshold(e){this.gainController.setNoiseGateThreshold(e)}getNoiseGateThreshold(){return this.gainController.getNoiseGateThreshold()}setFrequencyEstimationMethod(e){this.frequencyEstimator.setFrequencyEstimationMethod(e)}getFrequencyEstimationMethod(){return this.frequencyEstimator.getFrequencyEstimationMethod()}setBufferSizeMultiplier(e){this.frequencyEstimator.setBufferSizeMultiplier(e)}getBufferSizeMultiplier(){return this.frequencyEstimator.getBufferSizeMultiplier()}getEstimatedFrequency(){return this.frequencyEstimator.getEstimatedFrequency()}setFFTDisplay(e){this.renderer.setFFTDisplay(e)}getFFTDisplayEnabled(){return this.renderer.getFFTDisplayEnabled()}setHarmonicAnalysisEnabled(e){this.renderer.setHarmonicAnalysisEnabled(e)}getHarmonicAnalysisEnabled(){return this.renderer.getHarmonicAnalysisEnabled()}setDebugOverlaysEnabled(e){this.renderer.setDebugOverlaysEnabled(e)}getDebugOverlaysEnabled(){return this.renderer.getDebugOverlaysEnabled()}setOverlaysLayout(e){this.renderer.setOverlaysLayout(e)}getOverlaysLayout(){return this.renderer.getOverlaysLayout()}getCurrentGain(){return this.gainController.getCurrentGain()}getSimilarityScore(){return this.waveformSearcher.getLastSimilarity()}isSimilaritySearchActive(){return this.waveformSearcher.hasPreviousWaveform()}setUsePeakMode(e){this.zeroCrossDetector.setUsePeakMode(e)}getUsePeakMode(){return this.zeroCrossDetector.getUsePeakMode()}setZeroCrossMode(e){this.zeroCrossDetector.setZeroCrossMode(e)}getZeroCrossMode(){return this.zeroCrossDetector.getZeroCrossMode()}setPauseDrawing(e){this.isPaused=e}setDetailedTimingLogs(e){this.timingDiagnostics.setDetailedTimingLogs(e),this.dataProcessor.setDetailedTimingLogs(e)}getDetailedTimingLogsEnabled(){return this.timingDiagnostics.getDetailedTimingLogsEnabled()}getPauseDrawing(){return this.isPaused}setPhaseMarkerRangeEnabled(e){this.phaseMarkerRangeEnabled=e}getPhaseMarkerRangeEnabled(){return this.phaseMarkerRangeEnabled}}export{ge as O,z as d,D as f};
//# sourceMappingURL=Oscilloscope-BiPi-aIi.js.map
