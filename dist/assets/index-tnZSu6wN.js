var z=Object.defineProperty;var N=(u,e,t)=>e in u?z(u,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[e]=t;var s=(u,e,t)=>N(u,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function t(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(a){if(a.ep)return;a.ep=!0;const o=t(a);fetch(a.href,o)}})();function G(u){return Math.pow(10,u/20)}function K(u){return u<=0?-1/0:20*Math.log10(u)}function I(u){if(u<=0||!isFinite(u))return null;const t=440*Math.pow(2,-4.75),i=12*Math.log2(u/t),a=Math.round(i),o=Math.round((i-a)*100),l=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],n=Math.floor(a/12);return{noteName:`${l[(a%12+12)%12]}${n}`,cents:o}}const $=-48;function V(u){const e=u.numberOfChannels,t=u.sampleRate,i=u.length,a=[];let o=0;for(let d=0;d<e;d++){const y=u.getChannelData(d);a.push(y);for(let h=0;h<i;h++){const f=Math.abs(y[h]);f>o&&(o=f)}}if(o===0)return u;const l=o*Math.pow(10,$/20);let n=i;for(let d=0;d<i;d++){let y=!0;for(let h=0;h<e;h++)if(Math.abs(a[h][d])>l){y=!1;break}if(!y){n=d;break}}if(n>=i)return u;let r=i-1;for(let d=i-1;d>=n;d--){let y=!0;for(let h=0;h<e;h++)if(Math.abs(a[h][d])>l){y=!1;break}if(!y){r=d;break}}if(n===0&&r===i-1)return u;const v=r-n+1,c=new AudioBuffer({numberOfChannels:e,length:v,sampleRate:t});for(let d=0;d<e;d++){const y=a[d],h=c.getChannelData(d);for(let f=0;f<v;f++)h[f]=y[n+f]}return c}class Y{constructor(){s(this,"audioContext",null);s(this,"analyser",null);s(this,"mediaStream",null);s(this,"audioBufferSource",null);s(this,"bufferSource",null);s(this,"dataArray",null);s(this,"frequencyData",null);s(this,"frameBufferHistory",[]);s(this,"MAX_FRAME_HISTORY",16)}initializeAnalyser(){if(!this.audioContext)throw new Error("AudioContext must be initialized before creating analyser");this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=4096,this.analyser.smoothingTimeConstant=0;const e=this.analyser.fftSize;this.dataArray=new Float32Array(e),this.frequencyData=new Uint8Array(this.analyser.frequencyBinCount)}async start(){try{this.mediaStream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.audioContext=new AudioContext;const e=this.audioContext.createMediaStreamSource(this.mediaStream);this.initializeAnalyser(),e.connect(this.analyser)}catch(e){throw console.error("Error accessing microphone:",e),e}}async startFromFile(e){try{const t=await e.arrayBuffer();this.audioContext&&this.audioContext.state!=="closed"&&await this.audioContext.close(),this.audioContext=new AudioContext;let i=await this.audioContext.decodeAudioData(t);i=V(i),this.initializeAnalyser(),this.audioBufferSource=this.audioContext.createBufferSource(),this.audioBufferSource.buffer=i,this.audioBufferSource.loop=!0,this.audioBufferSource.connect(this.analyser),this.analyser.connect(this.audioContext.destination),this.audioBufferSource.start(0)}catch(t){throw console.error("Error loading audio file:",t),t}}async startFromBuffer(e){try{this.audioContext&&this.audioContext.state!=="closed"&&await this.audioContext.close(),this.audioContext=null,this.bufferSource=e,this.bufferSource.setChunkSize(4096),this.dataArray=new Float32Array(4096),this.frequencyData=new Uint8Array(2048)}catch(t){throw console.error("Error starting from buffer:",t),t}}async stop(){if(this.audioBufferSource){try{this.audioBufferSource.stop()}catch{}try{this.audioBufferSource.disconnect()}catch{}this.audioBufferSource=null}if(this.mediaStream&&(this.mediaStream.getTracks().forEach(e=>e.stop()),this.mediaStream=null),this.bufferSource&&(this.bufferSource.reset(),this.bufferSource=null),this.audioContext){try{await this.audioContext.close()}catch(e){console.error("Error closing AudioContext:",e)}this.audioContext=null}this.analyser=null,this.dataArray=null,this.frequencyData=null,this.clearFrameBufferHistory()}getTimeDomainData(){if(this.bufferSource&&this.dataArray){const e=this.bufferSource.getNextChunk();return e?(this.dataArray.set(e),this.updateFrameBufferHistory(this.dataArray),this.dataArray):null}return!this.analyser||!this.dataArray?null:(this.analyser.getFloatTimeDomainData(this.dataArray),this.updateFrameBufferHistory(this.dataArray),this.dataArray)}updateFrameBufferHistory(e){let t;this.frameBufferHistory.length<this.MAX_FRAME_HISTORY?t=new Float32Array(e.length):(t=this.frameBufferHistory.shift(),t.length!==e.length&&(t=new Float32Array(e.length))),t.set(e),this.frameBufferHistory.push(t)}getExtendedTimeDomainData(e){if(e===1)return this.dataArray;if(!this.dataArray||this.frameBufferHistory.length<e)return null;const t=this.frameBufferHistory.slice(-e),i=t.reduce((l,n)=>l+n.length,0),a=new Float32Array(i);let o=0;for(const l of t)a.set(l,o),o+=l.length;return a}clearFrameBufferHistory(){this.frameBufferHistory=[]}getFrequencyData(){return this.bufferSource&&this.dataArray&&this.frequencyData||!this.analyser||!this.frequencyData?null:(this.analyser.getByteFrequencyData(this.frequencyData),this.frequencyData)}getSampleRate(){var e;return this.bufferSource?this.bufferSource.getSampleRate():((e=this.audioContext)==null?void 0:e.sampleRate)||0}getFFTSize(){var e;return this.bufferSource?4096:((e=this.analyser)==null?void 0:e.fftSize)||0}getFrequencyBinCount(){var e;return this.bufferSource?2048:((e=this.analyser)==null?void 0:e.frequencyBinCount)||0}isReady(){return this.bufferSource?this.dataArray!==null:this.audioContext!==null&&this.analyser!==null}}class U{constructor(){s(this,"autoGainEnabled",!0);s(this,"currentGain",1);s(this,"noiseGateEnabled",!0);s(this,"noiseGateThreshold",G(-60))}setAutoGain(e){this.autoGainEnabled=e}getAutoGainEnabled(){return this.autoGainEnabled}setNoiseGate(e){this.noiseGateEnabled=e}getNoiseGateEnabled(){return this.noiseGateEnabled}setNoiseGateThreshold(e){this.noiseGateThreshold=Math.min(Math.max(e,0),1)}getNoiseGateThreshold(){return this.noiseGateThreshold}getCurrentGain(){return this.currentGain}}class Z{constructor(){s(this,"frequencyEstimationMethod","fft");s(this,"estimatedFrequency",0);s(this,"MIN_FREQUENCY_HZ",20);s(this,"MAX_FREQUENCY_HZ",5e3);s(this,"bufferSizeMultiplier",16);s(this,"frequencyPlotHistory",[])}clearHistory(){this.frequencyPlotHistory=[],this.estimatedFrequency=0}setFrequencyEstimationMethod(e){this.frequencyEstimationMethod!==e&&(this.frequencyEstimationMethod=e,this.frequencyPlotHistory=[])}getFrequencyEstimationMethod(){return this.frequencyEstimationMethod}setBufferSizeMultiplier(e){this.bufferSizeMultiplier=e}getBufferSizeMultiplier(){return this.bufferSizeMultiplier}getEstimatedFrequency(){return this.estimatedFrequency}getMinFrequency(){return this.MIN_FREQUENCY_HZ}getMaxFrequency(){return this.MAX_FREQUENCY_HZ}getFrequencyPlotHistory(){return this.frequencyPlotHistory}}function P(u,e){if(typeof u=="string"&&u.endsWith("%")){const t=parseFloat(u);return isNaN(t)?(console.warn(`Invalid percentage value: ${u}, using 0`),0):t<0?(console.warn(`Negative percentage value: ${u}, clamping to 0`),0):Math.floor(e*(t/100))}if(typeof u=="string"){const t=parseInt(u,10);return isNaN(t)?(console.warn(`Invalid numeric string: ${u}, using 0`),0):Math.max(0,t)}return typeof u=="number"?isNaN(u)?(console.warn(`Invalid number value: ${u}, using 0`),0):Math.max(0,Math.floor(u)):0}const Q={fftOverlay:{position:{x:10,y:"65%"},size:{width:"35%",height:"35%"}},harmonicAnalysis:{position:{x:10,y:10},size:{width:500,height:"auto"}},frequencyPlot:{position:{x:"right-10",y:10},size:{width:280,height:120}}};class D{constructor(e,t,i){s(this,"ctx");s(this,"canvasWidth");s(this,"canvasHeight");this.ctx=e,this.canvasWidth=t,this.canvasHeight=i}updateDimensions(e,t){this.canvasWidth=e,this.canvasHeight=t}calculateOverlayDimensions(e,t,i,a,o){if(!e)return{x:t,y:i,width:a,height:o};let l=t,n=i,r=a,v=o;if(e.position.x!==void 0)if(typeof e.position.x=="string"&&e.position.x.startsWith("right-")){const c=parseInt(e.position.x.substring(6),10),d=e.size.width!==void 0&&e.size.width!=="auto"?P(e.size.width,this.canvasWidth):a;l=this.canvasWidth-d-c}else l=P(e.position.x,this.canvasWidth);return e.position.y!==void 0&&(n=P(e.position.y,this.canvasHeight)),e.size.width!==void 0&&e.size.width!=="auto"&&(r=P(e.size.width,this.canvasWidth)),e.size.height!==void 0&&e.size.height!=="auto"&&(v=P(e.size.height,this.canvasHeight)),{x:l,y:n,width:r,height:v}}}class X{constructor(e,t,i){s(this,"ctx");s(this,"canvasWidth");s(this,"canvasHeight");this.ctx=e,this.canvasWidth=t,this.canvasHeight=i}updateDimensions(e,t){this.canvasWidth=e,this.canvasHeight=t}drawGrid(e,t,i){this.ctx.strokeStyle="#222222",this.ctx.lineWidth=1,this.ctx.beginPath();const a=5;for(let l=0;l<=a;l++){const n=this.canvasHeight/a*l;this.ctx.moveTo(0,n),this.ctx.lineTo(this.canvasWidth,n)}const o=10;for(let l=0;l<=o;l++){const n=this.canvasWidth/o*l;this.ctx.moveTo(n,0),this.ctx.lineTo(n,this.canvasHeight)}this.ctx.stroke(),this.ctx.strokeStyle="#444444",this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.moveTo(0,this.canvasHeight/2),this.ctx.lineTo(this.canvasWidth,this.canvasHeight/2),this.ctx.stroke(),e&&e>0&&t&&t>0&&i!==void 0&&i>0&&this.drawGridLabels(e,t,i)}drawGridLabels(e,t,i){this.ctx.save(),this.ctx.font="11px monospace",this.ctx.fillStyle="#666666";const a=t/e*1e3,o=10,l=a/o;for(let c=0;c<=o;c++){const d=this.canvasWidth/o*c,y=l*c;let h;y>=1e3?h=`${(y/1e3).toFixed(2)}s`:y>=1?h=`${y.toFixed(1)}ms`:h=`${(y*1e3).toFixed(0)}μs`;const f=this.ctx.measureText(h).width,x=Math.max(2,Math.min(d-f/2,this.canvasWidth-f-2));this.ctx.fillText(h,x,this.canvasHeight-3)}const n=5,v=1/(n/2*i);for(let c=0;c<=n;c++){const d=this.canvasHeight/n*c,h=(n/2-c)*v;let f;if(h===0)f="0dB*";else{const x=K(Math.abs(h)),m=h>0?"+":"-",g=Math.abs(x);g>=100?f=`${m}${g.toFixed(0)}dB`:f=`${m}${g.toFixed(1)}dB`}this.ctx.fillText(f,3,d+10)}this.ctx.restore()}}class j{constructor(e,t,i){s(this,"ctx");s(this,"canvasWidth");s(this,"canvasHeight");this.ctx=e,this.canvasWidth=t,this.canvasHeight=i}updateDimensions(e,t){this.canvasWidth=e,this.canvasHeight=t}drawWaveform(e,t,i,a){const o=i-t;if(o<=0)return;this.ctx.strokeStyle="#00ff00",this.ctx.lineWidth=2,this.ctx.beginPath();const l=this.canvasWidth/o,n=this.canvasHeight/2,v=this.canvasHeight/2*a;for(let c=0;c<o;c++){const d=t+c,y=e[d],h=n-y*v,f=Math.min(this.canvasHeight,Math.max(0,h)),x=c*l;c===0?this.ctx.moveTo(x,f):this.ctx.lineTo(x,f)}this.ctx.stroke()}}class J extends D{constructor(){super(...arguments);s(this,"FFT_OVERLAY_HEIGHT_RATIO",.9);s(this,"FFT_MIN_BAR_WIDTH",1)}drawFFTOverlay(t,i,a,o,l,n){const r=a/o,v=Math.floor(this.canvasWidth*.35),c=Math.floor(this.canvasHeight*.35),d=10,y=this.canvasHeight-c-10,{x:h,y:f,width:x,height:m}=this.calculateOverlayDimensions(n,d,y,v,c);this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(h,f,x,m),this.ctx.strokeStyle="#00aaff",this.ctx.lineWidth=2,this.ctx.strokeRect(h,f,x,m);const g=Math.min(t.length,Math.ceil(l/r)),E=x/g;this.ctx.fillStyle="#00aaff";for(let C=0;C<g;C++){const S=t[C]/255*m*this.FFT_OVERLAY_HEIGHT_RATIO,A=h+C*E,T=f+m-S;this.ctx.fillRect(A,T,Math.max(E-1,this.FFT_MIN_BAR_WIDTH),S)}if(i>0&&i<=l){const C=i/r,w=h+C*E;this.ctx.strokeStyle="#ff00ff",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(w,f),this.ctx.lineTo(w,f+m),this.ctx.stroke(),this.ctx.fillStyle="#ff00ff",this.ctx.font="bold 12px Arial";const S=`${i.toFixed(1)} Hz`,A=this.ctx.measureText(S).width;let T=w+3;T+A>h+x-5&&(T=w-A-3),this.ctx.fillText(S,T,f+15)}this.ctx.restore()}}class ee extends D{drawHarmonicAnalysis(e,t,i,a,o,l,n,r){if(e===void 0&&!t&&!i&&!l)return;const v=16,d=(1+(e!==void 0?1:0)+(t?1:0)+(i?1:0)+(l?2:0))*v+10,{x:y,y:h,width:f,height:x}=this.calculateOverlayDimensions(r,10,10,500,d);let m=h;if(this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillRect(y,h,f,x),this.ctx.strokeStyle="#ffaa00",this.ctx.lineWidth=2,this.ctx.strokeRect(y,h,f,x),this.ctx.fillStyle="#ffaa00",this.ctx.font="bold 12px monospace",m+=15,this.ctx.fillText("倍音分析 (Harmonic Analysis)",y+5,m),e!==void 0&&n){m+=v,this.ctx.fillStyle="#00ff00",this.ctx.font="11px monospace";const g=n/2;this.ctx.fillText(`1/2周波数 (${g.toFixed(1)}Hz) のpeak強度: ${e.toFixed(1)}%`,y+5,m)}if(t&&n){m+=v,this.ctx.fillStyle="#ff00ff",this.ctx.font="11px monospace";const g=t.map((C,w)=>`${w+1}x:${C.toFixed(2)}`).join(" "),E=a!==void 0?` (重み付け: ${a.toFixed(1)})`:"";this.ctx.fillText(`候補1 (${n.toFixed(1)}Hz) 倍音: ${g}${E}`,y+5,m)}if(i&&n){m+=v,this.ctx.fillStyle="#00aaff",this.ctx.font="11px monospace";const g=n/2,E=i.map((w,S)=>`${S+1}x:${w.toFixed(2)}`).join(" "),C=o!==void 0?` (重み付け: ${o.toFixed(1)})`:"";this.ctx.fillText(`候補2 (${g.toFixed(1)}Hz) 倍音: ${E}${C}`,y+5,m)}if(l){m+=v,this.ctx.fillStyle="#aaaaaa",this.ctx.font="10px monospace";const g=f-10,E=l.split(" ");let C="";for(const w of E){const S=C+(C?" ":"")+w;this.ctx.measureText(S).width>g&&C?(this.ctx.fillText(C,y+5,m),m+=v,C=w):C=S}C&&this.ctx.fillText(C,y+5,m)}this.ctx.restore()}}class te extends D{constructor(){super(...arguments);s(this,"FREQ_PLOT_MIN_RANGE_PADDING_HZ",50);s(this,"FREQ_PLOT_RANGE_PADDING_RATIO",.1)}drawFrequencyPlot(t,i,a,o){if(!t||t.length===0)return;const{x:l,y:n,width:r,height:v}=this.calculateOverlayDimensions(o,this.canvasWidth-280-10,10,280,120);this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(l,n,r,v),this.ctx.strokeStyle="#ffaa00",this.ctx.lineWidth=2,this.ctx.strokeRect(l,n,r,v),this.ctx.fillStyle="#ffaa00",this.ctx.font="bold 12px Arial",this.ctx.fillText(`周波数推移 (${t.length}frame)`,l+5,n+15);const c=l+35,d=n+25,y=r-45,h=v-45,f=t.filter(p=>p>0);if(f.length===0){this.ctx.restore();return}const x=Math.min(...f),m=Math.max(...f),g=(m-x)*this.FREQ_PLOT_RANGE_PADDING_RATIO||this.FREQ_PLOT_MIN_RANGE_PADDING_HZ,E=Math.max(i,x-g),C=Math.min(a,m+g);this.ctx.strokeStyle="#333333",this.ctx.lineWidth=1,this.ctx.beginPath();for(let p=0;p<=4;p++){const b=d+h/4*p;this.ctx.moveTo(c,b),this.ctx.lineTo(c+y,b)}for(let p=0;p<=4;p++){const b=c+y/4*p;this.ctx.moveTo(b,d),this.ctx.lineTo(b,d+h)}this.ctx.stroke(),this.ctx.fillStyle="#aaaaaa",this.ctx.font="10px monospace",this.ctx.textAlign="right",this.ctx.textBaseline="middle";for(let p=0;p<=4;p++){const b=C-(C-E)*(p/4),F=d+h/4*p,R=b>=1e3?`${(b/1e3).toFixed(1)}k`:`${b.toFixed(0)}`;this.ctx.fillText(R,c-5,F)}this.ctx.fillStyle="#88ccff",this.ctx.font="9px monospace",this.ctx.textAlign="right",this.ctx.textBaseline="middle";for(let p=0;p<=4;p++){const b=C-(C-E)*(p/4),F=d+h/4*p,R=I(b);if(R){const L=R.cents>=0?"+":"";this.ctx.fillText(`${L}${R.cents}¢`,c+y-5,F)}}this.ctx.strokeStyle="#00ff00",this.ctx.lineWidth=2,this.ctx.beginPath();const w=y/Math.max(t.length-1,1),S=Math.max(1,Math.floor(t.length/4)),A=p=>{const F=(Math.max(E,Math.min(C,p))-E)/(C-E);return d+h-F*h};let T=!1;for(let p=0;p<t.length;p++){const b=t[p],F=c+p*w;if(b===0){T=!1;continue}const R=A(b);T?this.ctx.lineTo(F,R):(this.ctx.moveTo(F,R),T=!0)}this.ctx.stroke(),this.ctx.font="9px monospace",this.ctx.textAlign="center",this.ctx.textBaseline="top";for(let p=0;p<t.length;p++){const b=t[p],F=c+p*w;if(b!==0){const _=A(b);this.ctx.fillStyle="#00ff00",this.ctx.beginPath(),this.ctx.arc(F,_,2,0,Math.PI*2),this.ctx.fill()}const R=p===t.length-1;if(p%S===0||R){this.ctx.fillStyle="#aaaaaa";const _=p-t.length+1;this.ctx.fillText(`${_}`,F,d+h+2)}}const H=t[t.length-1];if(H>0){const p=I(H);this.ctx.fillStyle="#00ff00",this.ctx.font="bold 11px Arial",this.ctx.textAlign="left",this.ctx.textBaseline="bottom";let b=`${H.toFixed(1)} Hz`;if(p){const F=p.cents>=0?"+":"";b+=` (${p.noteName} ${F}${p.cents}¢)`}this.ctx.fillText(b,c+2,d+h-2)}this.ctx.restore()}}class ie{constructor(e,t,i,a=!0){s(this,"ctx");s(this,"canvasWidth");s(this,"canvasHeight");s(this,"debugOverlaysEnabled");this.ctx=e,this.canvasWidth=t,this.canvasHeight=i,this.debugOverlaysEnabled=a}updateDimensions(e,t){this.canvasWidth=e,this.canvasHeight=t}setDebugOverlaysEnabled(e){this.debugOverlaysEnabled=e}drawPhaseMarkers(e,t,i,a,o,l,n){if(o===void 0||l===void 0)return;const r=l-o;if(r<=0)return;this.ctx.save();const v=(c,d,y)=>{const h=c-o;if(h<0||h>=r)return;const f=h/r*this.canvasWidth;this.ctx.strokeStyle=d,this.ctx.lineWidth=y,this.ctx.beginPath(),this.ctx.moveTo(f,0),this.ctx.lineTo(f,this.canvasHeight),this.ctx.stroke()};if(i!==void 0&&v(i,"#ff8800",2),a!==void 0&&v(a,"#ff8800",2),e!==void 0&&(v(e,"#ff0000",2),this.debugOverlaysEnabled&&(n==null?void 0:n.phaseZeroSegmentRelative)!==void 0)){const d=(e-o)/r*this.canvasWidth,y=20;this.ctx.save(),this.ctx.fillStyle="#ff0000",this.ctx.font="12px monospace",this.ctx.textAlign="left";const h=n.phaseZeroSegmentRelative,f=n.phaseZeroHistory??"?",x=n.phaseZeroTolerance??"?";[`Mode: ${n.zeroCrossModeName??"Unknown"}`,`Seg Rel: ${h}`,`History: ${f}`,`Tolerance: ±${x}`,`Range: ${typeof f=="number"&&typeof x=="number"?`${f-x}~${f+x}`:"?"}`].forEach((E,C)=>{this.ctx.fillText(E,d+5,y+C*14)}),this.ctx.restore()}t!==void 0&&v(t,"#ff0000",2),this.ctx.restore()}}class se{constructor(e,t){s(this,"canvas");s(this,"ctx");s(this,"fftDisplayEnabled",!0);s(this,"harmonicAnalysisEnabled",!1);s(this,"debugOverlaysEnabled",!0);s(this,"overlaysLayout");s(this,"gridRenderer");s(this,"waveformLineRenderer");s(this,"fftOverlayRenderer");s(this,"harmonicAnalysisRenderer");s(this,"frequencyPlotRenderer");s(this,"phaseMarkerRenderer");this.canvas=e;const i=e.getContext("2d");if(!i)throw new Error("Could not get 2D context");this.ctx=i,this.overlaysLayout=t||Q,this.gridRenderer=new X(this.ctx,e.width,e.height),this.waveformLineRenderer=new j(this.ctx,e.width,e.height),this.fftOverlayRenderer=new J(this.ctx,e.width,e.height),this.harmonicAnalysisRenderer=new ee(this.ctx,e.width,e.height),this.frequencyPlotRenderer=new te(this.ctx,e.width,e.height),this.phaseMarkerRenderer=new ie(this.ctx,e.width,e.height,this.debugOverlaysEnabled),e.width===300&&e.height===150&&console.warn('Canvas element is using default dimensions (300x150). Set explicit width and height attributes on the canvas element to match desired resolution. Example: <canvas id="oscilloscope" width="1800" height="1000"></canvas>')}clearAndDrawGrid(e,t,i){this.updateRendererDimensions(),this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.gridRenderer.drawGrid(e,t,i)}updateRendererDimensions(){const e=this.canvas.width,t=this.canvas.height;this.gridRenderer.updateDimensions(e,t),this.waveformLineRenderer.updateDimensions(e,t),this.fftOverlayRenderer.updateDimensions(e,t),this.harmonicAnalysisRenderer.updateDimensions(e,t),this.frequencyPlotRenderer.updateDimensions(e,t),this.phaseMarkerRenderer.updateDimensions(e,t)}drawWaveform(e,t,i,a){this.updateRendererDimensions(),this.waveformLineRenderer.drawWaveform(e,t,i,a)}drawFFTOverlay(e,t,i,a,o){this.fftDisplayEnabled&&(this.updateRendererDimensions(),this.fftOverlayRenderer.drawFFTOverlay(e,t,i,a,o,this.overlaysLayout.fftOverlay))}drawHarmonicAnalysis(e,t,i,a,o,l,n){this.harmonicAnalysisEnabled&&this.debugOverlaysEnabled&&this.fftDisplayEnabled&&(this.updateRendererDimensions(),this.harmonicAnalysisRenderer.drawHarmonicAnalysis(e,t,i,a,o,l,n,this.overlaysLayout.harmonicAnalysis))}drawFrequencyPlot(e,t,i){this.debugOverlaysEnabled&&(this.updateRendererDimensions(),this.frequencyPlotRenderer.drawFrequencyPlot(e,t,i,this.overlaysLayout.frequencyPlot))}drawPhaseMarkers(e,t,i,a,o,l,n){this.updateRendererDimensions(),this.phaseMarkerRenderer.drawPhaseMarkers(e,t,i,a,o,l,n)}setFFTDisplay(e){this.fftDisplayEnabled=e}getFFTDisplayEnabled(){return this.fftDisplayEnabled}setHarmonicAnalysisEnabled(e){this.harmonicAnalysisEnabled=e}getHarmonicAnalysisEnabled(){return this.harmonicAnalysisEnabled}setDebugOverlaysEnabled(e){this.debugOverlaysEnabled=e,this.phaseMarkerRenderer.setDebugOverlaysEnabled(e)}getDebugOverlaysEnabled(){return this.debugOverlaysEnabled}setOverlaysLayout(e){this.overlaysLayout={...this.overlaysLayout,...e}}getOverlaysLayout(){return this.overlaysLayout}}class ae{constructor(){s(this,"usePeakMode",!1);s(this,"zeroCrossMode","hysteresis")}setUsePeakMode(e){this.usePeakMode=e}getUsePeakMode(){return this.usePeakMode}setZeroCrossMode(e){this.zeroCrossMode=e}getZeroCrossMode(){return this.zeroCrossMode}reset(){}}class re{constructor(){s(this,"previousWaveform",null);s(this,"lastSimilarity",0)}getLastSimilarity(){return this.lastSimilarity}reset(){this.previousWaveform=null,this.lastSimilarity=0}hasPreviousWaveform(){return this.previousWaveform!==null}getPreviousWaveform(){return this.previousWaveform}}class ne{constructor(e,t,i,a){s(this,"previousCanvas");s(this,"currentCanvas");s(this,"similarityCanvas");s(this,"bufferCanvas");s(this,"previousCtx");s(this,"currentCtx");s(this,"similarityCtx");s(this,"bufferCtx");s(this,"TARGET_FILL_RATIO",.9);s(this,"MIN_PEAK_THRESHOLD",.001);s(this,"DEFAULT_AMPLITUDE_RATIO",.4);this.previousCanvas=e,this.currentCanvas=t,this.similarityCanvas=i,this.bufferCanvas=a;const o=e.getContext("2d"),l=t.getContext("2d"),n=i.getContext("2d"),r=a.getContext("2d");if(!o||!l||!n||!r)throw new Error("Could not get 2D context for comparison canvases");this.previousCtx=o,this.currentCtx=l,this.similarityCtx=n,this.bufferCtx=r,this.clearAllCanvases()}clearAllCanvases(){this.clearCanvas(this.previousCtx,this.previousCanvas.width,this.previousCanvas.height),this.clearCanvas(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height),this.clearCanvas(this.similarityCtx,this.similarityCanvas.width,this.similarityCanvas.height),this.clearCanvas(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height)}clearCanvas(e,t,i){e.fillStyle="#000000",e.fillRect(0,0,t,i)}findPeakAmplitude(e,t,i){let a=0;const o=Math.max(0,t),l=Math.min(e.length,i);for(let n=o;n<l;n++){const r=Math.abs(e[n]);r>a&&(a=r)}return a}drawWaveform(e,t,i,a,o,l,n){const r=l-o;if(r<=0)return;const v=this.findPeakAmplitude(a,o,l);e.strokeStyle=n,e.lineWidth=1.5,e.beginPath();const c=t/r,d=i/2;let y;if(v>this.MIN_PEAK_THRESHOLD){const h=this.TARGET_FILL_RATIO/v;y=i/2*h}else y=i*this.DEFAULT_AMPLITUDE_RATIO;for(let h=0;h<r;h++){const f=o+h;if(f>=a.length)break;const x=a[f],m=d-x*y,g=Math.min(i,Math.max(0,m)),E=h*c;h===0?e.moveTo(E,g):e.lineTo(E,g)}e.stroke()}drawCenterLine(e,t,i){e.strokeStyle="#444444",e.lineWidth=1,e.beginPath(),e.moveTo(0,i/2),e.lineTo(t,i/2),e.stroke()}drawSimilarityText(e){this.currentCtx.fillStyle="#00aaff",this.currentCtx.font="bold 14px Arial";const t=`Similarity: ${e.toFixed(3)}`,i=this.currentCtx.measureText(t).width,a=(this.currentCanvas.width-i)/2;this.currentCtx.fillText(t,a,20)}drawSimilarityPlot(e){if(!e||e.length===0)return;const t=this.similarityCtx,i=this.similarityCanvas.width,a=this.similarityCanvas.height;t.save(),t.fillStyle="#000000",t.fillRect(0,0,i,a),t.strokeStyle="#00aaff",t.lineWidth=2,t.strokeRect(0,0,i,a),t.fillStyle="#00aaff",t.font="bold 12px Arial",t.fillText("類似度推移 (Similarity)",5,15);const o=40,l=25,n=i-50,r=a-35,v=-1,c=1;t.strokeStyle="#333333",t.lineWidth=1,t.beginPath();for(let h=0;h<=4;h++){const f=l+r/4*h;t.moveTo(o,f),t.lineTo(o+n,f)}for(let h=0;h<=4;h++){const f=o+n/4*h;t.moveTo(f,l),t.lineTo(f,l+r)}t.stroke(),t.fillStyle="#aaaaaa",t.font="10px monospace",t.textAlign="right",t.textBaseline="middle";for(let h=0;h<=4;h++){const f=c-(c-v)*(h/4),x=l+r/4*h,m=f.toFixed(2);t.fillText(m,o-5,x)}t.strokeStyle="#00aaff",t.lineWidth=2,t.beginPath();const d=n/Math.max(e.length-1,1);for(let h=0;h<e.length;h++){const f=e[h],x=o+h*d,g=(Math.max(v,Math.min(c,f))-v)/(c-v),E=l+r-g*r;h===0?t.moveTo(x,E):t.lineTo(x,E)}t.stroke();const y=e[e.length-1];t.fillStyle="#00aaff",t.font="bold 11px Arial",t.textAlign="left",t.textBaseline="bottom",t.fillText(`${y.toFixed(3)}`,o+2,l+r-2),t.restore()}drawPositionMarkers(e,t,i,a,o,l){if(l<=0)return;const n=a/l*t,r=o/l*t;e.strokeStyle="#ff0000",e.lineWidth=2,e.beginPath(),e.moveTo(n,0),e.lineTo(n,i),e.stroke(),e.beginPath(),e.moveTo(r,0),e.lineTo(r,i),e.stroke(),e.fillStyle="#ff0000",e.font="10px Arial",e.fillText("S",n+2,12),e.fillText("E",r+2,12)}updatePanels(e,t,i,a,o,l,n=[]){this.clearAllCanvases(),e&&(this.drawCenterLine(this.previousCtx,this.previousCanvas.width,this.previousCanvas.height),this.drawWaveform(this.previousCtx,this.previousCanvas.width,this.previousCanvas.height,e,0,e.length,"#ffaa00")),this.drawCenterLine(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height),t&&t.length>0&&this.drawWaveform(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height,t,0,t.length,"#00ff00"),e&&this.drawSimilarityText(l),n.length>0&&this.drawSimilarityPlot(n),this.drawCenterLine(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height),this.drawWaveform(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height,i,0,i.length,"#888888"),this.drawPositionMarkers(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height,a,o,i.length)}clear(){this.clearAllCanvases()}}class oe{constructor(e,t,i){s(this,"canvas8div");s(this,"canvas4div");s(this,"canvas2div");s(this,"ctx8div");s(this,"ctx4div");s(this,"ctx2div");this.canvas8div=e,this.canvas4div=t,this.canvas2div=i;const a=e.getContext("2d"),o=t.getContext("2d"),l=i.getContext("2d");if(!a||!o||!l)throw new Error("Could not get 2D context for cycle similarity canvases");this.ctx8div=a,this.ctx4div=o,this.ctx2div=l,this.clearAllCanvases()}clearAllCanvases(){this.clearCanvas(this.ctx8div,this.canvas8div.width,this.canvas8div.height),this.clearCanvas(this.ctx4div,this.canvas4div.width,this.canvas4div.height),this.clearCanvas(this.ctx2div,this.canvas2div.width,this.canvas2div.height)}clearCanvas(e,t,i){e.fillStyle="#000000",e.fillRect(0,0,t,i)}drawSimilarityGraph(e,t,i,a,o,l){if(e.save(),e.fillStyle="#000000",e.fillRect(0,0,t,i),e.strokeStyle="#ff8800",e.lineWidth=2,e.strokeRect(0,0,t,i),e.fillStyle="#ff8800",e.font="bold 12px Arial",e.fillText(o,5,15),!a||a.length===0){e.fillStyle="#666666",e.font="11px Arial",e.fillText("データなし (No data)",t/2-50,i/2),e.restore();return}const n=35,r=25,v=t-45,c=i-35,d=-1,y=1;e.strokeStyle="#333333",e.lineWidth=1,e.beginPath();for(let m=0;m<=4;m++){const g=r+c/4*m;e.moveTo(n,g),e.lineTo(n+v,g)}for(let m=0;m<=a.length;m++){const g=n+v/a.length*m;e.moveTo(g,r),e.lineTo(g,r+c)}e.stroke(),e.fillStyle="#aaaaaa",e.font="10px monospace",e.textAlign="right",e.textBaseline="middle";for(let m=0;m<=4;m++){const g=y-(y-d)*(m/4),E=r+c/4*m,C=g.toFixed(1);e.fillText(C,n-5,E)}const h=v/a.length,f=h*.15;for(let m=0;m<a.length;m++){const g=a[m],E=Math.max(d,Math.min(y,g)),C=(E-d)/(y-d),w=r+c-C*c,S=r+c-(0-d)/(y-d)*c,A=n+m*h+f,T=h-f*2;g>=.9?e.fillStyle="#00ff00":g>=.7?e.fillStyle="#88ff00":g>=.5?e.fillStyle="#ffaa00":g>=0?e.fillStyle="#ff6600":e.fillStyle="#ff0000",w<S?e.fillRect(A,w,T,S-w):e.fillRect(A,S,T,w-S),e.fillStyle="#ffffff",e.font="9px monospace",e.textAlign="center",E>=0?(e.textBaseline="bottom",e.fillText(g.toFixed(2),A+T/2,w-2)):(e.textBaseline="top",e.fillText(g.toFixed(2),A+T/2,w+2))}const x=r+c-(0-d)/(y-d)*c;e.strokeStyle="#666666",e.lineWidth=1,e.beginPath(),e.moveTo(n,x),e.lineTo(n+v,x),e.stroke(),e.fillStyle="#aaaaaa",e.font="9px Arial",e.textAlign="center",e.textBaseline="top";for(let m=0;m<a.length;m++){const g=n+(m+.5)*h;e.fillText(`${m+1}-${m+2}`,g,r+c+2)}e.fillStyle="#aaaaaa",e.font="10px Arial",e.textAlign="center",e.fillText(l,n+v/2,i-3),e.restore()}updateGraphs(e,t,i){this.drawSimilarityGraph(this.ctx8div,this.canvas8div.width,this.canvas8div.height,e||[],"8分割 (1/2周期)","連続する1/2周期間の類似度"),this.drawSimilarityGraph(this.ctx4div,this.canvas4div.width,this.canvas4div.height,t||[],"4分割 (1周期)","連続する1周期間の類似度"),this.drawSimilarityGraph(this.ctx2div,this.canvas2div.width,this.canvas2div.height,i||[],"2分割 (2周期)","連続する2周期間の類似度")}clear(){this.clearAllCanvases()}}const k=class k{constructor(){s(this,"cachedBasePath",null)}getBasePath(){var t;if(this.cachedBasePath!==null)return this.cachedBasePath;let e=(t=document.querySelector("base"))==null?void 0:t.getAttribute("href");if(e)try{e=new URL(e,window.location.href).pathname}catch{}if(e||(e=this.getBasePathFromScripts()),!e&&window.location.pathname&&window.location.pathname!=="/"){const a=window.location.pathname.split("/").filter(o=>o.length>0);a.length>0&&(e=`/${a[0]}/`)}return e||(e="/"),e.endsWith("/")||(e+="/"),this.cachedBasePath=e,e}getBasePathFromScripts(){const e=document.querySelectorAll("script[src]");for(const t of e){const i=t.getAttribute("src");if(i)try{const o=new URL(i,window.location.href).pathname;for(const l of k.ASSET_PATTERNS){const n=o.indexOf(l);if(n>=0)return n===0?"/":o.substring(0,n)+"/"}}catch(a){(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&console.debug("Failed to parse script URL:",i,a);continue}}return""}};s(k,"ASSET_PATTERNS",["/assets/","/js/","/dist/"]);let W=k;class le{constructor(){s(this,"wasmProcessor",null);s(this,"isInitialized",!1);s(this,"LOAD_TIMEOUT_MS",1e4)}async loadWasmModule(e){if(!(this.isInitialized&&this.wasmProcessor)){if(typeof window>"u"||window.location.protocol==="file:")throw new Error("WASM module not available in test/non-browser environment");return new Promise((t,i)=>{if(window.wasmProcessor&&window.wasmProcessor.WasmDataProcessor){this.wasmProcessor=new window.wasmProcessor.WasmDataProcessor,this.isInitialized=!0,t();return}const a=setTimeout(()=>{n(),i(new Error(`WASM module loading timed out after ${this.LOAD_TIMEOUT_MS/1e3} seconds`))},this.LOAD_TIMEOUT_MS),o=`${e}wasm/wasm_processor.js`,l=document.createElement("script");l.type="module",l.textContent=`
        import init, { WasmDataProcessor } from '${o}';
        await init();
        window.wasmProcessor = { WasmDataProcessor };
        window.dispatchEvent(new Event('wasmLoaded'));
      `;const n=()=>{clearTimeout(a),window.removeEventListener("wasmLoaded",r)},r=()=>{n(),window.wasmProcessor&&window.wasmProcessor.WasmDataProcessor?(this.wasmProcessor=new window.wasmProcessor.WasmDataProcessor,this.isInitialized=!0,t()):i(new Error("WASM module loaded but WasmDataProcessor not found"))};window.addEventListener("wasmLoaded",r),l.onerror=()=>{n(),i(new Error("Failed to load WASM module script"))},document.head.appendChild(l)})}}getProcessor(){return this.wasmProcessor}isReady(){return this.isInitialized&&this.wasmProcessor!==null}}class he{constructor(e,t,i,a,o){s(this,"audioManager");s(this,"gainController");s(this,"frequencyEstimator");s(this,"waveformSearcher");s(this,"zeroCrossDetector");s(this,"basePathResolver");s(this,"wasmLoader");this.audioManager=e,this.gainController=t,this.frequencyEstimator=i,this.waveformSearcher=a,this.zeroCrossDetector=o,this.basePathResolver=new W,this.wasmLoader=new le}async initialize(){if(!this.wasmLoader.isReady())try{const e=this.basePathResolver.getBasePath();await this.wasmLoader.loadWasmModule(e),this.syncConfigToWasm()}catch(e){throw console.error("Failed to initialize WASM module:",e),e}}syncConfigToWasm(){const e=this.wasmLoader.getProcessor();e&&(e.setAutoGain(this.gainController.getAutoGainEnabled()),e.setNoiseGate(this.gainController.getNoiseGateEnabled()),e.setNoiseGateThreshold(this.gainController.getNoiseGateThreshold()),e.setFrequencyEstimationMethod(this.frequencyEstimator.getFrequencyEstimationMethod()),e.setBufferSizeMultiplier(this.frequencyEstimator.getBufferSizeMultiplier()),e.setZeroCrossMode(this.zeroCrossDetector.getZeroCrossMode()))}syncResultsFromWasm(e){this.frequencyEstimator.estimatedFrequency=e.estimatedFrequency,this.gainController.currentGain=e.gain,e.previousWaveform&&(this.waveformSearcher.previousWaveform=e.previousWaveform),this.waveformSearcher.lastSimilarity=e.similarity}processFrame(e){const t=this.wasmLoader.getProcessor();if(!this.wasmLoader.isReady()||!t)return console.warn("WASM processor not initialized"),null;if(!this.audioManager.isReady())return null;const i=this.audioManager.getTimeDomainData();if(!i)return null;const a=this.audioManager.getSampleRate(),o=this.audioManager.getFFTSize(),n=this.frequencyEstimator.getFrequencyEstimationMethod()==="fft"||e?this.audioManager.getFrequencyData():null;this.syncConfigToWasm();const r=t.processFrame(i,n,a,o,e);if(!r)return null;const v={waveformData:new Float32Array(r.waveform_data),displayStartIndex:r.displayStartIndex,displayEndIndex:r.displayEndIndex,gain:r.gain,estimatedFrequency:r.estimatedFrequency,frequencyPlotHistory:r.frequencyPlotHistory?Array.from(r.frequencyPlotHistory):[],sampleRate:r.sampleRate,fftSize:r.fftSize,frequencyData:r.frequencyData?new Uint8Array(r.frequencyData):void 0,isSignalAboveNoiseGate:r.isSignalAboveNoiseGate,maxFrequency:r.maxFrequency,previousWaveform:r.previousWaveform?new Float32Array(r.previousWaveform):null,currentWaveform:r.currentWaveform?new Float32Array(r.currentWaveform):null,similarity:r.similarity,similarityPlotHistory:r.similarityPlotHistory?Array.from(r.similarityPlotHistory):[],usedSimilaritySearch:r.usedSimilaritySearch,phaseZeroIndex:r.phaseZeroIndex,phaseTwoPiIndex:r.phaseTwoPiIndex,phaseMinusQuarterPiIndex:r.phaseMinusQuarterPiIndex,phaseTwoPiPlusQuarterPiIndex:r.phaseTwoPiPlusQuarterPiIndex,halfFreqPeakStrengthPercent:r.halfFreqPeakStrengthPercent,candidate1Harmonics:r.candidate1Harmonics?Array.from(r.candidate1Harmonics):void 0,candidate2Harmonics:r.candidate2Harmonics?Array.from(r.candidate2Harmonics):void 0,selectionReason:r.selectionReason,cycleSimilarities8div:r.cycleSimilarities8div?Array.from(r.cycleSimilarities8div):void 0,cycleSimilarities4div:r.cycleSimilarities4div?Array.from(r.cycleSimilarities4div):void 0,cycleSimilarities2div:r.cycleSimilarities2div?Array.from(r.cycleSimilarities2div):void 0};return this.syncResultsFromWasm(v),v}reset(){const e=this.wasmLoader.getProcessor();e&&e.reset()}}class ce{constructor(e,t,i,a,o,l,n,r,v){s(this,"audioManager");s(this,"gainController");s(this,"frequencyEstimator");s(this,"renderer");s(this,"zeroCrossDetector");s(this,"waveformSearcher");s(this,"comparisonRenderer");s(this,"cycleSimilarityRenderer",null);s(this,"dataProcessor");s(this,"animationId",null);s(this,"isRunning",!1);s(this,"isPaused",!1);s(this,"phaseMarkerRangeEnabled",!0);s(this,"lastFrameTime",0);s(this,"frameProcessingTimes",[]);s(this,"MAX_FRAME_TIMES",100);s(this,"TARGET_FRAME_TIME",16.67);s(this,"FPS_LOG_INTERVAL_FRAMES",60);this.audioManager=new Y,this.gainController=new U,this.frequencyEstimator=new Z,this.renderer=new se(e,v),this.zeroCrossDetector=new ae,this.waveformSearcher=new re,this.comparisonRenderer=new ne(t,i,a,o),l&&n&&r&&(this.cycleSimilarityRenderer=new oe(l,n,r)),this.dataProcessor=new he(this.audioManager,this.gainController,this.frequencyEstimator,this.waveformSearcher,this.zeroCrossDetector)}async start(){try{await this.dataProcessor.initialize(),await this.audioManager.start(),this.isRunning=!0,this.render()}catch(e){throw console.error("Error starting oscilloscope:",e),e}}async startFromFile(e){try{await this.dataProcessor.initialize(),await this.audioManager.startFromFile(e),this.isRunning=!0,this.render()}catch(t){throw console.error("Error loading audio file:",t),t}}async startFromBuffer(e){try{await this.dataProcessor.initialize(),await this.audioManager.startFromBuffer(e),this.isRunning=!0,this.render()}catch(t){throw console.error("Error starting from buffer:",t),t}}async stop(){this.isRunning=!1,this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null),await this.audioManager.stop(),this.frequencyEstimator.clearHistory(),this.zeroCrossDetector.reset(),this.waveformSearcher.reset(),this.comparisonRenderer.clear(),this.cycleSimilarityRenderer&&this.cycleSimilarityRenderer.clear(),this.dataProcessor.reset()}render(){if(!this.isRunning)return;const e=performance.now();if(!this.isPaused){const a=this.dataProcessor.processFrame(this.renderer.getFFTDisplayEnabled());a&&this.renderFrame(a)}const i=performance.now()-e;if(this.frameProcessingTimes.push(i),this.frameProcessingTimes.length>this.MAX_FRAME_TIMES&&this.frameProcessingTimes.shift(),i>this.TARGET_FRAME_TIME&&console.warn(`Frame processing time: ${i.toFixed(2)}ms (target: <${this.TARGET_FRAME_TIME}ms)`),this.lastFrameTime>0){const o=1e3/(e-this.lastFrameTime);if(this.frameProcessingTimes.length===this.FPS_LOG_INTERVAL_FRAMES){const l=this.frameProcessingTimes.reduce((n,r)=>n+r,0)/this.frameProcessingTimes.length;console.log(`FPS: ${o.toFixed(1)}, Avg frame time: ${l.toFixed(2)}ms`)}}this.lastFrameTime=e,this.animationId=requestAnimationFrame(()=>this.render())}renderFrame(e){let t=e.displayStartIndex,i=e.displayEndIndex;this.phaseMarkerRangeEnabled&&e.phaseMinusQuarterPiIndex!==void 0&&e.phaseTwoPiPlusQuarterPiIndex!==void 0&&e.phaseMinusQuarterPiIndex<=e.phaseTwoPiPlusQuarterPiIndex&&(t=e.phaseMinusQuarterPiIndex,i=e.phaseTwoPiPlusQuarterPiIndex);const a=i-t;this.renderer.clearAndDrawGrid(e.sampleRate,a,e.gain),this.renderer.drawWaveform(e.waveformData,t,i,e.gain),this.renderer.drawPhaseMarkers(e.phaseZeroIndex,e.phaseTwoPiIndex,e.phaseMinusQuarterPiIndex,e.phaseTwoPiPlusQuarterPiIndex,t,i,{phaseZeroSegmentRelative:e.phaseZeroSegmentRelative,phaseZeroHistory:e.phaseZeroHistory,phaseZeroTolerance:e.phaseZeroTolerance,zeroCrossModeName:e.zeroCrossModeName}),e.frequencyData&&this.renderer.getFFTDisplayEnabled()&&e.isSignalAboveNoiseGate&&(this.renderer.drawFFTOverlay(e.frequencyData,e.estimatedFrequency,e.sampleRate,e.fftSize,e.maxFrequency),this.renderer.drawHarmonicAnalysis(e.halfFreqPeakStrengthPercent,e.candidate1Harmonics,e.candidate2Harmonics,e.candidate1WeightedScore,e.candidate2WeightedScore,e.selectionReason,e.estimatedFrequency)),this.renderer.drawFrequencyPlot(e.frequencyPlotHistory,this.frequencyEstimator.getMinFrequency(),this.frequencyEstimator.getMaxFrequency()),this.comparisonRenderer.updatePanels(e.previousWaveform,e.currentWaveform,e.waveformData,t,i,e.similarity,e.similarityPlotHistory),this.cycleSimilarityRenderer&&this.cycleSimilarityRenderer.updateGraphs(e.cycleSimilarities8div,e.cycleSimilarities4div,e.cycleSimilarities2div)}getIsRunning(){return this.isRunning}setAutoGain(e){this.gainController.setAutoGain(e)}getAutoGainEnabled(){return this.gainController.getAutoGainEnabled()}setNoiseGate(e){this.gainController.setNoiseGate(e)}getNoiseGateEnabled(){return this.gainController.getNoiseGateEnabled()}setNoiseGateThreshold(e){this.gainController.setNoiseGateThreshold(e)}getNoiseGateThreshold(){return this.gainController.getNoiseGateThreshold()}setFrequencyEstimationMethod(e){this.frequencyEstimator.setFrequencyEstimationMethod(e)}getFrequencyEstimationMethod(){return this.frequencyEstimator.getFrequencyEstimationMethod()}setBufferSizeMultiplier(e){this.frequencyEstimator.setBufferSizeMultiplier(e)}getBufferSizeMultiplier(){return this.frequencyEstimator.getBufferSizeMultiplier()}getEstimatedFrequency(){return this.frequencyEstimator.getEstimatedFrequency()}setFFTDisplay(e){this.renderer.setFFTDisplay(e)}getFFTDisplayEnabled(){return this.renderer.getFFTDisplayEnabled()}setHarmonicAnalysisEnabled(e){this.renderer.setHarmonicAnalysisEnabled(e)}getHarmonicAnalysisEnabled(){return this.renderer.getHarmonicAnalysisEnabled()}setDebugOverlaysEnabled(e){this.renderer.setDebugOverlaysEnabled(e)}getDebugOverlaysEnabled(){return this.renderer.getDebugOverlaysEnabled()}setOverlaysLayout(e){this.renderer.setOverlaysLayout(e)}getOverlaysLayout(){return this.renderer.getOverlaysLayout()}getCurrentGain(){return this.gainController.getCurrentGain()}getSimilarityScore(){return this.waveformSearcher.getLastSimilarity()}isSimilaritySearchActive(){return this.waveformSearcher.hasPreviousWaveform()}setUsePeakMode(e){this.zeroCrossDetector.setUsePeakMode(e)}getUsePeakMode(){return this.zeroCrossDetector.getUsePeakMode()}setZeroCrossMode(e){this.zeroCrossDetector.setZeroCrossMode(e)}getZeroCrossMode(){return this.zeroCrossDetector.getZeroCrossMode()}setPauseDrawing(e){this.isPaused=e}getPauseDrawing(){return this.isPaused}setPhaseMarkerRangeEnabled(e){this.phaseMarkerRangeEnabled=e}getPhaseMarkerRangeEnabled(){return this.phaseMarkerRangeEnabled}}class de{constructor(e){s(this,"canvas");s(this,"ctx");s(this,"MIN_FREQ",50);s(this,"MAX_FREQ",2e3);s(this,"WHITE_KEY_WIDTH",20);s(this,"WHITE_KEY_HEIGHT",60);s(this,"BLACK_KEY_WIDTH",12);s(this,"BLACK_KEY_HEIGHT",38);s(this,"WHITE_KEY_COLOR","#ffffff");s(this,"BLACK_KEY_COLOR","#000000");s(this,"WHITE_KEY_HIGHLIGHT","#00ff00");s(this,"BLACK_KEY_HIGHLIGHT","#00cc00");s(this,"KEY_BORDER","#333333");s(this,"WHITE_KEY_NOTES",[0,2,4,5,7,9,11]);s(this,"BLACK_KEY_NOTES",[1,3,6,8,10]);s(this,"keyboardRange");s(this,"xOffset");s(this,"whiteKeyCount");this.canvas=e;const t=e.getContext("2d");if(!t)throw new Error("Could not get 2D context for piano keyboard");this.ctx=t,this.keyboardRange=this.calculateKeyboardRange(),this.whiteKeyCount=this.countWhiteKeys(),this.xOffset=this.calculateCenteringOffset()}frequencyToNoteInfo(e){const t=I(e);if(!t)return{note:-1,octave:-1,noteInOctave:-1};const i=t.noteName.match(/^([A-G]#?)(\d+)$/);if(!i)return{note:-1,octave:-1,noteInOctave:-1};const a=i[1],o=parseInt(i[2],10),n=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"].indexOf(a);return{note:o*12+n,octave:o,noteInOctave:n}}calculateKeyboardRange(){const e=this.frequencyToNoteInfo(this.MIN_FREQ),t=this.frequencyToNoteInfo(this.MAX_FREQ);return{startNote:e.note,endNote:t.note}}countWhiteKeys(){const e=this.keyboardRange;let t=0;for(let i=e.startNote;i<=e.endNote;i++){const a=(i%12+12)%12;this.WHITE_KEY_NOTES.includes(a)&&t++}return t}calculateCenteringOffset(){const e=this.whiteKeyCount*this.WHITE_KEY_WIDTH;return(this.canvas.width-e)/2}render(e){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);const t=this.keyboardRange,i=e>0?this.frequencyToNoteInfo(e):null;let a=0;for(let r=t.startNote;r<=t.endNote;r++){const v=(r%12+12)%12;if(this.WHITE_KEY_NOTES.includes(v)){const c=this.xOffset+a*this.WHITE_KEY_WIDTH,d=i&&i.note===r;this.ctx.fillStyle=d?this.WHITE_KEY_HIGHLIGHT:this.WHITE_KEY_COLOR,this.ctx.fillRect(c,0,this.WHITE_KEY_WIDTH,this.WHITE_KEY_HEIGHT),this.ctx.strokeStyle=this.KEY_BORDER,this.ctx.lineWidth=1,this.ctx.strokeRect(c,0,this.WHITE_KEY_WIDTH,this.WHITE_KEY_HEIGHT),a++}}a=0;for(let r=t.startNote;r<=t.endNote;r++){const v=(r%12+12)%12;if(this.WHITE_KEY_NOTES.includes(v)&&a++,this.BLACK_KEY_NOTES.includes(v)){const c=this.xOffset+a*this.WHITE_KEY_WIDTH-this.BLACK_KEY_WIDTH/2,d=i&&i.note===r;this.ctx.fillStyle=d?this.BLACK_KEY_HIGHLIGHT:this.BLACK_KEY_COLOR,this.ctx.fillRect(c,0,this.BLACK_KEY_WIDTH,this.BLACK_KEY_HEIGHT),this.ctx.strokeStyle=this.KEY_BORDER,this.ctx.lineWidth=1,this.ctx.strokeRect(c,0,this.BLACK_KEY_WIDTH,this.BLACK_KEY_HEIGHT)}}this.ctx.fillStyle="#888888",this.ctx.font="10px monospace",this.ctx.fillText(`${this.MIN_FREQ}Hz`,this.xOffset+5,this.WHITE_KEY_HEIGHT-5);const o=`${this.MAX_FREQ}Hz`,l=this.ctx.measureText(o).width,n=this.xOffset+this.whiteKeyCount*this.WHITE_KEY_WIDTH;this.ctx.fillText(o,n-l-5,this.WHITE_KEY_HEIGHT-5)}clear(){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}}class ue{constructor(){s(this,"canvas");s(this,"previousWaveformCanvas");s(this,"currentWaveformCanvas");s(this,"similarityPlotCanvas");s(this,"frameBufferCanvas");s(this,"cycleSimilarity8divCanvas");s(this,"cycleSimilarity4divCanvas");s(this,"cycleSimilarity2divCanvas");s(this,"pianoKeyboardCanvas");s(this,"startButton");s(this,"loadFileButton");s(this,"fileInput");s(this,"autoGainCheckbox");s(this,"noiseGateCheckbox");s(this,"fftDisplayCheckbox");s(this,"harmonicAnalysisCheckbox");s(this,"pauseDrawingCheckbox");s(this,"phaseMarkerRangeCheckbox");s(this,"noiseGateThreshold");s(this,"frequencyMethod");s(this,"bufferSizeMultiplier");s(this,"zeroCrossMode");s(this,"thresholdValue");s(this,"statusElement");s(this,"frequencyValue");s(this,"noteValue");s(this,"gainValue");s(this,"similarityValue");this.canvas=this.getElement("canvas"),this.previousWaveformCanvas=this.getElement("previousWaveformCanvas"),this.currentWaveformCanvas=this.getElement("currentWaveformCanvas"),this.similarityPlotCanvas=this.getElement("similarityPlotCanvas"),this.frameBufferCanvas=this.getElement("frameBufferCanvas"),this.cycleSimilarity8divCanvas=this.getElement("cycleSimilarity8divCanvas"),this.cycleSimilarity4divCanvas=this.getElement("cycleSimilarity4divCanvas"),this.cycleSimilarity2divCanvas=this.getElement("cycleSimilarity2divCanvas"),this.pianoKeyboardCanvas=this.getElement("pianoKeyboardCanvas"),this.startButton=this.getElement("startButton"),this.loadFileButton=this.getElement("loadFileButton"),this.fileInput=this.getElement("fileInput"),this.autoGainCheckbox=this.getElement("autoGainCheckbox"),this.noiseGateCheckbox=this.getElement("noiseGateCheckbox"),this.fftDisplayCheckbox=this.getElement("fftDisplayCheckbox"),this.harmonicAnalysisCheckbox=this.getElement("harmonicAnalysisCheckbox"),this.pauseDrawingCheckbox=this.getElement("pauseDrawingCheckbox"),this.phaseMarkerRangeCheckbox=this.getElement("phaseMarkerRangeCheckbox"),this.noiseGateThreshold=this.getElement("noiseGateThreshold"),this.frequencyMethod=this.getElement("frequencyMethod"),this.bufferSizeMultiplier=this.getElement("bufferSizeMultiplier"),this.zeroCrossMode=this.getElement("zeroCrossMode"),this.thresholdValue=this.getElement("thresholdValue"),this.statusElement=this.getElement("status"),this.frequencyValue=this.getElement("frequencyValue"),this.noteValue=this.getElement("noteValue"),this.gainValue=this.getElement("gainValue"),this.similarityValue=this.getElement("similarityValue"),this.validateElements()}getElement(e){const t=document.getElementById(e);if(!t)throw new Error(`Required DOM element not found: ${e}`);return t}validateElements(){const e=[{element:this.canvas,name:"canvas"},{element:this.previousWaveformCanvas,name:"previousWaveformCanvas"},{element:this.currentWaveformCanvas,name:"currentWaveformCanvas"},{element:this.similarityPlotCanvas,name:"similarityPlotCanvas"},{element:this.frameBufferCanvas,name:"frameBufferCanvas"},{element:this.cycleSimilarity8divCanvas,name:"cycleSimilarity8divCanvas"},{element:this.cycleSimilarity4divCanvas,name:"cycleSimilarity4divCanvas"},{element:this.cycleSimilarity2divCanvas,name:"cycleSimilarity2divCanvas"},{element:this.pianoKeyboardCanvas,name:"pianoKeyboardCanvas"},{element:this.startButton,name:"startButton"},{element:this.loadFileButton,name:"loadFileButton"},{element:this.fileInput,name:"fileInput"},{element:this.autoGainCheckbox,name:"autoGainCheckbox"},{element:this.noiseGateCheckbox,name:"noiseGateCheckbox"},{element:this.fftDisplayCheckbox,name:"fftDisplayCheckbox"},{element:this.harmonicAnalysisCheckbox,name:"harmonicAnalysisCheckbox"},{element:this.pauseDrawingCheckbox,name:"pauseDrawingCheckbox"},{element:this.phaseMarkerRangeCheckbox,name:"phaseMarkerRangeCheckbox"},{element:this.noiseGateThreshold,name:"noiseGateThreshold"},{element:this.thresholdValue,name:"thresholdValue"},{element:this.statusElement,name:"status"},{element:this.frequencyMethod,name:"frequencyMethod"},{element:this.bufferSizeMultiplier,name:"bufferSizeMultiplier"},{element:this.zeroCrossMode,name:"zeroCrossMode"},{element:this.frequencyValue,name:"frequencyValue"},{element:this.noteValue,name:"noteValue"},{element:this.gainValue,name:"gainValue"},{element:this.similarityValue,name:"similarityValue"}];for(const{element:t,name:i}of e)if(!t)throw new Error(`Required DOM element not found: ${i}`)}}class fe{constructor(e,t,i,a,o,l){s(this,"oscilloscope");s(this,"pianoKeyboardRenderer");s(this,"frequencyValue");s(this,"noteValue");s(this,"gainValue");s(this,"similarityValue");s(this,"updateInterval",null);s(this,"UPDATE_INTERVAL_MS",100);this.oscilloscope=e,this.pianoKeyboardRenderer=t,this.frequencyValue=i,this.noteValue=a,this.gainValue=o,this.similarityValue=l}start(){this.updateInterval===null&&(this.updateInterval=window.setInterval(()=>{this.update()},this.UPDATE_INTERVAL_MS))}stop(){this.updateInterval!==null&&(clearInterval(this.updateInterval),this.updateInterval=null,this.clearDisplays())}update(){this.updateFrequencyDisplay(),this.updateGainDisplay(),this.updateSimilarityDisplay()}updateFrequencyDisplay(){const e=this.oscilloscope.getEstimatedFrequency();if(e>0){this.frequencyValue.textContent=`${e.toFixed(1)} Hz`;const t=I(e);if(t){const i=t.cents>=0?"+":"";this.noteValue.textContent=`${t.noteName}${i}${t.cents}cent`}else this.noteValue.textContent="---";this.pianoKeyboardRenderer.render(e)}else this.frequencyValue.textContent="--- Hz",this.noteValue.textContent="---",this.pianoKeyboardRenderer.render(0)}updateGainDisplay(){const e=this.oscilloscope.getCurrentGain();this.gainValue.textContent=`${e.toFixed(2)}x`}updateSimilarityDisplay(){if(this.oscilloscope.isSimilaritySearchActive()){const e=this.oscilloscope.getSimilarityScore();this.similarityValue.textContent=e.toFixed(3)}else this.similarityValue.textContent="---"}clearDisplays(){this.frequencyValue.textContent="--- Hz",this.noteValue.textContent="---",this.gainValue.textContent="---x",this.similarityValue.textContent="---",this.pianoKeyboardRenderer.clear()}}class me{constructor(e,t,i){s(this,"oscilloscope");s(this,"dom");s(this,"displayUpdater");this.oscilloscope=e,this.dom=t,this.displayUpdater=i}setupEventHandlers(){this.setupCheckboxHandlers(),this.setupSliderHandlers(),this.setupSelectHandlers(),this.setupButtonHandlers(),this.setupFileInputHandler()}initializeUIState(){this.oscilloscope.setAutoGain(this.dom.autoGainCheckbox.checked),this.oscilloscope.setNoiseGate(this.dom.noiseGateCheckbox.checked),this.oscilloscope.setFFTDisplay(this.dom.fftDisplayCheckbox.checked),this.oscilloscope.setHarmonicAnalysisEnabled(this.dom.harmonicAnalysisCheckbox.checked),this.oscilloscope.setPauseDrawing(this.dom.pauseDrawingCheckbox.checked),this.oscilloscope.setPhaseMarkerRangeEnabled(this.dom.phaseMarkerRangeCheckbox.checked);const e=this.sliderValueToThreshold(this.dom.noiseGateThreshold.value);this.oscilloscope.setNoiseGateThreshold(e.amplitude),this.dom.thresholdValue.textContent=this.formatThresholdDisplay(e.db,e.amplitude);const t=this.dom.zeroCrossMode.value;["standard","peak-backtrack-history","bidirectional-nearest","gradient-based","adaptive-step","hysteresis","closest-to-zero"].includes(t)&&this.oscilloscope.setZeroCrossMode(t),this.dom.startButton.focus()}setupCheckboxHandlers(){this.dom.autoGainCheckbox.addEventListener("change",()=>{this.oscilloscope.setAutoGain(this.dom.autoGainCheckbox.checked)}),this.dom.noiseGateCheckbox.addEventListener("change",()=>{this.oscilloscope.setNoiseGate(this.dom.noiseGateCheckbox.checked)}),this.dom.fftDisplayCheckbox.addEventListener("change",()=>{this.oscilloscope.setFFTDisplay(this.dom.fftDisplayCheckbox.checked)}),this.dom.harmonicAnalysisCheckbox.addEventListener("change",()=>{this.oscilloscope.setHarmonicAnalysisEnabled(this.dom.harmonicAnalysisCheckbox.checked)}),this.dom.pauseDrawingCheckbox.addEventListener("change",()=>{this.oscilloscope.setPauseDrawing(this.dom.pauseDrawingCheckbox.checked)}),this.dom.phaseMarkerRangeCheckbox.addEventListener("change",()=>{this.oscilloscope.setPhaseMarkerRangeEnabled(this.dom.phaseMarkerRangeCheckbox.checked)})}setupSliderHandlers(){this.dom.noiseGateThreshold.addEventListener("input",()=>{const e=this.sliderValueToThreshold(this.dom.noiseGateThreshold.value);this.oscilloscope.setNoiseGateThreshold(e.amplitude),this.dom.thresholdValue.textContent=this.formatThresholdDisplay(e.db,e.amplitude)})}setupSelectHandlers(){this.dom.frequencyMethod.addEventListener("change",()=>{const e=this.dom.frequencyMethod.value;this.oscilloscope.setFrequencyEstimationMethod(e)}),this.dom.bufferSizeMultiplier.addEventListener("change",()=>{const e=parseInt(this.dom.bufferSizeMultiplier.value,10);e===1||e===4||e===16?this.oscilloscope.setBufferSizeMultiplier(e):(console.error("Invalid buffer size multiplier:",e),this.dom.bufferSizeMultiplier.value="1",this.oscilloscope.setBufferSizeMultiplier(1))}),this.dom.zeroCrossMode.addEventListener("change",()=>{const e=this.dom.zeroCrossMode.value;["standard","peak-backtrack-history","bidirectional-nearest","gradient-based","adaptive-step","hysteresis","closest-to-zero"].includes(e)?this.oscilloscope.setZeroCrossMode(e):(console.error("Invalid zero-cross mode:",e),this.dom.zeroCrossMode.value="hysteresis",this.oscilloscope.setZeroCrossMode("hysteresis"))})}setupButtonHandlers(){this.dom.startButton.addEventListener("click",async()=>{await this.handleStartStopButton()}),this.dom.loadFileButton.addEventListener("click",()=>{this.dom.fileInput.click()})}setupFileInputHandler(){this.dom.fileInput.addEventListener("change",async()=>{await this.handleFileInput()})}async handleStartStopButton(){if(this.oscilloscope.getIsRunning())try{this.displayUpdater.stop(),await this.oscilloscope.stop(),this.dom.startButton.textContent="Start",this.dom.loadFileButton.disabled=!1,this.dom.statusElement.textContent="Stopped"}catch(e){console.error("Failed to stop oscilloscope:",e),this.dom.statusElement.textContent="Stopped (with errors)",this.dom.startButton.textContent="Start",this.dom.loadFileButton.disabled=!1}else try{this.dom.startButton.disabled=!0,this.dom.loadFileButton.disabled=!0,this.dom.statusElement.textContent="Requesting microphone access...",await this.oscilloscope.start(),this.dom.startButton.textContent="Stop",this.dom.startButton.disabled=!1,this.dom.statusElement.textContent="Running - Microphone active",this.displayUpdater.start()}catch(e){console.error("Failed to start oscilloscope:",e),this.dom.statusElement.textContent="Error: Could not access microphone",this.dom.startButton.disabled=!1,this.dom.loadFileButton.disabled=!1}}async handleFileInput(){var t;const e=(t=this.dom.fileInput.files)==null?void 0:t[0];if(e){this.oscilloscope.getIsRunning()&&(this.displayUpdater.stop(),await this.oscilloscope.stop());try{this.dom.startButton.disabled=!0,this.dom.loadFileButton.disabled=!0,this.dom.statusElement.textContent=`Loading file: ${e.name}...`,await this.oscilloscope.startFromFile(e),this.dom.startButton.textContent="Stop",this.dom.startButton.disabled=!1,this.dom.statusElement.textContent=`Playing: ${e.name} (loop)`,this.displayUpdater.start()}catch(i){console.error("Failed to load audio file:",i),this.dom.statusElement.textContent="Error: Could not load audio file",this.dom.startButton.textContent="Start",this.dom.startButton.disabled=!1,this.dom.loadFileButton.disabled=!1}this.dom.fileInput.value=""}}sliderValueToThreshold(e){const t=parseFloat(e);if(Number.isNaN(t))throw new Error(`Invalid slider value for noise gate threshold: "${e}"`);return{db:t,amplitude:G(t)}}formatThresholdDisplay(e,t){return`${e.toFixed(0)} dB (${t.toFixed(3)})`}}const M=new ue,B=new ce(M.canvas,M.previousWaveformCanvas,M.currentWaveformCanvas,M.similarityPlotCanvas,M.frameBufferCanvas,M.cycleSimilarity8divCanvas,M.cycleSimilarity4divCanvas,M.cycleSimilarity2divCanvas),O=new de(M.pianoKeyboardCanvas);O.render(0);const ye=new fe(B,O,M.frequencyValue,M.noteValue,M.gainValue,M.similarityValue),q=new me(B,M,ye);q.initializeUIState();q.setupEventHandlers();
//# sourceMappingURL=index-tnZSu6wN.js.map
