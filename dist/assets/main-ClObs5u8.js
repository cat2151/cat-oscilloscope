var $=Object.defineProperty;var K=(y,e,t)=>e in y?$(y,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):y[e]=t;var i=(y,e,t)=>K(y,typeof e!="symbol"?e+"":e,t);import"./modulepreload-polyfill-B5Qt9EMX.js";function B(y){return Math.pow(10,y/20)}function Y(y){return y<=0?-1/0:20*Math.log10(y)}function H(y){if(y<=0||!isFinite(y))return null;const t=440*Math.pow(2,-4.75),s=12*Math.log2(y/t),a=Math.round(s),o=Math.round((s-a)*100),r=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],n=Math.floor(a/12);return{noteName:`${r[(a%12+12)%12]}${n}`,cents:o}}const V=-48;function Z(y){const e=y.numberOfChannels,t=y.sampleRate,s=y.length,a=[];let o=0;for(let u=0;u<e;u++){const p=y.getChannelData(u);a.push(p);for(let c=0;c<s;c++){const m=Math.abs(p[c]);m>o&&(o=m)}}if(o===0)return y;const r=o*Math.pow(10,V/20);let n=s;for(let u=0;u<s;u++){let p=!0;for(let c=0;c<e;c++)if(Math.abs(a[c][u])>r){p=!1;break}if(!p){n=u;break}}if(n>=s)return y;let l=s-1;for(let u=s-1;u>=n;u--){let p=!0;for(let c=0;c<e;c++)if(Math.abs(a[c][u])>r){p=!1;break}if(!p){l=u;break}}if(n===0&&l===s-1)return y;const f=l-n+1,d=new AudioBuffer({numberOfChannels:e,length:f,sampleRate:t});for(let u=0;u<e;u++){const p=a[u],c=d.getChannelData(u);for(let m=0;m<f;m++)c[m]=p[n+m]}return d}class U{constructor(){i(this,"frameBufferHistory",[]);i(this,"MAX_FRAME_HISTORY",16);i(this,"extendedBufferCache",new Map)}updateHistory(e){let t;this.frameBufferHistory.length<this.MAX_FRAME_HISTORY?t=new Float32Array(e.length):(t=this.frameBufferHistory.shift(),t.length!==e.length&&(t=new Float32Array(e.length))),t.set(e),this.frameBufferHistory.push(t)}getExtendedBuffer(e,t){if(e===1)return t;if(!t||this.frameBufferHistory.length<e)return null;const s=this.frameBufferHistory.slice(-e),a=s.reduce((n,l)=>n+l.length,0);let o=this.extendedBufferCache.get(e);(!o||o.length!==a)&&(o=new Float32Array(a),this.extendedBufferCache.set(e,o));let r=0;for(const n of s)o.set(n,r),r+=n.length;return o}clear(){this.frameBufferHistory=[],this.extendedBufferCache.clear()}}class Q{constructor(){i(this,"audioContext",null);i(this,"analyser",null);i(this,"mediaStream",null);i(this,"audioBufferSource",null);i(this,"bufferSource",null);i(this,"dataArray",null);i(this,"frequencyData",null);i(this,"frameBufferHistory",new U)}initializeAnalyser(){if(!this.audioContext)throw new Error("AudioContext must be initialized before creating analyser");this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=4096,this.analyser.smoothingTimeConstant=0;const e=this.analyser.fftSize;this.dataArray=new Float32Array(e),this.frequencyData=new Uint8Array(this.analyser.frequencyBinCount)}async start(){try{this.mediaStream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.audioContext=new AudioContext;const e=this.audioContext.createMediaStreamSource(this.mediaStream);this.initializeAnalyser(),e.connect(this.analyser)}catch(e){throw console.error("Error accessing microphone:",e),e}}async startFromFile(e){try{const t=await e.arrayBuffer();this.audioContext&&this.audioContext.state!=="closed"&&await this.audioContext.close(),this.audioContext=new AudioContext;let s=await this.audioContext.decodeAudioData(t);s=Z(s),this.initializeAnalyser(),this.audioBufferSource=this.audioContext.createBufferSource(),this.audioBufferSource.buffer=s,this.audioBufferSource.loop=!0,this.audioBufferSource.connect(this.analyser),this.analyser.connect(this.audioContext.destination),this.audioBufferSource.start(0)}catch(t){throw console.error("Error loading audio file:",t),t}}async startFromBuffer(e){try{this.audioContext&&this.audioContext.state!=="closed"&&await this.audioContext.close(),this.audioContext=new AudioContext,e.reset(),e.setChunkSize(4096);const s=e.getSampleRate(),a=e.getLength(),o=this.audioContext.createBuffer(1,a,s),r=o.getChannelData(0);let n=0;for(;n<a;){const l=e.getNextChunk();if(!l)break;r.set(l,n),n+=l.length}this.initializeAnalyser(),this.audioBufferSource=this.audioContext.createBufferSource(),this.audioBufferSource.buffer=o,this.audioBufferSource.loop=!0,this.audioBufferSource.connect(this.analyser),this.audioBufferSource.start(0)}catch(t){throw console.error("Error starting from buffer:",t),t}}async stop(){if(this.audioBufferSource){try{this.audioBufferSource.stop()}catch{}try{this.audioBufferSource.disconnect()}catch{}this.audioBufferSource=null}if(this.mediaStream&&(this.mediaStream.getTracks().forEach(e=>e.stop()),this.mediaStream=null),this.audioContext){try{await this.audioContext.close()}catch(e){console.error("Error closing AudioContext:",e)}this.audioContext=null}this.analyser=null,this.dataArray=null,this.frequencyData=null,this.frameBufferHistory.clear()}getTimeDomainData(){return!this.analyser||!this.dataArray?null:(this.analyser.getFloatTimeDomainData(this.dataArray),this.frameBufferHistory.updateHistory(this.dataArray),this.dataArray)}getExtendedTimeDomainData(e){return this.frameBufferHistory.getExtendedBuffer(e,this.dataArray)}getFrequencyData(){return!this.analyser||!this.frequencyData?null:(this.analyser.getByteFrequencyData(this.frequencyData),this.frequencyData)}getSampleRate(){var e;return((e=this.audioContext)==null?void 0:e.sampleRate)||0}getFFTSize(){var e;return this.bufferSource?4096:((e=this.analyser)==null?void 0:e.fftSize)||0}getFrequencyBinCount(){var e;return this.bufferSource?2048:((e=this.analyser)==null?void 0:e.frequencyBinCount)||0}isReady(){return this.bufferSource?this.dataArray!==null:this.audioContext!==null&&this.analyser!==null}}class X{constructor(){i(this,"autoGainEnabled",!0);i(this,"currentGain",1);i(this,"noiseGateEnabled",!0);i(this,"noiseGateThreshold",B(-60))}setAutoGain(e){this.autoGainEnabled=e}getAutoGainEnabled(){return this.autoGainEnabled}setNoiseGate(e){this.noiseGateEnabled=e}getNoiseGateEnabled(){return this.noiseGateEnabled}setNoiseGateThreshold(e){this.noiseGateThreshold=Math.min(Math.max(e,0),1)}getNoiseGateThreshold(){return this.noiseGateThreshold}getCurrentGain(){return this.currentGain}}class j{constructor(){i(this,"frequencyEstimationMethod","fft");i(this,"estimatedFrequency",0);i(this,"MIN_FREQUENCY_HZ",20);i(this,"MAX_FREQUENCY_HZ",5e3);i(this,"bufferSizeMultiplier",16);i(this,"frequencyPlotHistory",[])}clearHistory(){this.frequencyPlotHistory=[],this.estimatedFrequency=0}setFrequencyEstimationMethod(e){this.frequencyEstimationMethod!==e&&(this.frequencyEstimationMethod=e,this.frequencyPlotHistory=[])}getFrequencyEstimationMethod(){return this.frequencyEstimationMethod}setBufferSizeMultiplier(e){this.bufferSizeMultiplier=e}getBufferSizeMultiplier(){return this.bufferSizeMultiplier}getEstimatedFrequency(){return this.estimatedFrequency}getMinFrequency(){return this.MIN_FREQUENCY_HZ}getMaxFrequency(){return this.MAX_FREQUENCY_HZ}getFrequencyPlotHistory(){return this.frequencyPlotHistory}}function k(y,e){if(typeof y=="string"&&y.endsWith("%")){const t=parseFloat(y);return isNaN(t)?(console.warn(`Invalid percentage value: ${y}, using 0`),0):t<0?(console.warn(`Negative percentage value: ${y}, clamping to 0`),0):Math.floor(e*(t/100))}if(typeof y=="string"){const t=parseInt(y,10);return isNaN(t)?(console.warn(`Invalid numeric string: ${y}, using 0`),0):Math.max(0,t)}return typeof y=="number"?isNaN(y)?(console.warn(`Invalid number value: ${y}, using 0`),0):Math.max(0,Math.floor(y)):0}const J={fftOverlay:{position:{x:10,y:"65%"},size:{width:"35%",height:"35%"}},harmonicAnalysis:{position:{x:10,y:10},size:{width:500,height:"auto"}},frequencyPlot:{position:{x:"right-10",y:10},size:{width:280,height:120}}};class D{constructor(e,t,s){i(this,"ctx");i(this,"canvasWidth");i(this,"canvasHeight");this.ctx=e,this.canvasWidth=t,this.canvasHeight=s}updateDimensions(e,t){this.canvasWidth=e,this.canvasHeight=t}calculateOverlayDimensions(e,t,s,a,o){if(!e)return{x:t,y:s,width:a,height:o};let r=t,n=s,l=a,f=o;if(e.position.x!==void 0)if(typeof e.position.x=="string"&&e.position.x.startsWith("right-")){const d=parseInt(e.position.x.substring(6),10),u=e.size.width!==void 0&&e.size.width!=="auto"?k(e.size.width,this.canvasWidth):a;r=this.canvasWidth-u-d}else r=k(e.position.x,this.canvasWidth);return e.position.y!==void 0&&(n=k(e.position.y,this.canvasHeight)),e.size.width!==void 0&&e.size.width!=="auto"&&(l=k(e.size.width,this.canvasWidth)),e.size.height!==void 0&&e.size.height!=="auto"&&(f=k(e.size.height,this.canvasHeight)),{x:r,y:n,width:l,height:f}}}class ee{constructor(e,t,s){i(this,"ctx");i(this,"canvasWidth");i(this,"canvasHeight");this.ctx=e,this.canvasWidth=t,this.canvasHeight=s}updateDimensions(e,t){this.canvasWidth=e,this.canvasHeight=t}drawGrid(e,t,s){this.ctx.strokeStyle="#222222",this.ctx.lineWidth=1,this.ctx.beginPath();const a=5;for(let r=0;r<=a;r++){const n=this.canvasHeight/a*r;this.ctx.moveTo(0,n),this.ctx.lineTo(this.canvasWidth,n)}const o=10;for(let r=0;r<=o;r++){const n=this.canvasWidth/o*r;this.ctx.moveTo(n,0),this.ctx.lineTo(n,this.canvasHeight)}this.ctx.stroke(),this.ctx.strokeStyle="#444444",this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.moveTo(0,this.canvasHeight/2),this.ctx.lineTo(this.canvasWidth,this.canvasHeight/2),this.ctx.stroke(),e&&e>0&&t&&t>0&&s!==void 0&&s>0&&this.drawGridLabels(e,t,s)}drawGridLabels(e,t,s){this.ctx.save(),this.ctx.font="11px monospace",this.ctx.fillStyle="#666666";const a=t/e*1e3,o=10,r=a/o;for(let d=0;d<=o;d++){const u=this.canvasWidth/o*d,p=r*d;let c;p>=1e3?c=`${(p/1e3).toFixed(2)}s`:p>=1?c=`${p.toFixed(1)}ms`:c=`${(p*1e3).toFixed(0)}μs`;const m=this.ctx.measureText(c).width,x=Math.max(2,Math.min(u-m/2,this.canvasWidth-m-2));this.ctx.fillText(c,x,this.canvasHeight-3)}const n=5,f=1/(n/2*s);for(let d=0;d<=n;d++){const u=this.canvasHeight/n*d,c=(n/2-d)*f;let m;if(c===0)m="0dB*";else{const x=Y(Math.abs(c)),h=c>0?"+":"-",C=Math.abs(x);C>=100?m=`${h}${C.toFixed(0)}dB`:m=`${h}${C.toFixed(1)}dB`}this.ctx.fillText(m,3,u+10)}this.ctx.restore()}}class te{constructor(e,t,s){i(this,"ctx");i(this,"canvasWidth");i(this,"canvasHeight");this.ctx=e,this.canvasWidth=t,this.canvasHeight=s}updateDimensions(e,t){this.canvasWidth=e,this.canvasHeight=t}drawWaveform(e,t,s,a){const o=s-t;if(o<=0)return;this.ctx.strokeStyle="#00ff00",this.ctx.lineWidth=2,this.ctx.beginPath();const r=this.canvasWidth/o,n=this.canvasHeight/2,f=this.canvasHeight/2*a;for(let d=0;d<o;d++){const u=t+d,p=e[u],c=n-p*f,m=Math.min(this.canvasHeight,Math.max(0,c)),x=d*r;d===0?this.ctx.moveTo(x,m):this.ctx.lineTo(x,m)}this.ctx.stroke()}}class ie extends D{constructor(){super(...arguments);i(this,"FFT_OVERLAY_HEIGHT_RATIO",.9);i(this,"FFT_MIN_BAR_WIDTH",1)}drawFFTOverlay(t,s,a,o,r,n){const l=a/o,f=Math.floor(this.canvasWidth*.35),d=Math.floor(this.canvasHeight*.35),u=10,p=this.canvasHeight-d-10,{x:c,y:m,width:x,height:h}=this.calculateOverlayDimensions(n,u,p,f,d);this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(c,m,x,h),this.ctx.strokeStyle="#00aaff",this.ctx.lineWidth=2,this.ctx.strokeRect(c,m,x,h);const C=Math.min(t.length,Math.ceil(r/l)),w=x/C;this.ctx.fillStyle="#00aaff";for(let v=0;v<C;v++){const E=t[v]/255*h*this.FFT_OVERLAY_HEIGHT_RATIO,M=c+v*w,b=m+h-E;this.ctx.fillRect(M,b,Math.max(w-1,this.FFT_MIN_BAR_WIDTH),E)}if(s>0&&s<=r){const v=s/l,T=c+v*w;this.ctx.strokeStyle="#ff00ff",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(T,m),this.ctx.lineTo(T,m+h),this.ctx.stroke(),this.ctx.fillStyle="#ff00ff",this.ctx.font="bold 12px Arial";const E=`${s.toFixed(1)} Hz`,M=this.ctx.measureText(E).width;let b=T+3;b+M>c+x-5&&(b=T-M-3),this.ctx.fillText(E,b,m+15)}this.ctx.restore()}}class se extends D{drawHarmonicAnalysis(e,t,s,a,o,r,n,l){if(e===void 0&&!t&&!s&&!r)return;const f=16,u=(1+(e!==void 0?1:0)+(t?1:0)+(s?1:0)+(r?2:0))*f+10,{x:p,y:c,width:m,height:x}=this.calculateOverlayDimensions(l,10,10,500,u);let h=c;if(this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillRect(p,c,m,x),this.ctx.strokeStyle="#ffaa00",this.ctx.lineWidth=2,this.ctx.strokeRect(p,c,m,x),this.ctx.fillStyle="#ffaa00",this.ctx.font="bold 12px monospace",h+=15,this.ctx.fillText("倍音分析 (Harmonic Analysis)",p+5,h),e!==void 0&&n){h+=f,this.ctx.fillStyle="#00ff00",this.ctx.font="11px monospace";const C=n/2;this.ctx.fillText(`1/2周波数 (${C.toFixed(1)}Hz) のpeak強度: ${e.toFixed(1)}%`,p+5,h)}if(t&&n){h+=f,this.ctx.fillStyle="#ff00ff",this.ctx.font="11px monospace";const C=t.map((v,T)=>`${T+1}x:${v.toFixed(2)}`).join(" "),w=a!==void 0?` (重み付け: ${a.toFixed(1)})`:"";this.ctx.fillText(`候補1 (${n.toFixed(1)}Hz) 倍音: ${C}${w}`,p+5,h)}if(s&&n){h+=f,this.ctx.fillStyle="#00aaff",this.ctx.font="11px monospace";const C=n/2,w=s.map((T,E)=>`${E+1}x:${T.toFixed(2)}`).join(" "),v=o!==void 0?` (重み付け: ${o.toFixed(1)})`:"";this.ctx.fillText(`候補2 (${C.toFixed(1)}Hz) 倍音: ${w}${v}`,p+5,h)}if(r){h+=f,this.ctx.fillStyle="#aaaaaa",this.ctx.font="10px monospace";const C=m-10,w=r.split(" ");let v="";for(const T of w){const E=v+(v?" ":"")+T;this.ctx.measureText(E).width>C&&v?(this.ctx.fillText(v,p+5,h),h+=f,v=T):v=E}v&&this.ctx.fillText(v,p+5,h)}this.ctx.restore()}}class ae extends D{constructor(){super(...arguments);i(this,"FREQ_PLOT_MIN_RANGE_PADDING_HZ",50);i(this,"FREQ_PLOT_RANGE_PADDING_RATIO",.1)}drawFrequencyPlot(t,s,a,o){if(!t||t.length===0)return;const{x:r,y:n,width:l,height:f}=this.calculateOverlayDimensions(o,this.canvasWidth-280-10,10,280,120);this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(r,n,l,f),this.ctx.strokeStyle="#ffaa00",this.ctx.lineWidth=2,this.ctx.strokeRect(r,n,l,f),this.ctx.fillStyle="#ffaa00",this.ctx.font="bold 12px Arial",this.ctx.fillText(`周波数推移 (${t.length}frame)`,r+5,n+15);const d=r+35,u=n+25,p=l-45,c=f-45,m=t.filter(g=>g>0);if(m.length===0){this.ctx.restore();return}const x=Math.min(...m),h=Math.max(...m),C=(h-x)*this.FREQ_PLOT_RANGE_PADDING_RATIO||this.FREQ_PLOT_MIN_RANGE_PADDING_HZ,w=Math.max(s,x-C),v=Math.min(a,h+C);this.ctx.strokeStyle="#333333",this.ctx.lineWidth=1,this.ctx.beginPath();for(let g=0;g<=4;g++){const S=u+c/4*g;this.ctx.moveTo(d,S),this.ctx.lineTo(d+p,S)}for(let g=0;g<=4;g++){const S=d+p/4*g;this.ctx.moveTo(S,u),this.ctx.lineTo(S,u+c)}this.ctx.stroke(),this.ctx.fillStyle="#aaaaaa",this.ctx.font="10px monospace",this.ctx.textAlign="right",this.ctx.textBaseline="middle";for(let g=0;g<=4;g++){const S=v-(v-w)*(g/4),F=u+c/4*g,A=S>=1e3?`${(S/1e3).toFixed(1)}k`:`${S.toFixed(0)}`;this.ctx.fillText(A,d-5,F)}this.ctx.fillStyle="#88ccff",this.ctx.font="9px monospace",this.ctx.textAlign="right",this.ctx.textBaseline="middle";for(let g=0;g<=4;g++){const S=v-(v-w)*(g/4),F=u+c/4*g,A=H(S);if(A){const G=A.cents>=0?"+":"";this.ctx.fillText(`${G}${A.cents}¢`,d+p-5,F)}}this.ctx.strokeStyle="#00ff00",this.ctx.lineWidth=2,this.ctx.beginPath();const T=p/Math.max(t.length-1,1),E=Math.max(1,Math.floor(t.length/4)),M=g=>{const F=(Math.max(w,Math.min(v,g))-w)/(v-w);return u+c-F*c};let b=!1;for(let g=0;g<t.length;g++){const S=t[g],F=d+g*T;if(S===0){b=!1;continue}const A=M(S);b?this.ctx.lineTo(F,A):(this.ctx.moveTo(F,A),b=!0)}this.ctx.stroke(),this.ctx.font="9px monospace",this.ctx.textAlign="center",this.ctx.textBaseline="top";for(let g=0;g<t.length;g++){const S=t[g],F=d+g*T;if(S!==0){const O=M(S);this.ctx.fillStyle="#00ff00",this.ctx.beginPath(),this.ctx.arc(F,O,2,0,Math.PI*2),this.ctx.fill()}const A=g===t.length-1;if(g%E===0||A){this.ctx.fillStyle="#aaaaaa";const O=g-t.length+1;this.ctx.fillText(`${O}`,F,u+c+2)}}const P=t[t.length-1];if(P>0){const g=H(P);this.ctx.fillStyle="#00ff00",this.ctx.font="bold 11px Arial",this.ctx.textAlign="left",this.ctx.textBaseline="bottom";let S=`${P.toFixed(1)} Hz`;if(g){const F=g.cents>=0?"+":"";S+=` (${g.noteName} ${F}${g.cents}¢)`}this.ctx.fillText(S,d+2,u+c-2)}this.ctx.restore()}}class ne{constructor(e,t,s,a=!0){i(this,"ctx");i(this,"canvasWidth");i(this,"canvasHeight");i(this,"debugOverlaysEnabled");this.ctx=e,this.canvasWidth=t,this.canvasHeight=s,this.debugOverlaysEnabled=a}updateDimensions(e,t){this.canvasWidth=e,this.canvasHeight=t}setDebugOverlaysEnabled(e){this.debugOverlaysEnabled=e}drawPhaseMarkers(e,t,s,a,o,r,n){if(o===void 0||r===void 0)return;const l=r-o;if(l<=0)return;this.ctx.save();const f=(d,u,p)=>{const c=d-o;if(c<0||c>=l)return;const m=c/l*this.canvasWidth;this.ctx.strokeStyle=u,this.ctx.lineWidth=p,this.ctx.beginPath(),this.ctx.moveTo(m,0),this.ctx.lineTo(m,this.canvasHeight),this.ctx.stroke()};if(s!==void 0&&f(s,"#ff8800",2),a!==void 0&&f(a,"#ff8800",2),e!==void 0&&(f(e,"#ff0000",2),this.debugOverlaysEnabled&&(n==null?void 0:n.phaseZeroSegmentRelative)!==void 0)){const u=(e-o)/l*this.canvasWidth,p=20;this.ctx.save(),this.ctx.fillStyle="#ff0000",this.ctx.font="12px monospace",this.ctx.textAlign="left";const c=n.phaseZeroSegmentRelative,m=n.phaseZeroHistory??"?",x=n.phaseZeroTolerance??"?";[`Mode: ${n.zeroCrossModeName??"Unknown"}`,`Seg Rel: ${c}`,`History: ${m}`,`Tolerance: ±${x}`,`Range: ${typeof m=="number"&&typeof x=="number"?`${m-x}~${m+x}`:"?"}`].forEach((w,v)=>{this.ctx.fillText(w,u+5,p+v*14)}),this.ctx.restore()}t!==void 0&&f(t,"#ff0000",2),this.ctx.restore()}}class oe{constructor(e,t){i(this,"canvas");i(this,"ctx");i(this,"fftDisplayEnabled",!0);i(this,"harmonicAnalysisEnabled",!1);i(this,"debugOverlaysEnabled",!0);i(this,"overlaysLayout");i(this,"gridRenderer");i(this,"waveformLineRenderer");i(this,"fftOverlayRenderer");i(this,"harmonicAnalysisRenderer");i(this,"frequencyPlotRenderer");i(this,"phaseMarkerRenderer");this.canvas=e;const s=e.getContext("2d");if(!s)throw new Error("Could not get 2D context");this.ctx=s,this.overlaysLayout=t||J,this.gridRenderer=new ee(this.ctx,e.width,e.height),this.waveformLineRenderer=new te(this.ctx,e.width,e.height),this.fftOverlayRenderer=new ie(this.ctx,e.width,e.height),this.harmonicAnalysisRenderer=new se(this.ctx,e.width,e.height),this.frequencyPlotRenderer=new ae(this.ctx,e.width,e.height),this.phaseMarkerRenderer=new ne(this.ctx,e.width,e.height,this.debugOverlaysEnabled),e.width===300&&e.height===150&&console.warn('Canvas element is using default dimensions (300x150). Set explicit width and height attributes on the canvas element to match desired resolution. Example: <canvas id="oscilloscope" width="1800" height="1000"></canvas>')}clearAndDrawGrid(e,t,s){this.updateRendererDimensions(),this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.gridRenderer.drawGrid(e,t,s)}updateRendererDimensions(){const e=this.canvas.width,t=this.canvas.height;this.gridRenderer.updateDimensions(e,t),this.waveformLineRenderer.updateDimensions(e,t),this.fftOverlayRenderer.updateDimensions(e,t),this.harmonicAnalysisRenderer.updateDimensions(e,t),this.frequencyPlotRenderer.updateDimensions(e,t),this.phaseMarkerRenderer.updateDimensions(e,t)}drawWaveform(e,t,s,a){this.updateRendererDimensions(),this.waveformLineRenderer.drawWaveform(e,t,s,a)}drawFFTOverlay(e,t,s,a,o){this.fftDisplayEnabled&&(this.updateRendererDimensions(),this.fftOverlayRenderer.drawFFTOverlay(e,t,s,a,o,this.overlaysLayout.fftOverlay))}drawHarmonicAnalysis(e,t,s,a,o,r,n){this.harmonicAnalysisEnabled&&this.debugOverlaysEnabled&&this.fftDisplayEnabled&&(this.updateRendererDimensions(),this.harmonicAnalysisRenderer.drawHarmonicAnalysis(e,t,s,a,o,r,n,this.overlaysLayout.harmonicAnalysis))}drawFrequencyPlot(e,t,s){this.debugOverlaysEnabled&&(this.updateRendererDimensions(),this.frequencyPlotRenderer.drawFrequencyPlot(e,t,s,this.overlaysLayout.frequencyPlot))}drawPhaseMarkers(e,t,s,a,o,r,n){this.updateRendererDimensions(),this.phaseMarkerRenderer.drawPhaseMarkers(e,t,s,a,o,r,n)}setFFTDisplay(e){this.fftDisplayEnabled=e}getFFTDisplayEnabled(){return this.fftDisplayEnabled}setHarmonicAnalysisEnabled(e){this.harmonicAnalysisEnabled=e}getHarmonicAnalysisEnabled(){return this.harmonicAnalysisEnabled}setDebugOverlaysEnabled(e){this.debugOverlaysEnabled=e,this.phaseMarkerRenderer.setDebugOverlaysEnabled(e)}getDebugOverlaysEnabled(){return this.debugOverlaysEnabled}setOverlaysLayout(e){this.overlaysLayout={...this.overlaysLayout,...e}}getOverlaysLayout(){return this.overlaysLayout}}class re{constructor(){i(this,"usePeakMode",!1);i(this,"zeroCrossMode","hysteresis")}setUsePeakMode(e){this.usePeakMode=e}getUsePeakMode(){return this.usePeakMode}setZeroCrossMode(e){this.zeroCrossMode=e}getZeroCrossMode(){return this.zeroCrossMode}reset(){}}class le{constructor(){i(this,"previousWaveform",null);i(this,"lastSimilarity",0)}getLastSimilarity(){return this.lastSimilarity}reset(){this.previousWaveform=null,this.lastSimilarity=0}hasPreviousWaveform(){return this.previousWaveform!==null}getPreviousWaveform(){return this.previousWaveform}}class he{constructor(){i(this,"TARGET_FILL_RATIO",.9);i(this,"MIN_PEAK_THRESHOLD",.001);i(this,"DEFAULT_AMPLITUDE_RATIO",.4)}findPeakAmplitude(e,t,s){let a=0;const o=Math.max(0,t),r=Math.min(e.length,s);for(let n=o;n<r;n++){const l=Math.abs(e[n]);l>a&&(a=l)}return a}drawWaveform(e,t,s,a,o,r,n){const l=r-o;if(l<=0)return;const f=this.findPeakAmplitude(a,o,r);e.strokeStyle=n,e.lineWidth=1.5,e.beginPath();const d=t/l,u=s/2;let p;if(f>this.MIN_PEAK_THRESHOLD){const c=this.TARGET_FILL_RATIO/f;p=s/2*c}else p=s*this.DEFAULT_AMPLITUDE_RATIO;for(let c=0;c<l;c++){const m=o+c;if(m>=a.length)break;const x=a[m],h=u-x*p,C=Math.min(s,Math.max(0,h)),w=c*d;c===0?e.moveTo(w,C):e.lineTo(w,C)}e.stroke()}drawCenterLine(e,t,s){e.strokeStyle="#444444",e.lineWidth=1,e.beginPath(),e.moveTo(0,s/2),e.lineTo(t,s/2),e.stroke()}clearCanvas(e,t,s){e.fillStyle="#000000",e.fillRect(0,0,t,s)}}class ce{drawSimilarityPlot(e,t,s,a){if(!a||a.length===0)return;e.save(),e.fillStyle="#000000",e.fillRect(0,0,t,s),e.strokeStyle="#00aaff",e.lineWidth=2,e.strokeRect(0,0,t,s),e.fillStyle="#00aaff",e.font="bold 12px Arial",e.fillText("類似度推移 (Similarity)",5,15);const o=40,r=25,n=t-50,l=s-35,f=-1,d=1;e.strokeStyle="#333333",e.lineWidth=1,e.beginPath();for(let c=0;c<=4;c++){const m=r+l/4*c;e.moveTo(o,m),e.lineTo(o+n,m)}for(let c=0;c<=4;c++){const m=o+n/4*c;e.moveTo(m,r),e.lineTo(m,r+l)}e.stroke(),e.fillStyle="#aaaaaa",e.font="10px monospace",e.textAlign="right",e.textBaseline="middle";for(let c=0;c<=4;c++){const m=d-(d-f)*(c/4),x=r+l/4*c,h=m.toFixed(2);e.fillText(h,o-5,x)}e.strokeStyle="#00aaff",e.lineWidth=2,e.beginPath();const u=n/Math.max(a.length-1,1);for(let c=0;c<a.length;c++){const m=a[c],x=o+c*u,C=(Math.max(f,Math.min(d,m))-f)/(d-f),w=r+l-C*l;c===0?e.moveTo(x,w):e.lineTo(x,w)}e.stroke();const p=a[a.length-1];e.fillStyle="#00aaff",e.font="bold 11px Arial",e.textAlign="left",e.textBaseline="bottom",e.fillText(`${p.toFixed(3)}`,o+2,r+l-2),e.restore()}drawSimilarityText(e,t,s){e.fillStyle="#00aaff",e.font="bold 14px Arial";const a=`Similarity: ${s.toFixed(3)}`,o=e.measureText(a).width,r=(t-o)/2;e.fillText(a,r,20)}}class de{drawPositionMarkers(e,t,s,a,o,r){if(r<=0)return;const n=a/r*t,l=o/r*t;e.strokeStyle="#ff0000",e.lineWidth=2,e.beginPath(),e.moveTo(n,0),e.lineTo(n,s),e.stroke(),e.beginPath(),e.moveTo(l,0),e.lineTo(l,s),e.stroke(),e.fillStyle="#ff0000",e.font="10px Arial",e.fillText("S",n+2,12),e.fillText("E",l+2,12)}}class fe{drawOffsetOverlayGraphs(e,t,s,a=[],o=[]){if(a.length===0&&o.length===0)return;e.save();const r=Math.min(120,t*.4),n=Math.min(60,s*.4),l=t-r-5,f=5;e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(l,f,r,n),e.strokeStyle="#00aaff",e.lineWidth=1,e.strokeRect(l,f,r,n),e.fillStyle="#00aaff",e.font="9px Arial",e.fillText("Offset %",l+2,f+9);const d=2,u=l+d,p=f+12,c=r-d*2,m=n-12-d,x=0,h=100,C=(w,v)=>{if(w.length<2)return;e.strokeStyle=v,e.lineWidth=1.5,e.beginPath();const T=c/Math.max(w.length-1,1);for(let E=0;E<w.length;E++){const M=w[E],b=u+E*T,g=(Math.max(x,Math.min(h,M))-x)/(h-x),S=p+m-g*m;E===0?e.moveTo(b,S):e.lineTo(b,S)}e.stroke()};if(C(a,"#ff0000"),C(o,"#ff8800"),e.font="8px monospace",e.textAlign="left",a.length>0){const w=a[a.length-1];e.fillStyle="#ff0000",e.fillText(`S:${w.toFixed(1)}%`,l+2,f+n-11)}if(o.length>0){const w=o[o.length-1];e.fillStyle="#ff8800",e.fillText(`E:${w.toFixed(1)}%`,l+2,f+n-2)}e.restore()}}class ue{constructor(e,t,s,a){i(this,"previousCanvas");i(this,"currentCanvas");i(this,"similarityCanvas");i(this,"bufferCanvas");i(this,"previousCtx");i(this,"currentCtx");i(this,"similarityCtx");i(this,"bufferCtx");i(this,"waveformRenderer");i(this,"similarityPlotRenderer");i(this,"positionMarkerRenderer");i(this,"offsetOverlayRenderer");this.previousCanvas=e,this.currentCanvas=t,this.similarityCanvas=s,this.bufferCanvas=a;const o=e.getContext("2d"),r=t.getContext("2d"),n=s.getContext("2d"),l=a.getContext("2d");if(!o||!r||!n||!l)throw new Error("Could not get 2D context for comparison canvases");this.previousCtx=o,this.currentCtx=r,this.similarityCtx=n,this.bufferCtx=l,this.waveformRenderer=new he,this.similarityPlotRenderer=new ce,this.positionMarkerRenderer=new de,this.offsetOverlayRenderer=new fe,this.clearAllCanvases()}clearAllCanvases(){this.waveformRenderer.clearCanvas(this.previousCtx,this.previousCanvas.width,this.previousCanvas.height),this.waveformRenderer.clearCanvas(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height),this.waveformRenderer.clearCanvas(this.similarityCtx,this.similarityCanvas.width,this.similarityCanvas.height),this.waveformRenderer.clearCanvas(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height)}updatePanels(e,t,s,a,o,r,n=[],l=[],f=[]){this.clearAllCanvases(),e&&(this.waveformRenderer.drawCenterLine(this.previousCtx,this.previousCanvas.width,this.previousCanvas.height),this.waveformRenderer.drawWaveform(this.previousCtx,this.previousCanvas.width,this.previousCanvas.height,e,0,e.length,"#ffaa00")),this.waveformRenderer.drawCenterLine(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height),a-s>0&&this.waveformRenderer.drawWaveform(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height,t,s,a,"#00ff00"),e&&this.similarityPlotRenderer.drawSimilarityText(this.currentCtx,this.currentCanvas.width,r),this.offsetOverlayRenderer.drawOffsetOverlayGraphs(this.currentCtx,this.currentCanvas.width,this.currentCanvas.height,l,f),n.length>0&&this.similarityPlotRenderer.drawSimilarityPlot(this.similarityCtx,this.similarityCanvas.width,this.similarityCanvas.height,n),this.waveformRenderer.drawCenterLine(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height),this.waveformRenderer.drawWaveform(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height,o,0,o.length,"#888888"),this.positionMarkerRenderer.drawPositionMarkers(this.bufferCtx,this.bufferCanvas.width,this.bufferCanvas.height,s,a,o.length)}clear(){this.clearAllCanvases()}}const I=class I{constructor(e,t,s){i(this,"canvas8div");i(this,"canvas4div");i(this,"canvas2div");i(this,"ctx8div");i(this,"ctx4div");i(this,"ctx2div");i(this,"history8div",[]);i(this,"history4div",[]);i(this,"history2div",[]);this.canvas8div=e,this.canvas4div=t,this.canvas2div=s;const a=e.getContext("2d"),o=t.getContext("2d"),r=s.getContext("2d");if(!a||!o||!r)throw new Error("Could not get 2D context for cycle similarity canvases");this.ctx8div=a,this.ctx4div=o,this.ctx2div=r,this.clearAllCanvases()}clearAllCanvases(){this.clearCanvas(this.ctx8div,this.canvas8div.width,this.canvas8div.height),this.clearCanvas(this.ctx4div,this.canvas4div.width,this.canvas4div.height),this.clearCanvas(this.ctx2div,this.canvas2div.width,this.canvas2div.height)}clearCanvas(e,t,s){e.fillStyle="#000000",e.fillRect(0,0,t,s)}drawSimilarityGraph(e,t,s,a,o,r){if(e.save(),e.fillStyle="#000000",e.fillRect(0,0,t,s),e.strokeStyle="#ff8800",e.lineWidth=2,e.strokeRect(0,0,t,s),e.fillStyle="#ff8800",e.font="bold 12px Arial",e.fillText(o,5,15),!a||a.length===0||!a[0]||a[0].length===0){e.fillStyle="#666666",e.font="11px Arial",e.fillText("データなし (No data)",t/2-50,s/2),e.restore();return}const n=35,l=25,f=t-45,d=s-35,u=-1,p=1;e.strokeStyle="#333333",e.lineWidth=1,e.beginPath();for(let h=0;h<=4;h++){const C=l+d/4*h;e.moveTo(n,C),e.lineTo(n+f,C)}for(let h=0;h<=4;h++){const C=n+f/4*h;e.moveTo(C,l),e.lineTo(C,l+d)}e.stroke(),e.fillStyle="#aaaaaa",e.font="10px monospace",e.textAlign="right",e.textBaseline="middle";for(let h=0;h<=4;h++){const C=p-(p-u)*(h/4),w=l+d/4*h,v=C.toFixed(1);e.fillText(v,n-5,w)}const c=l+d-(0-u)/(p-u)*d;e.strokeStyle="#666666",e.lineWidth=1,e.beginPath(),e.moveTo(n,c),e.lineTo(n+f,c),e.stroke();const m=a[0].length;for(let h=0;h<m;h++){const C=I.SEGMENT_COLORS[h%I.SEGMENT_COLORS.length];e.strokeStyle=C,e.lineWidth=2,e.beginPath();const w=a.length>1?f/(a.length-1):0;let v=!1;for(let T=0;T<a.length;T++){const E=a[T];if(E&&E.length>h){const M=E[h],b=n+T*w,g=(Math.max(u,Math.min(p,M))-u)/(p-u),S=l+d-g*d;v?e.lineTo(b,S):(e.moveTo(b,S),v=!0)}}e.stroke()}const x=a[a.length-1];if(x&&x.length>0){const C=x.length*11+4,w=65,v=n+f-w-2,T=l+2;e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(v,T,w,C),e.strokeStyle="#555555",e.lineWidth=1,e.strokeRect(v,T,w,C),e.font="9px Arial",e.textAlign="left",e.textBaseline="top";for(let E=0;E<x.length;E++){const M=I.SEGMENT_COLORS[E%I.SEGMENT_COLORS.length],b=x[E],P=T+2+E*11;e.fillStyle=M,e.fillRect(v+2,P,8,8),e.fillStyle="#ffffff",e.fillText(`${E+1}-${E+2}: ${b.toFixed(2)}`,v+12,P)}}e.fillStyle="#aaaaaa",e.font="10px Arial",e.textAlign="center",e.fillText(r,n+f/2,s-3),e.restore()}updateGraphs(e,t,s){e&&e.length>0&&(this.history8div.push(e),this.history8div.length>I.HISTORY_SIZE&&this.history8div.shift()),t&&t.length>0&&(this.history4div.push(t),this.history4div.length>I.HISTORY_SIZE&&this.history4div.shift()),s&&s.length>0&&(this.history2div.push(s),this.history2div.length>I.HISTORY_SIZE&&this.history2div.shift()),this.drawSimilarityGraph(this.ctx8div,this.canvas8div.width,this.canvas8div.height,this.history8div,"8分割 (1/2周期)","連続する1/2周期間の類似度"),this.drawSimilarityGraph(this.ctx4div,this.canvas4div.width,this.canvas4div.height,this.history4div,"4分割 (1周期)","連続する1周期間の類似度"),this.drawSimilarityGraph(this.ctx2div,this.canvas2div.width,this.canvas2div.height,this.history2div,"2分割 (2周期)","連続する2周期間の類似度")}clear(){this.history8div=[],this.history4div=[],this.history2div=[],this.clearAllCanvases()}};i(I,"HISTORY_SIZE",100),i(I,"SEGMENT_COLORS",["#00ff00","#88ff00","#ffaa00","#ff6600","#ff0000","#ff00ff","#00ffff"]);let W=I;const _=class _{constructor(){i(this,"cachedBasePath",null)}getBasePath(){var t;if(this.cachedBasePath!==null)return this.cachedBasePath;let e=(t=document.querySelector("base"))==null?void 0:t.getAttribute("href");if(e)try{e=new URL(e,window.location.href).pathname}catch{}if(e||(e=this.getBasePathFromScripts()),!e&&window.location.pathname&&window.location.pathname!=="/"){const a=window.location.pathname.split("/").filter(o=>o.length>0);a.length>0&&(e=`/${a[0]}/`)}return e||(e="/"),e.endsWith("/")||(e+="/"),this.cachedBasePath=e,e}getBasePathFromScripts(){const e=document.querySelectorAll("script[src]");for(const t of e){const s=t.getAttribute("src");if(s)try{const o=new URL(s,window.location.href).pathname;for(const r of _.ASSET_PATTERNS){const n=o.indexOf(r);if(n>=0)return n===0?"/":o.substring(0,n)+"/"}}catch(a){(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&console.debug("Failed to parse script URL:",s,a);continue}}return""}};i(_,"ASSET_PATTERNS",["/assets/","/js/","/dist/"]);let L=_;class me{constructor(){i(this,"wasmProcessor",null);i(this,"isInitialized",!1);i(this,"LOAD_TIMEOUT_MS",1e4)}async loadWasmModule(e){if(!(this.isInitialized&&this.wasmProcessor)){if(typeof window>"u"||window.location.protocol==="file:")throw new Error("WASM module not available in test/non-browser environment");return new Promise((t,s)=>{if(window.wasmProcessor&&window.wasmProcessor.WasmDataProcessor){this.wasmProcessor=new window.wasmProcessor.WasmDataProcessor,this.isInitialized=!0,t();return}const a=setTimeout(()=>{n(),s(new Error(`WASM module loading timed out after ${this.LOAD_TIMEOUT_MS/1e3} seconds`))},this.LOAD_TIMEOUT_MS),o=`${e}wasm/signal_processor_wasm.js`,r=document.createElement("script");r.type="module",r.textContent=`
        import init, { WasmDataProcessor } from '${o}';
        await init();
        window.wasmProcessor = { WasmDataProcessor };
        window.dispatchEvent(new Event('wasmLoaded'));
      `;const n=()=>{clearTimeout(a),window.removeEventListener("wasmLoaded",l)},l=()=>{n(),window.wasmProcessor&&window.wasmProcessor.WasmDataProcessor?(this.wasmProcessor=new window.wasmProcessor.WasmDataProcessor,this.isInitialized=!0,t()):s(new Error("WASM module loaded but WasmDataProcessor not found"))};window.addEventListener("wasmLoaded",l),r.onerror=()=>{n(),s(new Error("Failed to load WASM module script"))},document.head.appendChild(r)})}}getProcessor(){return this.wasmProcessor}isReady(){return this.isInitialized&&this.wasmProcessor!==null}}class ye{constructor(e,t,s,a,o){i(this,"audioManager");i(this,"gainController");i(this,"frequencyEstimator");i(this,"waveformSearcher");i(this,"zeroCrossDetector");i(this,"basePathResolver");i(this,"wasmLoader");i(this,"phaseZeroOffsetHistory",[]);i(this,"phaseTwoPiOffsetHistory",[]);i(this,"MAX_OFFSET_HISTORY",100);i(this,"previousPhaseZeroIndex");i(this,"previousPhaseTwoPiIndex");i(this,"prevPhaseZeroPercent");i(this,"prevPhaseTwoPiPercent");i(this,"prevPhaseMinusQuarterPiPercent");i(this,"prevPhaseTwoPiPlusQuarterPiPercent");i(this,"enableDetailedTimingLogs",!1);i(this,"TIMING_LOG_THRESHOLD_MS",16.67);this.audioManager=e,this.gainController=t,this.frequencyEstimator=s,this.waveformSearcher=a,this.zeroCrossDetector=o,this.basePathResolver=new L,this.wasmLoader=new me}async initialize(){if(!this.wasmLoader.isReady())try{const e=this.basePathResolver.getBasePath();await this.wasmLoader.loadWasmModule(e),this.syncConfigToWasm()}catch(e){throw console.error("Failed to initialize WASM module:",e),e}}syncConfigToWasm(){const e=this.wasmLoader.getProcessor();e&&(e.setAutoGain(this.gainController.getAutoGainEnabled()),e.setNoiseGate(this.gainController.getNoiseGateEnabled()),e.setNoiseGateThreshold(this.gainController.getNoiseGateThreshold()),e.setFrequencyEstimationMethod(this.frequencyEstimator.getFrequencyEstimationMethod()),e.setBufferSizeMultiplier(this.frequencyEstimator.getBufferSizeMultiplier()),e.setZeroCrossMode(this.zeroCrossDetector.getZeroCrossMode()))}syncResultsFromWasm(e){this.frequencyEstimator.estimatedFrequency=e.estimatedFrequency,this.gainController.currentGain=e.gain,e.previousWaveform&&(this.waveformSearcher.previousWaveform=e.previousWaveform),this.waveformSearcher.lastSimilarity=e.similarity}processFrame(e,t){const s=performance.now(),a=this.wasmLoader.getProcessor();if(!this.wasmLoader.isReady()||!a)return console.warn("WASM processor not initialized"),null;if(!this.audioManager.isReady())return null;const o=performance.now(),r=this.audioManager.getTimeDomainData();if(!r)return null;const n=performance.now(),l=this.audioManager.getSampleRate(),f=this.audioManager.getFFTSize(),d=performance.now(),u=this.frequencyEstimator.getFrequencyEstimationMethod()==="fft"||e;let p=u?this.audioManager.getFrequencyData():null;const c=performance.now();if(u&&!p&&r){const P=a.computeFrequencyData(r,f);P&&(p=new Uint8Array(P))}const m=performance.now();this.syncConfigToWasm();const x=performance.now(),h=a.processFrame(r,p,l,f,e),C=performance.now();if(!h)return null;const w=performance.now(),v={waveformData:new Float32Array(h.waveform_data),displayStartIndex:h.displayStartIndex,displayEndIndex:h.displayEndIndex,gain:h.gain,estimatedFrequency:h.estimatedFrequency,frequencyPlotHistory:h.frequencyPlotHistory?Array.from(h.frequencyPlotHistory):[],sampleRate:h.sampleRate,fftSize:h.fftSize,frequencyData:h.frequencyData?new Uint8Array(h.frequencyData):void 0,isSignalAboveNoiseGate:h.isSignalAboveNoiseGate,maxFrequency:h.maxFrequency,previousWaveform:h.previousWaveform?new Float32Array(h.previousWaveform):null,similarity:h.similarity,similarityPlotHistory:h.similarityPlotHistory?Array.from(h.similarityPlotHistory):[],usedSimilaritySearch:h.usedSimilaritySearch,phaseZeroIndex:h.phaseZeroIndex,phaseTwoPiIndex:h.phaseTwoPiIndex,phaseMinusQuarterPiIndex:h.phaseMinusQuarterPiIndex,phaseTwoPiPlusQuarterPiIndex:h.phaseTwoPiPlusQuarterPiIndex,halfFreqPeakStrengthPercent:h.halfFreqPeakStrengthPercent,candidate1Harmonics:h.candidate1Harmonics?Array.from(h.candidate1Harmonics):void 0,candidate2Harmonics:h.candidate2Harmonics?Array.from(h.candidate2Harmonics):void 0,selectionReason:h.selectionReason,cycleSimilarities8div:h.cycleSimilarities8div?Array.from(h.cycleSimilarities8div):void 0,cycleSimilarities4div:h.cycleSimilarities4div?Array.from(h.cycleSimilarities4div):void 0,cycleSimilarities2div:h.cycleSimilarities2div?Array.from(h.cycleSimilarities2div):void 0},T=performance.now();this.clampPhaseMarkers(v),this.updatePhaseOffsetHistory(v),v.phaseZeroOffsetHistory=[...this.phaseZeroOffsetHistory],v.phaseTwoPiOffsetHistory=[...this.phaseTwoPiOffsetHistory],this.syncResultsFromWasm(v);const E=performance.now(),M=t!==void 0?t:this.enableDetailedTimingLogs,b=E-s;if(M||b>this.TIMING_LOG_THRESHOLD_MS){const P={init:(o-s).toFixed(2),getTimeDomain:(n-o).toFixed(2),getMetadata:(d-n).toFixed(2),getFreqData:(c-d).toFixed(2),computeFFT:(m-c).toFixed(2),syncConfig:(x-m).toFixed(2),wasmProcess:(C-x).toFixed(2),convertResult:(T-w).toFixed(2),postProcess:(E-T).toFixed(2),total:b.toFixed(2)};console.log(`[WaveformDataProcessor] init:${P.init}ms | getTimeDomain:${P.getTimeDomain}ms | getMeta:${P.getMetadata}ms | getFreq:${P.getFreqData}ms | computeFFT:${P.computeFFT}ms | syncCfg:${P.syncConfig}ms | WASM:${P.wasmProcess}ms | convert:${P.convertResult}ms | post:${P.postProcess}ms | total:${P.total}ms`)}return v}setDetailedTimingLogs(e){this.enableDetailedTimingLogs=e}clampPhaseMarkers(e){if(e.displayStartIndex===void 0||e.displayEndIndex===void 0)return;const t=e.displayEndIndex-e.displayStartIndex;if(t<=0)return;const s=1,a=(f,d)=>{if(f===void 0)return{index:void 0,percent:void 0};const u=(f-e.displayStartIndex)/t*100;if(d===void 0)return{index:f,percent:u};const p=u-d;if(Math.abs(p)<=s)return{index:f,percent:u};const c=d+Math.sign(p)*s;return{index:Math.round(e.displayStartIndex+c/100*t),percent:c}},o=a(e.phaseZeroIndex,this.prevPhaseZeroPercent);e.phaseZeroIndex=o.index,this.prevPhaseZeroPercent=o.percent;const r=a(e.phaseTwoPiIndex,this.prevPhaseTwoPiPercent);e.phaseTwoPiIndex=r.index,this.prevPhaseTwoPiPercent=r.percent;const n=a(e.phaseMinusQuarterPiIndex,this.prevPhaseMinusQuarterPiPercent);e.phaseMinusQuarterPiIndex=n.index,this.prevPhaseMinusQuarterPiPercent=n.percent;const l=a(e.phaseTwoPiPlusQuarterPiIndex,this.prevPhaseTwoPiPlusQuarterPiPercent);e.phaseTwoPiPlusQuarterPiIndex=l.index,this.prevPhaseTwoPiPlusQuarterPiPercent=l.percent}updatePhaseOffsetHistory(e){if(e.displayStartIndex===void 0||e.displayEndIndex===void 0)return;const t=e.displayEndIndex-e.displayStartIndex;if(t<=0)return;let s=!1;const a={frame:Date.now(),fourCycleWindow:{lengthSamples:t}};if(e.phaseZeroIndex!==void 0){const r=(e.phaseZeroIndex-e.displayStartIndex)/t*100;if(a.phaseZero={startOffsetPercent:r},this.previousPhaseZeroIndex!==void 0){const n=this.phaseZeroOffsetHistory[this.phaseZeroOffsetHistory.length-1];if(n!==void 0){const l=Math.abs(r-n);a.phaseZero.offsetChange=l,a.phaseZero.previousOffsetPercent=n,l>1&&(s=!0,a.phaseZero.SPEC_VIOLATION=!0)}}this.phaseZeroOffsetHistory.push(r),this.phaseZeroOffsetHistory.length>this.MAX_OFFSET_HISTORY&&this.phaseZeroOffsetHistory.shift(),this.previousPhaseZeroIndex=e.phaseZeroIndex}if(e.phaseTwoPiIndex!==void 0){const r=(e.phaseTwoPiIndex-e.displayStartIndex)/t*100;if(a.phaseTwoPi={endOffsetPercent:r},this.previousPhaseTwoPiIndex!==void 0){const n=this.phaseTwoPiOffsetHistory[this.phaseTwoPiOffsetHistory.length-1];if(n!==void 0){const l=Math.abs(r-n);a.phaseTwoPi.offsetChange=l,a.phaseTwoPi.previousOffsetPercent=n,l>1&&(s=!0,a.phaseTwoPi.SPEC_VIOLATION=!0)}}this.phaseTwoPiOffsetHistory.push(r),this.phaseTwoPiOffsetHistory.length>this.MAX_OFFSET_HISTORY&&this.phaseTwoPiOffsetHistory.shift(),this.previousPhaseTwoPiIndex=e.phaseTwoPiIndex}s&&(console.warn("[1% Spec Violation Detected - Issue #254]",a),console.warn("→ Offset within 4-cycle window moved by more than 1% in one frame"))}reset(){const e=this.wasmLoader.getProcessor();e&&e.reset(),this.phaseZeroOffsetHistory=[],this.phaseTwoPiOffsetHistory=[],this.previousPhaseZeroIndex=void 0,this.previousPhaseTwoPiIndex=void 0,this.prevPhaseZeroPercent=void 0,this.prevPhaseTwoPiPercent=void 0,this.prevPhaseMinusQuarterPiPercent=void 0,this.prevPhaseTwoPiPlusQuarterPiPercent=void 0}}class pe{constructor(e,t,s,a,o,r,n,l,f){i(this,"audioManager");i(this,"gainController");i(this,"frequencyEstimator");i(this,"renderer");i(this,"zeroCrossDetector");i(this,"waveformSearcher");i(this,"comparisonRenderer");i(this,"cycleSimilarityRenderer",null);i(this,"dataProcessor");i(this,"animationId",null);i(this,"isRunning",!1);i(this,"isPaused",!1);i(this,"phaseMarkerRangeEnabled",!0);i(this,"lastFrameTime",0);i(this,"frameProcessingTimes",[]);i(this,"MAX_FRAME_TIMES",100);i(this,"TARGET_FRAME_TIME",16.67);i(this,"FPS_LOG_INTERVAL_FRAMES",60);i(this,"enableDetailedTimingLogs",!1);this.audioManager=new Q,this.gainController=new X,this.frequencyEstimator=new j,this.renderer=new oe(e,f),this.zeroCrossDetector=new re,this.waveformSearcher=new le,this.comparisonRenderer=new ue(t,s,a,o),r&&n&&l&&(this.cycleSimilarityRenderer=new W(r,n,l)),this.dataProcessor=new ye(this.audioManager,this.gainController,this.frequencyEstimator,this.waveformSearcher,this.zeroCrossDetector)}async start(){try{await this.dataProcessor.initialize(),await this.audioManager.start(),this.isRunning=!0,this.render()}catch(e){throw console.error("Error starting oscilloscope:",e),e}}async startFromFile(e){try{await this.dataProcessor.initialize(),await this.audioManager.startFromFile(e),this.isRunning=!0,this.render()}catch(t){throw console.error("Error loading audio file:",t),t}}async startFromBuffer(e){try{await this.dataProcessor.initialize(),await this.audioManager.startFromBuffer(e),this.isRunning=!0,this.render()}catch(t){throw console.error("Error starting from buffer:",t),t}}async stop(){this.isRunning=!1,this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null),await this.audioManager.stop(),this.frequencyEstimator.clearHistory(),this.zeroCrossDetector.reset(),this.waveformSearcher.reset(),this.comparisonRenderer.clear(),this.cycleSimilarityRenderer&&this.cycleSimilarityRenderer.clear(),this.dataProcessor.reset()}render(){if(!this.isRunning)return;const e=performance.now();if(!this.isPaused){const a=performance.now(),o=this.dataProcessor.processFrame(this.renderer.getFFTDisplayEnabled(),this.enableDetailedTimingLogs),r=performance.now();if(o){this.renderFrame(o);const n=performance.now(),l=r-a,f=n-r,d=n-a;(this.enableDetailedTimingLogs||d>this.TARGET_FRAME_TIME)&&console.log(`[Frame Timing] Total: ${d.toFixed(2)}ms | Data Processing: ${l.toFixed(2)}ms | Rendering: ${f.toFixed(2)}ms`)}}const s=performance.now()-e;if(this.frameProcessingTimes.push(s),this.frameProcessingTimes.length>this.MAX_FRAME_TIMES&&this.frameProcessingTimes.shift(),s>this.TARGET_FRAME_TIME&&console.warn(`Frame processing time: ${s.toFixed(2)}ms (target: <${this.TARGET_FRAME_TIME}ms)`),this.lastFrameTime>0){const o=1e3/(e-this.lastFrameTime);if(this.frameProcessingTimes.length===this.FPS_LOG_INTERVAL_FRAMES){const r=this.frameProcessingTimes.reduce((n,l)=>n+l,0)/this.frameProcessingTimes.length;console.log(`FPS: ${o.toFixed(1)}, Avg frame time: ${r.toFixed(2)}ms`)}}this.lastFrameTime=e,this.animationId=requestAnimationFrame(()=>this.render())}renderFrame(e){let t=e.displayStartIndex,s=e.displayEndIndex;this.phaseMarkerRangeEnabled&&e.phaseMinusQuarterPiIndex!==void 0&&e.phaseTwoPiPlusQuarterPiIndex!==void 0&&e.phaseMinusQuarterPiIndex<=e.phaseTwoPiPlusQuarterPiIndex&&(t=e.phaseMinusQuarterPiIndex,s=e.phaseTwoPiPlusQuarterPiIndex);const a=s-t;this.renderer.clearAndDrawGrid(e.sampleRate,a,e.gain),this.renderer.drawWaveform(e.waveformData,t,s,e.gain),this.renderer.drawPhaseMarkers(e.phaseZeroIndex,e.phaseTwoPiIndex,e.phaseMinusQuarterPiIndex,e.phaseTwoPiPlusQuarterPiIndex,t,s,{phaseZeroSegmentRelative:e.phaseZeroSegmentRelative,phaseZeroHistory:e.phaseZeroHistory,phaseZeroTolerance:e.phaseZeroTolerance,zeroCrossModeName:e.zeroCrossModeName}),e.frequencyData&&this.renderer.getFFTDisplayEnabled()&&e.isSignalAboveNoiseGate&&(this.renderer.drawFFTOverlay(e.frequencyData,e.estimatedFrequency,e.sampleRate,e.fftSize,e.maxFrequency),this.renderer.drawHarmonicAnalysis(e.halfFreqPeakStrengthPercent,e.candidate1Harmonics,e.candidate2Harmonics,e.candidate1WeightedScore,e.candidate2WeightedScore,e.selectionReason,e.estimatedFrequency)),this.renderer.drawFrequencyPlot(e.frequencyPlotHistory,this.frequencyEstimator.getMinFrequency(),this.frequencyEstimator.getMaxFrequency()),this.comparisonRenderer.updatePanels(e.previousWaveform,e.waveformData,e.displayStartIndex,e.displayEndIndex,e.waveformData,e.similarity,e.similarityPlotHistory,e.phaseZeroOffsetHistory,e.phaseTwoPiOffsetHistory),this.cycleSimilarityRenderer&&this.cycleSimilarityRenderer.updateGraphs(e.cycleSimilarities8div,e.cycleSimilarities4div,e.cycleSimilarities2div)}getIsRunning(){return this.isRunning}setAutoGain(e){this.gainController.setAutoGain(e)}getAutoGainEnabled(){return this.gainController.getAutoGainEnabled()}setNoiseGate(e){this.gainController.setNoiseGate(e)}getNoiseGateEnabled(){return this.gainController.getNoiseGateEnabled()}setNoiseGateThreshold(e){this.gainController.setNoiseGateThreshold(e)}getNoiseGateThreshold(){return this.gainController.getNoiseGateThreshold()}setFrequencyEstimationMethod(e){this.frequencyEstimator.setFrequencyEstimationMethod(e)}getFrequencyEstimationMethod(){return this.frequencyEstimator.getFrequencyEstimationMethod()}setBufferSizeMultiplier(e){this.frequencyEstimator.setBufferSizeMultiplier(e)}getBufferSizeMultiplier(){return this.frequencyEstimator.getBufferSizeMultiplier()}getEstimatedFrequency(){return this.frequencyEstimator.getEstimatedFrequency()}setFFTDisplay(e){this.renderer.setFFTDisplay(e)}getFFTDisplayEnabled(){return this.renderer.getFFTDisplayEnabled()}setHarmonicAnalysisEnabled(e){this.renderer.setHarmonicAnalysisEnabled(e)}getHarmonicAnalysisEnabled(){return this.renderer.getHarmonicAnalysisEnabled()}setDebugOverlaysEnabled(e){this.renderer.setDebugOverlaysEnabled(e)}getDebugOverlaysEnabled(){return this.renderer.getDebugOverlaysEnabled()}setOverlaysLayout(e){this.renderer.setOverlaysLayout(e)}getOverlaysLayout(){return this.renderer.getOverlaysLayout()}getCurrentGain(){return this.gainController.getCurrentGain()}getSimilarityScore(){return this.waveformSearcher.getLastSimilarity()}isSimilaritySearchActive(){return this.waveformSearcher.hasPreviousWaveform()}setUsePeakMode(e){this.zeroCrossDetector.setUsePeakMode(e)}getUsePeakMode(){return this.zeroCrossDetector.getUsePeakMode()}setZeroCrossMode(e){this.zeroCrossDetector.setZeroCrossMode(e)}getZeroCrossMode(){return this.zeroCrossDetector.getZeroCrossMode()}setPauseDrawing(e){this.isPaused=e}setDetailedTimingLogs(e){this.enableDetailedTimingLogs=e,this.dataProcessor.setDetailedTimingLogs(e)}getDetailedTimingLogsEnabled(){return this.enableDetailedTimingLogs}getPauseDrawing(){return this.isPaused}setPhaseMarkerRangeEnabled(e){this.phaseMarkerRangeEnabled=e}getPhaseMarkerRangeEnabled(){return this.phaseMarkerRangeEnabled}}class ve{constructor(e){i(this,"canvas");i(this,"ctx");i(this,"MIN_FREQ",50);i(this,"MAX_FREQ",2e3);i(this,"WHITE_KEY_WIDTH",20);i(this,"WHITE_KEY_HEIGHT",60);i(this,"BLACK_KEY_WIDTH",12);i(this,"BLACK_KEY_HEIGHT",38);i(this,"WHITE_KEY_COLOR","#ffffff");i(this,"BLACK_KEY_COLOR","#000000");i(this,"WHITE_KEY_HIGHLIGHT","#00ff00");i(this,"BLACK_KEY_HIGHLIGHT","#00cc00");i(this,"KEY_BORDER","#333333");i(this,"WHITE_KEY_NOTES",[0,2,4,5,7,9,11]);i(this,"BLACK_KEY_NOTES",[1,3,6,8,10]);i(this,"keyboardRange");i(this,"xOffset");i(this,"whiteKeyCount");this.canvas=e;const t=e.getContext("2d");if(!t)throw new Error("Could not get 2D context for piano keyboard");this.ctx=t,this.keyboardRange=this.calculateKeyboardRange(),this.whiteKeyCount=this.countWhiteKeys(),this.xOffset=this.calculateCenteringOffset()}frequencyToNoteInfo(e){const t=H(e);if(!t)return{note:-1,octave:-1,noteInOctave:-1};const s=t.noteName.match(/^([A-G]#?)(\d+)$/);if(!s)return{note:-1,octave:-1,noteInOctave:-1};const a=s[1],o=parseInt(s[2],10),n=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"].indexOf(a);return{note:o*12+n,octave:o,noteInOctave:n}}calculateKeyboardRange(){const e=this.frequencyToNoteInfo(this.MIN_FREQ),t=this.frequencyToNoteInfo(this.MAX_FREQ);return{startNote:e.note,endNote:t.note}}countWhiteKeys(){const e=this.keyboardRange;let t=0;for(let s=e.startNote;s<=e.endNote;s++){const a=(s%12+12)%12;this.WHITE_KEY_NOTES.includes(a)&&t++}return t}calculateCenteringOffset(){const e=this.whiteKeyCount*this.WHITE_KEY_WIDTH;return(this.canvas.width-e)/2}render(e){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);const t=this.keyboardRange,s=e>0?this.frequencyToNoteInfo(e):null;let a=0;for(let l=t.startNote;l<=t.endNote;l++){const f=(l%12+12)%12;if(this.WHITE_KEY_NOTES.includes(f)){const d=this.xOffset+a*this.WHITE_KEY_WIDTH,u=s&&s.note===l;this.ctx.fillStyle=u?this.WHITE_KEY_HIGHLIGHT:this.WHITE_KEY_COLOR,this.ctx.fillRect(d,0,this.WHITE_KEY_WIDTH,this.WHITE_KEY_HEIGHT),this.ctx.strokeStyle=this.KEY_BORDER,this.ctx.lineWidth=1,this.ctx.strokeRect(d,0,this.WHITE_KEY_WIDTH,this.WHITE_KEY_HEIGHT),a++}}a=0;for(let l=t.startNote;l<=t.endNote;l++){const f=(l%12+12)%12;if(this.WHITE_KEY_NOTES.includes(f)&&a++,this.BLACK_KEY_NOTES.includes(f)){const d=this.xOffset+a*this.WHITE_KEY_WIDTH-this.BLACK_KEY_WIDTH/2,u=s&&s.note===l;this.ctx.fillStyle=u?this.BLACK_KEY_HIGHLIGHT:this.BLACK_KEY_COLOR,this.ctx.fillRect(d,0,this.BLACK_KEY_WIDTH,this.BLACK_KEY_HEIGHT),this.ctx.strokeStyle=this.KEY_BORDER,this.ctx.lineWidth=1,this.ctx.strokeRect(d,0,this.BLACK_KEY_WIDTH,this.BLACK_KEY_HEIGHT)}}this.ctx.fillStyle="#888888",this.ctx.font="10px monospace",this.ctx.fillText(`${this.MIN_FREQ}Hz`,this.xOffset+5,this.WHITE_KEY_HEIGHT-5);const o=`${this.MAX_FREQ}Hz`,r=this.ctx.measureText(o).width,n=this.xOffset+this.whiteKeyCount*this.WHITE_KEY_WIDTH;this.ctx.fillText(o,n-r-5,this.WHITE_KEY_HEIGHT-5)}clear(){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}}class ge{constructor(){i(this,"canvas");i(this,"previousWaveformCanvas");i(this,"currentWaveformCanvas");i(this,"similarityPlotCanvas");i(this,"frameBufferCanvas");i(this,"cycleSimilarity8divCanvas");i(this,"cycleSimilarity4divCanvas");i(this,"cycleSimilarity2divCanvas");i(this,"pianoKeyboardCanvas");i(this,"startButton");i(this,"loadFileButton");i(this,"fileInput");i(this,"autoGainCheckbox");i(this,"noiseGateCheckbox");i(this,"fftDisplayCheckbox");i(this,"harmonicAnalysisCheckbox");i(this,"pauseDrawingCheckbox");i(this,"phaseMarkerRangeCheckbox");i(this,"cycleSimilarityDisplayCheckbox");i(this,"noiseGateThreshold");i(this,"frequencyMethod");i(this,"bufferSizeMultiplier");i(this,"zeroCrossMode");i(this,"cycleSimilarityPanel");i(this,"thresholdValue");i(this,"statusElement");i(this,"frequencyValue");i(this,"noteValue");i(this,"gainValue");i(this,"similarityValue");this.canvas=this.getElement("canvas"),this.previousWaveformCanvas=this.getElement("previousWaveformCanvas"),this.currentWaveformCanvas=this.getElement("currentWaveformCanvas"),this.similarityPlotCanvas=this.getElement("similarityPlotCanvas"),this.frameBufferCanvas=this.getElement("frameBufferCanvas"),this.cycleSimilarity8divCanvas=this.getElement("cycleSimilarity8divCanvas"),this.cycleSimilarity4divCanvas=this.getElement("cycleSimilarity4divCanvas"),this.cycleSimilarity2divCanvas=this.getElement("cycleSimilarity2divCanvas"),this.pianoKeyboardCanvas=this.getElement("pianoKeyboardCanvas"),this.startButton=this.getElement("startButton"),this.loadFileButton=this.getElement("loadFileButton"),this.fileInput=this.getElement("fileInput"),this.autoGainCheckbox=this.getElement("autoGainCheckbox"),this.noiseGateCheckbox=this.getElement("noiseGateCheckbox"),this.fftDisplayCheckbox=this.getElement("fftDisplayCheckbox"),this.harmonicAnalysisCheckbox=this.getElement("harmonicAnalysisCheckbox"),this.pauseDrawingCheckbox=this.getElement("pauseDrawingCheckbox"),this.phaseMarkerRangeCheckbox=this.getElement("phaseMarkerRangeCheckbox"),this.cycleSimilarityDisplayCheckbox=this.getElement("cycleSimilarityDisplayCheckbox"),this.noiseGateThreshold=this.getElement("noiseGateThreshold"),this.frequencyMethod=this.getElement("frequencyMethod"),this.bufferSizeMultiplier=this.getElement("bufferSizeMultiplier"),this.zeroCrossMode=this.getElement("zeroCrossMode"),this.cycleSimilarityPanel=this.getElement("cycleSimilarityPanel"),this.thresholdValue=this.getElement("thresholdValue"),this.statusElement=this.getElement("status"),this.frequencyValue=this.getElement("frequencyValue"),this.noteValue=this.getElement("noteValue"),this.gainValue=this.getElement("gainValue"),this.similarityValue=this.getElement("similarityValue"),this.validateElements()}getElement(e){const t=document.getElementById(e);if(!t)throw new Error(`Required DOM element not found: ${e}`);return t}validateElements(){const e=[{element:this.canvas,name:"canvas"},{element:this.previousWaveformCanvas,name:"previousWaveformCanvas"},{element:this.currentWaveformCanvas,name:"currentWaveformCanvas"},{element:this.similarityPlotCanvas,name:"similarityPlotCanvas"},{element:this.frameBufferCanvas,name:"frameBufferCanvas"},{element:this.cycleSimilarity8divCanvas,name:"cycleSimilarity8divCanvas"},{element:this.cycleSimilarity4divCanvas,name:"cycleSimilarity4divCanvas"},{element:this.cycleSimilarity2divCanvas,name:"cycleSimilarity2divCanvas"},{element:this.pianoKeyboardCanvas,name:"pianoKeyboardCanvas"},{element:this.startButton,name:"startButton"},{element:this.loadFileButton,name:"loadFileButton"},{element:this.fileInput,name:"fileInput"},{element:this.autoGainCheckbox,name:"autoGainCheckbox"},{element:this.noiseGateCheckbox,name:"noiseGateCheckbox"},{element:this.fftDisplayCheckbox,name:"fftDisplayCheckbox"},{element:this.harmonicAnalysisCheckbox,name:"harmonicAnalysisCheckbox"},{element:this.pauseDrawingCheckbox,name:"pauseDrawingCheckbox"},{element:this.phaseMarkerRangeCheckbox,name:"phaseMarkerRangeCheckbox"},{element:this.cycleSimilarityDisplayCheckbox,name:"cycleSimilarityDisplayCheckbox"},{element:this.noiseGateThreshold,name:"noiseGateThreshold"},{element:this.thresholdValue,name:"thresholdValue"},{element:this.cycleSimilarityPanel,name:"cycleSimilarityPanel"},{element:this.statusElement,name:"status"},{element:this.frequencyMethod,name:"frequencyMethod"},{element:this.bufferSizeMultiplier,name:"bufferSizeMultiplier"},{element:this.zeroCrossMode,name:"zeroCrossMode"},{element:this.frequencyValue,name:"frequencyValue"},{element:this.noteValue,name:"noteValue"},{element:this.gainValue,name:"gainValue"},{element:this.similarityValue,name:"similarityValue"}];for(const{element:t,name:s}of e)if(!t)throw new Error(`Required DOM element not found: ${s}`)}}class xe{constructor(e,t,s,a,o,r){i(this,"oscilloscope");i(this,"pianoKeyboardRenderer");i(this,"frequencyValue");i(this,"noteValue");i(this,"gainValue");i(this,"similarityValue");i(this,"updateInterval",null);i(this,"UPDATE_INTERVAL_MS",100);this.oscilloscope=e,this.pianoKeyboardRenderer=t,this.frequencyValue=s,this.noteValue=a,this.gainValue=o,this.similarityValue=r}start(){this.updateInterval===null&&(this.updateInterval=window.setInterval(()=>{this.update()},this.UPDATE_INTERVAL_MS))}stop(){this.updateInterval!==null&&(clearInterval(this.updateInterval),this.updateInterval=null,this.clearDisplays())}update(){this.updateFrequencyDisplay(),this.updateGainDisplay(),this.updateSimilarityDisplay()}updateFrequencyDisplay(){const e=this.oscilloscope.getEstimatedFrequency();if(e>0){this.frequencyValue.textContent=`${e.toFixed(1)} Hz`;const t=H(e);if(t){const s=t.cents>=0?"+":"";this.noteValue.textContent=`${t.noteName}${s}${t.cents}cent`}else this.noteValue.textContent="---";this.pianoKeyboardRenderer.render(e)}else this.frequencyValue.textContent="--- Hz",this.noteValue.textContent="---",this.pianoKeyboardRenderer.render(0)}updateGainDisplay(){const e=this.oscilloscope.getCurrentGain();this.gainValue.textContent=`${e.toFixed(2)}x`}updateSimilarityDisplay(){if(this.oscilloscope.isSimilaritySearchActive()){const e=this.oscilloscope.getSimilarityScore();this.similarityValue.textContent=e.toFixed(3)}else this.similarityValue.textContent="---"}clearDisplays(){this.frequencyValue.textContent="--- Hz",this.noteValue.textContent="---",this.gainValue.textContent="---x",this.similarityValue.textContent="---",this.pianoKeyboardRenderer.clear()}}class we{constructor(e,t,s){i(this,"oscilloscope");i(this,"dom");i(this,"displayUpdater");this.oscilloscope=e,this.dom=t,this.displayUpdater=s}setupEventHandlers(){this.setupCheckboxHandlers(),this.setupSliderHandlers(),this.setupSelectHandlers(),this.setupButtonHandlers(),this.setupFileInputHandler()}initializeUIState(){this.oscilloscope.setAutoGain(this.dom.autoGainCheckbox.checked),this.oscilloscope.setNoiseGate(this.dom.noiseGateCheckbox.checked),this.oscilloscope.setFFTDisplay(this.dom.fftDisplayCheckbox.checked),this.oscilloscope.setHarmonicAnalysisEnabled(this.dom.harmonicAnalysisCheckbox.checked),this.oscilloscope.setPauseDrawing(this.dom.pauseDrawingCheckbox.checked),this.oscilloscope.setPhaseMarkerRangeEnabled(this.dom.phaseMarkerRangeCheckbox.checked),this.updateCycleSimilarityPanelDisplay(this.dom.cycleSimilarityDisplayCheckbox.checked);const e=this.sliderValueToThreshold(this.dom.noiseGateThreshold.value);this.oscilloscope.setNoiseGateThreshold(e.amplitude),this.dom.thresholdValue.textContent=this.formatThresholdDisplay(e.db,e.amplitude);const t=this.dom.zeroCrossMode.value;["standard","peak-backtrack-history","bidirectional-nearest","gradient-based","adaptive-step","hysteresis","closest-to-zero"].includes(t)&&this.oscilloscope.setZeroCrossMode(t),this.dom.startButton.focus()}setupCheckboxHandlers(){this.dom.autoGainCheckbox.addEventListener("change",()=>{this.oscilloscope.setAutoGain(this.dom.autoGainCheckbox.checked)}),this.dom.noiseGateCheckbox.addEventListener("change",()=>{this.oscilloscope.setNoiseGate(this.dom.noiseGateCheckbox.checked)}),this.dom.fftDisplayCheckbox.addEventListener("change",()=>{this.oscilloscope.setFFTDisplay(this.dom.fftDisplayCheckbox.checked)}),this.dom.harmonicAnalysisCheckbox.addEventListener("change",()=>{this.oscilloscope.setHarmonicAnalysisEnabled(this.dom.harmonicAnalysisCheckbox.checked)}),this.dom.pauseDrawingCheckbox.addEventListener("change",()=>{this.oscilloscope.setPauseDrawing(this.dom.pauseDrawingCheckbox.checked)}),this.dom.phaseMarkerRangeCheckbox.addEventListener("change",()=>{this.oscilloscope.setPhaseMarkerRangeEnabled(this.dom.phaseMarkerRangeCheckbox.checked)}),this.dom.cycleSimilarityDisplayCheckbox.addEventListener("change",()=>{this.updateCycleSimilarityPanelDisplay(this.dom.cycleSimilarityDisplayCheckbox.checked)})}setupSliderHandlers(){this.dom.noiseGateThreshold.addEventListener("input",()=>{const e=this.sliderValueToThreshold(this.dom.noiseGateThreshold.value);this.oscilloscope.setNoiseGateThreshold(e.amplitude),this.dom.thresholdValue.textContent=this.formatThresholdDisplay(e.db,e.amplitude)})}setupSelectHandlers(){this.dom.frequencyMethod.addEventListener("change",()=>{const e=this.dom.frequencyMethod.value;this.oscilloscope.setFrequencyEstimationMethod(e)}),this.dom.bufferSizeMultiplier.addEventListener("change",()=>{const e=parseInt(this.dom.bufferSizeMultiplier.value,10);e===1||e===4||e===16?this.oscilloscope.setBufferSizeMultiplier(e):(console.error("Invalid buffer size multiplier:",e),this.dom.bufferSizeMultiplier.value="1",this.oscilloscope.setBufferSizeMultiplier(1))}),this.dom.zeroCrossMode.addEventListener("change",()=>{const e=this.dom.zeroCrossMode.value;["standard","peak-backtrack-history","bidirectional-nearest","gradient-based","adaptive-step","hysteresis","closest-to-zero"].includes(e)?this.oscilloscope.setZeroCrossMode(e):(console.error("Invalid zero-cross mode:",e),this.dom.zeroCrossMode.value="hysteresis",this.oscilloscope.setZeroCrossMode("hysteresis"))})}setupButtonHandlers(){this.dom.startButton.addEventListener("click",async()=>{await this.handleStartStopButton()}),this.dom.loadFileButton.addEventListener("click",()=>{this.dom.fileInput.click()})}setupFileInputHandler(){this.dom.fileInput.addEventListener("change",async()=>{await this.handleFileInput()})}async handleStartStopButton(){if(this.oscilloscope.getIsRunning())try{this.displayUpdater.stop(),await this.oscilloscope.stop(),this.dom.startButton.textContent="Start",this.dom.loadFileButton.disabled=!1,this.dom.statusElement.textContent="Stopped"}catch(e){console.error("Failed to stop oscilloscope:",e),this.dom.statusElement.textContent="Stopped (with errors)",this.dom.startButton.textContent="Start",this.dom.loadFileButton.disabled=!1}else try{this.dom.startButton.disabled=!0,this.dom.loadFileButton.disabled=!0,this.dom.statusElement.textContent="Requesting microphone access...",await this.oscilloscope.start(),this.dom.startButton.textContent="Stop",this.dom.startButton.disabled=!1,this.dom.statusElement.textContent="Running - Microphone active",this.displayUpdater.start()}catch(e){console.error("Failed to start oscilloscope:",e),this.dom.statusElement.textContent="Error: Could not access microphone",this.dom.startButton.disabled=!1,this.dom.loadFileButton.disabled=!1}}async handleFileInput(){var t;const e=(t=this.dom.fileInput.files)==null?void 0:t[0];if(e){this.oscilloscope.getIsRunning()&&(this.displayUpdater.stop(),await this.oscilloscope.stop());try{this.dom.startButton.disabled=!0,this.dom.loadFileButton.disabled=!0,this.dom.statusElement.textContent=`Loading file: ${e.name}...`,await this.oscilloscope.startFromFile(e),this.dom.startButton.textContent="Stop",this.dom.startButton.disabled=!1,this.dom.statusElement.textContent=`Playing: ${e.name} (loop)`,this.displayUpdater.start()}catch(s){console.error("Failed to load audio file:",s),this.dom.statusElement.textContent="Error: Could not load audio file",this.dom.startButton.textContent="Start",this.dom.startButton.disabled=!1,this.dom.loadFileButton.disabled=!1}this.dom.fileInput.value=""}}sliderValueToThreshold(e){const t=parseFloat(e);if(Number.isNaN(t))throw new Error(`Invalid slider value for noise gate threshold: "${e}"`);return{db:t,amplitude:B(t)}}formatThresholdDisplay(e,t){return`${e.toFixed(0)} dB (${t.toFixed(3)})`}updateCycleSimilarityPanelDisplay(e){this.dom.cycleSimilarityPanel.style.display=e?"flex":"none"}}const R=new ge,q=new pe(R.canvas,R.previousWaveformCanvas,R.currentWaveformCanvas,R.similarityPlotCanvas,R.frameBufferCanvas,R.cycleSimilarity8divCanvas,R.cycleSimilarity4divCanvas,R.cycleSimilarity2divCanvas),z=new ve(R.pianoKeyboardCanvas);z.render(0);const Ce=new xe(q,z,R.frequencyValue,R.noteValue,R.gainValue,R.similarityValue),N=new we(q,R,Ce);N.initializeUIState();N.setupEventHandlers();
//# sourceMappingURL=main-ClObs5u8.js.map
