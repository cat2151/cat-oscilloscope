# WaveformRenderer アーキテクチャ

## Before（変更前）

```
┌────────────────────────────────────────┐
│      WaveformRenderer.ts (825行)       │
│                                        │
│  - clearAndDrawGrid()                  │
│  - drawGrid()                          │
│  - drawGridLabels()                    │
│  - drawWaveform()                      │
│  - drawFFTOverlay()                    │
│  - drawHarmonicAnalysis()              │
│  - drawFrequencyPlot()                 │
│  - drawPhaseMarkers()                  │
│  - calculateOverlayDimensions() x3     │
│  - setters/getters                     │
│                                        │
│  問題:                                  │
│  ❌ ファイルが肥大化（825行）            │
│  ❌ 複数の責任を持つ                     │
│  ❌ コードの重複（calculateOverlay x3）  │
│  ❌ ハルシネーションリスク高             │
└────────────────────────────────────────┘
```

## After（変更後）

```
┌─────────────────────────────────────────────────────────────┐
│            WaveformRenderer.ts (255行)                       │
│                  [Facade Pattern]                           │
│                                                              │
│  役割: 統一されたAPIを提供、内部実装を隠蔽                    │
│                                                              │
│  - clearAndDrawGrid() → GridRenderer へ委譲                  │
│  - drawWaveform() → WaveformLineRenderer へ委譲              │
│  - drawFFTOverlay() → FFTOverlayRenderer へ委譲              │
│  - drawHarmonicAnalysis() → HarmonicAnalysisRenderer へ委譲  │
│  - drawFrequencyPlot() → FrequencyPlotRenderer へ委譲        │
│  - drawPhaseMarkers() → PhaseMarkerRenderer へ委譲           │
│                                                              │
└──────────┬──────────────────────────────────────────────────┘
           │ Composition
           ├─────────────────────────────┐
           │                             │
           ▼                             ▼
┌──────────────────────┐    ┌───────────────────────────────┐
│  GridRenderer (145行) │    │ BaseOverlayRenderer (75行)    │
│                      │    │   [Base Class]                │
│  責務:                │    │                               │
│  - グリッド線描画      │    │  責務:                         │
│  - 時間軸ラベル        │    │  - canvas寸法管理              │
│  - 振幅軸ラベル        │    │  - レイアウト計算の共通実装     │
└──────────────────────┘    └───────────┬───────────────────┘
                                        │ Inheritance
           ┌────────────────────────────┼────────────────────┐
           │                            │                    │
           ▼                            ▼                    ▼
┌─────────────────────┐  ┌───────────────────────┐  ┌──────────────────────┐
│ WaveformLineRenderer│  │  FFTOverlayRenderer   │  │ HarmonicAnalysis     │
│      (57行)         │  │       (97行)          │  │   Renderer (139行)   │
│                     │  │                       │  │                      │
│  責務:              │  │  責務:                │  │  責務:               │
│  - 波形信号の       │  │  - FFTスペクトラム     │  │  - 倍音分析情報      │
│    線描画           │  │    バー描画           │  │    表示              │
└─────────────────────┘  │  - 基本周波数マーカー  │  └──────────────────────┘
                        └───────────────────────┘
           ┌────────────────────────────┼────────────────────┐
           │                            │                    │
           ▼                            ▼                    ▼
┌─────────────────────┐  ┌───────────────────────┐  ┌──────────────────────┐
│ FrequencyPlot       │  │  PhaseMarkerRenderer  │  │                      │
│  Renderer (218行)   │  │       (140行)         │  │                      │
│                     │  │                       │  │                      │
│  責務:              │  │  責務:                │  │                      │
│  - 周波数履歴       │  │  - 位相マーカー線     │  │                      │
│    プロット表示     │  │    描画               │  │                      │
│  - 音符偏差表示     │  │  - デバッグ情報表示   │  │                      │
└─────────────────────┘  └───────────────────────┘  └──────────────────────┘
```

## クラス図

```
                    ┌──────────────────┐
                    │ WaveformRenderer │
                    │   (Facade)       │
                    └─────────┬────────┘
                              │
              ┌───────────────┼───────────────┐
              │               │               │
              ▼               ▼               ▼
      ┌──────────┐    ┌──────────┐   ┌──────────────┐
      │   Grid   │    │ Waveform │   │ PhaseMarker  │
      │ Renderer │    │   Line   │   │   Renderer   │
      │          │    │ Renderer │   │              │
      └──────────┘    └──────────┘   └──────────────┘
              
                    ┌───────────────────┐
                    │  BaseOverlay      │
                    │   Renderer        │
                    │  (Abstract Base)  │
                    └─────────┬─────────┘
                              │
              ┌───────────────┼────────────────┐
              │               │                │
              ▼               ▼                ▼
      ┌──────────┐    ┌──────────────┐  ┌────────────┐
      │   FFT    │    │  Harmonic    │  │ Frequency  │
      │ Overlay  │    │  Analysis    │  │   Plot     │
      │ Renderer │    │   Renderer   │  │  Renderer  │
      └──────────┘    └──────────────┘  └────────────┘
```

## メリット

### 1. 単一責任の原則（SRP）
各クラスが明確に定義された単一の責任を持つ。

### 2. 開放閉鎖の原則（OCP）
新しいレンダラーを追加する際、既存コードを変更せずに拡張可能。

### 3. コード重複の削減
BaseOverlayRendererで共通機能を一元化。

### 4. テスト容易性
各レンダラーを独立してテストできる。

### 5. 保守性の向上
変更の影響範囲が限定される。

## 設計の決定事項

### Facadeパターンの採用
**理由**: 
- 外部からは統一されたシンプルなAPIを提供
- 内部の複雑な実装を隠蔽
- 既存のAPIを変更せずに内部をリファクタリング可能

### BaseOverlayRendererの導入
**理由**:
- 3つのオーバーレイレンダラーで共通のcalculateOverlayDimensions実装
- DRY原則に従い、重複を排除
- 将来のオーバーレイレンダラー追加時にも再利用可能

### Compositionの使用
**理由**:
- WaveformRendererは各レンダラーを「持つ（has-a）」関係
- ランタイムでの柔軟な組み合わせが可能
- 密結合を避け、疎結合な設計

## パフォーマンスへの影響

### メソッド呼び出しのオーバーヘッド
- 影響: 無視できるレベル（ナノ秒オーダー）
- Canvas描画処理自体の方が圧倒的に重い

### メモリ使用量
- 各レンダラーのインスタンスを保持（約8個）
- 影響: 無視できるレベル（数KB程度）

**結論**: パフォーマンスへの悪影響はなし。
