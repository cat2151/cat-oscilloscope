<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>startFromBuffer Error Reproduction Test (#277/#281)</title>
</head>
<body>
  <h1>startFromBuffer Error Test</h1>
  <canvas id="oscilloscope" width="800" height="400"></canvas>
  <div id="result"></div>
  <script type="module">
    import { Oscilloscope, BufferSource } from '../src/index.ts';

    const resultDiv = document.getElementById('result');
    const errors = [];

    // Capture console errors
    const originalError = console.error;
    console.error = function(...args) {
      originalError.apply(console, args);
      errors.push(args.join(' '));
    };

    async function runTest() {
      try {
        const canvas = document.getElementById('oscilloscope');
        const hiddenCanvas = document.createElement('canvas');
        hiddenCanvas.width = 250;
        hiddenCanvas.height = 120;

        const oscilloscope = new Oscilloscope(
          canvas, hiddenCanvas, hiddenCanvas, hiddenCanvas, hiddenCanvas
        );
        oscilloscope.setDebugOverlaysEnabled(false);

        // Generate 440Hz sine wave (same as demo-simple.js)
        const sampleRate = 44100;
        const duration = 1;
        const audioData = new Float32Array(sampleRate * duration);
        for (let i = 0; i < audioData.length; i++) {
          audioData[i] = Math.sin(2 * Math.PI * 440 * i / sampleRate);
        }

        const bufferSource = new BufferSource(audioData, sampleRate, { loop: true });
        await oscilloscope.startFromBuffer(bufferSource);

        // Wait a bit for rendering
        await new Promise(resolve => setTimeout(resolve, 500));

        if (errors.length > 0) {
          resultDiv.textContent = 'FAIL: ' + errors.join('; ');
          resultDiv.setAttribute('data-status', 'fail');
        } else {
          resultDiv.textContent = 'PASS: No errors';
          resultDiv.setAttribute('data-status', 'pass');
        }
      } catch (error) {
        resultDiv.textContent = 'FAIL: ' + error.message;
        resultDiv.setAttribute('data-status', 'fail');
      }
    }

    runTest();
  </script>
</body>
</html>
