# cat-oscilloscope

<p align="left">
  <a href="README.ja.md"><img src="https://img.shields.io/badge/🇯🇵-Japanese-red.svg" alt="Japanese"></a>
  <a href="README.md"><img src="https://img.shields.io/badge/🇺🇸-English-blue.svg" alt="English"></a>
  <a href="https://deepwiki.com/cat2151/cat-oscilloscope"><img src="https://deepwiki.com/badge.svg" alt="Ask DeepWiki"></a>
  <a href="https://cat2151.github.io/cat-oscilloscope/"><img src="https://img.shields.io/badge/🌐-Live_Demo-green.svg" alt="Live Demo"></a>
</p>

ブラウザで動く、オシロスコープ風の波形ビジュアライザー

## 状況
- このドキュメントはまだAI生成の文章があり読みづらいです。今後文章を人間の手で読みやすく改善する予定です

## 🌐 ライブデモ

**フルバージョン**: [https://cat2151.github.io/cat-oscilloscope/](https://cat2151.github.io/cat-oscilloscope/)  
**簡易デモ（ライブラリ利用例）**: [https://cat2151.github.io/cat-oscilloscope/demo-simple.html](https://cat2151.github.io/cat-oscilloscope/demo-simple.html)

上記のURLでアプリケーションを試すことができます。フルバージョンではマイクへのアクセス許可が必要です。簡易デモはBufferSourceを使った最小限の実装例で、CDN経由でのライブラリ利用方法を示しています。

## 実装状況

### ✅ 完了済みの主要実装

- **Rust/WASM統合**: すべてのデータ処理アルゴリズムがRust/WASMで実装され、高速で型安全な処理を実現
- **ライブラリ対応**: npmライブラリとして他のプロジェクトから利用可能（ESM/CJS両対応、完全な型定義サポート）
- **5つの周波数推定方式**: Zero-Crossing、Autocorrelation、FFT、STFT、CQTをサポート
- **バッファサイズマルチプライヤー**: 低周波検出精度を向上させる拡張バッファ機能（1x/4x/16x）
- **波形比較パネル**: 前回と今回の波形の類似度をリアルタイム表示
- **ピアノ鍵盤表示**: 検出した周波数を視覚的に表示

### 現在の安定性

- ✅ 大きなバグは解決済み
- ✅ WAVファイルからのオーディオ再生時は高い実用性
- ⚠️ マイク入力は環境音の影響を受けるため、静かな環境での使用を推奨

## 📚 ライブラリとしての使用

cat-oscilloscopeは、あなた自身のプロジェクトでnpmライブラリとして使用できます。詳細な手順は [LIBRARY_USAGE.md](./LIBRARY_USAGE.md) をご覧ください。

⚠️ **重要**: npmやGitHubからインストールする場合、WASMファイルの手動セットアップが必要です。詳細は [LIBRARY_USAGE.md](./LIBRARY_USAGE.md) の「WASMファイルのセットアップ」セクションをご覧ください。

```typescript
import { Oscilloscope, BufferSource } from 'cat-oscilloscope';

const canvas = document.getElementById('canvas') as HTMLCanvasElement;
const oscilloscope = new Oscilloscope(canvas);

// マイク入力から可視化
await oscilloscope.start();

// 静的バッファから可視化（オーディオ再生なし）
const audioData = new Float32Array(44100); // 1秒分のデータ
const bufferSource = new BufferSource(audioData, 44100, { loop: true });
await oscilloscope.startFromBuffer(bufferSource);
```

**BufferSource機能**: wavlpfなどの音声処理ライブラリとの統合に最適な、静的バッファからの可視化機能を提供します。

**表示制御**: オーバーレイ（FFTスペクトラム、倍音分析、周波数推移プロット）の表示/非表示は`setDebugOverlaysEnabled()`で制御できます。また、`setOverlaysLayout()`でレイアウトをカスタマイズできます。詳細は [LIBRARY_USAGE.md](./LIBRARY_USAGE.md) の「デバッグオーバーレイ表示の制御」と「オーバーレイのレイアウトカスタマイズ」をご覧ください。


## 機能

### 周波数推定

cat-oscilloscopeは、5つの周波数推定アルゴリズムをサポートしています：

1. **Zero-Crossing（ゼロクロス法）**: シンプルで高速。単純な波形に適しています。
2. **Autocorrelation（自己相関法）**: 複雑な波形に対してバランスの良い精度。
3. **FFT（高速フーリエ変換）**: デフォルト。周波数スペクトラム解析。高周波に強い。
4. **STFT（短時間フーリエ変換）**: 可変窓長により、低周波の検出精度が向上。
5. **CQT（定Q変換）**: 低周波域で高い周波数分解能を持つ。音楽分析に適しています。

### バッファサイズマルチプライヤー

低周波の検出精度を向上させるため、過去のフレームバッファを利用した拡張バッファをサポート：

- **1x (Standard)**: 標準バッファサイズ（約1/60秒）
- **4x (Better Low Freq)**: 4倍の拡張バッファで低周波の検出精度向上
- **16x (Best Low Freq)**: 16倍の拡張バッファで最高の低周波検出精度

**使用例**: 20-50Hzの低周波を検出する場合、STFT または CQT を選択し、Buffer Size を 16x に設定すると最適です。

**重要な注意事項:**
- バッファサイズを変更すると、履歴が蓄積されるまで（最大16フレーム）、新しいバッファサイズが有効になりません
- 大きなバッファサイズ（16x）では、初回の周波数検出に約0.3秒かかります

### 検出可能な周波数範囲

バッファサイズによって、検出可能な最低周波数が異なります：

- **1x (4096サンプル @ 48kHz)**: 約80Hz以上（標準使用）
- **4x (16384サンプル)**: 約30Hz以上（低周波向上）
- **16x (65536サンプル)**: 約20Hz以上（最良の低周波検出）

## メモ

- 周波数推定
  - FFTが正確なときと、FFT以外が正確なとき、それぞれがあります。
  - STFTとCQTは特に低周波（20-100Hz）の検出に優れています。
  - バッファサイズマルチプライヤーを大きくすると、低周波の精度が向上しますが、レスポンスが若干遅くなります。
  - **パフォーマンス**: 16xバッファサイズでは、STFT/CQTの計算に時間がかかる場合があります（教育目的の実装のため）。

- オフセット%オーバーレイ（Offset %）- Issue #254調査中
  - 「今回の波形」パネルの右上に表示される、位相マーカーの4周期座標系内での位置を示すグラフ
  - **重要：座標系の理解**
    - **4周期座標系**: 表示される4周期分の波形内での相対位置（0-100%）← これが重要
    - **全フレーム座標系**: サンプルバッファ全体での絶対位置 ← 今回の調査対象外
  - **用語説明**:
    - **start offset**: 位相0マーカー（開始位置）が4周期座標系内のどこにあるか（0-100%）
    - **end offset**: 位相2πマーカー（終了位置）が4周期座標系内のどこにあるか（0-100%）
    - **offsetChange**: 前フレームからのオフセット変化量（仕様：1%以内）
  - **表示内容**: 
    - 赤線（S）: start offset（4周期座標系での位相0の位置、0-100%）
    - オレンジ線（E）: end offset（4周期座標系での位相2πの位置、0-100%）
  - **仕様違反検出**: 
    - 4周期座標系において、フレーム間で1%を超える変化を検出すると警告を出力
    - 診断情報には以下が含まれます：
      - start/end offsetの現在値と前フレーム値（4周期座標系内での位置%）
      - offsetChange（変化量、仕様では1%以内）
      - SPEC_VIOLATION フラグ
  - **目的**: 4周期座標系において、オフセットが仕様（1%以内）を遵守しているか検証

## データ処理の実装について

すべてのデータ処理（波形探索、周波数推定、ゼロクロス検出など）は**Rust/WASMで実装**されています。

- **高速な処理性能**: Rustの最適化により効率的な実行
- **型安全で信頼性の高い実装**: Rustの厳格な型システムによる安全性
- **単一実装**: アルゴリズムはWASMのみで実装され、TypeScriptとの二重管理を解消
- **TypeScriptの役割**: 設定管理とレンダリングのみを担当

### WASM実装のビルド

WASM実装は `signal-processor-wasm` ディレクトリにあります。

```bash
# WASM実装のビルド（wasm-packが必要）
npm run build:wasm

# アプリ全体のビルド（WASMも含む）
npm run build
```

**必要なツール**:
- Rust toolchain (rustc, cargo)
- wasm-pack (`cargo install wasm-pack`)

**注意**: 通常の使用では、事前ビルド済みのWASMファイルが `public/wasm/` に含まれているため、Rustツールチェーンは不要です。

## 主な機能

- 🎤 **マイク入力** - マイクからの音声をリアルタイムでキャプチャ
- 📂 **オーディオファイル** - WAVファイルのループ再生に対応
- 📊 **周波数推定** - ゼロクロス、自己相関、FFT、STFT、CQTの5つの方式
- 🎹 **ピアノ鍵盤表示** - 検出した周波数を鍵盤上に表示
- 🎚️ **自動ゲイン** - 波形の振幅を自動調整
- 🔇 **ノイズゲート** - 閾値以下の信号をカット
- 📈 **FFTスペクトラム** - 周波数スペクトラムをオーバーレイ表示
- 🔍 **波形比較パネル** - 前回と今回の波形の類似度を表示
- ⏸️ **描画の一時停止** - 波形を静止して観察可能

## はじめに

### 必要条件

- Node.js（v16以上を推奨）
- npm または yarn

### インストール

```bash
npm install
```

### 開発

開発サーバーを起動：

```bash
npm run dev
```

ブラウザで `http://localhost:3000/` を開いてください。

### ビルド

本番用にビルド：

```bash
npm run build
```

ビルドされたファイルは `dist` ディレクトリに出力されます。

### 本番ビルドのプレビュー

```bash
npm run preview
```

### テスト

テストを実行：

```bash
npm test
```

カバレッジレポートを生成：

```bash
npm run test:coverage
```

テストUIを起動：

```bash
npm run test:ui
```

## 仕組み

### ゼロクロス検出アルゴリズム

このオシロスコープは、以下のようなゼロクロス検出アルゴリズムを実装しています：

1. 音声バッファをスキャンし、波形がマイナス（またはゼロ）からプラスに交差するポイントを検出
2. 最初のゼロクロスポイントを特定
3. 次のゼロクロスポイントを見つけて、1つの完全な波形サイクルを決定
4. ゼロクロスポイントの前後にわずかなパディングを付けて波形を表示

これにより、安定した非スクロール表示が実現されます。

### 技術的詳細

- **FFTサイズ**: 高解像度のため4096サンプル
- **スムージング**: 正確な波形表現のため無効（0）
- **表示パディング**: ゼロクロスポイントの前後に20サンプル
- **オートゲイン**: 
  - キャンバスの高さの80%を目標に自動調整
  - ピーク追跡による滑らかな遷移（減衰率: 0.95）
  - ゲイン範囲: 0.5倍〜99倍
  - 補間係数: 0.1（段階的な調整）
  - UIチェックボックスで有効/無効を切り替え可能（デフォルト: 有効）
- **キャンバス解像度**: 800x400ピクセル
- **リフレッシュレート**: ブラウザのrequestAnimationFrameに同期（約60 FPS）

## 技術スタック

- **Rust/WebAssembly** - 高速で型安全なデータ処理アルゴリズム
- **TypeScript** - 型安全なJavaScript（設定管理とレンダリング）
- **Vite** - 高速なビルドツールと開発サーバー
- **Web Audio API** - 音声のキャプチャと分析
- **HTML Canvas** - 2D波形レンダリング

## ブラウザ要件

このアプリケーションには以下が必要です：
- Web Audio APIをサポートするモダンブラウザ（Chrome、Firefox、Safari、Edge）
- ユーザーによるマイクのアクセス許可
- HTTPSまたはlocalhost（マイクアクセスに必要）

## マイク入力時の制約

マイクからの入力を使用する場合、以下の制約があります：

### 環境音の影響

マイクは周囲のすべての音を拾うため、以下のような環境音が波形に影響を与えます：

- **マウスクリック音**: マウスをクリックする際の機械的な音が波形に現れます。特に一時停止ボタンをマウスでクリックした瞬間、波形が乱れて見えることがあります。
- **キーボード打鍵音**: キーボードのタイプ音も波形に影響します。ただし、静音性の高いキーボードを使用している場合は、影響が少なくなります。
- **その他の環境音**: 話し声、室内の空調音、外部からの騒音なども波形に現れます。

### 実用上のヒント

- **一時停止の方法**: マウスクリックの代わりに、静音性の高いキーボードのスペースキーを使用することで、一時停止時の波形への影響を最小限に抑えることができます。
- **音源の選択**: マイク入力は環境音の影響を受けやすいため、ノイズのない波形を観察したい場合は、WAVファイルなどのオーディオファイルを使用することをお勧めします。
- **測定環境**: できるだけ静かな環境で使用することで、より正確な波形を観察できます。

これらはアプリケーションの制限ではなく、マイクというデバイスの特性によるものです。

## 開発・保守

### コード品質の自動チェック

このプロジェクトでは、コード品質を維持するために以下の自動チェックが実行されます：

- **大きなファイルの検出**: 日次バッチでソースファイルの行数をチェックし、500行を超えるファイルがあればissueを自動起票します
  - 設定ファイル: `.github/check-large-files.toml`
  - 実行スクリプト: `.github/scripts/check_large_files.py`
  - ワークフロー: `.github/workflows/check-large-files.yml`
  - 日本時間 毎日09:00に自動実行 (手動実行も可能)

この仕組みにより、ファイルが大きくなりすぎる前に早期発見し、適切なタイミングでリファクタリングを検討できます。

## ライセンス

MITライセンス - 詳細は [LICENSE](LICENSE) ファイルを参照してください

*Big Brother is listening to you. Now it’s the cat.* 🐱
