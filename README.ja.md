# cat-oscilloscope

ブラウザで動く、オシロスコープ風の波形ビジュアライザー

## 🌐 ライブデモ

**[https://cat2151.github.io/cat-oscilloscope/](https://cat2151.github.io/cat-oscilloscope/)**

上記のURLでアプリケーションを試すことができます。マイクへのアクセス許可が必要です。

※このドキュメントは仮のため大部分がLLMによって生成されました。今後修正していきます

## 状況
- 大きなバグは一通り取った状態です。
- 細かい不具合はあります。
- micからの音の場合、位相が揃ったり揃わなかったりが不安定で、実用度が低いです。
- WAVファイルからのチップチューンのモノラルの単純波形の場合、実用度が高いです。
- ライブラリとしてどれくらい楽に使えるかは、これから検証予定です。

## 📚 ライブラリとしての使用

cat-oscilloscopeは、あなた自身のプロジェクトでnpmライブラリとして使用できます。詳細な手順は [LIBRARY_USAGE.md](./LIBRARY_USAGE.md) をご覧ください。

```typescript
import { Oscilloscope } from 'cat-oscilloscope';

const canvas = document.getElementById('canvas') as HTMLCanvasElement;
const oscilloscope = new Oscilloscope(canvas);
await oscilloscope.start();
```

## 機能

### 周波数推定

cat-oscilloscopeは、5つの周波数推定アルゴリズムをサポートしています：

1. **Zero-Crossing（ゼロクロス法）**: シンプルで高速。単純な波形に適しています。
2. **Autocorrelation（自己相関法）**: デフォルト。複雑な波形に対してバランスの良い精度。
3. **FFT（高速フーリエ変換）**: 周波数スペクトラム解析。高周波に強い。
4. **STFT（短時間フーリエ変換）**: 可変窓長により、低周波の検出精度が向上。
5. **CQT（定Q変換）**: 低周波域で高い周波数分解能を持つ。音楽分析に適しています。

### バッファサイズマルチプライヤー

低周波の検出精度を向上させるため、過去のフレームバッファを利用した拡張バッファをサポート：

- **1x (Standard)**: 標準バッファサイズ（約1/60秒）
- **4x (Better Low Freq)**: 4倍の拡張バッファで低周波の検出精度向上
- **16x (Best Low Freq)**: 16倍の拡張バッファで最高の低周波検出精度

**使用例**: 20-50Hzの低周波を検出する場合、STFT または CQT を選択し、Buffer Size を 16x に設定すると最適です。

**重要な注意事項:**
- バッファサイズを変更すると、履歴が蓄積されるまで（最大16フレーム）、新しいバッファサイズが有効になりません
- 大きなバッファサイズ（16x）では、初回の周波数検出に約0.3秒かかります

### 検出可能な周波数範囲

バッファサイズによって、検出可能な最低周波数が異なります：

- **1x (4096サンプル @ 48kHz)**: 約80Hz以上（標準使用）
- **4x (16384サンプル)**: 約30Hz以上（低周波向上）
- **16x (65536サンプル)**: 約20Hz以上（最良の低周波検出）

## メモ

- 周波数推定
  - FFTが正確なときと、FFT以外が正確なとき、それぞれがあります。
  - STFTとCQTは特に低周波（20-100Hz）の検出に優れています。
  - バッファサイズマルチプライヤーを大きくすると、低周波の精度が向上しますが、レスポンスが若干遅くなります。
  - **パフォーマンス**: 16xバッファサイズでは、STFT/CQTの計算に時間がかかる場合があります（教育目的の実装のため）。

## WASM実装について

データ処理部分（波形探索、周波数推定、ゼロクロス検出など）は、Rust/WASMでも実装されています。

- **TypeScript実装**: デフォルトで使用されます。互換性が高く、デバッグが容易です。
- **Rust/WASM実装**: より高速な処理が期待できます。「Use WASM」チェックボックスで切り替え可能です。

両実装は完全に同じ`WaveformRenderData`構造を返すため、レンダリングロジックは共通です。

### WASM実装のビルド

WASM実装は `wasm-processor` ディレクトリにあります。

```bash
# WASM実装のビルド（wasm-packが必要）
npm run build:wasm

# アプリ全体のビルド（WASMも含む）
npm run build
```

**必要なツール**:
- Rust toolchain (rustc, cargo)
- wasm-pack (`cargo install wasm-pack`)

## 機能

- 🎤 **マイク入力** - マイクからの音声をリアルタイムでキャプチャ
- 🎯 **ゼロクロス検出** - 音声がマイナスからプラスに交差するポイントを自動検出
- 📊 **安定した表示** - ゼロクロスポイントに基づいて波形表示を整列し、安定した表示を実現
- 🔊 **オートゲイン** - 波形の振幅を自動調整し、キャンバスの高さを最適に活用
- ⚡ **リアルタイムレンダリング** - 波形の可視化を継続的に更新
- 🎨 **クラシックなデザイン** - 黒背景にグリーンの波形とグリッドオーバーレイ
- 🛡️ **エラーハンドリング** - マイクのアクセス許可の問題を適切に処理
- 🔍 **波形類似探索** - 前フレームとの類似度を計算し、安定した波形表示を実現
- 🦀 **Rust/WASM対応** - データ処理部分をRust/WASMでも実装、チェックボックスで切り替え可能

## はじめに

### 必要条件

- Node.js（v16以上を推奨）
- npm または yarn

### インストール

```bash
npm install
```

### 開発

開発サーバーを起動：

```bash
npm run dev
```

ブラウザで `http://localhost:3000/` を開いてください。

### ビルド

本番用にビルド：

```bash
npm run build
```

ビルドされたファイルは `dist` ディレクトリに出力されます。

### 本番ビルドのプレビュー

```bash
npm run preview
```

### テスト

テストを実行：

```bash
npm test
```

カバレッジレポートを生成：

```bash
npm run test:coverage
```

テストUIを起動：

```bash
npm run test:ui
```

詳細は [TESTING.md](TESTING.md) を参照してください。

## 仕組み

### ゼロクロス検出アルゴリズム

このオシロスコープは、以下のようなゼロクロス検出アルゴリズムを実装しています：

1. 音声バッファをスキャンし、波形がマイナス（またはゼロ）からプラスに交差するポイントを検出
2. 最初のゼロクロスポイントを特定
3. 次のゼロクロスポイントを見つけて、1つの完全な波形サイクルを決定
4. ゼロクロスポイントの前後にわずかなパディングを付けて波形を表示

これにより、安定した非スクロール表示が実現されます。

### 技術的詳細

- **FFTサイズ**: 高解像度のため4096サンプル
- **スムージング**: 正確な波形表現のため無効（0）
- **表示パディング**: ゼロクロスポイントの前後に20サンプル
- **オートゲイン**: 
  - キャンバスの高さの80%を目標に自動調整
  - ピーク追跡による滑らかな遷移（減衰率: 0.95）
  - ゲイン範囲: 0.5倍〜99倍
  - 補間係数: 0.1（段階的な調整）
  - UIチェックボックスで有効/無効を切り替え可能（デフォルト: 有効）
- **キャンバス解像度**: 800x400ピクセル
- **リフレッシュレート**: ブラウザのrequestAnimationFrameに同期（約60 FPS）

## 技術スタック

- **TypeScript** - 型安全なJavaScript
- **Vite** - 高速なビルドツールと開発サーバー
- **Web Audio API** - 音声のキャプチャと分析
- **HTML Canvas** - 2D波形レンダリング

## ブラウザ要件

このアプリケーションには以下が必要です：
- Web Audio APIをサポートするモダンブラウザ（Chrome、Firefox、Safari、Edge）
- ユーザーによるマイクのアクセス許可
- HTTPSまたはlocalhost（マイクアクセスに必要）

## ライセンス

MITライセンス - 詳細は [LICENSE](LICENSE) ファイルを参照してください

*Big Brother is listening to you. Now it’s the cat.* 🐱
