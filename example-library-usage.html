<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>cat-oscilloscope Library Example</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a1a;
      color: #fff;
    }
    h1 {
      color: #00ff00;
    }
    canvas {
      border: 2px solid #00ff00;
      display: block;
      margin: 20px 0;
    }
    .controls {
      margin: 20px 0;
    }
    button {
      background: #00ff00;
      border: none;
      color: #000;
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      font-size: 16px;
      border-radius: 4px;
    }
    button:hover {
      background: #00cc00;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    label {
      margin: 10px;
      display: inline-block;
    }
    input[type="checkbox"] {
      margin-right: 5px;
    }
    .info {
      background: #333;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }
    .status {
      color: #00ff00;
      font-weight: bold;
    }
    code {
      background: #222;
      padding: 2px 6px;
      border-radius: 3px;
      color: #00ff00;
    }
    pre {
      background: #222;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>ğŸ± cat-oscilloscope ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä½¿ç”¨ä¾‹</h1>
  
  <div class="info">
    <p>ã“ã®ãƒšãƒ¼ã‚¸ã¯ã€cat-oscilloscopeã‚’npmãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã‚’ç¤ºã™ä¾‹ã§ã™ã€‚</p>
    <p><strong>æ³¨æ„:</strong> ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¿…è¦ã§ã™ã€‚HTTPSã¾ãŸã¯localhostã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
  </div>

  <canvas id="oscilloscope" width="800" height="400"></canvas>
  
  <!-- Hidden canvases for comparison panel - not displayed in this simple example -->
  <canvas id="previousWaveformCanvas" width="250" height="120" style="display: none;"></canvas>
  <canvas id="currentWaveformCanvas" width="250" height="120" style="display: none;"></canvas>
  <canvas id="similarityPlotCanvas" width="250" height="120" style="display: none;"></canvas>
  <canvas id="frameBufferCanvas" width="800" height="120" style="display: none;"></canvas>
  
  <div class="controls">
    <button id="startBtn">Start Microphone</button>
    <button id="stopBtn" disabled>Stop</button>
    <input type="file" id="fileInput" accept="audio/*" style="display: none;">
    <button id="loadFileBtn">Load Audio File</button>
    <button id="demoBufferBtn">Demo: Sine Wave (BufferSource)</button>
    <br>
    <label>
      <input type="checkbox" id="autoGain" checked>
      Auto Gain
    </label>
    <label>
      <input type="checkbox" id="noiseGate">
      Noise Gate
    </label>
    <label>
      <input type="checkbox" id="fftDisplay">
      FFT Display
    </label>
    <label>
      <input type="checkbox" id="debugOverlays" checked>
      Debug Overlays (é»„è‰²æ ã®æƒ…å ±)
    </label>
    <label>
      <input type="checkbox" id="detailedTimingLogs">
      Detailed Timing Logs (è¨ºæ–­ç”¨)
    </label>
    <br>
    <label>
      å‘¨æ³¢æ•°æ¨å®šæ–¹æ³•:
      <select id="freqMethod">
        <option value="zero-crossing">Zero-Crossing</option>
        <option value="autocorrelation">Autocorrelation</option>
        <option value="fft" selected>FFT</option>
      </select>
    </label>
  </div>

  <div class="info">
    <p>çŠ¶æ…‹: <span class="status" id="status">Stopped</span></p>
    <p>å‘¨æ³¢æ•°: <span class="status" id="frequency">--- Hz</span></p>
    <p>ã‚²ã‚¤ãƒ³: <span class="status" id="gain">---x</span></p>
    <p><strong>ãƒ’ãƒ³ãƒˆ:</strong> ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€ã€ŒDebug Overlaysã€ã®ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚</p>
  </div>

  <div class="info">
    <h3>ä½¿ç”¨æ–¹æ³•:</h3>
    
    <h4>GitHubãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ç›´æ¥ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«:</h4>
    <pre><code>npm install git+https://github.com/cat2151/cat-oscilloscope.git</code></pre>
    
    <h4>npmçµŒç”±ã§ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å…¬é–‹å¾Œï¼‰:</h4>
    <pre><code>npm install cat-oscilloscope</code></pre>
    
    <h4>åŸºæœ¬çš„ãªä½¿ç”¨ä¾‹:</h4>
    <pre><code>import { Oscilloscope } from 'cat-oscilloscope';

const canvas = document.getElementById('oscilloscope');
const oscilloscope = new Oscilloscope(canvas);

// ãƒã‚¤ã‚¯é–‹å§‹
await oscilloscope.start();

// ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®š
oscilloscope.setAutoGain(true);
oscilloscope.setNoiseGate(false);
oscilloscope.setFrequencyEstimationMethod('autocorrelation');

// åœæ­¢
await oscilloscope.stop();</code></pre>
    
    <p>è©³ç´°ã¯ <a href="https://github.com/cat2151/cat-oscilloscope/blob/main/LIBRARY_USAGE.md" style="color: #00ff00;">LIBRARY_USAGE.md</a> ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚</p>
  </div>

  <script type="module">
    // ã“ã®ä¾‹ã§ã¯ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã¨ä»®å®šã—ã¦ã„ã¾ã™
    // å®Ÿéš›ã®ä½¿ç”¨ã§ã¯: import { Oscilloscope, BufferSource } from 'cat-oscilloscope';
    
    // ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ã«srcã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    import { Oscilloscope, BufferSource } from './src/index.ts';

    const canvas = document.getElementById('oscilloscope');
    // Hidden canvases for comparison panel - required by constructor but not displayed
    const previousWaveformCanvas = document.getElementById('previousWaveformCanvas');
    const currentWaveformCanvas = document.getElementById('currentWaveformCanvas');
    const similarityPlotCanvas = document.getElementById('similarityPlotCanvas');
    const frameBufferCanvas = document.getElementById('frameBufferCanvas');
    
    const oscilloscope = new Oscilloscope(
      canvas,
      previousWaveformCanvas,
      currentWaveformCanvas,
      similarityPlotCanvas,
      frameBufferCanvas
    );
    
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const loadFileBtn = document.getElementById('loadFileBtn');
    const demoBufferBtn = document.getElementById('demoBufferBtn');
    const fileInput = document.getElementById('fileInput');
    const autoGainCheckbox = document.getElementById('autoGain');
    const noiseGateCheckbox = document.getElementById('noiseGate');
    const fftDisplayCheckbox = document.getElementById('fftDisplay');
    const debugOverlaysCheckbox = document.getElementById('debugOverlays');
    const detailedTimingLogsCheckbox = document.getElementById('detailedTimingLogs');
    const freqMethodSelect = document.getElementById('freqMethod');
    const statusElement = document.getElementById('status');
    const frequencyElement = document.getElementById('frequency');
    const gainElement = document.getElementById('gain');

    // åˆæœŸè¨­å®š
    oscilloscope.setAutoGain(autoGainCheckbox.checked);
    oscilloscope.setNoiseGate(noiseGateCheckbox.checked);
    oscilloscope.setFFTDisplay(fftDisplayCheckbox.checked);
    oscilloscope.setDebugOverlaysEnabled(debugOverlaysCheckbox.checked);
    oscilloscope.setDetailedTimingLogs(detailedTimingLogsCheckbox.checked);
    oscilloscope.setFrequencyEstimationMethod(freqMethodSelect.value);

    // å‘¨æ³¢æ•°ã¨ã‚²ã‚¤ãƒ³è¡¨ç¤ºã®æ›´æ–°
    let updateInterval = null;
    function startUpdates() {
      updateInterval = setInterval(() => {
        const freq = oscilloscope.getEstimatedFrequency();
        frequencyElement.textContent = freq > 0 ? `${freq.toFixed(1)} Hz` : '--- Hz';
        
        const gain = oscilloscope.getCurrentGain();
        gainElement.textContent = `${gain.toFixed(2)}x`;
      }, 100);
    }
    
    function stopUpdates() {
      if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
      }
      frequencyElement.textContent = '--- Hz';
      gainElement.textContent = '---x';
    }

    // ãƒã‚¤ã‚¯é–‹å§‹ãƒœã‚¿ãƒ³
    startBtn.addEventListener('click', async () => {
      try {
        startBtn.disabled = true;
        loadFileBtn.disabled = true;
        demoBufferBtn.disabled = true;
        statusElement.textContent = 'Requesting microphone access...';
        
        await oscilloscope.start();
        
        statusElement.textContent = 'Running - Microphone active';
        startBtn.style.display = 'none';
        stopBtn.disabled = false;
        startUpdates();
      } catch (error) {
        console.error('Failed to start oscilloscope:', error);
        statusElement.textContent = 'Error: Could not access microphone';
        startBtn.disabled = false;
        loadFileBtn.disabled = false;
        demoBufferBtn.disabled = false;
      }
    });

    // åœæ­¢ãƒœã‚¿ãƒ³
    stopBtn.addEventListener('click', async () => {
      try {
        await oscilloscope.stop();
        
        statusElement.textContent = 'Stopped';
        startBtn.style.display = 'inline-block';
        startBtn.disabled = false;
        stopBtn.disabled = true;
        loadFileBtn.disabled = false;
        demoBufferBtn.disabled = false;
        stopUpdates();
      } catch (error) {
        console.error('Failed to stop oscilloscope:', error);
      }
    });

    // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
    loadFileBtn.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', async () => {
      const file = fileInput.files?.[0];
      if (!file) return;
      
      if (oscilloscope.getIsRunning()) {
        await oscilloscope.stop();
        stopUpdates();
      }
      
      try {
        startBtn.disabled = true;
        loadFileBtn.disabled = true;
        demoBufferBtn.disabled = true;
        stopBtn.disabled = true;
        statusElement.textContent = `Loading: ${file.name}...`;
        
        await oscilloscope.startFromFile(file);
        
        statusElement.textContent = `Playing: ${file.name} (loop)`;
        startBtn.style.display = 'none';
        stopBtn.disabled = false;
        startUpdates();
      } catch (error) {
        console.error('Failed to load audio file:', error);
        statusElement.textContent = 'Error: Could not load audio file';
        startBtn.style.display = 'inline-block';
        startBtn.disabled = false;
        loadFileBtn.disabled = false;
        demoBufferBtn.disabled = false;
        stopBtn.disabled = true;
      }
      
      fileInput.value = '';
    });

    // BufferSource ãƒ‡ãƒ¢ãƒœã‚¿ãƒ³
    demoBufferBtn.addEventListener('click', async () => {
      if (oscilloscope.getIsRunning()) {
        await oscilloscope.stop();
        stopUpdates();
      }
      
      try {
        startBtn.disabled = true;
        loadFileBtn.disabled = true;
        demoBufferBtn.disabled = true;
        statusElement.textContent = 'Generating sine wave...';
        
        // 440Hz ã‚µã‚¤ãƒ³æ³¢ã‚’ç”Ÿæˆ (1ç§’åˆ†)
        const sampleRate = 44100;
        const duration = 1; // seconds
        const frequency = 440; // Hz
        const audioData = new Float32Array(sampleRate * duration);
        
        for (let i = 0; i < audioData.length; i++) {
          audioData[i] = Math.sin(2 * Math.PI * frequency * i / sampleRate);
        }
        
        // BufferSourceã‚’ä½œæˆã—ã¦ãƒ«ãƒ¼ãƒ—å†ç”Ÿ
        const bufferSource = new BufferSource(audioData, sampleRate, { loop: true });
        
        await oscilloscope.startFromBuffer(bufferSource);
        
        statusElement.textContent = `BufferSource Demo: 440Hz Sine Wave (loop)`;
        startBtn.style.display = 'none';
        stopBtn.disabled = false;
        startUpdates();
      } catch (error) {
        console.error('Failed to start BufferSource demo:', error);
        statusElement.textContent = 'Error: Could not start BufferSource demo';
        startBtn.style.display = 'inline-block';
        startBtn.disabled = false;
        loadFileBtn.disabled = false;
        demoBufferBtn.disabled = false;
        stopBtn.disabled = true;
      }
    });

    // è¨­å®šå¤‰æ›´
    autoGainCheckbox.addEventListener('change', () => {
      oscilloscope.setAutoGain(autoGainCheckbox.checked);
    });

    noiseGateCheckbox.addEventListener('change', () => {
      oscilloscope.setNoiseGate(noiseGateCheckbox.checked);
    });

    fftDisplayCheckbox.addEventListener('change', () => {
      oscilloscope.setFFTDisplay(fftDisplayCheckbox.checked);
    });

    debugOverlaysCheckbox.addEventListener('change', () => {
      oscilloscope.setDebugOverlaysEnabled(debugOverlaysCheckbox.checked);
    });

    detailedTimingLogsCheckbox.addEventListener('change', () => {
      oscilloscope.setDetailedTimingLogs(detailedTimingLogsCheckbox.checked);
    });

    freqMethodSelect.addEventListener('change', () => {
      oscilloscope.setFrequencyEstimationMethod(freqMethodSelect.value);
    });
  </script>
</body>
</html>
