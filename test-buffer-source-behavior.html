<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BufferSource Feature Parity Test</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1a1a1a;
      color: #00ff00;
    }
    canvas {
      border: 2px solid #00ff00;
      display: block;
      margin: 20px 0;
      background: #000;
    }
    button {
      background: #00ff00;
      border: none;
      color: #000;
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }
    .log {
      background: #000;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #00ff00;
      max-height: 400px;
      overflow-y: auto;
    }
    .log-entry {
      margin: 2px 0;
    }
    .success { color: #00ff00; }
    .warning { color: #ffaa00; }
    .error { color: #ff0000; }
    .feature-list {
      background: #000;
      padding: 15px;
      margin: 20px 0;
      border: 1px solid #00ff00;
    }
    .feature-item {
      margin: 5px 0;
      padding: 5px;
    }
    .feature-enabled {
      color: #00ff00;
    }
    .feature-disabled {
      color: #888;
    }
  </style>
</head>
<body>
  <h1>BufferSource Feature Parity Test</h1>
  <p>このテストは、BufferSourceモードがすべての機能をサポートしていることを検証します。</p>
  
  <canvas id="oscilloscope" width="800" height="350"></canvas>
  
  <div>
    <button id="startButton">Start BufferSource (440Hz)</button>
    <button id="stopButton" disabled>Stop</button>
  </div>
  
  <div class="feature-list">
    <h2>機能テスト結果:</h2>
    <div class="feature-item" id="freq-test">⏳ 周波数推定: テスト中...</div>
    <div class="feature-item" id="gain-test">⏳ 自動ゲイン: テスト中...</div>
    <div class="feature-item" id="fft-test">⏳ FFT計算: テスト中...</div>
    <div class="feature-item" id="waveform-test">⏳ 波形描画: テスト中...</div>
  </div>
  
  <h2>リアルタイム情報:</h2>
  <div id="results">
    <div>推定周波数: <span id="frequency">---</span> Hz (期待値: 440Hz)</div>
    <div>ゲイン: <span id="gain">---</span>x</div>
    <div>周波数推定メソッド: <span id="method">---</span></div>
  </div>
  
  <h2>Debug Log:</h2>
  <div id="log" class="log"></div>

  <script type="module">
    import { Oscilloscope, BufferSource } from '/src/index.ts';
    
    const canvas = document.getElementById('oscilloscope');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const logDiv = document.getElementById('log');
    
    // Create hidden canvases
    const hiddenCanvas = document.createElement('canvas');
    hiddenCanvas.width = 250;
    hiddenCanvas.height = 120;
    
    const oscilloscope = new Oscilloscope(
      canvas,
      hiddenCanvas,
      hiddenCanvas,
      hiddenCanvas,
      hiddenCanvas
    );
    
    // Enable FFT display to test FFT computation
    oscilloscope.setFFTDisplayEnabled(true);
    
    function log(message, type = 'success') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      logDiv.insertBefore(entry, logDiv.firstChild);
      console.log(`[${type}] ${message}`);
    }
    
    function updateFeatureStatus(id, status, message) {
      const element = document.getElementById(id);
      if (status === 'success') {
        element.innerHTML = `✅ ${message}`;
        element.className = 'feature-item feature-enabled';
      } else if (status === 'error') {
        element.innerHTML = `❌ ${message}`;
        element.className = 'feature-item feature-disabled';
      } else {
        element.innerHTML = `⏳ ${message}`;
        element.className = 'feature-item';
      }
    }
    
    let updateInterval = null;
    let testPassed = {
      freq: false,
      gain: false,
      fft: false,
      waveform: false
    };
    
    function startUpdates() {
      log('Starting periodic updates and feature tests...', 'success');
      
      let frameCount = 0;
      
      updateInterval = setInterval(() => {
        try {
          const freq = oscilloscope.getEstimatedFrequency();
          const gain = oscilloscope.getCurrentGain();
          const method = oscilloscope.getFrequencyEstimationMethod();
          
          document.getElementById('frequency').textContent = freq > 0 ? freq.toFixed(1) : '---';
          document.getElementById('gain').textContent = gain.toFixed(2);
          document.getElementById('method').textContent = method;
          
          frameCount++;
          
          // Test frequency estimation (should detect 440Hz within ±10Hz after 1 second)
          if (freq > 430 && freq < 450 && !testPassed.freq) {
            testPassed.freq = true;
            updateFeatureStatus('freq-test', 'success', `周波数推定: 動作確認 (${freq.toFixed(1)}Hz)`);
            log(`✓ Frequency estimation test PASSED: ${freq.toFixed(1)}Hz (expected: 440Hz)`, 'success');
          }
          
          // Test auto-gain (should be > 1.0 if enabled)
          if (gain > 1.0 && !testPassed.gain) {
            testPassed.gain = true;
            updateFeatureStatus('gain-test', 'success', `自動ゲイン: 動作確認 (${gain.toFixed(2)}x)`);
            log(`✓ Auto-gain test PASSED: ${gain.toFixed(2)}x`, 'success');
          }
          
          // Test FFT (if frequency estimation works with 'fft' method, FFT is working)
          if (method === 'fft' && freq > 430 && freq < 450 && !testPassed.fft) {
            testPassed.fft = true;
            updateFeatureStatus('fft-test', 'success', 'FFT計算: 動作確認 (WASM経由)');
            log('✓ FFT computation test PASSED: FFT calculated via WASM', 'success');
          }
          
          // Test waveform rendering (assume success if we got here)
          if (frameCount > 5 && !testPassed.waveform) {
            testPassed.waveform = true;
            updateFeatureStatus('waveform-test', 'success', '波形描画: 動作確認');
            log('✓ Waveform rendering test PASSED', 'success');
          }
          
          // After 5 seconds, check for failures
          if (frameCount === 50) {
            if (!testPassed.freq) {
              updateFeatureStatus('freq-test', 'error', '周波数推定: 失敗');
              log('✗ Frequency estimation test FAILED', 'error');
            }
            if (!testPassed.gain) {
              updateFeatureStatus('gain-test', 'error', '自動ゲイン: 無効または信号が強すぎる');
              log('⚠ Auto-gain test: disabled or signal too strong', 'warning');
            }
            if (!testPassed.fft) {
              updateFeatureStatus('fft-test', 'error', 'FFT計算: 失敗');
              log('✗ FFT computation test FAILED', 'error');
            }
            
            // Summary
            const allPassed = testPassed.freq && testPassed.fft && testPassed.waveform;
            if (allPassed) {
              log('=== ALL CRITICAL TESTS PASSED ===', 'success');
              log('BufferSourceモードは期待通りに動作しています', 'success');
            } else {
              log('=== SOME TESTS FAILED ===', 'error');
            }
          }
          
        } catch (error) {
          log(`Update error: ${error.message}`, 'error');
        }
      }, 100);
    }
    
    function stopUpdates() {
      if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
      }
    }
    
    startButton.addEventListener('click', async () => {
      try {
        log('=== Starting BufferSource Feature Parity Test ===', 'warning');
        log('Creating 440Hz sine wave...', 'success');
        
        // Reset test status
        testPassed = { freq: false, gain: false, fft: false, waveform: false };
        
        // Generate 440Hz sine wave
        const sampleRate = 44100;
        const duration = 1;
        const frequency = 440;
        const audioData = new Float32Array(sampleRate * duration);
        
        for (let i = 0; i < audioData.length; i++) {
          audioData[i] = Math.sin(2 * Math.PI * frequency * i / sampleRate);
        }
        
        log(`Generated ${audioData.length} samples at ${sampleRate}Hz`, 'success');
        
        // Create BufferSource
        const bufferSource = new BufferSource(audioData, sampleRate, { loop: true });
        log('BufferSource created with loop=true', 'success');
        
        // Check current settings
        const method = oscilloscope.getFrequencyEstimationMethod();
        log(`Frequency estimation method: ${method}`, 'success');
        log('FFT display: enabled (to test FFT computation)', 'success');
        log('Auto-gain: enabled (default)', 'success');
        
        // Start visualization
        log('Starting oscilloscope from buffer...', 'warning');
        await oscilloscope.startFromBuffer(bufferSource);
        log('Oscilloscope started successfully!', 'success');
        log('Running feature tests...', 'warning');
        
        startButton.disabled = true;
        stopButton.disabled = false;
        startUpdates();
        
      } catch (error) {
        log(`ERROR: ${error.message}`, 'error');
        console.error('Full error:', error);
        startButton.disabled = false;
        updateFeatureStatus('freq-test', 'error', '周波数推定: エラー');
        updateFeatureStatus('gain-test', 'error', '自動ゲイン: エラー');
        updateFeatureStatus('fft-test', 'error', 'FFT計算: エラー');
        updateFeatureStatus('waveform-test', 'error', '波形描画: エラー');
      }
    });
    
    stopButton.addEventListener('click', async () => {
      try {
        log('Stopping oscilloscope...', 'warning');
        await oscilloscope.stop();
        log('Oscilloscope stopped', 'success');
        
        startButton.disabled = false;
        stopButton.disabled = true;
        stopUpdates();
        
        document.getElementById('frequency').textContent = '---';
        document.getElementById('gain').textContent = '---';
      } catch (error) {
        log(`Stop error: ${error.message}`, 'error');
      }
    });
    
    log('Test page initialized. Click "Start BufferSource (440Hz)" to begin testing.', 'success');
  </script>
</body>
</html>
